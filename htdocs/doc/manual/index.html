<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<script type="text/javascript">
//<![CDATA[
var version = {title: "TiddlyWiki", major: 2, minor: 2, revision: 4, date: new Date("Jun 19, 2007"), extensions: {}};
//]]>
</script>
<!--
TiddlyWiki created by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)

Copyright (c) UnaMesa Association 2004-2007

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of the UnaMesa Association nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.
-->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<!--PRE-HEAD-START-->
<!--{{{-->
<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml'/>
<!--}}}-->
<!--PRE-HEAD-END-->
<title> Habari - | User Manual </title>
<style type="text/css">
#saveTest {display:none;}
#messageArea {display:none;}
#copyright {display:none;}
#storeArea {display:none;}
#storeArea div {padding:0.5em; margin:1em 0em 0em 0em; border-color:#fff #666 #444 #ddd; border-style:solid; border-width:2px; overflow:auto;}
#shadowArea {display:none;}
#javascriptWarning {width:100%; text-align:center; font-weight:bold; background-color:#dd1100; color:#fff; padding:1em 0em;}
</style>
<!--POST-HEAD-START-->

<!--POST-HEAD-END-->
</head>
<body onload="main();" onunload="if(window.checkUnsavedChanges) checkUnsavedChanges(); if(window.scrubNodes) scrubNodes(document.body);">
<!--PRE-BODY-START-->

<!--PRE-BODY-END-->
<div id="copyright">
Welcome to TiddlyWiki created by Jeremy Ruston, Copyright &copy; 2007 UnaMesa Association
</div>
<noscript>
	<div id="javascriptWarning">This page requires JavaScript to function properly.<br /><br />If you are using Microsoft Internet Explorer you may need to click on the yellow bar above and select 'Allow Blocked Content'. You must then click 'Yes' on the following security warning.</div>
</noscript>
<div id="saveTest"></div>
<div id="backstageCloak"></div>
<div id="backstageButton"></div>
<div id="backstageArea"><div id="backstageToolbar"></div></div>
<div id="backstage">
	<div id="backstagePanel"></div>
</div>
<div id="contentWrapper"></div>
<div id="contentStash"></div>
<div id="shadowArea">
<div title="ColorPalette">
<pre>Background: #fff
Foreground: #000
PrimaryPale: #8cf
PrimaryLight: #18f
PrimaryMid: #04b
PrimaryDark: #014
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #841
TertiaryPale: #eee
TertiaryLight: #ccc
TertiaryMid: #999
TertiaryDark: #666
Error: #f88</pre>
</div>
<div title="StyleSheetColors">
<pre>/*{{{*/
body {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}

a {color:[[ColorPalette::PrimaryMid]];}
a:hover {background-color:[[ColorPalette::PrimaryMid]]; color:[[ColorPalette::Background]];}
a img {border:0;}

h1,h2,h3,h4,h5,h6 {color:[[ColorPalette::SecondaryDark]]; background:transparent;}
h1 {border-bottom:2px solid [[ColorPalette::TertiaryLight]];}
h2,h3 {border-bottom:1px solid [[ColorPalette::TertiaryLight]];}

.button {color:[[ColorPalette::PrimaryDark]]; border:1px solid [[ColorPalette::Background]];}
.button:hover {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::SecondaryLight]]; border-color:[[ColorPalette::SecondaryMid]];}
.button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::SecondaryDark]];}

.header {background:[[ColorPalette::PrimaryMid]];}
.headerShadow {color:[[ColorPalette::Foreground]];}
.headerShadow a {font-weight:normal; color:[[ColorPalette::Foreground]];}
.headerForeground {color:[[ColorPalette::Background]];}
.headerForeground a {font-weight:normal; color:[[ColorPalette::PrimaryPale]];}

.tabSelected{color:[[ColorPalette::PrimaryDark]];
	background:[[ColorPalette::TertiaryPale]];
	border-left:1px solid [[ColorPalette::TertiaryLight]];
	border-top:1px solid [[ColorPalette::TertiaryLight]];
	border-right:1px solid [[ColorPalette::TertiaryLight]];
}
.tabUnselected {color:[[ColorPalette::Background]]; background:[[ColorPalette::TertiaryMid]];}
.tabContents {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::TertiaryPale]]; border:1px solid [[ColorPalette::TertiaryLight]];}
.tabContents .button {border:0;}

#sidebar {}
#sidebarOptions input {border:1px solid [[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel {background:[[ColorPalette::PrimaryPale]];}
#sidebarOptions .sliderPanel a {border:none;color:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:hover {color:[[ColorPalette::Background]]; background:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:active {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::Background]];}

.wizard {background:[[ColorPalette::PrimaryPale]]; border:1px solid [[ColorPalette::PrimaryMid]];}
.wizard h1 {color:[[ColorPalette::PrimaryDark]]; border:none;}
.wizard h2 {color:[[ColorPalette::Foreground]]; border:none;}
.wizardStep {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];
	border:1px solid [[ColorPalette::PrimaryMid]];}
.wizardStep.wizardStepDone {background::[[ColorPalette::TertiaryLight]];}
.wizardFooter {background:[[ColorPalette::PrimaryPale]];}
.wizardFooter .status {background:[[ColorPalette::PrimaryDark]]; color:[[ColorPalette::Background]];}
.wizard .button {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryLight]]; border: 1px solid;
	border-color:[[ColorPalette::SecondaryPale]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryPale]];}
.wizard .button:hover {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Background]];}
.wizard .button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::Foreground]]; border: 1px solid;
	border-color:[[ColorPalette::PrimaryDark]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryDark]];}

#messageArea {border:1px solid [[ColorPalette::SecondaryMid]]; background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]];}
#messageArea .button {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::SecondaryPale]]; border:none;}

.popupTiddler {background:[[ColorPalette::TertiaryPale]]; border:2px solid [[ColorPalette::TertiaryMid]];}

.popup {background:[[ColorPalette::TertiaryPale]]; color:[[ColorPalette::TertiaryDark]]; border-left:1px solid [[ColorPalette::TertiaryMid]]; border-top:1px solid [[ColorPalette::TertiaryMid]]; border-right:2px solid [[ColorPalette::TertiaryDark]]; border-bottom:2px solid [[ColorPalette::TertiaryDark]];}
.popup hr {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::PrimaryDark]]; border-bottom:1px;}
.popup li.disabled {color:[[ColorPalette::TertiaryMid]];}
.popup li a, .popup li a:visited {color:[[ColorPalette::Foreground]]; border: none;}
.popup li a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; border: none;}
.popup li a:active {background:[[ColorPalette::SecondaryPale]]; color:[[ColorPalette::Foreground]]; border: none;}
.popupHighlight {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
.listBreak div {border-bottom:1px solid [[ColorPalette::TertiaryDark]];}

.tiddler .defaultCommand {font-weight:bold;}

.shadow .title {color:[[ColorPalette::TertiaryDark]];}

.title {color:[[ColorPalette::SecondaryDark]];}
.subtitle {color:[[ColorPalette::TertiaryDark]];}

.toolbar {color:[[ColorPalette::PrimaryMid]];}
.toolbar a {color:[[ColorPalette::TertiaryLight]];}
.selected .toolbar a {color:[[ColorPalette::TertiaryMid]];}
.selected .toolbar a:hover {color:[[ColorPalette::Foreground]];}

.tagging, .tagged {border:1px solid [[ColorPalette::TertiaryPale]]; background-color:[[ColorPalette::TertiaryPale]];}
.selected .tagging, .selected .tagged {background-color:[[ColorPalette::TertiaryLight]]; border:1px solid [[ColorPalette::TertiaryMid]];}
.tagging .listTitle, .tagged .listTitle {color:[[ColorPalette::PrimaryDark]];}
.tagging .button, .tagged .button {border:none;}

.footer {color:[[ColorPalette::TertiaryLight]];}
.selected .footer {color:[[ColorPalette::TertiaryMid]];}

.sparkline {background:[[ColorPalette::PrimaryPale]]; border:0;}
.sparktick {background:[[ColorPalette::PrimaryDark]];}

.error, .errorButton {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Error]];}
.warning {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryPale]];}
.lowlight {background:[[ColorPalette::TertiaryLight]];}

.zoomer {background:none; color:[[ColorPalette::TertiaryMid]]; border:3px solid [[ColorPalette::TertiaryMid]];}

.imageLink, #displayArea .imageLink {background:transparent;}

.annotation {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; border:2px solid [[ColorPalette::SecondaryMid]];}

.viewer .listTitle {list-style-type:none; margin-left:-2em;}
.viewer .button {border:1px solid [[ColorPalette::SecondaryMid]];}
.viewer blockquote {border-left:3px solid [[ColorPalette::TertiaryDark]];}

.viewer table, table.twtable {border:2px solid [[ColorPalette::TertiaryDark]];}
.viewer th, .viewer thead td, .twtable th, .twtable thead td {background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::Background]];}
.viewer td, .viewer tr, .twtable td, .twtable tr {border:1px solid [[ColorPalette::TertiaryDark]];}

.viewer pre {border:1px solid [[ColorPalette::SecondaryLight]]; background:[[ColorPalette::SecondaryPale]];}
.viewer code {color:[[ColorPalette::SecondaryDark]];}
.viewer hr {border:0; border-top:dashed 1px [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::TertiaryDark]];}

.highlight, .marked {background:[[ColorPalette::SecondaryLight]];}

.editor input {border:1px solid [[ColorPalette::PrimaryMid]];}
.editor textarea {border:1px solid [[ColorPalette::PrimaryMid]]; width:100%;}
.editorFooter {color:[[ColorPalette::TertiaryMid]];}

#backstageArea {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::TertiaryMid]];}
#backstageArea a {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstageArea a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; }
#backstageArea a.backstageSelTab {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
#backstageButton a {background:none; color:[[ColorPalette::Background]]; border:none;}
#backstageButton a:hover {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstagePanel {background:[[ColorPalette::Background]]; border-color: [[ColorPalette::Background]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]];}
.backstagePanelFooter .button {border:none; color:[[ColorPalette::Background]];}
.backstagePanelFooter .button:hover {color:[[ColorPalette::Foreground]];}
#backstageCloak {background:[[ColorPalette::Foreground]]; opacity:0.6; filter:'alpha(opacity:60)';}
/*}}}*/</pre>
</div>
<div title="StyleSheetLayout">
<pre>/*{{{*/
* html .tiddler {height:1%;}

body {font-size:.75em; font-family:arial,helvetica; margin:0; padding:0;}

h1,h2,h3,h4,h5,h6 {font-weight:bold; text-decoration:none;}
h1,h2,h3 {padding-bottom:1px; margin-top:1.2em;margin-bottom:0.3em;}
h4,h5,h6 {margin-top:1em;}
h1 {font-size:1.35em;}
h2 {font-size:1.25em;}
h3 {font-size:1.1em;}
h4 {font-size:1em;}
h5 {font-size:.9em;}

hr {height:1px;}

a {text-decoration:none;}

dt {font-weight:bold;}

ol {list-style-type:decimal;}
ol ol {list-style-type:lower-alpha;}
ol ol ol {list-style-type:lower-roman;}
ol ol ol ol {list-style-type:decimal;}
ol ol ol ol ol {list-style-type:lower-alpha;}
ol ol ol ol ol ol {list-style-type:lower-roman;}
ol ol ol ol ol ol ol {list-style-type:decimal;}

.txtOptionInput {width:11em;}

#contentWrapper .chkOptionInput {border:0;}

.externalLink {text-decoration:underline;}

.indent {margin-left:3em;}
.outdent {margin-left:3em; text-indent:-3em;}
code.escaped {white-space:nowrap;}

.tiddlyLinkExisting {font-weight:bold;}
.tiddlyLinkNonExisting {font-style:italic;}

/* the 'a' is required for IE, otherwise it renders the whole tiddler in bold */
a.tiddlyLinkNonExisting.shadow {font-weight:bold;}

#mainMenu .tiddlyLinkExisting,
	#mainMenu .tiddlyLinkNonExisting,
	#sidebarTabs .tiddlyLinkNonExisting {font-weight:normal; font-style:normal;}
#sidebarTabs .tiddlyLinkExisting {font-weight:bold; font-style:normal;}

.header {position:relative;}
.header a:hover {background:transparent;}
.headerShadow {position:relative; padding:4.5em 0em 1em 1em; left:-1px; top:-1px;}
.headerForeground {position:absolute; padding:4.5em 0em 1em 1em; left:0px; top:0px;}

.siteTitle {font-size:3em;}
.siteSubtitle {font-size:1.2em;}

#mainMenu {position:absolute; left:0; width:10em; text-align:right; line-height:1.6em; padding:1.5em 0.5em 0.5em 0.5em; font-size:1.1em;}

#sidebar {position:absolute; right:3px; width:16em; font-size:.9em;}
#sidebarOptions {padding-top:0.3em;}
#sidebarOptions a {margin:0em 0.2em; padding:0.2em 0.3em; display:block;}
#sidebarOptions input {margin:0.4em 0.5em;}
#sidebarOptions .sliderPanel {margin-left:1em; padding:0.5em; font-size:.85em;}
#sidebarOptions .sliderPanel a {font-weight:bold; display:inline; padding:0;}
#sidebarOptions .sliderPanel input {margin:0 0 .3em 0;}
#sidebarTabs .tabContents {width:15em; overflow:hidden;}

.wizard {padding:0.1em 1em 0em 2em;}
.wizard h1 {font-size:2em; font-weight:bold; background:none; padding:0em 0em 0em 0em; margin:0.4em 0em 0.2em 0em;}
.wizard h2 {font-size:1.2em; font-weight:bold; background:none; padding:0em 0em 0em 0em; margin:0.4em 0em 0.2em 0em;}
.wizardStep {padding:1em 1em 1em 1em;}
.wizard .button {margin:0.5em 0em 0em 0em; font-size:1.2em;}
.wizardFooter {padding:0.8em 0.4em 0.8em 0em;}
.wizardFooter .status {padding:0em 0.4em 0em 0.4em; margin-left:1em;}
.wizard .button {padding:0.1em 0.2em 0.1em 0.2em;}

#messageArea {position:fixed; top:2em; right:0em; margin:0.5em; padding:0.5em; z-index:2000; _position:absolute;}
.messageToolbar {display:block; text-align:right; padding:0.2em 0.2em 0.2em 0.2em;}
#messageArea a {text-decoration:underline;}

.tiddlerPopupButton {padding:0.2em 0.2em 0.2em 0.2em;}
.popupTiddler {position: absolute; z-index:300; padding:1em 1em 1em 1em; margin:0;}

.popup {position:absolute; z-index:300; font-size:.9em; padding:0; list-style:none; margin:0;}
.popup .popupMessage {padding:0.4em;}
.popup hr {display:block; height:1px; width:auto; padding:0; margin:0.2em 0em;}
.popup li.disabled {padding:0.4em;}
.popup li a {display:block; padding:0.4em; font-weight:normal; cursor:pointer;}
.listBreak {font-size:1px; line-height:1px;}
.listBreak div {margin:2px 0;}

.tabset {padding:1em 0em 0em 0.5em;}
.tab {margin:0em 0em 0em 0.25em; padding:2px;}
.tabContents {padding:0.5em;}
.tabContents ul, .tabContents ol {margin:0; padding:0;}
.txtMainTab .tabContents li {list-style:none;}
.tabContents li.listLink { margin-left:.75em;}

#contentWrapper {display:block;}
#splashScreen {display:none;}

#displayArea {margin:1em 17em 0em 14em;}

.toolbar {text-align:right; font-size:.9em;}

.tiddler {padding:1em 1em 0em 1em;}

.missing .viewer,.missing .title {font-style:italic;}

.title {font-size:1.6em; font-weight:bold;}

.missing .subtitle {display:none;}
.subtitle {font-size:1.1em;}

.tiddler .button {padding:0.2em 0.4em;}

.tagging {margin:0.5em 0.5em 0.5em 0; float:left; display:none;}
.isTag .tagging {display:block;}
.tagged {margin:0.5em; float:right;}
.tagging, .tagged {font-size:0.9em; padding:0.25em;}
.tagging ul, .tagged ul {list-style:none; margin:0.25em; padding:0;}
.tagClear {clear:both;}

.footer {font-size:.9em;}
.footer li {display:inline;}

.annotation {padding:0.5em; margin:0.5em;}

* html .viewer pre {width:99%; padding:0 0 1em 0;}
.viewer {line-height:1.4em; padding-top:0.5em;}
.viewer .button {margin:0em 0.25em; padding:0em 0.25em;}
.viewer blockquote {line-height:1.5em; padding-left:0.8em;margin-left:2.5em;}
.viewer ul, .viewer ol {margin-left:0.5em; padding-left:1.5em;}

.viewer table, table.twtable {border-collapse:collapse; margin:0.8em 1.0em;}
.viewer th, .viewer td, .viewer tr,.viewer caption,.twtable th, .twtable td, .twtable tr,.twtable caption {padding:3px;}
table.listView {font-size:0.85em; margin:0.8em 1.0em;}
table.listView th, table.listView td, table.listView tr {padding:0px 3px 0px 3px;}

.viewer pre {padding:0.5em; margin-left:0.5em; font-size:1.2em; line-height:1.4em; overflow:auto;}
.viewer code {font-size:1.2em; line-height:1.4em;}

.editor {font-size:1.1em;}
.editor input, .editor textarea {display:block; width:100%; font:inherit;}
.editorFooter {padding:0.25em 0em; font-size:.9em;}
.editorFooter .button {padding-top:0px; padding-bottom:0px;}

.fieldsetFix {border:0; padding:0; margin:1px 0px 1px 0px;}

.sparkline {line-height:1em;}
.sparktick {outline:0;}

.zoomer {font-size:1.1em; position:absolute; overflow:hidden;}
.zoomer div {padding:1em;}

* html #backstage {width:99%;}
* html #backstageArea {width:99%;}
#backstageArea {display:none; position:relative; overflow: hidden; z-index:150; padding:0.3em 0.5em 0.3em 0.5em;}
#backstageToolbar {position:relative;}
#backstageArea a {font-weight:bold; margin-left:0.5em; padding:0.3em 0.5em 0.3em 0.5em;}
#backstageButton {display:none; position:absolute; z-index:175; top:0em; right:0em;}
#backstageButton a {padding:0.1em 0.4em 0.1em 0.4em; margin:0.1em 0.1em 0.1em 0.1em;}
#backstage {position:relative; width:100%; z-index:50;}
#backstagePanel {display:none; z-index:100; position:absolute; margin:0em 3em 0em 3em; padding:1em 1em 1em 1em;}
.backstagePanelFooter {padding-top:0.2em; float:right;}
.backstagePanelFooter a {padding:0.2em 0.4em 0.2em 0.4em;}
#backstageCloak {display:none; z-index:20; position:absolute; width:100%; height:100px;}

.whenBackstage {display:none;}
.backstageVisible .whenBackstage {display:block;}
/*}}}*/</pre>
</div>
<div title="StyleSheetLocale">
<pre>/***
StyleSheet for use when a translation requires any css style changes.
This StyleSheet can be used directly by languages such as Chinese, Japanese and Korean which use a logographic writing system and need larger font sizes.
***/

/*{{{*/
body {font-size:0.8em;}

#sidebarOptions {font-size:1.05em;}
#sidebarOptions a {font-style:normal;}
#sidebarOptions .sliderPanel {font-size:0.95em;}

.subtitle {font-size:0.8em;}

.viewer table.listView {font-size:0.95em;}

.htmlarea .toolbarHA table {border:1px solid ButtonFace; margin:0em 0em;}
/*}}}*/</pre>
</div>
<div title="StyleSheetPrint">
<pre>/*{{{*/
@media print {
#mainMenu, #sidebar, #messageArea, .toolbar, #backstageButton {display: none ! important;}
#displayArea {margin: 1em 1em 0em 1em;}
/* Fixes a feature in Firefox 1.5.0.2 where print preview displays the noscript content */
noscript {display:none;}
}
/*}}}*/</pre>
</div>
<div title="PageTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='header' macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'&gt;
&lt;div class='headerShadow'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div class='headerForeground'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;div id='sidebar'&gt;
&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="ViewTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar closeTiddler closeOthers +editTiddler &gt; fields syncing permalink references jump'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;&lt;span macro='view modifier link'&gt;&lt;/span&gt;, &lt;span macro='view modified date'&gt;&lt;/span&gt; (&lt;span macro='message views.wikified.createdPrompt'&gt;&lt;/span&gt; &lt;span macro='view created date'&gt;&lt;/span&gt;)&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="EditTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar +saveTiddler -cancelTiddler deleteTiddler'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit title'&gt;&lt;/div&gt;
&lt;div macro='annotations'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit text'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit tags'&gt;&lt;/div&gt;&lt;div class='editorFooter'&gt;&lt;span macro='message views.editor.tagPrompt'&gt;&lt;/span&gt;&lt;span macro='tagChooser'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="GettingStarted">
<pre>To get started with this blank TiddlyWiki, you'll need to modify the following tiddlers:
* SiteTitle &amp; SiteSubtitle: The title and subtitle of the site, as shown above (after saving, they will also appear in the browser title bar)
* MainMenu: The menu (usually on the left)
* DefaultTiddlers: Contains the names of the tiddlers that you want to appear when the TiddlyWiki is opened
You'll also need to enter your username for signing your edits: &lt;&lt;option txtUserName&gt;&gt;</pre>
</div>
<div title="OptionsPanel">
<pre>These InterfaceOptions for customising TiddlyWiki are saved in your browser

Your username for signing your edits. Write it as a WikiWord (eg JoeBloggs)

&lt;&lt;option txtUserName&gt;&gt;
&lt;&lt;option chkSaveBackups&gt;&gt; SaveBackups
&lt;&lt;option chkAutoSave&gt;&gt; AutoSave
&lt;&lt;option chkRegExpSearch&gt;&gt; RegExpSearch
&lt;&lt;option chkCaseSensitiveSearch&gt;&gt; CaseSensitiveSearch
&lt;&lt;option chkAnimate&gt;&gt; EnableAnimations

----
Also see AdvancedOptions</pre>
</div>
</div>
<!--POST-SHADOWAREA-->
<div id="storeArea">
<div title="Asides" modifier="habari" modified="200710161722" created="200710131844" tags="MediaWikiFormat" changecount="5">
<pre>Asides, or short posts, are a common feature in blogs.  These are generally a few lines, and intended to be outside the loop of larger posts.  It's quite common it show these in a sidebar or big footer.

To accomplish this with Habari, you will employ the use of tags.  Your first order is to determine what tag you want to use.  In this example &quot;aside&quot; will be used.

The first file you will be editing will be your theme.php file.

You will be adding a few lines to your custom Class. (In k2 this class is called myTheme, your custom theme should be named something different)

First, we are going to exclude the aside tag from the main loop.
&lt;pre&gt;public function act_display_home()
{
    parent::act_display_home( array( 'not:tag' =&gt; 'aside' ) );
}
&lt;/pre&gt;

(Note, if you use a different tag other than &quot;aside&quot;, you will need to change it in all the code examples).

Next you are going to define a variable so that you can control how many posts to show, and output the list of posts.
&lt;pre&gt;$this-&gt;assign( 'asides', Posts::get( array( 'tag'=&gt;'aside', 'limit'=&gt;5) ) );
parent::add_template_vars();
&lt;/pre&gt;
You can obviously change the limit variable to alter the number of items you are going to output.

Now that the theme.php file has been edited, the &quot;aside&quot; tag is excluded from the main loop of posts, and you are ready to output your list of asides.  Determine where you want to output this list (as mentioned, a sidebar is a very common place).

&lt;pre&gt;&lt;ul&gt;
&lt;?php
foreach($asides as $post):
echo '&lt;li&gt;&lt;span class=&quot;date&quot;&gt;';
echo $post-&gt;pubdate_out . ' - ' . '&lt;/span&gt;';
echo '&lt;a href=&quot;' . $post-&gt;permalink .'&quot;/&gt;' . $post-&gt;title_out . '&lt;/a&gt; - ';
echo '&lt;/li&gt;'; ?&gt;
&lt;?php endforeach; ?&gt;
&lt;/ul&gt;
&lt;/pre&gt;

In this example, Only the post title and a permalink to the post is shown.  You can add &lt;code&gt;echo $post-&gt;content_out;&lt;/code&gt; where you want it shown in the foreach (ie, before the closing &lt;code&gt;&lt;/li&gt;&lt;/code&gt;)

You may also want to read over [[Using Excerpts]] if you want to have full length posts in your main content, and excerpts for your asides.

Here is [http://www.chrisjdavis.org/asides-with-habari another tutorial] for doing inline asides.  That is, asides listed along with primary posts, however with the ability to format them differently.</pre>
</div>
<div title="Available Plugins" modifier="laserlight" modified="200806260907" created="200807250028" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>''Add your plugins to the list!''

The Habari community also maintains the [http://trac.habariproject.org/habari-extras Habari-Extras repository] to house community developed plugins and themes, many of which are not listed here. Plugins can be [http://www.habariproject.org/dist/plugins/ downloaded from the distribution directory].  Currently this repository does not separate stable builds from development builds, so compatibility with various builds of Habari is not guaranteed.  Eventually this will be resolved.

== [http://www.awhitebox.com Ali B. (a.k.a. dmondark)] ==
[http://www.awhitebox.com/audio-player-plugin-quick-update Audio Player Plugin 0.2]
''lets you insert a flash-based, mp3 audio player anywhere within your posts or pages.''

[http://www.awhitebox.com/woopra-plugin-for-habari Woopra Plugin 0.3]
''Add Woopra's tracking code to the footer of your site.''

The plugins below can now be found in the [http://trac.habariproject.org/habari-extras Habari-Extras] repository, and can be [http://www.habariproject.org/dist/plugins/ downloaded from the distribution directory]

'''Recent Comments'''
''Display the most recent comments in your blog and customize how they are displayed''

'''Blogroll'''
''Displays a blogroll on your blog''

== [http://myfla.ws Arthus Erea] ==
The plugins below can now be found in the [http://trac.habariproject.org/habari-extras Habari-Extras] repository, and can be [http://www.habariproject.org/dist/plugins/ downloaded from the distribution directory].

* '''[http://trac.habariproject.org/habari-extras/browser/plugins/aliencontact AlienContact]''' generates and manages an extensible contact form for insertion into pages.
* '''[http://trac.habariproject.org/habari-extras/browser/plugins/partytime partyTime]''' creates an event content-type for managing events on your Habari blog

== [http://www.andrewdasilva.com/plugins Andrew da Silva] ==

''These plugins can now be found in the [http://trac.habariproject.org/habari-extras Habari-Extras] repository, and can be [http://www.habariproject.org/dist/plugins/ downloaded from the distribution directory]''

'''Feedburner 0.5'''
''Redirects your Habari feeds through Feedburner.''

'''Google Sitemaps 0.6'''
''Generates a sitemap.xml when requested.''

'''Gravatar 0.5'''
''Simple yet effective Gravatar plugin for Habari.''

'''MetaWeblog 0.8.2'''
''Adds support for the metaWeblog XMLRPC protocol!

'''Route 301 0.5'''
''Ease your move to Habari, route your old URLs to your new format.''

'''Thickbox 0.1'''
''Add Thickbox, a lightweight clone of Lightbox using the jQuery library.''

'''OpenSearch 0.1'''
''Add OpenSearch functionality to Habari''

'''OpenID 0.1'''
''Add OpenID support to Habari''

== [http://www.nbrightside.com/blog/ Andy C] ==
[http://www.nbrightside.com/blog/user/files/plugins/quote-0.2.tar.gz Quote]
''Display a random one-line quote from a user defined list''

== [http://caius.name/ Caius Durling] ==
[http://qwert.us/habari-markdown Habari Markdown (Updated)]
''An updated version of drunkenmonkeys markdown plugin.  Applies markdown to the atom feed as well as the http:// content''

== [http://www.chrisjdavis.org/plugins/ Chris J. Davis] ==
[http://www.chrisjdavis.org/akismet-for-habari Akismet for Habari]
''Uhhh, yeah Akismet for Habari, like it says.''

[http://www.chrisjdavis.org/cjd-lifestream-1-0 CJD Lifestream 1.0]
''Lifestream for Habari''

[http://www.chrisjdavis.org/cjd-quick-posts-1-0 CJD Quick Post]
''Quickly post asides without loading the admin interface with this plugin.''

== [http://drunkenmonkey.org/ Drunken Monkey Labs] ==
[http://drunkenmonkey.org/projects/habari-markdown Habari Markdown] ''Enables [http://daringfireball.net John Gruber's] [http://daringfireball.net/projects/markdown/ Markdown syntax] for Habari''

[http://drunkenmonkey.org/user/files/habminbar-0.2.tar.gz Habminbar v.0.2] ''Habmin Bar is a small plugin for Habari that adds an admin bar to top of every page for easy access to the admin section. And in the latest version the styling makes it all look beautiful.''

[http://drunkenmonkey.org/projects/jambo Jambo Development Preview] ''Jambo plugin for Habari that will insert a contact form into any post you wish. Just insert &lt;nowiki&gt;&lt;!-- Jambo --&gt;&lt;/nowiki&gt; wherever you want the contact form to be displayed.''

[http://drunkenmonkey.org/user/files/tabasamu.dev.tar.gz Tabasamu Development Preview] ''Tabasamu is a plugin for Habari that allows for the selection of different smilies packages. Smilies packages are a set of text/image smiley replacements which filter the post content and replace all text smilies with their image counterpart.''

== [http://blog.trifolddesigns.com/ Dylan Wreggelsworth] ==
[http://blog.trifolddesigns.com/textile-2-0-0-plugin-for-habari Habari Textile]
''Allows Textile 2.0.0 Parsing for articles and pages.''

[http://blog.trifolddesigns.com/pownce-plugin-for-habari Habari Pownce]
''Show your latest public posts from Pownce.''

== [http://iamgraham.net/ Graham Christensen 'itrebal' ] ==
[http://iamgraham.net/plugins#adsense Google AdSense]
''Displays Google AdSense in the sidebar.''

[http://iamgraham.net/plugins#analytics Google Analytics]
''Adds Google Analytics JS code to track your site using their services.''

[http://iamgraham.net/plugins#commenthttp Comment HTTP Filter]
''Filters out http:// from comments who's URL is '''only''' http://, leaves &quot;http://&quot; for all other URLs.''

== [http://josedasilva.net/blog/ Jose da Silva ] ==
[http://josedasilva.net/blog/habari-linkedin-plugin LinkedIn Habari Plugin] ''LinkedIn Plugin for Habari allows you to have the plugin badge in you template on a simple way!''
* Current Version: 0.1
* Tested on Habari Versions: DR 0.4

== [http://massimiliano.farinetti.eu Massimiliano Farinetti ] ==
[http://massimiliano.farinetti.eu/scartari/comment-notifier-for-habari Comment Notifier]
''Enables comment notification to a selected e-mail address.''
* Current Version: 0.4
* Tested on Habari 0.4 and 0.5-alpha (r1382)

== [http://www.twofishcreative.com/michael/blog Michael C. Harris ] ==
[http://www.twofishcreative.com/michael/blog/publish-quote Publish Quote]
''Easily quote web sites on your blog using a bookmarklet.''

[http://www.twofishcreative.com/michael/blog/tinymce TinyMCE]
''Publish posts using the TinyMCE WYSIWYG HTML editor.''

(The following plugins are available on [http://habariproject.org/dist/plugins/ Habari-Extras])

[http://www.habariproject.org/dist/plugins/jwysiwyg.zip jWYSIWYG]
''Publish posts using the lightweight JQuery-based jWYSIWYG HTML editor.''

[http://www.habariproject.org/dist/plugins/youtubesilo.zip YouTube Media Silo]
''Access your YouTube videos from within Habari's publish page, for easy embedding.''

[http://www.habariproject.org/dist/plugins/livehelp.zip Live Help]
''Get live help from Habari developers and users from your Habari admin.''

== [http://blog.tinyau.net/ Raman Ng (a.k.a. tinyau)] ==
[http://blog.tinyau.net/archives/2007/06/25/habari-rn-code-escape-plugin/ RN Code Escape]
''Escape &amp;, &lt;, &gt; inside &amp;lt;code&amp;gt;...&amp;lt;/code&amp;gt; block into HTML entities automatically''

[http://blog.tinyau.net/archives/2007/07/02/habari-rn-related-posts-plugin/ RN Related Posts]
''Show related posts of a post based on tag intersection of tags''

[http://blog.tinyau.net/archives/2007/07/17/habari-rn-related-tags-plugin/ RN Related Tags]
''Show related tags of a post''

[http://blog.tinyau.net/archives/2007/07/29/habari-rn-flickrrss-plugin/ RN FlickrRSS]
''Show recent images of Flickr through RSS feed''

[http://blog.tinyau.net/archives/2007/07/29/habari-rn-zooomrrss-plugin/ RN ZooomrRSS]
''Show recent images of Zooomr through RSS feed''

[http://blog.tinyau.net/archives/2007/08/30/habari-rn-tag-cloud-plugin/ RN Tag Cloud]
''Show tag cloud of your blog''

[http://blog.tinyau.net/archives/2007/09/22/habari-rn-monthly-archives-plugin/ RN Monthly Archives]
''Show monthly archives''

[http://blog.tinyau.net/archives/2008/03/12/habari-rn-custom-permalink-plugin/ RN Custom Permalink]
''Customize permalink structure of every content type and its corresponding comments feed''

== [http://robinadr.com Robin Adrianse ] ==
[http://robinadr.com/projects/footnotes Footnotes]
''Adds footnotes to your posts!''

[http://robinadr.com/projects/headcode Headcode]
''Enables you to Inject your own code into the section of your template, and before the closing tag in your template.''

[http://robinadr.com/projects/underscore_permalinks Underscore Permalinks]
''changes Habari’s slug creation to use underscores (_) instead of dashes (-).''

== [http://www.morydd.net/ Sean T Evans (a.k.a. Morydd)] ==
[http://www.morydd.net/habari-magic-tags-0-1 Morydd's Magic Tags]
''Hide tags begining with &quot;@&quot; from display Tested on DR 0.2)''
* Current Version: 0.3
* Tested on Habari Versions: DR 0.2
(Now avilable on [http://habariproject.org/dist/plugins/ Habari-Extras])

== [http://www.shihui.org/sheng/ Mike Shi] ==
[http://www.shihui.org/sheng/chinese-plugin-for-habari Chinese Plugin For Habari]

让Habari更好支持中文的插件，主要功能是把中文标题转换成拼音形式，比如标题为“测试”，则生成的URL地址为“ce-shi”,对于标签做同样的操作。

If you can NOT understand the text above, I guess you will not be interested in this plugin, because it is useful (or meaningful) only for people who write blogs in Chinese. You, however, still can get the English introduction from [http://www.shihui.org/sheng/chinese-plugin-for-habari here]

[http://www.shihui.org/sheng/fanfou-plugin-for-habari Fanfou Plugin For Habari]

Fanfou(饭否) is one of twitter's mimics in China. It supplies a badge for showing the lastest messages of you in the sidebar of your blog. I wrote this plugin to make it easy to use it. Maybe it's useless for the people who do not use Fanfou, but I think it's useful for some Chinese people since Fanfou is very popular in China. You can download it at [http://code.google.com/p/habari-chinese-plugin/downloads/list here]

[http://www.shihui.org/sheng/timezone-plugin-for-habari Timezone  Plugin For Habari] '''OMG, there is still a serious bug in it, I will fix it asap. Sorry.'''

Timezone plugin can make your blog's time be shown correctly for your timezone. Active it, and select your timezone in configuration field, and, that's all. The date saved in database is still the server's timezone, so it will not damage your data. You can download from [http://habari-chinese-plugin.googlecode.com/files/timezone_0.8.zip here]

== [http://numberbox.net Elijah Snyder] ==
[http://numberbox.net/blogs/files/barcampdev.zip barcamp Orlando Developer Day Badge]

[http://numberbox.net/blogs/files/barcampmedia.zip barcamp Orlando Media Day Badge]

Simple plugins to add barcamp badges to your sidebar for [http://barcamporlando.com barcamp Orlando]

These plugins are designed to work &quot;out of the box&quot; with the K2 and other older themes that use act('theme_sidebar_top'), or invoked with $theme-&gt;sidebar_top()

[http://numberbox.net/blogs/files/diggplugin.zip Digg Tags on your posts]
Simple plugin for a configurable Digg tag on your post content.  Very old, not very useful...
Invoked with $theme-&gt;digg(&quot;link to article&quot;), for example: $theme-&gt;digg($post-&gt;permalink)

[http://numberbox.net/blogs/files/geshiplugin.zip GeSHi plugin for Habari.]
GeSHi in Habari!&lt;br/&gt;
This plugin requires that you download GeSHi yourself.&lt;br/&gt;
[http://geshi.org Get GeSHi]

[http://numberbox.net/blogs/habaritup-testing Content editor for Habari featuring markItUp! and simpleModal -- IN TESTING!]
Adds a light weight, extensible jQuery based editor to Habari.

== [http://mikelietz.org/code/habari Mike Lietz] ==
[http://mikelietz.org/code/habari/geotags.php GeoTags] ''Adds [http://wikipedia.org/wiki/Geotagging Geotag] meta tags to the header, for 0.4.1 and later.''

[http://mikelietz.org/code/habari/counters.php Post Word Count] ''Counts words in a given post, for 0.4.1 and later.''

[http://mikelietz.org/code/habari/counters.php Word Count by Tag] ''Totals word counts for all published posts in with one or more specified tags, for 0.4.1 and later.''

== [http://gopherwood.info wayne] ==
[http://gopherwood.info/2008/05/19/habari-plugin-post-mailer Post Mailer] ''Be used to mail a copy of post new published to indicated email addresses.''

[http://gopherwood.info/2008/05/21/fckeditor-plugin-for-habari Fckeditor] ''FckEditor plugin for Habari''

[http://gopherwood.info/2008/05/21/syntaxhighlighter-for-habari SyntaxHighlighter for Habari] ''SyntaxHighlighter for Habari is used to highlight source code in your post''

== [http://www.aranel.net Eugene Wee] ==
[https://launchpad.net/habari-captcha CAPTCHA] ''Provides a CAPTCHA for comment submission.''

Comments are allowed to bypass moderation if the submitter passes the CAPTCHA provided by reCAPTCHA. By default, comment submitters may choose to ignore the CAPTCHA, but this behaviour may be configured through the Habari admin panel.
* Current version: 1.0b2
* Compatible with Habari 0.5 (tested on revision 2104)
* Version 1.0b1 compatible with Habari 0.4.1</pre>
</div>
<div title="CSS Coding Standards" modifier="rickc" modified="200807241310" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>===Shorthand===

It is not only legal to use shorthand CSS, it is in fact recommended to save space. Thus, instead of:
&lt;pre&gt;
font-family: Helvetica, Sans-Serif;
font-size: 1em;
&lt;/pre&gt;
You should use:
&lt;pre&gt;
font: 1em Helvetica, Sans-Serif;
&lt;/pre&gt;
This isn't applicable however if using shorthand means overwriting cascading CSS with similar CSS simply for the sake of using shorthand. The following example for instance, is wrong:
&lt;pre&gt;
ul li {
	margin: 0 5px;
}

ul li.last-child {
	margin: 0 5px 0 10px;
}
&lt;/pre&gt;
This would be the correct way of changing the left margin:
&lt;pre&gt;
ul li.last-child {
	margin-left: 10px;
}
&lt;/pre&gt;
In this way, you retain any changes higher up in the hierarchy.

===Colors Shorthand===

Using shorthand colors is entirely legal, like so:
&lt;pre&gt;
body {
	color: #222;
}
&lt;/pre&gt;
Color names (white, black, cyan) should not be used, because implementation on all browsers is not the same. Additionally, they provide no added benefit beyond convenience.

===Proprietary Styling===

It is fully legal to use proprietary styling rules, like for instance -webkit-box-shadow, as long as it doesn't degrade the user experience in any significant way on browsers where it isn't supported.

Also, when doing so, e.g. with -webkit-border-radius, it is recommended that any other similar implementations be supported as well; in this case -moz-border-radius.

===Remember the Cascade===

It is easy to forget the cascading part of CSS in the heat of battle. However, in order to make future editing of admin.css as effortless as possible, remembering to contain the cascading of styling is paramount.

Because of this, it is also suggested that the !important rule not be used, as it most often means that the cascading isn't being handled properly elsewhere in the CSS.

===Sections===

Some files, like /system/admin/css/admin.css, can grow quite large, and require some measure of organization to remain usable. For this, 'sections' are employed, which loosely group definitions by the elements they affect. admin.css for instance has sections like The Basics, The Menubar, The Menu, Dropbuttons and so on and so forth.

A section is a commented capitalized section title with a dash to the extreme left in the comment:
&lt;pre&gt;
/*- FORMS */
&lt;/pre&gt;
And is always preceeded by two line breaks and followed by a single line space.

Sub-sections can be helpful for dividing large sections. The sub-section title should be descriptive, so browsing the CSS file is swift. They looks like this:
&lt;pre&gt;
/*-- FORM BUTTONS */
&lt;/pre&gt;
The use of the dash to the left of the inside of the comment, makes it easy to step-search through the CSS file for a section, sub-section or simple comment, but searching for '/*- ' (sections) or '/*-- ' (sub-sections) or simply '/* ' (comments).

===CSS Code Layout===

All style definitions should have one line of space before and after. All CSS rules should be indented with a single tab space, and have a single space between the colon and the value of the rule. Finally, a semi-colon should follow all values, regardless of whether the value is the last in the style definition.

Like so:
&lt;pre&gt;
body {
	background: #eee;
	font: 1em Helvetica, 'Trebuchet MS', Sans-Serif;
	color: #222;
}
&lt;/pre&gt;
As with any well-formed CSS, notice the apostrophe's around 'Trebuchet MS' and the defaulting to Sans-Serif.

For readability and consistency's sake, it is generally recommended that even single-line style definitions be set up in the above manner, and not on a single line, like so:
&lt;pre&gt;
body { color: #222; }
&lt;/pre&gt;
===Inline Comments===

When a piece of CSS is inserted for non-obvious reasons, it can be a good idea to leave a small comment for others so as to not have it removed later because it didn't seem to make any immediate sense.

Comments are inserted on the right-hand side of the element they are meant for. If they cover an entire block of code, it would look like this:
&lt;pre&gt;
body { /* Something insightful goes here */
	background: #eee;
	font: 1em Helvetica, 'Trebuchet MS', Sans-Serif;
	color: #222;
}
&lt;/pre&gt;
If they cover only a single element, it would look like this:
&lt;pre&gt;
body {
	background: #eee;
	font: 1em Helvetica, 'Trebuchet MS', Sans-Serif; /* Trebuchet MS doesn't match Helvetica well */
	color: #222;
}
&lt;/pre&gt;

===Complete Example===

This is how the end of one section and the beginning of a new, complete with inline comments, might look:

&lt;pre&gt;
body {
	background: #eee;
	font: 1em Helvetica, 'Trebuchet MS', Sans-Serif;
	color: #222;
}


/*- HEADERS */

h1, h2 {
	color: #111; /* Redundant comment */
	font-size: 2em;
}

h2 {
	font-size: 1.5em;
}
&lt;/pre&gt;

[[Category:Manual]]</pre>
</div>
<div title="Classes/QueryRecord" modifier="dmondark" modified="200803031924" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>A single instance of QueryRecord represents a single query result row.  QueryRecord also serves as the base class for derivative classes that provide row-level data access.  QueryRecord is, in many ways, the fundamental building block of Habari.

==Using QueryRecord==

QueryRecord provides basic functions that allow Habari to interact with the single row of data.  The properties of a QueryRecord object represent the field values of the row.  

To obtain an instance of QueryRecord with data, call one of these static methods on the DB class:
;get_row():Returns a single QueryRecord instance for the single row retrieved
;get_results():Returns an array of QueryRecord instances, one per row returned in the query

For example:
&lt;code&gt;
 $record = DB::get_row('SELECT id, bar FROM foo WHERE id = 1');
 echo $record-&gt;bar;
&lt;/code&gt;

The code above firsts queries the database for a record containing the fields &lt;tt&gt;id&lt;/tt&gt; and &lt;tt&gt;bar&lt;/tt&gt; from the table 'foo' where the 'id' field is equal to 1.  The single record (only one is returned by &lt;tt&gt;DB::get_row()&lt;/tt&gt;) is stored in &lt;tt&gt;$record&lt;/tt&gt; as an instance of the QueryRecord class.  The property &lt;tt&gt;bar&lt;/tt&gt; referenced as &lt;tt&gt;$record-&gt;bar&lt;/tt&gt; contains the value of the 'bar' field returned by the query.  Similarly, although this is not shown, the 'id' field is assigned to &lt;tt&gt;$record-&gt;id&lt;/tt&gt;.

By echoing the value of &lt;tt&gt;$record-&gt;bar&lt;/tt&gt;, the value of that field is output.

==Updating a Record==

By changing the values of these properties and calling the update() method on the object, the QueryRow can commit that data back to the database.  For example:

&lt;code&gt;
 $record = DB::get_row('SELECT id, bar FROM foo WHERE id = 1');
 $record-&gt;bar = 'hello';
 $record-&gt;update('foo', array('id'));
&lt;/code&gt;

As with the prior example, the values of the fields 'id' and 'bar' have been queried into an instance of QueryRecord.

The &lt;tt&gt;$record-&gt;bar&lt;/tt&gt; is then assigned the value 'hello'.  This prepares the new data for update in the database.  The value of &lt;tt&gt;$record-&gt;bar&lt;/tt&gt; will contain 'hello' after this assignment.  

To update the record in the database, the &lt;tt&gt;update()&lt;/tt&gt; method is called.  In QueryRecord, update() accepts two parameters.  The first is the table to which the data will be written and the second is an array of fields that will be used to match the data in the object to the correct row in the database.

In this case, the table updated is 'foo', and the value of &lt;tt&gt;$record-&gt;id&lt;/tt&gt; will be matched against the field 'id' in the database.  Any record in the database with a matching id value will have its fields updated to the other property values of &lt;tt&gt;$record&lt;/tt&gt;

==Inserting a Record==

QueryRecord can also be used to insert new records into a table.  For example:

&lt;code&gt;
 $record = new QueryRecord(
   array('bar'=&gt;'hello')
 );
 $record-&gt;insert('foo');
&lt;/code&gt;

In the above example, a new instance of QueryRecord is created and asigned to &lt;tt&gt;$record&lt;/tt&gt;.  The values of the properties in the new QueryRecord are built from the associative array that is passed to the QueryRecord constructor.  The keys of the array become the object's properties, and the values of the array become those properties' values.  After creating &lt;tt&gt;$record&lt;/tt&gt; as above, the value of &lt;tt&gt;$record-&gt;bar&lt;/tt&gt; would be set to 'hello'.

Calling &lt;tt&gt;$record-&gt;insert()&lt;/tt&gt; inserts the property values into the specified table, in this case, 'foo'.

In order for this to work correctly, all of the values required to insert a row into a table must have been set as properties of the QueryRecord object.  Note that in this example, the 'id' field is omitted with the assumption that it is an auto_increment primary key in the 'foo' table.

After the row is inserted, the value of 'id' *will not* be set in &lt;tt&gt;$record-&gt;id&lt;/tt&gt;.  This must be done manually using &lt;tt&gt;DB::last_insert_id()&lt;/tt&gt;, which is often handled from a subclass, as described in the Extending QueryRecord section below.

==Deleting a Record==

This is fundamentally the same as updating a row, except it deletes the row from the table that has fields with the matching values.

&lt;code&gt;
 $record-&gt;delete('foo', array('id'));
&lt;/code&gt;

==Extending QueryRecord==

As part of Habari's Object-Oriented approach, other classes can extend the QueryRecord class to provide additional methods that interact with QueryRecords that contain a specific type of data.  For example, the Post class extends QueryRecord to provide additional methods that are post-specific.  The class that extends QueryRecord [http://en.wikipedia.org/wiki/Inheritance_%28computer_science%29 inherits] all of the methods of QueryRecord in addition to any that it provides on its own.

In most cases, a QueryRecord is not the class of a row.  A row is usually requested as one of QueryRecord's descendant classes.

Many classes extend the QueryRecord class.  The following classes all inherit from QueryRecord:
;Post: Represents a single post
;Comment: Represents a single comment
;LogEntry: Represents a single entry in the event log
;CronJob: Represents a single periodically executed task
;RewriteRule: Represents a single rewrite rule
;User: Represents a single user

The classes above represent wildly different functionality and and data representations; yet they each extend the base QueryRecord class.  By providing this core functionality for descendant classes, extended classes don't need to duplicate code.  

QueryRecord descendants map to database tables of the same name, and most of the properties of the descendants map the columns of that table.  For example, the Post table is used to store Post object data.  The Post object has fields 'id', 'title', and 'content', among others.  These fields are also columns in the 'posts' table in the database.

The Post class also provides special functionality that is associated only to posts.  For example, every post has a status value.  In the database, this status value is stored as an integer.  Because it's often easier to work with the names of these status, the Post class provides the ability to accept either the integer or the string as the value of the poperty, but always stores the value in the database as an integer.  This is just one example of what additional functionality a subclass of QueryRecord can provide.

One of the more significant additions a subclass can make is to override the &lt;tt&gt;update()&lt;/tt&gt; and &lt;tt&gt;insert()&lt;/tt&gt; methods of QueryRecord.  By creating having its own &lt;tt&gt;update()&lt;/tt&gt; method, a class can identify the correct table and key fields that are used to update that row in the database.  This allows a subclass instance to omit the table and keyfields parameters in the call to update.  So when updating a post, instead of this:

&lt;code&gt;$record-&gt;update('foo', array('id'));&lt;/code&gt;

You would simply call this:

&lt;code&gt;$post-&gt;update();&lt;/code&gt;

Using a subclass, you can transparently assign the value of DB::last_insert_id() to the keyfield property of the object.  This will allow you to update the object after it is inserted without having to manually retrieve the key values each time.  So when inserting a post, instead of this, where the &lt;tt&gt;id&lt;/tt&gt; property must be set manually:

&lt;code&gt;
 $record = new QueryRecord(/* post field data */);
 $record-&gt;insert('posts');
 $record-&gt;id = DB::last_insert_id();
 $record-&gt;title = 'new title';
 $record-&gt;update('post', array('id'));
&lt;/code&gt;

You would simply call this:

&lt;code&gt;
 $post = new Post(/* post field data*/);
 $post-&gt;insert();
 $post-&gt;title = 'new title';
 $post-&gt;update();
&lt;/code&gt;

It's not that the assignment doesn't need to be made at all, but that it takes place in the Post class (which extends QueryRecord) so that you need not repeat it whenever you insert a new post.

Please review the documentation for the classes that extend QueryRecord for the details of functionality that they provide beyond QueryRecord itself.


QueryRecord provides the following:
* [http://us.php.net/manual/en/language.oop5.overloading.php overloaded] __get(), __set() and __isset()
* exclude_fields() and list_excluded_fields(), for identifying properties handled exclusively by the database
* insert(), for adding data to the database
* to_array(), to permit array operations on the object (like &lt;code&gt;foreach&lt;/code&gt;)
* get_url_args(), which returns an array of the values represented by the object
* update(), for recording modified values to the database
* delete(), for deleting an item from the database

{{developer}}

[[Category:Manual]]</pre>
</div>
<div title="Code Submisson" modifier="michaeltwofish" modified="200805241224" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>Contributions to the Habari codebase made by the wider community are incredibly important. This page describes the process that developers should follow to submit code to Habari.

== Editing the Code ==
First, you must [[Installation#Downloading_Habari|download the source code]] from SVN.

Then, following the [[Coding Standards]], make your changes to the code.

Next, create an appropriately named patch file of the changes you have made. For example, if you have made code changes to the file ''filename.php'' at revision 1701, you could run the command &lt;pre&gt; svn diff filename.php &gt; filename.php.r1701.diff &lt;/pre&gt;

Then, attach your .diff file to the appropriate issue in the [http://trac.habariproject.org/habari issue tracker].

Other users will then be able to apply your patch to test its compatibility with other configurations, and once tested and approved a comitter will then be able to apply your patch to the code to become a part of Habari.

{{developer}}

[[Category:Manual]]</pre>
</div>
<div title="Coding Standards" modifier="blakej" modified="200806231617" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>These are the Coding Standards for Habari:

*Use tabs instead of spaces for indentation
*for functions and classes, the opening brace { should be on its own line
*conditionals have the opening brace on the same line: &lt;code&gt;if ( foo == bar ) {&lt;/code&gt;
*on an else condition, closing brace on new line, else and opening brace on same line: &lt;code&gt;} ''[line break]'' else {&lt;/code&gt;
*Classes are named like so: &lt;code&gt;ClassName&lt;/code&gt; ''[http://en.wikipedia.org/wiki/UpperCamelCase UpperCamelCase]''
*Variables are named with underscores: &lt;code&gt;variable_name&lt;/code&gt;
*spaces inside parentheses and operators: ( parentheses ), &lt;code&gt;foo == bar&lt;/code&gt;
*spaces before and after assignment: &lt;code&gt;$foo = bar&lt;/code&gt;
*Single line comments should use the // comment format; multi-line comments should use the /* */ format
*Calls through the DB class should use the brace syntax for table names: &lt;code&gt;DB::query( 'SELECT * FROM {table}' );&lt;/code&gt;
*Where HTML and PHP is mixed in templates, [http://au.php.net/alternative_syntax| PHP's alternative control syntax] should be used.

{{developer}}

[[Category:Manual]]</pre>
</div>
<div title="Creating a Custom Theme" modifier="michaeltwofish" modified="200805190107" created="200807242317" tags="Category:Theming Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>Habari supports a powerful and flexible way to create custom themes, and this article describes in detail how to create one. A good way to get started is to use the default K2 theme or one of the other [[Available Themes|available themes]] as a reference. Create a new directory in &lt;code&gt;/user/themes/&lt;/code&gt; for your new theme, and put all of your theme files in this directory. The minimum requirement for a theme is an XML file that describes the theme, and some template files, with a minimum of the &lt;code&gt;home.php&lt;/code&gt; template. Themes may also optionally&amp;#151;and almost always will&amp;#151;include a file called &lt;code&gt;theme.php&lt;/code&gt;, which is used to customise theme behaviour.  Themes may also include a screen shot to be shown on the Admin | Themes page.  The screen shot should be in png, jpg, or gif format, and be 150px high by 200px wide for optimal display (or some 3:4 ratio, as the image will be resized to those dimensions).  The screen shot should be named &lt;code&gt;screenshot.file_type&lt;/code&gt;, i.e., &lt;code&gt;screenshot.png&lt;/code&gt;.

==theme.xml==
The first step in creating a custom theme is to define it's basic properties in &lt;code&gt;theme.xml&lt;/code&gt; within the theme's base directory. These properties will be used to identify the theme to users, give you credit, and appropriately version the theme through its life.

{| class=&quot;wikitable&quot;
|-
| 
! Description
|-
! &lt;name&gt;&lt;/name&gt;
| The name of the theme.
|-
! &lt;author&gt;&lt;/author&gt;
| Author's name or whomever is being credited with the design.
|-
! &lt;url&gt;&lt;/url&gt;
| Location at which the theme can be found.
|-
! &lt;version&gt;&lt;/version&gt;
| Current version of the template
|-
! &lt;template_engine&gt;&lt;/template_engine&gt;
| The template engine that the theme uses.
|}

===Example theme.xml===
&lt;code lang=&quot;xml&quot;&gt;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;theme&gt;
        &lt;name&gt;K2&lt;/name&gt;
        &lt;author&gt;K2 Team&lt;/author&gt;
        &lt;url&gt;http://getk2.com/&lt;/url&gt;
        &lt;version&gt;1.0&lt;/version&gt;
        &lt;template_engine&gt;rawphpengine&lt;/template_engine&gt;
&lt;/theme&gt;&lt;/code&gt;

You can now visit your Admin -&gt; Themes page and activate your new theme, however, if you visit your site you will be presented with a blank page. This is because as yet there are no templates, so Habari does not know how to display anything. 

==theme.php==
This optional file can be part of your theme.  By including it, you can provide additional functionality to your theme.  If you do not include it, the core theme functions will be used.

The &lt;code&gt;theme.php&lt;/code&gt; file should contain a class that extends Habari's own &lt;code&gt;Theme&lt;/code&gt; class. This class can be used to override Habari's default behaviour and to define functions that your theme can call. For example, you might define a function to format tags in a particular way. See [[Customizing Theme Behavior]] for more information.

The instance of your custom theme class &amp;#151; or the default theme if you have not defined your own &amp;#151; is available in your theme as the &lt;code&gt;$theme&lt;/code&gt; variable. Thus, functions you define in your theme class can be called as &lt;code&gt;$theme-&gt;my_function()&lt;/code&gt;.

A custom theme class has all of the same abilities as a plugin.  If you add functions in the theme class that use the plugin prefixes (&lt;tt&gt;filter_&lt;/tt&gt;, &lt;tt&gt;action_&lt;/tt&gt;, etc.), Habari will treat them as though they were in an active plugin.  Only the current theme's theme class will have functions like this enabled.

==Template Files==
Habari has flexible template support, allowing you to customise any aspect of a how a blog is displayed. The way that the templates are processed is dependent on the template engine being used. Currently Habari supports &lt;code&gt;rawphpengine&lt;/code&gt;, however, it is designed so that any number of other engines can be supported (Smarty and PHPTal engines are some examples of template engines that have been discussed for inclusion with Habari). More information can be found at [[Template Engines]]. 

Templates using the &lt;code&gt;rawphpengine&lt;/code&gt; are simply HTML files with embedded PHP. While you can use any code you like in your templates, you should try to keep the templates as simple as possible. Ideally, complex code should be located in &lt;code&gt;theme.php&lt;/code&gt; and the output included in variables, which you simply echo in your template. 

Most themes will include a number of different templates, each being called in different circumstances. This section will describe some of the most common template files. Note that this is far from an exhaustive list of templates recognized by Habari. In fact, Habari will use templates as specific as for a particular post id or date. See [[Template File Hierarchy]] for information on how Habari decides what template to use when displaying particular content. 

===home.php===
This template is used to display the front page of the blog. Usually, this template will display the most recent blog entries.

===single.php===
This template is used to display a single post, no matter what it's content type. A theme developer may choose not to use this template but instead have specific templates for a content type, such as &lt;code&gt;entry.single.php&lt;/code&gt;.

===multiple.php===
Similar to &lt;code&gt;single.php&lt;/code&gt;, this template is used when multiple posts are to be displayed, no matter what the content type. This means that this template might be displaying entries and pages on the same page. Again, a theme developer may choose not to include this template but to use specific templates, such as &lt;code&gt;entry.multiple.php&lt;/code&gt;.

===tag.php===
The &lt;code&gt;tag.php&lt;/code&gt; template is used for displaying queries for a specific tag.  By default, using the &lt;code&gt;$post-&gt;tags_out&lt;/code&gt; variable, tags are linked to display such a query.

===search.php===
The &lt;code&gt;search.php&lt;/code&gt; template is used when displaying the results of a search. As with &lt;code&gt;multiple.php&lt;/code&gt;, posts may be any content type, so this template will display a mixture of entries and pages on the same page.

===404.php===
The &lt;code&gt;404.php&lt;/code&gt; template is used as a fall back when attempting to serve a post or page that the site can not find.  The template can contain any type of information, including calling a search form, a list of tags, or simply a message notifying the visitor that they've reached a bad URL.

===login.php===
The &lt;code&gt;login.php&lt;/code&gt; template is an option for themers to add if they want to customize the login screen for registered users to match the active theme.  Depending on the theme design, this template can either call an internal template &lt;code&gt;loginform.php&lt;/code&gt; or contain the code directly, depending if the designer wants the login in multiple locations. If no &lt;code&gt;login.php&lt;/code&gt; template is provided, Habari uses a default login screen.

===Internal Templates===
Themes can also include internal templates for common code that are never called directly by Habari. For example, if your theme has a sidebar that should be displayed on every page, you could have a template called &lt;code&gt;sidebar.php&lt;/code&gt;. You can simply call &lt;code&gt;include sidebar.php&lt;/code&gt; in the appropriate place in each template to display the sidebar, however, the ideal way to include these ancillary templates would be to use &lt;code&gt; $theme-&gt;display ('sidebar'); &lt;/code&gt; or what ever template it is you are looking to include.  This allows for plugins to do things with the template that a regular include would not.  Other examples templates that your theme might include are templates for the header and footer.  Other common internal templates would be &lt;code&gt;searchform.php&lt;/code&gt;, &lt;code&gt;commentform.php&lt;/code&gt; and the aforementioned &lt;code&gt;loginform.php&lt;/code&gt;.

==Plugin Output==
It's likely that you'll want your theme to display output from [[Plugins|plugins]], if those plugins are active. Habari provides a number of ways of doing this. If the plugin outputs content directly, you can check if the plugin is loaded and use that data in your template. Checking that a particular plugin is loaded is simple, and is illustrated here by checking if the pingback plugin is active. (A more [[Plugins#Checking_for_Plugins_in_Themes|complete example]] demonstrating the active condtion).  The &lt;code&gt;is_loaded()&lt;/code&gt; function can also take a second parameter that specifies a particular version of the plugin.
&lt;code lang=&quot;php&quot;&gt;&lt;?php Plugins::is_loaded('pingback'); ?&gt;&lt;/code&gt;

Alternatively, and a better way of doing this is to use theme functions. These are special functions that let theme developers safely insert content returned by plugins, meaning, if the function is in a theme template, and the plugin is not active, nothing will out put and the theme will ignore the function. More detail can be found under [[Theme Functions]].

==Variables Available to Custom Themes==
In addition to the &lt;code&gt;$theme&lt;/code&gt; variable that holds a reference to the theme, other variables available to theme developers are described in the table below. 

{| class=&quot;wikitable&quot; style=&quot;text-align: left&quot;
! Variable  !! Description
|-
|$template
| The name of the template Habari has chosen for display.
|-
| $template_file
| The full path to the template Habari is using for display.
|-
| $matched_rule
| An object representing the rewrite rule that was matched to transform the requested URL.
|-
| $request
| An object representing the original request.
|-
| $posts
| An object that holds the posts that are available for display. Individual post objects can be accessed through this variable.
|-
| $page
| The current number being displayed. For example, if multiple posts have been returned in response to a request, these may be spread across several pages.
|}

[[Category:Theming]]
[[Category:Manual]]</pre>
</div>
<div title="Creating_A_Plugin" modifier="habari" modified="200710161723" created="200710132108" tags="MediaWikiFormat" changecount="2">
<pre>Writing a plugin in Habari is dirt-simple.

First, have in mind the idea for your plugin, and what you might like to call it, then proceed with the steps below.

== Step 1: Create The Plugin Class File ==

Create a new directory in your &lt;tt&gt;/user/plugins&lt;/tt&gt; directory that uses the name of your plugin.  As an example, you could create: &lt;tt&gt;/user/plugins/mysample&lt;/tt&gt;

In that directory, create a php file that contains the name of your plugin (the same as the directory) plus &lt;tt&gt;.plugin.php&lt;/tt&gt; added to the end.  For our example, we would create:  &lt;tt&gt;/user/plugins/mysample/mysample.plugin.php&lt;/tt&gt;

== Step 2: Create the Base Plugin Class == 

All plugins in Habari should be created as a class.  This allows the system to easily find and register your plugin.  The class you create must extend the core &lt;tt&gt;Plugin&lt;/tt&gt; class:

&lt;pre&gt;class MyPlugin extends Plugin
 {
   function info()
   {
     return array(
       'url'=&gt;'http://habariproject.org',
       'name'=&gt;'My Plugin',
       'license'=&gt;'Apache License 2.0',
       'author'=&gt;'Owen Winkler',
       'version'=&gt;'1.0',
     );
   }
 }&lt;/pre&gt;

The &lt;tt&gt;info()&lt;/tt&gt; member of the plugin is _required_.  It indicates the basic plugin information.  If you want your plugin to appear properly in Habari's list of plugins in the admin, then you need to provide these fields at a minimum:

;name: The name of the plugin as it will appear in the admin console.
;url: The URL location of your plugin.  This will be used to create a link to your plugin from the admin console.
;license: The distribution license of your plugin.
;author: The name of the author of your plugin.  (Your name!)
;version: The version of your plugin.  It is important that this version number be compatible with PHP's [http://php.net/version_compare version_compare()] function if you want your plugin to be compatible with the habariproject.org update beacon.

You should not create an instance of your plugin (&lt;tt&gt;$foo = new MyPlugin()&lt;/tt&gt;) within your plugin class file.  Habari will find your plugin and create an instance of it for you when your plugin is activated.  It is able to do this because your plugin extends the core &lt;tt&gt;Plugin&lt;/tt&gt; class.  (If your plugin requires a separate class, Habari won't create an instance of it, because it wouldn't extend &lt;tt&gt;Plugin&lt;/tt&gt;.)

== Step 3: Add Actions and Filters ==

The plugin system in Habari works based on Actions and Filters.

An Action occurs when a certain event in the software takes place.  This could happen when a post is saved or displayed.  An Action does not allow you to change the values that are passed to it.  It simply notifies you that the event has taken place.

A Filter is processed in the software when you should be allowed to change data that will be used by the system.  This could happen when a comment is submitted and the &quot;spamminess&quot; of the comment needs to be returned.  The value that is returned from a filter is passed to subsequent filters as the first parameter, and eventually used as the value for the filtered item.

Each action or filter has a name called a &quot;hook name&quot;.  A plugin &quot;hook&quot; is the place in the code where plugin code is executed.  A plugin &quot;sink&quot; is one of the actual functions that gets executed when the plugin hook code is run.  The methods in your plugin class are &quot;sinks&quot;.

Creating sinks that are activated for specific hooks is as simple as adding a method to your class with the appropriate name.

=== Action Example ===

Assume that you want your plugin to perform a task whenever the system has finished loading all plugins.  The hook name of this hook is &lt;tt&gt;plugins_loaded&lt;/tt&gt;.  &lt;tt&gt;plugins_loaded&lt;/tt&gt; is an action.

To sink this action, create a new method in your plugin like so:

&lt;pre&gt;function action_plugins_loaded()
 {
   Utils::debug('Hello!');
 }&lt;/pre&gt;

The prefix of &lt;tt&gt;action_&lt;/tt&gt; in your function name tells Habari that you are creating a sink for an action.  The &lt;tt&gt;plugins_loaded&lt;/tt&gt; part of the function name tells Habari what hook you want to sink.

When you activate the plugin with this function in it, you should see the &quot;Hello!&quot; message from inside the pink debug box.  This is executed immediately after all active plugins are loaded.

Some actions will pass values to the sink methods.  These values can be checked and acted upon.

=== Filter Example ===

Assume that you want your plugin to check on the spamminess of a comment.  The hook name of a hook that will do this is &lt;tt&gt;spam_filter&lt;/tt&gt;.  &lt;tt&gt;spam_filter&lt;/tt&gt; is a filter.

To sink this filter, create a new method in your plugin like so:

&lt;pre&gt;function filter_spam_filter($rating, $comment, $handler_vars)
 {
   if( strpos( $comment-&gt;content, 'viagra' ) ) {
     $rating++;
   }
   return $rating;
 }&lt;/pre&gt;

The prefix of &lt;tt&gt;filter_&lt;/tt&gt; in your function name tells Habari that you are creating a sink for a filter.  The &lt;tt&gt;spam_filter&lt;/tt&gt; part of the function name tells Habari what hook you want to sink.

When you activate the plugin with this method, Habari will pass every submitted comment through it.  The function looks for the word &quot;viagra&quot; in the content of the comment, and upon finding it, increases the spam rating of the comment.  

Finally, the rating is returned for use by the next plugin, and by the system.  Note that even when no adjustment is made to the value of &lt;tt&gt;$rating&lt;/tt&gt;, &lt;tt&gt;$rating&lt;/tt&gt; *must* be returned, otherwise the system will not have a value to process.

In this sink method, the &lt;tt&gt;$handler_vars&lt;/tt&gt; parameter is provided to the method by the system, but it is not used by the method.  This parameter could have been omitted in the method declaration, but it might be useful to leave it there for future use.

=== XMLRPC Example ===

Implementing XMLRPC via plugins is very easy by use of a special prefix for a plugin function.

&lt;pre&gt;function xmlrpc_namespace__function($param1, $param2, ...);&lt;/pre&gt;

A hook implemented in this way uses the &quot;namespace&quot; part of the hook name as the XMLRPC namespace, and the &quot;function&quot; part as the XMLRPC function.  The two are separated by two underscore characters.

Values passed from to this hook function are those interpreted by processing the incoming values posted to Habari's XMLRPC endpoint.

To return a properly formatted XMLRPC value, simply return a standard PHP data type.  This will be converted into a proper XMLRPC response by the plugin system.

== Step 4: Common Plugin Tasks ==

The previous three steps provide instructions for constructing the basic structure of a Habari plugin.  With that knowledge, leveraging the many plugin hooks is a simple task.

What follows are a few things that are common tasks when creating a plugin.

=== Add Output to a Theme ===

So, you have created your killer plugin and want to provide theme developers a chance to show off your work.  Based on the action example above, you can do something like this:

&lt;pre&gt;function action_add_template_vars( $theme ) {
 {
   $theme-&gt;yourvariable= 'Sweet Plugin Output';
 }&lt;/pre&gt;

This makes &lt;tt&gt;$yourvariable&lt;/tt&gt; available in the theme, where you can do something like 

&lt;pre&gt;&lt;?php echo $yourvariable ?&gt;&lt;/pre&gt;

and that will output the value directly in the theme template file.


=== Use FormUI to Create an Options Page ===

Adding an options control to your plugin is also very easy, and most users will be more comfortable with setting the options via the admin panel than editing the plugins code directly. Thankfully Habari provides a mechanism called FormUI that enables plugin developers to quickly create their own option controls.

The basic structure that needs to be added to the plugin, is as follows:
&lt;pre&gt;public function filter_plugin_config( $actions, $plugin_id )
        {
                if ( $plugin_id == $this-&gt;plugin_id() ) {
                        $actions[] = _t('Configure');
                }
                return $actions;
        }&lt;/pre&gt;
The _t() function translates the string into the language used by the site.  For English-language blogs, the output would be &quot;Configure&quot;, while for Spanish-language blogs, for example, the output might be &quot;Configurar&quot;.
The _e() function echoes a translated string for display.
&lt;pre&gt;public function action_plugin_ui( $plugin_id, $action )
        {
                if ( $plugin_id == $this-&gt;plugin_id() ) {
                        switch ( $action ) {
                                case _t('Configure') :
                                        $ui = new FormUI( strtolower( get_class( $this ) ) );
                                        $customvalue= $ui-&gt;add( 'text', 'customvalue', _t('Your custom value:') );
                                        $ui-&gt;on_success( array( $this, 'updated_config' ) );
                                        $ui-&gt;out();
                                break;
                        }
                }
        }&lt;/pre&gt;
&lt;pre&gt;public function updated_config( $ui )
        {
                return true;
        }&lt;/pre&gt;

The first function &lt;tt&gt;filter_plugin_config&lt;/tt&gt; enables a simple configure link for the plugin, on the Plugin Administration page.
&lt;tt&gt;action_plugin_ui&lt;/tt&gt; adds the form controls, in this example a text field called &lt;tt&gt;customvalue&lt;/tt&gt; is added.
&lt;tt&gt;updated_config&lt;/tt&gt; returns true if the data in the field has been updated.

Now, if you want to read the value of the variable have defined, all you have to do is call &lt;tt&gt;Options::get( 'myplugin:customvalue' );&lt;/tt&gt; and build your logic around the value it returns.

=== Change the Priority of Execution for Your Plugin ===

Sometimes you want your implementation of a plugin hook to execute before certain core hooks or other plugins' implementations.  To do this, you need to set the priority of your hooks.

By default, the priority of every hook in your plugin is 8.  Hooks with a lower priority execute sooner.

To set the priority of one of your hooks, add the method &lt;tt&gt;set_priorities()&lt;/tt&gt; in your plugin class.  Have it return an associative array using the full function name of the hook (including the 'filter_' or 'action_' prefix) as the key and the priority integer as the value.

&lt;pre&gt;function set_priorities()
 {
   return array(
     'action_add_template_vars' =&gt; 10,
   );
 }&lt;/pre&gt;

Habari will process this function for priorities, and use them to order the execution of plugin hooks.
</pre>
</div>
<div title="Customizing Theme Behavior" modifier="Massimiliano" modified="200802022117" created="200803130446" tags="Category:Asides Category:Theming" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="1198">
<pre>In addition to the ability of using custom templates to display output for particular requests, Habari allows customization of the code that controls which templates are called for display and what values are passed to them.

To accomplish this, Habari attempts to load a &lt;tt&gt;theme.php&lt;/tt&gt; file located in the theme directory.  If this file is present, it is included in the code before the theme is rendered for any incoming request.

To override the core behavior for themes (defined in &lt;tt&gt;/system/classes/theme.php&lt;/tt&gt;), define a new class structure in the theme's &lt;tt&gt;theme.php&lt;/tt&gt; that extends the core &lt;tt&gt;Theme&lt;/tt&gt; class.  

Consider this custom class:

&lt;source lang=&quot;php&quot;&gt;
// Set a custom theme to use for all public page (UserThemeHandler) theme output
define('THEME_CLASS', 'CustomTheme');

/**
 * A custom theme class
 * Custom themes are not required for themes, but they are handy in letting you 
 * define your own output data and possibly even additional, non-standard templates.
 **/   
class CustomTheme extends Theme
{

	/**
	 * Override Theme::display_posts() to provide alternate post display behavior
	 **/	 	 	
	public function act_display_posts()
	{
		parent::act_display_posts();
	}

	/**
	 * Add Theme::act_display_mine() to provide new, custom display behavior
	 **/	 	 	
	public function act_display_mine()
	{
		parent::act_display_posts();
	}

}
&lt;/source&gt;

This class defines two custom functions for output.  Both of these functions would be executed based on the action field value set for the &lt;tt&gt;rewrite_rules&lt;/tt&gt; record that matches an incoming URL request.

[[Category:Asides]]
[[Category:Theming]]</pre>
</div>
<div title="Database Schema" modifier="rickc" modified="200807241406" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>=Tables=
''Note: The schema below applies to revision 2230''
==commentinfo==
* comment_id (Primary)
* name (Primary)
* type
* value

==comments==
*id (Primary)
*post_id
*name
*email
*url
*ip
*content
*status
*date
*type

==crontab==
*cron_id (Priamary)
*name
*callback
*last_run
*increment
*next_run
*start_time
*end_time
*result
*notify
*cron_class
*description

==groups==
*id (Primary)
*name

==groups_permissions==
*id (Primary)
*group_id
*permission_id
*denied

==log==
*id (Primary)
*user_id
*type_id
*severity_id
*message
*data
*timestamp
*ip

==log_types==
*id (Primary)
*module
*type

==options==
*name (Priamry)
*type
*value

==permissions==
*id (Primary)
*name
*description

==postinfo==
*post_id (Priamry)
*name (Priamry)
*type
*value

==posts==
*id (Primary
*slug
*content_type
*title
*guid
*content
*cached_content
*user_id
*status
*pubdate
*updated

==poststatus==
*id (Primary)
*name
*internal

==posttype==
*id (Primary)
*name
*active

==rewrite_rules==
*rule_id (Primary)
*name
*parse_regex
*build_str
*handler
*action
*priority
*is_active
*rule_class
*description

==sessions==
*token
*subnet
*expires
*ua
*user_id
*data

==tag2post==
*tag_id (Primary)
*post_id (Primary)

==tags==
*id (Primary)
*tag_text
*tag_slug

==userinfo==
* user_id (Primary)
* name (Primary)
* type
* value

==users==
*id (Primary)
*username
*email
*password (SHA512 encrypted

==users_groups==
id (Primary)
user_id
group_id

=Notes and Questions=
''Please delete any of the below if/when obsolete. Please use the user groups to submit any further comments.

*Does it make sense not to use AUTO_INCREMENT IDs and instead index by what is most often looked up?
*Uing GMT for all timestamps?
*what values should we support for &quot;status&quot;?
**public
**private
**draft

*Could just create new users per comment author with no permissions and join the tables.
** RCB: +1
** SDM: -1 :This would potentially create a LOT of &quot;users&quot;, especially when one posts a popular / controversial item that generates a lot of comments.  Chris' idea below is an appealing solution.
** CJD: As an alternative, we can periodically (or on comment creation) check the number of comments from the author and if it hits a certain threshhold, we create an account and give them karma?
*chris: I would like to have tracks and pings seperated out from comments, since they are not the same thing.  I am not sure if that should be through splitting them out to a new table, or using some kind of type decleration.

{{developer}}

[[Category:Manual]]</pre>
</div>
<div title="Debugging Tips" modifier="rickc" modified="200807241309" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>Habari provides some features that allow you to better debug things when problems arise.  Here are some tips that will help speed your progress.

==Debug Mode==

Normally, Habari runs in a silent mode, where error details are not displayed.  This protects your site's code and data from potential exposure if problems arise.

Habari has a &quot;debug mode&quot; that will cause the error details to be displayed with any error.

To enable this mode, edit the config.php file for your site and add this line:

&lt;code language=&quot;php&quot;&gt;
define('DEBUG', true);
&lt;/code&gt;

Any error that occurs will have a complete call stack displayed, which is very useful for tracing execution through the code that led to the error.

==Utils::debug==

When tracing through the Habari source code, sometimes it's useful to display the value of a variable at a certain place in execution.  Normally, you might use the PHP command &lt;tt&gt;print_r()&lt;/tt&gt; to output this information, but without some extra markup, this may cause some formatting issues, and doesn't provide all of the information that might be useful for debugging.

Instead, Habari provides the &lt;tt&gt;Utils::debug&lt;/tt&gt; command, which produces output like &lt;tt&gt;print_r()&lt;/tt&gt;, but formats it nicely and provides a call stack.  The call stack can be expanded to show the functions that were executed to arrive at that point in code.  Each of the functions displayed also shows the parameter types passed to that function, and if you click on them they will toggle, revealing the parameter values.

To call &lt;tt&gt;Utils::debug()&lt;/tt&gt;, you may pass zero or more parameters, the values of each will appear in the output along with their type information:

&lt;code language=&quot;php&quot;&gt;
Utils::debug($foo, $bar, $baz);
&lt;/code&gt;

[[Category:Manual]]</pre>
</div>
<div title="DefaultTiddlers" modifier="miklb" modified="200707302054" created="200703132340" server.type="file" server.host="file:///Users/blogworks/Sites/MyHabari/Docs/Habari_Manual.20070916.0135310976.html" server.page.revision="200707302054">
<pre>[[Introduction]]

</pre>
</div>
<div title="Desktop Blogging" modifier="rickc" modified="200807201500" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>Many clients exist to allow you to edit your blog and post new content from your desktop without having to interact with the admin interface. They also provide a backup of your posts in case you have a server problem. Habari supports [http://en.wikipedia.org/wiki/Atom_(standard) Atom Publishing Protocol] by default, and with a MetaWeblog plugin, most desktop blogging clients should be able to post to Habari. The XMLRPC entry point should be specified as &lt;nowiki&gt;'http://&lt;site&gt;/xmlrpc'.&lt;/nowiki&gt;

Consult the following chart to determine which clients will work best.

{| class=&quot;wikitable&quot; border=&quot;1&quot; cellspacing=&quot;0&quot; cellpadding=&quot;5&quot;
|-
! Client Name
! OS
! Protocol Support
! Create Posts
! Edit Posts
! Delete Posts
! Tags Supported
|-
| [http://www.red-sweater.com/marsedit/ MarsEdit]
| OSX
| MetaWeblog
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ddffdd&quot; |
|-
| [http://www.scribefire.com/ ScribeFire]
| Firefox
| MetaWeblog
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ffdddd&quot; | no
|-
| [http://infinite-sushi.com/software/ecto/ Ecto]
| OSX
| MetaWeblog
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ddffdd&quot; |
|-
| [http://infinite-sushi.com/software/ecto/ Ecto]
| Windows
| *
| *
| *
| *
| *
|-
| [http://www.codingrobots.com/blogjet/ BlogJet]
| Windows
| MetaWeblog
| style=&quot;background-color:#ffdddd&quot; | no
| style=&quot;background-color:#ffdddd&quot; | no
| style=&quot;background-color:#ffdddd&quot; | no
| style=&quot;background-color:#ffdddd&quot; |
|-
| [http://www.anconia.com/rocketpost/demo/ RocketPost]
| Windows
| MetaWeblog
| style=&quot;background-color:#ffdddd&quot; | no
| style=&quot;background-color:#ffdddd&quot; | no
| style=&quot;background-color:#ffdddd&quot; | no
| style=&quot;background-color:#ffdddd&quot; |
|-
| [http://get.live.com/betas/writer_betas Windows Live Writer]
| Windows
| MetaWeblog
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ddffdd&quot; | yes
|-
| [http://www.qumana.com/ Qumana]
| OSX
| MetaWeblog
| style=&quot;background-color:#ffdddd&quot; | no
| style=&quot;background-color:#ffdddd&quot; | no
| style=&quot;background-color:#ffdddd&quot; | no
| style=&quot;background-color:#ffdddd&quot; |
|-
| [http://homepage.mac.com/dschimpf/ MacJournal]
| OSX
| Atom
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ffdddd&quot; | no
| style=&quot;background-color:#ffdddd&quot; |
|-
| [http://docs.google.com/ Google Docs]
| Web
| MetaWeblog
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ffdddd&quot; | no
| style=&quot;background-color:#ffdddd&quot; | no
| style=&quot;background-color:#ffdddd&quot; |
|-
| [http://options.wordpress.com/2006/01/08/dotpost/ DotPost]
| Windows
| MetaWeblog
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ffdddd&quot; | no
| style=&quot;background-color:#ffdddd&quot; | no
| style=&quot;background-color:#ffdddd&quot; |
|-
| [http://wbloggar.com/ w.bloggar]
| Windows
| MetaWeblog
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ddffdd&quot; | yes
| style=&quot;background-color:#ddffdd&quot; | yes
|}

[[Category:Manual]]</pre>
</div>
<div title="Developer Introduction" modifier="rickc" modified="200807240402" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>This page should be the main index to learning about '''Habari''' internals, plugin development, etc.

* [[Debugging Tips]]: Some tips for getting started with debugging in Habari.
* [[QueryRecord]]: The building block of Habari.
* [[Coding Standards]]: Generally accepted practice within the project.
* [[CSS Coding Standards]]: Generally accepted CSS practice within the project (suggestion).
* [[Habari Workflow]] : How Habari processes requests.
* [[Code Submisson]] : How to submit code and patches for Habari.
* [[Habari Classes]] : An overview of the main object classes used by Habari.
* [[Multisite]] : How multi-site configurations work in Habari.
* [[User Overrides]] : How to use the `/user/classes` and `/user/themes` directories to override core Habari functionality.
* [[Plugin Hooks]] : A list of available hooks for your plugins.
* [[Creating_A_Plugin|Creating A Plugin]] : A tutorial on Habari Plugin architecture.
* [[Rewrite Tutorial]] : How to construct rewrite rules for Habari.
* [[Database Schema]] : Structure of the Habari Database.
* [[Stack Class]]: The Stack class allows a developer to create a &quot;stack&quot; of items for later output.
* [[Managing Media]]: How Habari helps developers manage media from a variety of sources.
* [[Monolith Human Interface Guide]]: How to approach the further development of the administration interface and its intended use.

[[Category:Manual]]</pre>
</div>
<div title="FAQ" modifier="YourName" modified="200807250350" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined" changecount="1">
<pre>= Project Questions =
==What does &quot;habari&quot; mean?==
[http://www.kamusiproject.org/cgi-bin/lookup.cgi?Word=habari&amp;EngP=0 &quot;Habari&quot;] is a [http://en.wikipedia.org/wiki/Swahili Swahili] word that means &quot;what's the news?&quot;  It's similar to the English &quot;What's up?&quot; or the Spanish &quot;¿Qué pasa?&quot;  The typical response is &quot;nzuri sana&quot;, which means &quot;very good.&quot;


==How is this different from the eleventy billion other blog packages?==
It's true that there are tons of blogging software solutions from which to choose.  Each has their place, and their legion of ardent followers.

Habari is being written with a firm understanding of the current state of blogging.  Most other blogging packages have been around long enough that their responses to things like comment spam and Digg site overloads are bolted on after the fact; whereas Habari is being written from the beginning to take these things -- and more -- into account.

Habari strongly favors open, standard, and documented protocols.  Atom, being both open and documented, is the prefered syndication format, and the Atom Publishing Protocol is the prefered means of remote communication with your site.  This is a core feature, and not a plugin.

Habari is being written specifically for modern web hosting environments, and uses modern object-oriented programming techniques.  Using these recent but well-established additions to the PHP language allows Habari to make use of PDO, enabling prepared statements for all interactions with the database.  This greatly reduces the system's vulnerability to SQL injection attacks.  This is just one of many benefits of modern object-oriented techniques.

Those are just a few of the technical differences, but a major component of what makes Habari different is its community participation model.  Users who demonstrate a consistent level of quality contributions to the project are granted more privileges within the project.


==Why not fork an existing project?==
None of the packages we've tried have really satisfied us, so in the fine tradition of open source software we're trying to scratch our own itch.  

To be sure, there's a lot that many blog packages do right, and we'd be foolish to re-invent the wheel simply to be different.  But many existing blog packages have made fundamental decisions that limit what can be done, or how, with the system.  Rather than try to work around those limitations, or try to remove what's broken, we'd prefer to start fresh and import those ideas that are good.


==How is Habari licensed?==
Habari uses a modified version of the Apache License (http://www.apache.org/licenses/LICENSE-2.0). For those unfamiliar with this license, the [http://www.apache.org/foundation/licence-FAQ.html Apache License FAQ page] should answer most of your questions.

Developers contributing to the Habari project itself should note that, unless explicitly stated otherwise, any contribution intentionally submitted for inclusion shall be under the terms and conditions of the Habari license, without any additional terms or conditions. However, plugins and themes designed to work with Habari are not required to have the same license as Habari itself.

You can find our license included in the source, and http://svn.habariproject.org/habari/trunk/LICENSE in our code repository].


==Why HTML vs XHTML==
A consensus amongst project members concluded a thorough discussion as to the merits of the two DOC types, and what would be appropriate for the Admin pages of Habari.  The conclusion was that HTML was the &quot;proper&quot; way, however, end users are welcome to serve their pages in any way they prefer by declaring the DOC type in their theme.  A more [[XHTML_vs_HTML|comprehensive outline]] of the discussion, culled from the information in the original discussion is provided.



= Running Habari =
==Will Habari work with my web host?==
Habari should work with any web host that supports the above requirements. A list of web hosts where Habari has been tested and run successfully can be found at [[Supported Hosts]].


==What are the system requirements?==
Habari is a modern solution for blogging, and requires modern software.  To successfully use Habari, you will need:

* '''Web Server''' - ([http://httpd.apache.org/ Apache], [http://www.lighttpd.net/ lighttpd] and [http://nginx.net/ nginx] have been tested successfully
* [http://www.php.net/ '''PHP] 5.2.x or above''' - Habari ''will not'' work with PHP 4.
* [http://www.php.net/pdo PHP Data Objects] support. Depending on the database you are using, the following pdo extensions need to be enabled
**[http://www.php.net/pdo/mysql php_pdo_mysql]
**[http://www.php.net/pdo/sqlite php_pdo_sqlite]
* '''Database''' - [http://www.mysql.com/ MySQL], [http://www.postgresql.org PostgresSQL], and [http://www.sqlite.org/ SQLite] are supported
* The following extensions enabled in PHP
**[http://php.net/hash hash]
**[http://php.net/iconv iconv]
**[http://php.net/tokenizer tokenizer]
**[http://php.net/simplexml simplexml]
**[http://php.net/mbstring mbstring]

==Does Habari work with PostgreSQL?==
Yes. Support for [http://www.postgresql.org/ PostgreSQL] introduced in version 0.5 of Habari.

==Does using SQLite as my database have any special requirements?==
* SQLite is a single file database that creates temporary files in the directory which contains your database. As a result, your web server must have write access to the directory in which your database exists. If you do not designate a specific directory in your Habari configuration, the default directory in which your database file is created is the directory in which you installed Habari.

= Contributing Questions =
==How can I help?==
* Open new issues [http://trac.habariproject.org/habari/ on our issue tracker] describing problems you experience, or to request new features.
* Join the Google Group(s) in which you have the most interest, and start sharing!
** The [http://groups.google.com/group/habari-users habari-users] group is for end user support, and general discussion.
** The [http://groups.google.com/group/habari-dev habari-dev] group is for nitty-gritty implementation discussions of the code, database schemas, and the like.
** The [http://groups.google.com/group/habari-svn habari-svn] group is a way to track the development activity of the source code.  You can review the commit logs, and monitor changes as they occur.

==How do I add my code changes to the project?==

If you would like to work on a feature or bug fix, there is a best practice for getting your changes into the process.

Regardless of the type of fix/change, first create an issue in the issue tracker describing your proposed change.  Allowing the group to review your proposal could save you the time of implementing something that is being done as part of a larger task, and could gain you the insight or help of other people who are interested in what you're doing.

As you write your code, review Habari's [[Coding Standards|coding standards]] to get acquainted to how your code should be formatted.
As you prepare your changes, ask for review on the development mailing list as often as you need it.

When your changes are complete, file code changes as a diff in the issue that you're tracking, and attach any associated files.  Be sure to mention how the files are to be applied if there are any special considerations.  Your issue will be reviewed, and if suitable, will be applied in the code repository.

[[Category:Manual]]</pre>
</div>
<div title="Formatting" modifier="habari" modified="200710161724" created="200704162110" server.type="file" server.host="file:///Users/blogworks/Sites/MyHabari/Docs/Habari_Manual.20070916.0135310976.html" server.page.revision="200704162110" changecount="1">
<pre>Like most wikis, TiddlyWiki supports a range of simplified character formatting:
| !To get | !Type this |h
| ''Bold'' | {{{''Bold''}}} |
| --Strikethrough-- | {{{--Strikethrough--}}} |
| __Underline__ | {{{__Underline__}}} (that's two underline characters) |
| //Italic// | {{{//Italic//}}} |
| Superscript: 2^^3^^=8 | {{{2^^3^^=8}}} |
| Subscript: a~~ij~~ = -a~~ji~~ | {{{a~~ij~~ = -a~~ji~~}}} |
| @@highlight@@ | {{{@@highlight@@}}} |
&lt;&lt;&lt;
The highlight can also accept CSS syntax to directly style the text:
@@color:green;green coloured@@
@@background-color:#ff0000;color:#ffffff;red coloured@@
@@text-shadow:black 3px 3px 8px;font-size:18pt;display:block;margin:1em 1em 1em 1em;border:1px solid black;Access any CSS style@@
&lt;&lt;&lt;

//For backwards compatibility, the following highlight syntax is also accepted://
{{{
@@bgcolor(#ff0000):color(#ffffff):red coloured@@
}}}
@@bgcolor(#ff0000):color(#ffffff):red coloured@@</pre>
</div>
<div title="Habari Classes" modifier="rickc" modified="200805110539" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>If a class is a subheading of another class, this means that the subheaded class is an extension (or implementation) of the class (or interface) above. 

'''See also:''' [http://doc.habariproject.org/api/ Habari API Documentation]

===[[Classes/ACL|ACL]]===
The '''ACL''' class implements access control lists, and provides the foundation of Habari's permission system.

===[[Classes/ActionHandler|ActionHandler]]===

The ActionHandler class is the superclass of classes that respond to URL requests.

For example, when making a request for a user-facing theme page, the request is handled by UserThemeHandler, which extends ActionHandler.

ActionHandler contains the basic act() function required to handle incoming action requests, although this can be overridden in subclasses to implement different behavior.  In &lt;tt&gt;Controller&lt;/tt&gt;, when a &lt;tt&gt;RewriteRule&lt;/tt&gt;'s &lt;tt&gt;parse_regex&lt;/tt&gt; matches the requested URL, it creates an instance of the &lt;tt&gt;RewriteRule&lt;/tt&gt;'s indicated &lt;tt&gt;handler&lt;/tt&gt; class, and calls &lt;tt&gt;-&gt;act()&lt;/tt&gt; on that object, passing the &lt;tt&gt;RewriteRule&lt;/tt&gt;'s &lt;tt&gt;action&lt;/tt&gt; as a parameter.
==== Classes that extend ActionHandler ====
* [[Classes/AdminHandler|AdminHandler]]
* [[Classes/AjaxHandler|AjaxHandler]]
* [[Classes/AtomHandler|AtomHandler]]
* [[Classes/CronTab|CronTab]]
* [[Classes/InstallHandler|InstallHandler]]
* [[Classes/FeedbackHandler|FeedbackHandler]]
* [[Classes/ThemeHandler|ThemeHandler]]
* [[Classes/UserHandler|UserHandler]]
* [[Classes/UserThemeHandler|UserThemeHandler]]
* [[Classes/XMLRPCServer|XMLRPCServer]]

===[[Classes/ArrayObject|ArrayObject]] (built in class)===
Many objects in '''Habari''' are arrays of other objects.  In addition to being able to iterate over the members of the array, it is also often useful to perform some actions on the entire collection of member objects.  For these situations, PHP's built-in ArrayObject is extended.  The following classes all extend ArrayObject:
* [[Classes/Comments|Comments]]
* [[Classes/EventLog|EventLog]]
* [[Classes/InfoRecords|InfoRecords]]
** [[Classes/CommentInfo|CommentInfo]]
** [[Classes/InfoObject|InfoObject]]
** [[Classes/PostInfo|PostInfo]]
** [[Classes/UserInfo|UserInfo]]
* [[Classes/Posts|Posts]]
* [[Classes/RewriteRules|RewriteRules]]
* [[Classes/Tags|Tags]]
* [[Classes/UserGroups|UserGroups]]
* [[Classes/Users|Users]]

===[[Classes/Bitmask|Bitmask]]===

===[[Classes/Cache|Cache]]===
* [[Classes/FileCache|FileCache]]

===[[Classes/ColorUtils|ColorUtils]]===

===[[Classes/CronJob|CronJob]]===

===[[Classes/CronTab|CronTab]]===

===[[Classes/DatabaseConnection|DatabaseConnection]]===

===[[Classes/Error|Error]]===

===[[Classes/Exception|Exception]]===
* [[Classes/Error|Error]]
* [[Classes/XMLRPCException|XMLRPCException]]

===[[Classes/Format|Format]]===

===[[Classes/FormControl|FormControl]]===
* [[Classes/FormControlCheckbox|FormControlCheckbox]]
* [[Classes/FormControlPassword|FormControlPassword]]
* [[Classes/FormControlSelect|FormControlSelect]]
* [[Classes/FormControlStatic|FormControlStatic]]
* [[Classes/FormControlText|FormControlText]]
* [[Classes/FormControlTextArea|FormControlTextArea]]
* [[Classes/FormControlTextMulti|FormControlTextMulti]]

===[[Classes/FormUI|FormUI]]===

===[[Classes/HTMLTokenizer|HTMLTokenizer]]===

===[[Interfaces/Importer|Importer]]===

===[[Classes/InputFilter|InputFilter]]===

===[[Classes/Locale|Locale]]===

===[[Classes/Media|Media]]===

===[[Classes/MediaAsset|MediaAsset]]===

===[[Interfaces/MediaSilo|MediaSilo]]===

===[[Classes/Miscellaneous|Miscellaneous]]===

===[[Classes/Pluggable|Pluggable]]===
* [[Classes/Plugin|Plugin]]
* [[Classes/Theme|Theme]]

===[[Classes/Plugins|Plugins]]===

===[[Classes/QueryProfile|QueryProfile]]===

===[[Classes/QueryRecord|QueryRecord]]===
The QueryRecord class defines a base object that corresponds to a database table.  It has specific methods for inserting, updating, and deleting an instance of itself from the database.  
==== Classes that extend QueryRecord ====
* [[Classes/CronJob|CronJob]]
* [[Classes/Comment|Comment]]
* [[Classes/File|File]]
* [[Classes/LogEntry|LogEntry]]
* [[Classes/Post|Post]]
* [[Classes/RewriteRule|RewriteRule]]
* [[Classes/User|User]]
* [[Classes/UserGroup|UserGroup]]

===[[Classes/RemoteRequest|RemoteRequest]]===

===[[Interfaces/RequestProcessor|RequestProcessor]]===
* [[Classes/CURLRequestProcessor|CURLRequestProcessor]]
* [[Classes/SocketRequestProcessor|SocketRequestProcessor]]

===[[Classes/RPCClient|RPCClient]]===

===[[Classes/Session|Session]]===
The '''session''' class registers a [http://us3.php.net/manual/en/ref.session.php PHP session] handler to store transient data between page loads.

===[[Classes/Singleton|Singleton]]===
A [http://en.wikipedia.org/wiki/Singleton_pattern singleton] is a [http://en.wikipedia.org/wiki/Design_pattern_%28computer_science%29 design pattern] used to restrict a class from being instantiated more than once.  '''Habari''' uses the singleton pattern for a number of its classes.  For example, the Controller class, which implements the Controller in Model-View-Controller, is a singleton because there can be only one Controller driving the Model-View.  The DB class is a singleton facade: the normal execution of '''Habari''' requires only a single database instance for execution, but there are situations in which one might want to connect to a different database without having to write your own database handling routines.
* [[Classes/Controller|Controller]]
* [[Classes/DB|DB]]
* [[Classes/Options|Options]]
* [[Classes/Update|Update]]
* [[Classes/URL|URL]]

===[[Classes/Site|Site]]===
The '''site''' class is responsible for building URLs and filesystem paths of various sorts for the current site.  This class provides a unified mechanism for building URLs and paths that supports Habari's multi-site functionality.

===[[Classes/Stack|Stack]]===

===[[Classes/TemplateEngine|TemplateEngine]]===
TemplateEngine defines the mechanics of a specific templating system.  The two currently defined engines are RawPHPEngine and Smarty.  Using the RawPHPEngine, one will construct template files in a manner similar to that used by, for example, WordPress: you mix HTML and PHP code together.  Using the SmartyEngine, one will construct [http://smarty.php.net/ Smarty] template files.
* [[Classes/RawPHPEngine|RawPHPEngine]]
* [[Classes/SmartyEngine|SmartyEngine]]

===[[Classes/Themes|Themes]]===

===[[Interfaces/URLProperties|URLProperties]]===

===[[Classes/Utils|Utils]]===
The '''utils''' class is a bit of a grab-bag of handy routines that don't really fit well within other classes.

===[[Classes/UUID|UUID]]===
The '''uuid''' class provides a mechanism for producing &quot;universally unique identifiers&quot;, per [http://www.ietf.org/rfc/rfc4122.txt RFC 4122].

===[[Classes/Version|Version]]===
The '''version''' class is a small class used to record metadata about the current Habari version.  Specifically, it reports the Habari API and database version numbers.

===[[Classes/XMLRPCBinary|XMLRPCBinary]]===

===[[Classes/XMLRPCClient|XMLRPCClient]]===

===[[Classes/XMLRPCDate|XMLRPCDate]]===

===[[Classes/XMLRPCStruct|XMLRPCStruct]]===

===[[Classes/XMLRPCUtils|XMLRPCUtils]]===

 Alphabetical
{{developer}}

[[Category:Manual]]</pre>
</div>
<div title="Habari Workflow" modifier="lildude" modified="200805291914" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>''Workflow'' might be the wrong term.  This page will attempt to describe in general terms what happens when Habari receives a request from a user.  The process is basically the same for visitors (anonymous or otherwise) and users (administrators or otherwise), but each will be explained in detail for your benefit.

For the purposes of this document, we will assume that a client somewhere on the internet is accessing an instance of Habari at &lt;code&gt;&lt;nowiki&gt;http://habariproject.org/en/&lt;/nowiki&gt;&lt;/code&gt;.

==Set up==
The client computer will initiate an HTTP request to &lt;code&gt;&lt;nowiki&gt;http://habariproject.org/en/&lt;/nowiki&gt;&lt;/code&gt;.  The Habari instance on the server will accept the request. All requests begin in the same way. This section describes Habari's set up process.

===mod_rewrite===
Before Habari is ever invoked, the web server software (Apache, Lighttpd, IIS) will evaluate whether the incoming request is an actual file on the server's hard disk(s) or not.  If the request is for a specific file that does actually exist, the web server software will deliver this file to the client, and Habari will not be involved.  This happens when serving &lt;code&gt;.css&lt;/code&gt; stylesheets, for example.  This might also happen when serving media files (images, podcasts, etc).

If the client request is not for a specific file that exists on the server's hard disk(s), the web server software will pass the request on to the Habari &lt;code&gt;index.php&lt;/code&gt;.

===Version Check===
The very first thing &lt;code&gt;index.php&lt;/code&gt; does is to determine whether the version of PHP installed on the server is at least version 5.2.0 or above.  This is the absolute bare minimum version of PHP that Habari will support.

===HABARI_PATH===
Next, &lt;code&gt;index.php&lt;/code&gt; sets a constant -- &lt;code&gt;HABARI_PATH&lt;/code&gt; -- that will be used throughout the program.  This constant contains the filesystem path to the &lt;code&gt;index.php&lt;/code&gt; file.  For example, if Habari is installed at &lt;code&gt;/home/habari/public_html&lt;/code&gt;, then &lt;code&gt;HABARI_PATH&lt;/code&gt; will contain ''/home/habari/public_html''.  The &lt;code&gt;HABARI_PATH&lt;/code&gt; constant is used in many places throughout the Habari code.

===Output Buffering===
Once the constant has been set, Habari enables output buffering.  This is a process to delay sending any data to the client until such time as the server is ready to do so.  In the normal execution of a web site, content is delivered to the client directly from the server as it is read in by the server.  With output buffering, content is held on the server until the script on the server specifically tells the server to send it to the client.

===__autoload()===
The next portion of the &lt;code&gt;index.php&lt;/code&gt; defines a function, &lt;code&gt;__autoload()&lt;/code&gt;, that represents one of the fundamental building blocks of Habari.  Although it is defined here in &lt;code&gt;index.php&lt;/code&gt;, it is not executed at this time.  The [http://www.php.net/autoload __autoload()] function automatically locates and loads any PHP class files that are referenced for use within Habari.  This function looks for class files first in the Site classes directory, if it exists, and then in &lt;code&gt;HABARI_PATH/system/classes&lt;/code&gt;.  By using the &lt;code&gt;__autoload()&lt;/code&gt; function, Habari is able to dynamically load class files as they are needed, without requiring the Habari developers to pre-define every single class file and its location.

===Error Reporting===
With the &lt;code&gt;__autoload()&lt;/code&gt; function defined, Habari now sets PHP error reporting to &quot;All&quot;.  This step is primarily to aid server administrators by ensuring that sufficient diagnostic information is recorded in the web server error logs if something goes wrong.  Without this, it is often difficult to know exactly where a problem has occurred, or why.

===revert_magic_quotes_gpc()===
Next Habari invokes a function called &lt;code&gt;revert_magic_quotes_gpc()&lt;/code&gt; inside the &lt;code&gt;Utils&lt;/code&gt; class.  Because the &lt;code&gt;Utils&lt;/code&gt; class is not yet defined, the &lt;code&gt;__autoload()&lt;/code&gt; function is triggered.  &lt;code&gt;__autoload()&lt;/code&gt; searches for a file named &lt;code&gt;utils.php&lt;/code&gt; in one of several directories.  Unless you have created your own &lt;code&gt;utils.php&lt;/code&gt; file, Habari will load &lt;code&gt;HABARI_PATH/system/classes/utils.php&lt;/code&gt; and execute the &lt;code&gt;revert_magic_quotes_gpc()&lt;/code&gt; function therein.  This function undoes &quot;[http://www.php.net/magic_quotes magic quotes]&quot;.  Habari does not rely on magic quotes in the same way that many other tools do.

===config.php===
With all of that set, Habari is finally ready to load the &lt;code&gt;config.php&lt;/code&gt; file that specifies how to connect to the database.  A single installation of the Habari source code can power many sites, so there are a number of places in which the &lt;code&gt;config.php&lt;/code&gt; file might be found.  The &lt;code&gt;get_config_path()&lt;/code&gt; function in the &lt;code&gt;Site&lt;/code&gt; class determines where the correct &lt;code&gt;config.php&lt;/code&gt; file is for this invocation of Habari.  Remember, the &lt;code&gt;Site&lt;/code&gt; class will be automatically loaded by the &lt;code&gt;__autoload()&lt;/code&gt; function!

If Habari is only being used for a single site -- say a personal blog -- then the &lt;code&gt;config.php&lt;/code&gt; file should reside inside the &lt;code&gt;HABARI_PATH&lt;/code&gt; directory.  However, Habari has no immediate way of determining whether it is being used for one site or one hundred sites.  &lt;code&gt;get_config_path()&lt;/code&gt; does the following:
* defines the path to the &lt;code&gt;config.php&lt;/code&gt; as &lt;code&gt;HABARI_PATH&lt;/code&gt;, by default
* looks for the existence of any &lt;code&gt;config.php&lt;/code&gt; files inside any sub-directories of &lt;code&gt;HABARI_PATH/user/sites&lt;/code&gt;
** if none are found, return the default path of &lt;code&gt;HABARI_PATH&lt;/code&gt;
* Compare the URL used to access Habari for this request with the directories in &lt;code&gt;HABARI_PATH/user/sites&lt;/code&gt;, using the following formula:
** strip off the protocol used to access the site.  &lt;code&gt;&lt;nowiki&gt;http://habariproject.org/en/&lt;/nowiki&gt;&lt;/code&gt; becomes &lt;code&gt;//habariproject.org/en/&lt;/code&gt;
** replace all slashes with periods.  So &lt;code&gt;habariproject.org/en&lt;/code&gt; becomes &lt;code&gt;habariproject.org.en&lt;/code&gt;.
** place any non-standard HTTP port at the beginning of the directory.  So &lt;code&gt;habariproject.org/en:8080&lt;/code&gt; becomes &lt;code&gt;8080.habariproject.org.en&lt;/code&gt;
** if a match exists between the URL used for this request and a directory, return that directory.  For example, &lt;code&gt;&lt;nowiki&gt;http://habariproject.org/en/&lt;/nowiki&gt;&lt;/code&gt; matches &lt;code&gt;HABARI_PATH/user/sites/habariproject.org.en&lt;/code&gt;

===Install?===
If there is no &lt;code&gt;config.php&lt;/code&gt;, or if it is incomplete, the Habari installation process will be invoked.  If there is a valid &lt;code&gt;config.php&lt;/code&gt;, Habari will attempt to connect to the database.  If that fails, the installation process will be invoked.

===Content Type===
Habari next forcibly sets the content type to &lt;code&gt;text/html;charset=utf-8&lt;/code&gt;.

===Locale===
Habari sets the locale, which governs the language used to display Habari-generated messages.  The default locale is U.S. English.

===Plugins===
Plugins are loaded next, and the very first plugin hook is triggered.  Any plugins registered against the &lt;code&gt;plugins_loaded&lt;/code&gt; hook will be executed.  See [[Plugins]] for more information.

===Controller===
The controller ( '''C''' in MVC ([http://en.wikipedia.org/wiki/Model-view-controller model-view-controller]) &quot;[p]rocesses and responds to events, typically user actions, and may invoke changes on the model.&quot;  The controller first examines the request (&lt;code&gt;Controller::parse_request();&lt;/code&gt;).  This compares the requested URL against the list of registered actions in the &lt;code&gt;rewrite_rules&lt;/code&gt; database table.  If a match is found, the action specified in the rule is invoked against the handler specified in the rule.  For more information on rewrite rules, see the [[Rewrite Tutorial]].  The controller contains an array of &lt;code&gt;handler_vars&lt;/code&gt;, which are set by HTTP POST and GET values passed to this request, as well as any values set by plugins. Execution from this point is different, depending on which handler is invoked according to the rewrite rule matched. The following sections describe in the workflow for different handlers.

==End User Workflow==
In the event that the requested URL is simply to a public page of the blog, that is for the normal case of a user viewing the site, the handler will be UserThemeHandler.  UserThemeHandler evaluates the request (home page, single post view, date-based archive view, etc) and loads the proper theme template files.  For information on how Habari chooses which template file to use, see [[Template File Hierarchy]].  The handler will place the &lt;code&gt;handler_vars&lt;/code&gt; into the theme's global variable space.  The template files are then delivered to the viewer.

==Administrative Workflow==
For requests to the administration section of Habari, those whose path begins with &lt;code&gt;/admin&lt;/code&gt; the AdminHandler will be invoked.

===Authentication and Authorisation===
Only users with administration privileges can access pages under &lt;code&gt;/admin&lt;/code&gt;, so the first thing that AdminHandler does is check if the user is logged in, and if not redirects them to the login page. The user's privileges are then checked, and if they do not have administrative access an error message is displayed.

===Routing the request===
Once the user is authenticated and authorised, control is passed to &lt;code&gt;AdminHandler-&gt;act_admin()&lt;/code&gt; which decides where the request should be routed based on the HTTP method used (GET or POST) and the page requested (the portion of the URL following &lt;code&gt;/admin&lt;/code&gt;) to the appropriate function in &lt;code&gt;AdminHandler&lt;/code&gt;.  For example, a GET request to &lt;code&gt;/admin/publish&lt;/code&gt; will be sent to &lt;code&gt;AdminHandler-&gt;get_publish()&lt;/code&gt;, and the handler will prepare the publish page for display.

===Administration Output===
The administration section has its own theme, located in &lt;code&gt;HABARI_PATH/system/admin&lt;/code&gt;. Each of the functions in &lt;code&gt;AdminHandler&lt;/code&gt; specify which template should be used as their output, which is then output in the same way as any other theme.

==Flush Output==
The very last thing that &lt;code&gt;index.php&lt;/code&gt; does is to flush the output buffer.  Any output that has been prepared is finally sent to the browser.

{{developer}}

[[Category:Manual]]</pre>
</div>
<div title="Importing Content" modifier="rickc" modified="200807240342" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>Habari currently ships with a plugin to import posts, comments, tags (including Ultimate Tag Warrior Tags) and users from WordPress (current version confirmed to work with 2.5, mileage will vary with older versions), and Serendipity 0.9 and up. Other importers are planned.

You must first activate the plugin for the platform from which you are importing before navigating to the admin/import page.  After activating the plugin, you will get a select box to choose what type of content you are importing.

=Importing A Wordpress Database=
After choosing to import a Wordpress database, you will be prompted to fill in your WordPress database information, and choose your options for tag importation.

It is suggested you set up a separate database for your Habari install from that of your WordPress installation. The import process will be much faster and less room for error. WordPress pages should import as Habari pages, and everything else either an entry or draft.

Approved and unapproved comments will also be imported.

Note that WordPress permalinks and paths will be lost, and you should explore options with .htaccess if you are concerned with maintaining your previous links. Andrew da Silva's [http://www.habariproject.org/dist/plugins/route301.zip Route 301] plugin may help in some cases, as will Raman Ng's [http://wiki.habariproject.org/en/Available_Plugins#Raman_Ng_.28a.k.a._tinyau.29 RN Custom Permalink] plugin. Alternatively, you can set up a custom permalink scheme by adding a rewrite rule to your Habari database. Feel free to post to [http://groups.google.com/group/habari-users Habari users] if you have any questions or problems with your migration.

Note: Due to the feature of importing users, in earlier versions of Habari you could not have the same user name in your Habari install at the time of import (this can easily be changed under admin/users/ -&gt;edit, and change the name.  You can change back after importing.  Example, if your Habari install uses admin and your WordPress install uses admin, change your Habari name to admin2 for the import, and change it back after importing). '''For the 0.4 release, and as of revision 1319 this issue was resolved.'''


=Importing A Serendipity Database=

After choosing to import a Serendipity database, you will be prompted to enter the version of Serendipity you are using, '''OR''' the location of the root web directory where the Serendipity configuration file can be found to gather version information. After entering this, you will be prompted for your database connection details, whether or not to import your Serendipity categories as tags, and whether or not to import unapproved comments. Enter these details, then click the '''Process with Import''' button to procede.

As with Wordpress, your permalinks and paths will be lost. Explore the same options discussed above to maintain your previous links.

[[Category:Manual]]</pre>
</div>
<div title="Installation" modifier="YourName" modified="200807250347" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined" changecount="3">
<pre>==Before You Install==

=== Server Requirements ===
*Supported Web Server
**[http://httpd.apache.org/ Apache (1.3.x or higher, 2.x or higher recommended)] with [http://httpd.apache.org/docs/1.3/mod/mod_rewrite.html mod_rewrite] enabled
**[http://www.lighttpd.net/ Lighttpd]
**[http://www.nginx.net/ Nginx]
*Supported Database
**MySQL 4.1.x or greater
**SQLite
**PostgresSQL
*PHP version 5.2 or above with the following modules enabled
**PHP Data Objects (PDO) and the PDO driver for the database you wish to use
**SimpleXML
**Hash
**Iconv
**Mbstring
**Tokenizer
**JSON

To install habari on [http://dreamhost.com/ Dreamhost] you need to make sure that you have php5 selected when you are in the manage domains menu. If you are stuck there is a  
[http://wiki.habariproject.org/en/Installation:Dreamhost faq here.]

=== Change Permissions ===
In order to enjoy the most convenient installation process, it is required to make writable the folder where Habari will be installed.  The Habari installation process will create a &lt;tt&gt;config.php&lt;/tt&gt; file and &lt;tt&gt;.htaccess&lt;/tt&gt; file for you automatically.

If you are using a GNU/Linux (or other UNIX-like) host, you may apply the following chmod to the root folder of your Habari installation:
&lt;pre&gt;
chmod o+w .
&lt;/pre&gt;
That allows everyone to write to the Habari directory.  Specifically, the web server will use this to create the files necessary for Habari's execution.

When the installation process completes, you may remove the &quot;everyone&quot; write permission with this:
&lt;pre&gt;
chmod o-w .
&lt;/pre&gt;

==== Instructions for the paranoid ====
If the idea of giving everyone write access to your Habari directory gives you the willies, you can instead perform the following steps:
&lt;pre&gt;
touch .htaccess
touch config.php
chmod o+w .htaccess
chmod o+w config.php
&lt;/pre&gt;
This creates empty &lt;tt&gt;.htaccess&lt;/tt&gt; and &lt;tt&gt;config.php&lt;/tt&gt; files, and makes only these files world-writable.  Habari will add the necessary bits to these files.

Upon completion, you may remove the world-writable permission with these commands:
&lt;pre&gt;
chmod o-w .htaccess
chmod o-w config.php
&lt;/pre&gt;

The Habari installation process will do its best not to clobber any existing &lt;tt&gt;.htaccess&lt;/tt&gt; file that might exist.

=== Activate PHP5 ===

Some hosts may offer both PHP4 and PHP5, but execute files with the &lt;tt&gt;.php&lt;/tt&gt; extension using the PHP4 by default. You can often change this behavior by adding the following single line in the &lt;tt&gt;.htaccess&lt;/tt&gt; file found in the root folder of your Habari installation:

&lt;pre&gt;AddHandler application/x-httpd-php5 .php &lt;/pre&gt;

&lt;em&gt;Please read your host's FAQ as some hosts may require a different &lt;tt&gt;AddHandler&lt;/tt&gt;.&lt;/em&gt;

== Installing Habari ==

=== Step 1: Download and Extract ===

&lt;em&gt;As Habari is still in development, no guarantees are made that these are fully stable versions, or that updating won't break the current database structure.&lt;/em&gt;

==== Developer Release ====
* Habari is still in development, however there is a developer release [http://habariproject.org/dist/ available for download].

==== SVN Checkout ====
&lt;em&gt;In order to use SVN you will need SSH access to your server. Some hosts have it enabled by default, but others may only enable it upon request.&lt;/em&gt;

* Login to your web host.
&lt;pre&gt;ssh username@yourblog.com&lt;/pre&gt;

Your host will then ask for your host password. Put it in and you are in. 

* Change directory to the one you wish to install Habari in. &lt;em&gt;Directory name may differ.&lt;/em&gt;
&lt;pre&gt;cd ~/public_html/habari/&lt;/pre&gt;

* Checkout the source code.
&lt;pre&gt;svn checkout http://svn.habariproject.org/habari/trunk/htdocs .&lt;/pre&gt;

* If you are not in the Habari directory, use the following command to &lt;em&gt;checkout&lt;/em&gt; in a new directory called &lt;tt&gt;habari&lt;/tt&gt;.

&lt;pre&gt;svn checkout http://svn.habariproject.org/habari/trunk/htdocs habari&lt;/pre&gt;

&lt;em&gt;Reference: [[Subversion and applying patchs]]&lt;/em&gt;

===Step 2: Preparing the Database===
As mentioned, Habari requires a database from one of the supported formats.  If you are running on a professional hosting company (see [[Supported Hosts]]), chances are you either were provided with a database, or a web interface for creating a database. If that's the case, you can skip to the next step. Either way you are going to need:

* The name of the database
* The database user
* The password for that database user.

Please note that by default some third party hosts add your user name prior to these items.

===Step 3: Running the Installer===
After checking out the files, and creating your database, you are ready to run the installer.  Open your web browser and navigate to your install location, ie, &lt;tt&gt;&lt;nowiki&gt;http://example.com/habari&lt;/nowiki&gt;&lt;/tt&gt;.
You should be prompted with an installer, requiring you to choose your database type, and the necessary information to complete installation.

If the installer is not working properly, the [[Common Questions]] page has some information that may help you troubleshoot the installer.
====Database Host====
99% of the time, this is going to be &lt;tt&gt;localhost&lt;/tt&gt;, and should be the default value in the installer.  

If this is not the case, your host should have provided you with the necessary information.  For example, if your installation is to be hosted on [http://dreamhost.com/ Dreamhost], then this value will be &lt;tt&gt;mysql.yourDomain.com&lt;/tt&gt;.

====User Name====
This is the user name for the database, not your domain's user name.  If you created your database via the common C-Panel interface, remember this name is prefixed by the account, then the username, ie, &lt;tt&gt;user_dbusername&lt;/tt&gt;.
====Password====
Again, this is the database user's password, not necessarily the account password.
====Database Name====
This is the name of the database you created for your installation.  As with the user, it's possible the database name is prefixed with your domain username, ie, &lt;tt&gt;user_databasename&lt;/tt&gt;.
====Table Prefix====
&lt;tt&gt;habari__&lt;/tt&gt; is the default, however if you are using multiple instances of habari in the same database, or have your own naming conventions, you can change the prefix here.

Fill in the remaining data with the name of your blog, an admin user name and password, and a default email.  Note that these can be changed later.

Click install, and if all goes well, you should be taken to the blog's home page.  You can then log in with the admin name and password you used on the installer page, and start blogging!

If you had any problems, you can post to the [http://groups.google.com/group/habari-users Habari user group].  Be sure to provide as many details as possible, including version of PHP, MySQL, and server config.

==Advanced Installation==
This procedure outlines a way to automate the installation process by predefining the &lt;tt&gt;.config&lt;/tt&gt; file.

=== Predefined Configuration ===
Depending on your DBMS of choice, MySQL or SQLite, copy &lt;tt&gt;&lt;root&gt;/system/schema/&lt;dbms&gt;/config.php&lt;/tt&gt; to the root folder, where &lt;tt&gt;index.php&lt;/tt&gt; is.

&lt;em&gt;Modify this array definition, or similar, in the copied &lt;tt&gt;config.php&lt;/tt&gt; file.&lt;/em&gt;
&lt;pre&gt;
$blog_data= array( 'admin_username' =&gt; 'ernie',
        'admin_pass1' =&gt; 'RubberDuck',
        'admin_pass2' =&gt; 'RubberDuck',
        'admin_email' =&gt; 'ernie@www.sesamestreetlive.com'
        );
&lt;/pre&gt;

&lt;em&gt;Valid Parameters&lt;/em&gt;
&lt;pre&gt;
        'db_user' =&gt; '',
        'db_pass' =&gt; '',
        'db_schema' =&gt; 'habari',
        'connection_string' =&gt; '',
        'table_prefix' =&gt; 'habari__',
        'admin_username' =&gt; 'admin',
        'admin_pass1' =&gt; '',
        'admin_pass2' =&gt; '',
        'blog_title' =&gt; 'I love Cookies',
        'admin_email' =&gt; 'bert@www.sesamestreetlive.com', 
&lt;/pre&gt;

'''NOTE''': the password elements accept either plaintext or encrypted passwords.  We strongly recommend that you never store a plaintext password in your &lt;tt&gt;config.php&lt;/tt&gt; file.  You may use our [http://www.habariproject.org/utils/ssha512.php SSHA512 password encryption page] to generate an encrypted password.

These values will be extracted when or if &lt;tt&gt;index.php&lt;/tt&gt; detects that there are DBMS tables present.  In that case, the installer will not display the form but use these values instead.

This will allow a fully automated installation, without any prompts being displayed to the user (assuming the $db_connection array is properly constructed, too).

At the moment, it's a convenience for those who are constantly re-installing Habari and who don't want to waste a bunch of time keying in the same values over and over.  It's also the basis of an automagic deployment tool for hosting providers.

==Troubleshooting==

See [http://wiki.habariproject.org/en/Troubleshooting troubleshooting] page for more details...

==Special Instructions==
===Software Bundles===
*[http://wiki.habariproject.org/en/Installation/Special_Instructions/WAMP WAMP]
*[http://wiki.habariproject.org/en/Installation/Special_Instructions/Nginx Nginx]
*[http://wiki.habariproject.org/en/Installation/Special_Instructions/LiteSpeed LiteSpeed]

===Hosting Solutions===
*[http://wiki.habariproject.org/en/Installation/Special_Instructions/A_Small_Orange A Small Orange]
*[http://wiki.habariproject.org/en/Installation/Special_Instructions/Dreamhost Dreamhost]
*[http://wiki.habariproject.org/en/Installation/Special_Instructions/Bluehost Bluehost]

[[Category:Manual]]</pre>
</div>
<div title="Installation/Special_Instructions/Bluehost" modifier="andycowl" modified="200803031431" created="200803130447" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="1373">
<pre>Early in 2008, [http://www.bluehost.com Bluehost] upgraded all servers to PHP 5.2.x which allows Habari to be installed and configured on a Bluehost server.

The other main pre-requisite for using Habari is the installation of the [http://uk.php.net/pdo PDO] (PHP Data Objects) extensions; specifically PDO drivers for the MySQL database.

To check the version of PHP running on a Bluehost server and to determine whether your server has the necessary software installed, simply create a text file named 'phpinfo.php' in the root directory of the Web server containing the following lines:

&lt;pre&gt;
&lt;?php
phpinfo();
?&gt;
&lt;/pre&gt;

Then, visit the URL in a Web browser - &lt;nowiki&gt;http://www.mysite.com/phpinfo.php&lt;/nowiki&gt; and examine the output.

The summary section includes the operating system of the host server, the exact version of the PHP interpreter and the options used to configure PHP.

[[Image:Bluehost-php-summary.png]]


* Check the version of PHP - Habari needs 5.2 (or higher)
* Check PDO and the required drivers for the MySQL database are installed. The Web page will be long so searching for 'PDO' may quickly locate the necessary section. If PDO and the drivers are present, you should see a section similar to the following:

[[Image:Bluehost-pdo.png]]

If the PDO extensions and the support for MySQL are present, proceed with the installation of Habari.

Otherwise, raise a ticket with Bluehost Technical Support asking for PDO and/or the drivers for MySQL to be installed on your server.</pre>
</div>
<div title="Introduction" modifier="habari" modified="200710161719" created="200707302035" tags="MediaWikiFormat" server.type="file" server.host="file:///Users/blogworks/Sites/MyHabari/Docs/Habari_Manual.20070916.0135310976.html" server.page.revision="200708032058" changecount="11">
<pre>These documents are intended for basic information on installing, upgrading and base use. As development continues, additional information will be added. For more
comprehensive documentation, visit the [http://wiki.habariproject.org/en/Main_Page main Habari wiki].

==About Habari== 
Habari intends to represent a fresh start to the idea of blogging. The system will be fast, easy to use, and easy to modify. New users should have no
problem using and enjoying Habari. Advanced users should have no problem tweaking Habari to do exactly what they need it to do.

==What Does Habari Mean?== 
&quot;Habari&quot; is a Swahili word that means &quot;what's the news?&quot; It's similar to the English &quot;What's up?&quot; or the Spanish &quot;¿Qué pasa?&quot; The typical
response is &quot;mzuri sana&quot;, which means &quot;very good.&quot;

==How Will it be Different?== 
Habari is being written with a firm understanding of the current state of blogging. Most other blogging packages have been around long
enough that their responses to things like comment spam and Digg site overloads are bolted on after the fact; whereas Habari is being written from the beginning to
take these things -- and more -- into account.

Habari strongly favors open, standard, and documented protocols. Atom, being both open and documented, is the prefered syndication format, and the Atom Publishing
Protocol is the prefered means of remote communication with your site. This is a core feature, and not a plugin.

Habari is being written specifically for modern web hosting environments, and uses modern object-oriented programming techniques. Using these recent but
well-established additions to the PHP language allows Habari to make use of PDO, enabling prepared statements for all interactions with the database. This greatly
reduces the system's vulnerability to SQL injection attacks. This is just one of many benefits of modern object-oriented techniques.

Those are just a few of the technical differences, but a major component of what makes Habari different is its community participation model. Users who demonstrate a
consistent level of quality contributions to the project are granted more privileges within the project.

==Our Process==
===Meritocracy=== 
Following the [http://www.apache.org/foundation/how-it-works.html#meritocracy/ meritocracy] model advocated by the Apache Software
Foundation, the Habari project rewards contributors with decision making privilege in the project. Regular participants should be able to influence the direction of
the project to which they dedicate their time and talent. The requirement for participation will be something of a moving target over time, but the barrier to entry
should never be so high that dedicated people are excluded.

===Transparency===
A fundamental aspect of successful open source projects is transparency. Decisions are made in the public's eye, and discussion and deliberation
takes place in the open. The Habari project pursues transparency by using the Google issues tracker to maintain a record of proposed changes, and discussion
associated with those changes. All proposals -- whether for code, documentation, visual style, etc -- are logged through the issues tracker for public scrutiny and
input.

===Licensing=== 
All contributions to Habari will acquire the Apache License, which is a modified version of the [http://www.apache.org/licenses/LICENSE-2.0 Apache
License]. For those unfamiliar with this license, the [http://www.apache.org/foundation/licence-FAQ.html Apache License FAQ
page] should answer most of your questions.

Developers contributing to the Habari project itself should note that, unless explicitly stated otherwise, any contribution intentionally submitted for inclusion
shall be under the terms and conditions of the Habari license, without any additional terms or conditions. However, plugins and themes designed to work with Habari
are not required to have the same license as Habari itself.

You can find our license included in the source, and in our [http://trac.habariproject.org/habari/browser/trunk/LICENSE code repository].
</pre>
</div>
<div title="MainMenu" modifier="YourName" modified="200807242326" created="200703132343" server.type="file" server.host="file:///Users/blogworks/Sites/MyHabari/Docs/Habari_Manual.20070916.0135310976.html" server.page.revision="200709160129" changecount="3">
<pre>[[Introduction]]
[[What's New]]
[[Installation]]
[[Upgrading]]
[[FAQ]]
[[User Documentation]]
[[Developer Introduction]]</pre>
</div>
<div title="Managing Media" modifier="rickc" modified="200807241319" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>To assist in the management of media, such as images, video and audio, Habari provides a mechanism for defining virtual filesystems for media, called Media Silos. A silo provides a consistent interface for dealing with media. Examples of media silos can be seen in the [[SimpleFileSilo]] or FlickrSilo plugins. A developer wanting to interface with a media service should write a plugin that implements the MediaSilo interface.

== Media Overview ==

The Habari media system provides access to disparate systems through a unified interface.  This is done through use of a virtual filesystem.  Each path in the virtual filesystem maps to a specific media asset, be it a directory or file.  The root directory in a virtual path indicates the Silo in which the asset exists.

A &quot;Silo&quot; is a wrapper for media from a specific source that provides a standard set of functions for access.  The name of the silo is the root directory in the filesystem.

For example, if the Silo is &quot;Local Files&quot;, then all of the assets within that silo will have a path that begins with &quot;/Local Files&quot;.  The Silo is responsible for mapping virtual paths within its root to actual files.  

The meaning of &quot;virtual filesystem&quot; is that a Silo can present any path that easily allows access to an asset, without representing the physical location of that asset.  A file located in the virtual path &quot;/Flickr/tags/Monkey&quot; might actually be located on a different server, and might not even use the name specified as the filename.  By using the virtual filesystem, Habari can present a unified interface across all Silos and their asset repositories that is easily navigable via a traditional path structure.

In addition to specifying the structure of the virtual paths within their purviews, a Silo provides access to the local and remote physical assets it contains.  Functions in the Silo provide access to the metadata used to address the file via the web - often a URL, but sometimes something more abstract.  It should also be possible to directly access the physical file of the asset for manipulation by the system via plugin.

Silos provide functions to enumerate assets stored in a specific virtual path.  Also, Silos provide permission information on the assets, and can even allow the copying, deleting, and uploading of new assets, regardless of whether the store is local or remote.

Silos are simply an abstraction for the Media API, and do not provide an interface of their own.

Rather than interacting with Silos directly, Habari provides a Media class that functions as a [http://en.wikipedia.org/wiki/Fa%C3%A7ade_pattern facade pattern].  Using path names that include the silo root names, it dispatches functions to the correct Silo and returns its results without the consumer of the API needing to know anything about the virtual paths or the Silos that implement them.

== Usage in Habari ==

The Publish page of the Habari Admin contains an area that allows a user to select assets for insertion into posts.  The assets are supplied via the Media/Silo system.

== Consuming Silo Data ==

== Creating New Silos ==
To create a new media silo, you need to override the methods defined in the MediaSilo interface. Below is a description of each of the methods.

=== silo_info() ===
This method returns information about the silo. Most importantly, it should return the name of the silo, which is used as the first part of the media silo's URL. For example, the Flickr media silo would return an associative array with key &lt;tt&gt;name&lt;/tt&gt; that has the value &lt;tt&gt;flickr&lt;/tt&gt;. Therefore, all Flickr media assets would be accessed through a virtual directory beginning with &lt;tt&gt;flickr/&lt;/tt&gt;. An icon can optionally be defined in the array with a key of &lt;tt&gt;icon&lt;/tt&gt; and the URL of the icon which should be used. These icons are displayed on the publish page and may become the only representation of a silo. The icon should be 16 pixels by 16 pixels.

=== silo_dir( $path ) ===
This method returns an array of MediaAsset objects that are located at the given virtual path. It should map the virtual path to the real path of the service, creating MediaAssets that contain the correct virtual paths. 

=== silo_get( $path, $qualities = null ) === 
=== silo_put( $path, $filedata ) ===
=== silo_delete( $path ) ===
=== silo_highlights() ===
=== silo_permissions( $path ) ===

===Custom Media Types===
Every MediaAsset has a &quot;type&quot;, similar to a MIME type, which is used to control how MediaAssets are output. Types can be silo-specific, and can be added by silo plugins, so that the way that assets are previewed or output can be customised. The &lt;tt&gt;media&lt;/tt&gt; object in the &lt;tt&gt;habari&lt;/tt&gt; JavaScript object has functions named after the MediaAsset types. If a function exists with the MediaAsset type name, that function is called to output the asset.  If no function exist with that type name, the default &quot;image&quot; output function is used.

To add a custom type, you need to specify the type when creating the MediaAsset object, and add the custom output to the JavaScript object, as demonstrated below for the Flickr MediaSilo.

&lt;code lang=&quot;php&quot;&gt;
// set other properties
$props['filetype'] = 'flickr';
// Add a new media asset 
$results[] = new MediaAsset(
  self::SILO_NAME . '/photos/' . $photo['id'], 
  false,
  $props
);
&lt;/code&gt;

The Javascript can be added using the &lt;code&gt;action_admin_footer&lt;/code&gt; hook.

&lt;code lang=&quot;php&quot;&gt;
public function action_admin_footer( $theme ) {
  if ($theme-&gt;admin_page == 'publish') {
    echo &lt;&lt;&lt; FLICKR
    &lt;script type=&quot;text/javascript&quot;&gt;
      habari.media.output.flickr = function(fileindex, fileobj) {
        habari.editor.insertSelection('&lt;a href=&quot;' + fileobj.flickr_url + '&quot;&gt;&lt;img src=&quot;' + fileobj.url + '&quot;&gt;&lt;/a&gt;');
      }
      habari.media.preview.flickr = function(fileindex, fileobj) {
        var stats = '';
        return '&lt;div class=&quot;mediatitle&quot;&gt;' + fileobj.title + '&lt;/div&gt;&lt;img src=&quot;' + fileobj.thumbnail_url + '&quot;&gt;&lt;div class=&quot;mediastats&quot;&gt; ' + stats + '&lt;/div&gt;';
      }
    &lt;/script&gt;
FLICKR;
  }
}
&lt;/code&gt;

{{developer}}

[[Category:Manual]]</pre>
</div>
<div title="MediaWikiFormatterPlugin" modifier="miklb" modified="200710161648" created="200610020000" tags="systemConfig">
<pre>/***
|''Name:''|MediaWikiFormatterPlugin|
|''Description:''|Allows Tiddlers to use [[MediaWiki|http://meta.wikimedia.org/wiki/Help:Wikitext]] ([[WikiPedia|http://meta.wikipedia.org/]]) text formatting|
|''Author:''|Martin Budden (mjbudden (at) gmail (dot) com)|
|''Source:''|http://www.martinswiki.com/#MediaWikiFormatterPlugin |
|''CodeRepository:''|http://svn.tiddlywiki.org/Trunk/contributors/MartinBudden/formatters/MediaWikiFormatterPlugin.js |
|''Version:''|0.4.3|
|''Date:''|Jul 27, 2007|
|''Comments:''|Please make comments at http://groups.google.co.uk/group/TiddlyWikiDev |
|''License:''|[[Apache Software License 2.0|http://www.apache.org/licenses/LICENSE-2.0.html]]|
|''~CoreVersion:''|2.1.0|

|''Display instrumentation''|&lt;&lt;option chkDisplayInstrumentation&gt;&gt;|
|''Display empty template links:''|&lt;&lt;option chkMediaWikiDisplayEmptyTemplateLinks&gt;&gt;|
|''Allow zooming of thumbnail images''|&lt;&lt;option chkMediaWikiDisplayEnableThumbZoom&gt;&gt;|
|''List references''|&lt;&lt;option chkMediaWikiListReferences&gt;&gt;|
|''Display unsupported magic words''|&lt;&lt;option chkDisplayMediaWikiMagicWords&gt;&gt;|

This is the MediaWikiFormatterPlugin, which allows you to insert MediaWiki formated text into a TiddlyWiki.

The aim is not to fully emulate MediaWiki, but to allow you to work with MediaWiki content off-line and then resync the content with your MediaWiki later on, with the expectation that only minor edits will be required.

To use MediaWiki format in a Tiddler, tag the Tiddler with MediaWikiFormat or set the tiddler's {{{wikiformat}}} extended field to {{{mediawiki}}}.

!!!Issues
There are (at least) the following known issues:
# Not all styles from http://meta.wikimedia.org/wiki/MediaWiki:Common.css incorporated
## Styles for tables don't yet match Wikipedia styles.
## Styles for image galleries don't yet match Wikipedia styles.
# Anchors not yet supported.

!!!Not supported
# Template parser functions (also called colon functions) http://meta.wikimedia.org/wiki/ParserFunctions eg &amp;#123;&amp;#123; #functionname: argument 1 | argument 2 | argument 3... &amp;#125;&amp;#125;
# Magic words and variables http://meta.wikimedia.org/wiki/Help:Magic_words eg {{{__TOC__}}}, &amp;#123;&amp;#123;CURRENTDAY&amp;#125;&amp;#125;, &amp;#123;&amp;#123;PAGENAME&amp;#125;&amp;#125;
# {{{^''}}} (italic at start of line) indents, makes italic and quotes with guilmot quote

!!!No plans to support
# Template substitution on save http://meta.wikimedia.org/wiki/Help:Substitution eg &amp;#123;&amp;#123; subst: templatename &amp;#125;&amp;#125;

***/

//{{{
// Ensure that the MediaWikiFormatter Plugin is only installed once.
if(!version.extensions.MediaWikiFormatterPlugin) {
version.extensions.MediaWikiFormatterPlugin = {installed:true};

if(version.major &lt; 2 || (version.major == 2 &amp;&amp; version.minor &lt; 1))
	{alertAndThrow('MediaWikiFormatterPlugin requires TiddlyWiki 2.1 or later.');}

if(config.options.chkDisplayInstrumentation == undefined)
	{config.options.chkDisplayInstrumentation = false;}

if(config.options.chkMediaWikiDisplayEmptyTemplateLinks == undefined)
	{config.options.chkMediaWikiDisplayEmptyTemplateLinks = false;}
if(config.options.chkMediaWikiDisplayEnableThumbZoom == undefined)
	{config.options.chkMediaWikiDisplayEnableThumbZoom = false;}
if(config.options.chkMediaWikiListReferences == undefined)
	{config.options.chkMediaWikiListReferences = false;}
if(config.options.chkDisplayMediaWikiMagicWords == undefined)
	{config.options.chkDisplayMediaWikiMagicWords = false;}

//#config.textPrimitives.urlPattern = &quot;(([a-zA-Z][0-9a-zA-Z+\\-\\.]*:)?/{0,2}[0-9a-zA-Z;/?:@&amp;=+$\\.\\-_!~*'()%]+)?(#[0-9a-zA-Z;/?:@&amp;=+$\\.\\-_!~*'()%]+)?&quot;;
//#config.textPrimitives.urlPattern = &quot;[a-z]{3,8}:/{0,2}[^\\s:/&lt;&gt;'\&quot;][^\\s/&lt;&gt;'\&quot;]*(?:/|\\b)&quot;;

//&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;;

config.macros.include = {};
config.macros.include.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if((tiddler instanceof Tiddler) &amp;&amp; params[0]) {
		var host = store.getValue(tiddler,'server.host');
		if(host &amp;&amp; host.indexOf('wikipedia')!=-1) {
			var t = store.fetchTiddler(params[0]);
			var text = store.getValue(t,'text');
			wikify(text,place,highlightHack,tiddler);
		}
	}
};


MediaWikiFormatter = {}; // 'namespace' for local functions

mwDebug = function(out,str)
{
	createTiddlyText(out,str.replace(/\n/mg,'\\n').replace(/\r/mg,'RR'));
	createTiddlyElement2(out,'br');
};

MediaWikiFormatter.Tiddler_changed = Tiddler.prototype.changed;
Tiddler.prototype.changed = function()
{
	if((this.fields.wikiformat==config.parsers.mediawikiFormatter.format) || this.isTagged(config.parsers.mediawikiFormatter.formatTag)) {
		//# update the links array, by checking for MediaWiki format links
		this.links = [];
//#lookaheadRegExp: /\[\[(?:([a-z]{2,3}:)?)(#?)([^\|\]]*?)(?:(\]\](\w*))|(\|(.*?)\]\]))/mg,
		var tiddlerLinkRegExp = /\[\[(?::?([A-Za-z]{2,}:)?)(#?)([^\|\]]*?)(?:(\]\])|(\|(.*?)\]\]))/mg;
		tiddlerLinkRegExp.lastIndex = 0;
		var match = tiddlerLinkRegExp.exec(this.text);
		while(match) {
			if(!match[1] &amp;&amp; !match[2])
				this.links.pushUnique(match[3]);
			match = tiddlerLinkRegExp.exec(this.text);
		}
	} else if(!this.isTagged('systemConfig')) {
		MediaWikiFormatter.Tiddler_changed.apply(this,arguments);
		return;
	}
	this.linksUpdated = true;
};

TiddlyWiki.prototype.getMediaWikiPagesInNamespace = function(namespace)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(tiddler.title.indexOf(namespace)==0)
			results.push(tiddler);
		});
	results.sort(function(a,b) {return a.title &lt; b.title ? -1 : +1;});
	return results;
};

TiddlyWiki.prototype.getMediaWikiPages = function()
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(!tiddler.isTagged('excludeLists') &amp;&amp; tiddler.title.indexOf(':')==-1)
			results.push(tiddler);
		});
	results.sort(function(a,b) {return a.title &lt; b.title ? -1 : +1;});
	return results;
};

TiddlyWiki.prototype.getMediaWikiOtherPages = function()
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(!tiddler.isTagged('excludeLists') &amp;&amp; tiddler.title.indexOf(':')!=-1)
			results.push(tiddler);
		});
	results.sort(function(a,b) {return a.title &lt; b.title ? -1 : +1;});
	return results;
};

config.macros.list.otherpages = {};
config.macros.list.otherpages.handler = function(params)
{
	return store.getMediaWikiOtherPages();
};

config.macros.list.templates = {};
config.macros.list.templates.handler = function(params)
{
	return store.getMediaWikiPagesInNamespace('Template:');
};

config.macros.list.categories = {};
config.macros.list.categories.handler = function(params)
{
	return store.getMediaWikiPagesInNamespace('Category:');
};

wikify = function(source,output,highlightRegExp,tiddler)
{
	if(source &amp;&amp; source != '') {
		var w = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);
		w.linkCount = 0;
		w.tableDepth = 0;
		w.output = tiddler==null ? output : createTiddlyElement2(output,'p');
		var t1,t0 = new Date();
		w.subWikifyUnterm(w.output);
		if(tiddler &amp;&amp; config.options.chkDisplayInstrumentation) {
			t1 = new Date();
			var t = tiddler ? tiddler.title : source.substr(0,10);
			displayMessage('Wikify &quot;'+t+'&quot; in ' + (t1-t0) + ' ms');
		}
	}
//#at point of usage can use:
//#var output = w.output.nodeType==1 &amp;&amp; w.output.nodeName=='P' ? w.output.parentNode : w.output;
};

function createTiddlyElement2(parent,element)
{
	var e = document.createElement(element);
	parent.appendChild(e);
	return e;
}

config.formatterHelpers.createElementAndWikify = function(w)
{
	w.subWikifyTerm(createTiddlyElement2(w.output,this.element),this.termRegExp);
};

MediaWikiFormatter.hijackListAll = function ()
{
	MediaWikiFormatter.oldListAll = config.macros.list.all.handler;
	config.macros.list.all.handler = function(params) {
		return store.getMediaWikiPages();
	};
};
MediaWikiFormatter.hijackListAll();

MediaWikiFormatter.normalizedTitle = function(title)
{
	title = title.trim();
	var n = title.charAt(0).toUpperCase() + title.substr(1);
	return n.replace(/\s/g,'_');
};

//# see http://meta.wikimedia.org/wiki/Help:Variable
MediaWikiFormatter.expandVariable = function(w,variable)
{
	switch(variable) {
	case 'PAGENAME':
		createTiddlyText(w.output,w.tiddler.title);
		break;
	case 'PAGENAMEE':
		createTiddlyText(w.output,MediaWikiFormatter.normalizedTitle(w.tiddler.title));
		break;
	case 'REVISIONID':
		var text = w.tiddler.fields['server.revision'];
		if(text)
			createTiddlyText(w.output,text);
		break;
	default:
		return false;
	}
	return true;
};

MediaWikiFormatter.getTemplateParams = function(text)
{
//#{{test|a|b}}
//#{{test|n=a|m=b}}
	var params = {};

	text += '|';
	var pRegExp = /(?:([^\|]*)=)?([^\|]*)\|/mg;
	var match = pRegExp.exec(text);
	if(match) {
		//# skip template name
		match = pRegExp.exec(text);
	}
	var i = 1;
	while(match) {
		//#params[match[1] ? match[1] : i++] = match[2];
		if(match[1]) {
			params[match[1]] = match[2];
		} else {
			params[i] = match[2];
			i++;
		}
		match = pRegExp.exec(text);
	}
	return params;
};

//#The #if function is an if-then-else construct. The syntax is:
//#	{{#if: &lt;condition&gt; | &lt;then text&gt; | &lt;else text&gt; }}
//#	{{#if: &lt;condition&gt; | &lt;then text&gt; }}

//#If the condition is an empty string or consists only of whitespace, then it is considered false, and the ''else text'' is returned. Otherwise, the ''then text'' is returned. The ''else text'' may be omitted, in which case the result will be blank if the condition is false.

//#An example:
//#	{{#if| {{{parameter|}}} | Parameter is defined. | Parameter is undefined, or empty}}

//#Note that the {{#if}} function does '''not''' support &quot;=&quot; signs or mathematical expressions.
//#	{{#if|1 = 2 | yes | no}} will return &quot;yes&quot;, because the string &quot;1 = 2&quot; is not blank.
//#	It is intended as an ''&quot;if not empty&quot;'' structure.

//# {{#if:{{{param1|}}} | param1value:{{{param1}}} }}
//# include {{testTpf|param1=hello}}
//# becomes:
//# {{#if:hello | param1value:hello }}
//# becomes:
//# param1value:hello

//# include {{testTpf}}
//# becomes:
//# {{#if: | param1value: }}
//# becomes:
//# &lt;nothing&gt;


//# see:
//# http://meta.wikimedia.org/wiki/ParserFunctions
//# http://www.mediawiki.org/wiki/Extension:Parser_function_extensions
//# http://svn.wikimedia.org/viewvc/mediawiki/trunk/extensions/ParserFunctions/ParserFunctions.php?view=markup
//# http://svn.wikimedia.org/viewvc/mediawiki/trunk/phase3/includes/Parser.php?view=markup
MediaWikiFormatter.evaluateTemplateParserFunctions = function(text)
{
//#displayMessage(&quot;evtpf:&quot;+text);
//#if(text==&quot;{{#if:hello | param1value=hello }}&quot;)
//#	return &quot;param1value=hello&quot;;
//#	return text;
	var fnRegExp = /\{\{#if:([^\|]*?)\|([^\|]*?)(?:\|(.*?))?\}\}/mg;
	var t = '';
	var fi = 0;
	match = fnRegExp.exec(text);
	while(match) {
//#displayMessage(&quot;m:&quot;+match);
//#displayMessage(&quot;m0:&quot;+match[0]);
//#displayMessage(&quot;m1:&quot;+match[1]);
//#displayMessage(&quot;m2:&quot;+match[2]);
//#displayMessage(&quot;m3:&quot;+match[3]);
//#displayMessage(&quot;ss:&quot;+text.substring(fi,match.index));
		t += text.substring(fi,match.index);
		var m = match[1] ? match[1].trim() : null;
		if(m)
			t += match[2];
		else if(match[3])
			t += match[3].trim();
		fi = fnRegExp.lastIndex;
		match = fnRegExp.exec(text);
	}
	t += text.substring(fi);
	text = t == '' ? text : t;
//#displayMessage(&quot;text:&quot;+text);
	return text;
};

MediaWikiFormatter.expandTemplate = function(w,templateText,params)
//# Expand the template by dealing with &lt;noinclude&gt;, &lt;includeonly&gt; and substituting parameters with their values
//# see http://meta.wikimedia.org/wiki/Help:Template
{
//#mwDebug(w.output,'et:'+templateText);
//#displayMessage(&quot;expandTemplate:&quot;+templateText);
	var text = templateText;
	text = text.replace(/&lt;noinclude&gt;((?:.|\n)*?)&lt;\/noinclude&gt;/mg,'');// remove text between noinclude tags
	var includeOnlyRegExp = /&lt;includeonly&gt;((?:.|\n)*?)&lt;\/includeonly&gt;/mg;
	var t = '';
	var match = includeOnlyRegExp.exec(text);
	while(match) {
		t += match[1];
		match = includeOnlyRegExp.exec(text);
	}
	text = t == '' ? text : t;

	var paramsRegExp = /\{\{\{(.*?)(?:\|(.*?))?\}\}\}/mg;
	t = '';
	var pi = 0;
	match = paramsRegExp.exec(text);
	while(match) {
		var name = match[1];
		var val = params[name];
		if(!val) {
			//# use default
			val = match[2];
		}
		if(!val) {
			//# if no value or default, parameter evaluates to name
			val = '';//val = match[0];
		}
		t += text.substring(pi,match.index) + val;
		pi = paramsRegExp.lastIndex;
		match = paramsRegExp.exec(text);
	}
	return t == '' ? text : t;
/*	//displayMessage(&quot;ss:&quot;+text.substring(pi));
	t += text.substring(pi);
	t = MediaWikiFormatter.evaluateTemplateParserFunctions(t);
	//{{#if: {{{perihelion|}}} | &lt;tr&gt;&lt;th&gt;[[Perihelion|Perihelion distance]]:&lt;/th&gt;&lt;td&gt;{{{perihelion}}}&lt;/td&gt;&lt;/tr&gt;}}
	//{{#if:{{{symbol|}}} | {{{symbol}}} | }}
	text = t == '' ? text : t;
	displayMessage(&quot;t2:&quot;+text);
	return text;
*/
};

MediaWikiFormatter.endOfParams = function(w,text)
{
	var p = 0;
	var i = text.indexOf('|');
	if(i==-1) {return -1;}
	var n = text.indexOf('\n');
	if(n!=-1 &amp;&amp; n&lt;i) {return -1;}
	var b = text.indexOf('[[');
	//# can't have [[ in parameters
	if(b!=-1 &amp;&amp; b&lt;i) {return -1;}
	
	b = text.indexOf('{{');
	while(b!=-1 &amp;&amp; b&lt;i) {
		//# have {{ before |, so need to find first '|' after '{{..}}' pairs
		//# cut off the ..{{, find the }} cut off and repeat
		p += b;
		text = text.substr(b);
		var c = text.indexOf('}}');
		p += c;
		text = text.substr(c);
		i = text.indexOf('|');
		if(i==-1) {return -1;}
		n = text.indexOf('\n');
		if(n!=-1 &amp;&amp; n&lt;i) {return -1;}
		b = text.indexOf('{{');
		i = -1;
	}
	return i;
};

MediaWikiFormatter.readToDelim = function(w)
//!!! this is a bit rubish, needs doing properly.
{
//#delimiter, startBracket terminatorBracket
	var dRegExp = /\|/mg;
	var sRegExp = /\[\[/mg;
	var tRegExp = /\]\]/mg;

	dRegExp.lastIndex = w.startMatch;
	var dMatch = dRegExp.exec(w.source);
	sRegExp.lastIndex = w.startMatch;
	var sMatch = sRegExp.exec(w.source);
	tRegExp.lastIndex = w.startMatch;
	var tMatch = tRegExp.exec(w.source);
	if(!tMatch) {
		//#mwDebug(w.output,'ERROR1');
		return false;
	}

	while(sMatch &amp;&amp; sMatch.index&lt;tMatch.index) {
		if(dMatch &amp;&amp; dMatch.index&lt;sMatch.index) {
			//# delim is before startBracket, so return it
//#mwDebug(w.output,'di:'+dMatch.index+' dl:'+sRegExp.lastIndex);
			w.nextMatch = dRegExp.lastIndex;
			w.matchLength = dMatch.index - w.startMatch;
			return true;
		}
//#mwDebug(w.output,'si:'+sMatch.index+' sl:'+sRegExp.lastIndex);
//#mwDebug(w.output,'ti:'+tMatch.index+' tl:'+tRegExp.lastIndex);
		//# startBracket before termBracket, so skip over bracket pairs
		//# found eg [[, so look for ]]
		tRegExp.lastIndex = sRegExp.lastIndex;
		tMatch = tRegExp.exec(w.source);
//#mwDebug(w.output,'xti:'+tMatch.index+' tl:'+tRegExp.lastIndex);
		
		//# and look for another [[
		w.nextMatch = tRegExp.lastIndex;
		dRegExp.lastIndex = w.nextMatch;
		dMatch = dRegExp.exec(w.source);
		sRegExp.lastIndex = w.nextMatch;
		sMatch = sRegExp.exec(w.source);
		tRegExp.lastIndex = w.nextMatch;
		tMatch = tRegExp.exec(w.source);
	}
		
	if(dMatch &amp;&amp; dMatch.index&lt;tMatch.index) {
		//# delim is before term, so return it
//#mwDebug(w.output,'2di:'+dMatch.index+' dl:'+sRegExp.lastIndex);
		w.nextMatch = dRegExp.lastIndex;
		w.matchLength = dMatch.index - w.startMatch;
		return true;
	}
	if(tMatch) {
		//# delim is before term, so return it
//#mwDebug(w.output,'2ti:'+tMatch.index+' tl:'+tRegExp.lastIndex);
		w.nextMatch = tRegExp.lastIndex;
		w.matchLength = tMatch.index - w.startMatch;
		return false;
	}
	//#mwDebug(w.output,'ERROR2');
	//# return term
	w.nextMatch = tRegExp.lastIndex;
	w.matchLength = -1;
	return false;
};

MediaWikiFormatter.getParams = function(w)
{
	var params = [];
	var i = 1;
	w.startMatch = w.nextMatch;
	var read = MediaWikiFormatter.readToDelim(w);
	if(w.matchLength!=-1) {
		params[i] = w.source.substr(w.startMatch,w.matchLength);
	}
	while(read) {
		i++;
		w.startMatch = w.nextMatch;
		read = MediaWikiFormatter.readToDelim(w);
		if(w.matchLength!=-1) {
			params[i] = w.source.substr(w.startMatch,w.matchLength);
		}
	}
	return params;
};

MediaWikiFormatter.setFromParams = function(w,p)
{
	var r = {};
	var re = /\s*(.*?)=(?:(?:&quot;(.*?)&quot;)|(?:'(.*?)')|((?:\w|%|#)*))/mg;
	var match = re.exec(p);
	while(match)
		{
		var s = match[1].unDash();
		if(match[2]) {
			r[s] = match[2];
		} else if(match[3]) {
			r[s] = match[3];
		} else {
			r[s] = match[4];
		}
		match = re.exec(p);
	}
	return r;
};

MediaWikiFormatter.setAttributesFromParams = function(e,p)
{
	var re = /\s*(.*?)=(?:(?:&quot;(.*?)&quot;)|(?:'(.*?)')|((?:\w|%|#)*))/mg;
	var match = re.exec(p);
	while(match) {
		var s = match[1].unDash();
		if(s == 'bgcolor') {
			s = 'backgroundColor';
		}
		try {
			if(match[2]) {
				e.setAttribute(s,match[2]);
			} else if(match[3]) {
				e.setAttribute(s,match[3]);
			} else {
				e.setAttribute(s,match[4]);
			}
		}
		catch(ex) {}
		match = re.exec(p);
	}
};

config.mediawiki = {};
config.mediawiki.formatters = [
{
	name: 'mediaWikiHeading',
	match: '^={1,6}(?!=)\\n?',
	termRegExp: /(={1,6}\n?)/mg,
	handler: function(w)
	{
		//#var output = w.output.nodeType==1 &amp;&amp; w.output.nodeName=='P' ? w.output.parentNode : w.output;
		var output = w.output;
		var e = createTiddlyElement2(output,'h' + w.matchLength);
		//# drop anchor
		var a = createTiddlyElement2(e,'a');
		var t = w.tiddler ? MediaWikiFormatter.normalizedTitle(w.tiddler.title) + ':' : '';
		var len = w.source.substr(w.nextMatch).indexOf('=');
		a.setAttribute('name',t+MediaWikiFormatter.normalizedTitle(w.source.substr(w.nextMatch,len)));
		w.subWikifyTerm(e,this.termRegExp);
		//#w.output = createTiddlyElement2(output,'p');
	}
},

{
	name: 'mediaWikiTable',
	match: '^\\{\\|', // ^{|
	tableTerm: '\\n\\|\\}', // |}
	rowStart: '\\n\\|\\-', // \n|-
	cellStart: '\\n!|!!|\\|\\||\\n\\|', //\n! or !! or || or \n|
	caption: '\\n\\|\\+',
	rowTerm: null,
	cellTerm: null,
	inCellTerm: null,
	tt: 0,
	debug: null,
	rowTermRegExp: null,
	handler: function(w)
	{
		if(!this.rowTermRegExp) {
			this.rowTerm = '(' + this.tableTerm +')|(' + this.rowStart + ')';
			this.cellTerm = this.rowTerm + '|(' + this.cellStart + ')';
			this.inCellTerm = '(' + this.match + ')|' + this.rowTerm + '|(' + this.cellStart + ')';
			this.caption = '(' + this.caption + ')|' + this.cellTerm;

			this.rowTermRegExp = new RegExp(this.rowTerm,'mg');
			this.cellTermRegExp = new RegExp(this.cellTerm,'mg');
			this.inCellTermRegExp = new RegExp(this.inCellTerm,'mg');
			this.captionRegExp = new RegExp(this.caption,'mg');
		}
//#this.debug = createTiddlyElement2(w.output,'p');
//#mwDebug(this.debug,'start table');
		this.captionRegExp.lastIndex = w.nextMatch;
		var match = this.captionRegExp.exec(w.source);
		if(!match) {return;}
		//#var inPara = w.output.nodeType==1 &amp;&amp; w.output.nodeName=='P' ? true : false;
		//#var output = inPara ? w.output.parentNode : w.output;
		var output = w.output;
		var table = createTiddlyElement2(output,'table');
		var rowContainer = table;

		var i = w.source.indexOf('\n',w.nextMatch);
		if(i&gt;w.nextMatch) {
			MediaWikiFormatter.setAttributesFromParams(table,w.source.substring(w.nextMatch,i));
			w.nextMatch = i;
		}

		var rowCount = 0;
		var eot = false;
		if(match[1]) {
			//# caption
			var caption = createTiddlyElement2(table,'caption');
			w.nextMatch = this.captionRegExp.lastIndex;
			var captionText = w.source.substring(w.nextMatch);
			var n = captionText.indexOf('\n');
			captionText = captionText.substr(0,n);
			i = MediaWikiFormatter.endOfParams(w,captionText);
			if(i!=-1) {
				captionText = w.source.substr(w.nextMatch,i);
				//#captionText = captionText.replace(/^\+/mg,'')//!!hack until I fix this properly
				//#MediaWikiFormatter.setAttributesFromParams(caption,captionText);
				w.nextMatch += i+1;
			}
			if(caption != table.firstChild) {
				table.insertBefore(caption,table.firstChild);
			}
			w.subWikify(caption,this.cellTerm);
			//# rewind to before the match
			w.nextMatch -= w.matchLength;
			this.cellTermRegExp.lastIndex = w.nextMatch;
			var match2 = this.cellTermRegExp.exec(w.source);
			if(match2) {
				if(match2[3]) {
					//# no first row marker
					eot = this.rowHandler(w,createTiddlyElement2(rowContainer,'tr'));
					rowCount++;
				}
			}
		} else if(match[3]) {
			//# row
			//# rewind to before the match
			w.nextMatch = this.captionRegExp.lastIndex-match[3].length;
		} else if(match[4]) {
			//# cell, no first row marker in table
			//# rewind to before the match
			w.nextMatch = this.captionRegExp.lastIndex-match[4].length;
			eot = this.rowHandler(w,createTiddlyElement2(rowContainer,'tr'));
			rowCount++;
		}

		this.rowTermRegExp.lastIndex = w.nextMatch;
		match = this.rowTermRegExp.exec(w.source);
		while(match &amp;&amp; eot==false) {
			if(match[1]) {
				//# end table
				w.nextMatch = this.rowTermRegExp.lastIndex;
				if(w.tableDepth==0) {
					return;
				}
			} else if(match[2]) {
				//# row
				var rowElement = createTiddlyElement2(rowContainer,'tr');
				//# skip over the match
				w.nextMatch += match[2].length;
				i = w.source.indexOf('\n',w.nextMatch);
				if(i&gt;w.nextMatch) {
					MediaWikiFormatter.setAttributesFromParams(rowElement,w.source.substring(w.nextMatch,i));
					w.nextMatch = i;
				}
				eot = this.rowHandler(w,rowElement);
			}
			rowCount++;
			this.rowTermRegExp.lastIndex = w.nextMatch;
			match = this.rowTermRegExp.exec(w.source);
		}//# end while
		if(w.tableDepth==0) {
			//# skip over tableterm, \n|}
			w.nextMatch +=3;
		}
		//#if(inPara)
		//#	w.output = createTiddlyElement2(output,'p');
	},//# end handler

	rowHandler: function(w,e)
	{
		//# assumes w.nextMatch points to first cell terminator, returns false if any improperly terminated element
		var cell;
		this.inCellTermRegExp.lastIndex = w.nextMatch;
		var match = this.inCellTermRegExp.exec(w.source);
		while(match) {
			if(match[1]) {
				//# nested table
				w.tableDepth++;
				w.subWikify(cell,this.tableTerm);
				w.nextMatch = this.tt;
				w.tableDepth--;
				return false;
			} else if(match[2]) {
				//# end table
				this.tt = this.inCellTermRegExp.lastIndex;
				return true;
			} else if(match[3]) {
				//# end row
				return false;
			} else if(match[4]) {
				//# cell
				var len = match[4].length;
				cell = createTiddlyElement2(e,match[4].substr(len-1)=='!'?'th':'td');
				//# skip over the match
				w.nextMatch += len;

				this.inCellTermRegExp.lastIndex = w.nextMatch;
				var lookahead = this.inCellTermRegExp.exec(w.source);
				if(!lookahead) {
					//# improperly terminated table
					return false;
				}
				var cellText = w.source.substr(w.nextMatch,lookahead.index-w.nextMatch);
				var oldSource = w.source;
				var i = MediaWikiFormatter.endOfParams(w,cellText);//cellText.indexOf('|');
				if(i!=-1) {
					cellText = cellText.replace(/^\+/mg,'');  //!!hack until I fix this properly
					MediaWikiFormatter.setAttributesFromParams(cell,cellText.substr(0,i-1));
					cellText = cellText.substring(i+1);
				}
				//# remove leading spaces so not treated as preformatted
				cellText = cellText.replace(/^\s*/mg,'');
				w.source = cellText;
				w.nextMatch = 0;
				w.subWikifyUnterm(cell);
				w.source = oldSource;
				w.nextMatch = lookahead.index;
			}
			this.inCellTermRegExp.lastIndex = w.nextMatch;
			match = this.inCellTermRegExp.exec(w.source);
		}//# end while
		return false;
	}//# end rowHandler
},

{
	name: 'mediaWikiList',
	match: '^[\\*#;:]+',
	lookaheadRegExp: /(?:(?:(\*)|(#)|(;)|(:))+)(?: ?)/mg,
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
//#this.debug = createTiddlyElement2(w.output,'p');
//#mwDebug(this.debug,'start list');
		var stack = [w.output];
		var currLevel = 0, currType = null;
		var listType, itemType;
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.nextMatch) {
			if(lookaheadMatch[1]) {
				listType = 'ul';
				itemType = 'li';
			} else if(lookaheadMatch[2]) {
				listType = 'ol';
				itemType = 'li';
			} else if(lookaheadMatch[3]) {
				listType = 'dl';
				itemType = 'dt';
			} else if(lookaheadMatch[4]) {
				listType = 'dl';
				itemType = 'dd';
			}
			var listLevel = lookaheadMatch[0].length;
			w.nextMatch += listLevel;
			if(listLevel &gt; currLevel) {
				for(var i=currLevel; i&lt;listLevel; i++) {
					stack.push(createTiddlyElement2(stack[stack.length-1],listType));
				}
			} else if(listLevel &lt; currLevel) {
				for(i=currLevel; i&gt;listLevel; i--) {
					stack.pop();
				}
			} else if(listLevel == currLevel &amp;&amp; listType != currType) {
				stack.pop();
				stack.push(createTiddlyElement2(stack[stack.length-1],listType));
			}
//#mwDebug(this.debug,&quot;b:&quot;+w.source.substr(w.nextMatch,30));
			currLevel = listLevel;
			currType = listType;
			var e = createTiddlyElement2(stack[stack.length-1],itemType);
			var ci = w.source.indexOf(':',w.nextMatch);
			var ni = w.source.indexOf('\n',w.nextMatch);
			if(itemType=='dt' &amp;&amp; (ni==-1 || (ci!=-1 &amp;&amp; ci&lt;ni))) {
				//# deal with ':' on same line as ';'
				w.subWikifyTerm(e,/(:)/mg);
				w.nextMatch--;
			} else {
				w.subWikifyTerm(e,this.termRegExp);
			}
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	}
},

{
	name: 'mediaWikiRule',
	match: '^----+$\\n?',
	handler: function(w)
	{
		//#var output = w.output.parentNode;
		createTiddlyElement2(w.output,'hr');
		//#w.output = createTiddlyElement2(output,'p');
	}
},

{
	name: 'mediaWikiLeadingSpaces',
	match: '^ ',
	lookaheadRegExp: /^ /mg,
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		var e = createTiddlyElement2(w.output,'pre');
		while(true) {
			w.subWikifyTerm(e,this.termRegExp);
			createTiddlyElement2(e,'br');
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.nextMatch) {
				w.nextMatch += lookaheadMatch[0].length;
			} else {
				break;
			}
		}
	}
},

//# [[Image:Westminstpalace.jpg|frame|none|caption text]]
//# //http://en.wikipedia.org/wiki/Image:Westminstpalace.jpg
//# &lt;a href=&quot;/wiki/Image:Westminstpalace.jpg&quot; class=&quot;internal&quot; title=&quot;caption text&quot;&gt;
//# &lt;img src=&quot;http://upload.wikimedia.org/wikipedia/commons/3/39/Westminstpalace.jpg&quot;
//#  alt=&quot;caption text&quot; width=&quot;400&quot; height=&quot;300&quot; longdesc=&quot;/wiki/Image:Westminstpalace.jpg&quot; /&gt;
//# &lt;/a&gt;

//# [[image:Stockholm.jpg|right|350px|thumb|Stockholm panorama from the City Hall]]
//# &lt;div class=&quot;thumb tright&quot;&gt;
//# 	&lt;div style=&quot;width:352px;&quot;&gt;
//# 		&lt;a href=&quot;/wiki/Image:Stockholm.jpg&quot; class=&quot;internal&quot; title=&quot;Stockholm panorama from the City Hall&quot;&gt;
//# 			&lt;img src=&quot;http://upload.wikimedia.org/wikipedia/commons/thumb/c/c3/Stockholm.jpg/350px-Stockholm.jpg&quot; alt=&quot;Stockholm panorama from the City Hall&quot; width=&quot;350&quot; height=&quot;84&quot; longdesc=&quot;/wiki/Image:Stockholm.jpg&quot; /&gt;
//# 		&lt;/a&gt;
//# 		&lt;div class=&quot;thumbcaption&quot;&gt;
//# 			&lt;div class=&quot;magnify&quot; style=&quot;float:right&quot;&gt;
//# 				&lt;a href=&quot;/wiki/Image:Stockholm.jpg&quot; class=&quot;internal&quot; title=&quot;Enlarge&quot;&gt;
//# 				&lt;img src=&quot;/skins-1.5/common/images/magnify-clip.png&quot; width=&quot;15&quot; height=&quot;11&quot; alt=&quot;Enlarge&quot; /&gt;
//# 				&lt;/a&gt;
//# 			&lt;/div&gt;
//# 			Stockholm panorama from the City Hall
//# 		&lt;/div&gt;
//# 	&lt;/div&gt;
//# &lt;/div&gt;
{
	name: 'mediaWikiImage',
	match: '\\[\\[(?:[Ii]mage|Bild):',
	lookaheadRegExp: /\[\[(?:[Ii]mage|Bild):/mg,
	defaultPx: 180,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {
			var params = MediaWikiFormatter.getParams(w);
			var src = params[1];
			src = src.trim().replace(/ /mg,'_');
			src = src.substr(0,1).toUpperCase() + src.substring(1);
			var palign = null;
			var ptitle = null;
			var psrc = false;
			var px = null;
			var pthumb = false;
			var pframed = false;
			for(var i=2;i&lt;params.length;i++) {
				//# right, left, center, none, sizepx, thumbnail (thumb), frame, and alternate (caption) text.
				var p = params[i];
				if(p=='right'||p=='left'||p=='center'||p=='none') {
					palign = p;
				} else if(p=='thumbnail'||p=='thumb') {
					pthumb = true;
				} else if(p=='framed') {
					pframed = true;
				} else if(/\d{1,4} ?px/.exec(p)) {
					px = p.substr(0,p.length-2).trim();
				} else {
					ptitle = p;
				}
			}//#end for
			if(pthumb) {
				//#var output = w.output.nodeType==1 &amp;&amp; w.output.nodeName=='P' ? w.output.parentNode : w.output;
				var output = w.output;
				if(!palign) {
					palign = 'right';
				}
				if(!px) {
					px = 180;
				}
				psrc = px + 'px-' + src;
				var t = createTiddlyElement(output,'div',null,'thumb'+(palign?' t'+palign:''));
				var s = createTiddlyElement2(t,'div');
				s.style['width'] = Number(px) + 2 + 'px';
				var a = createTiddlyElement(s,'a',null,'internal');
				if(config.options.chkMediaWikiDisplayEnableThumbZoom) {
					a.href = src;
				}
				a.title = ptitle;
				var img = createTiddlyElement2(a,'img');
				img.src = 'images/' + psrc;
//#mwDebug(w.output,'s1:'+img.src);
				img.width = px;
				img.longdesc = 'Image:' + src;
				img.alt = ptitle;

				var tc = createTiddlyElement(s,'div',null,'thumbcaption');
				var oldSource = w.source; var oldMatch = w.nextMatch;
				w.source = ptitle; w.nextMatch = 0;
				w.subWikifyUnterm(tc);
				w.source = oldSource; w.nextMatch = oldMatch;

				if(config.options.chkMediaWikiDisplayEnableThumbZoom) {
					var tm = createTiddlyElement(tc,'div',null,'magnify');
					tm.style['float'] = 'right';
					var ta = createTiddlyElement(tm,'a',null,'internal');
					ta.title = 'Enlarge';
					timg = createTiddlyElement2(ta,'img'); timg.src = 'magnify-clip.png'; timg.alt = 'Enlarge'; timg.width = '15'; timg.height = '11';
					ta.href = src;
				}
			} else {
				//# not pthumb
				a = createTiddlyElement(w.output,'a',null,'image');
				a.title = ptitle;
				img = createTiddlyElement2(a,'img');
				if(palign) {img.align = palign;}
				img.src = px ? 'images/' + px + 'px-' + src : 'images/' + src;
//#mwDebug(w.output,'s2:'+img.src);
				if(px) {img.width = px;}
				img.longdesc = 'Image:' + src;
				img.alt = ptitle;
			}
		}
	}//#end image handler
},

{
	name: 'mediaWikiExplicitLink',
	match: '\\[\\[',
	lookaheadRegExp: /\[\[(?:([a-z]{2,3}:)?)(#?)([^\|\]]*?)(?:(\]\](\w*))|(\|(.*?)\]\]))/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {
			if(!lookaheadMatch[1]) {
				//# not (eg) [[en:...]]
				var e;
				var link = lookaheadMatch[3];
				var text = link;
				//#var link2 = link;
				link = link.substr(0,1).toUpperCase() + link.substring(1);
				if(lookaheadMatch[4]) {
					//# Simple bracketted link
					if(lookaheadMatch[2]) {
						//# link to anchor
						var a = createTiddlyElement(w.output,'a');
						var t = w.tiddler ? MediaWikiFormatter.normalizedTitle(w.tiddler.title) + ':' : '';
						t = '#' + t + MediaWikiFormatter.normalizedTitle(link);
						a.setAttribute('href',t);
						a.title = '#' + MediaWikiFormatter.normalizedTitle(link);
						createTiddlyText(a,'#'+link);
					} else {
					//#mwDebug(w.output,'fm1:'+w.tiddler.title);
						e = createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
						if(lookaheadMatch[5]) {
							//# add any non-space after the ]]
							text += lookaheadMatch[5];
						}
						createTiddlyText(e,text);
					}
				} else if(lookaheadMatch[6]) {
					//# Piped link
					if(link.charAt(0)==':')
						link = link.substring(1);
					//#if(config.formatterHelpers.isExternalLink(link)) {
					//#	e = createExternalLink(w.output,link);
					//#} else {
					//#mwDebug(w.output,'fm2:'+w.tiddler.title);
						e = createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
					//#}
					var oldSource = w.source; var oldMatch = w.nextMatch;
					w.source = lookaheadMatch[7].trim(); w.nextMatch = 0;
					w.subWikifyUnterm(e);
					w.source = oldSource; w.nextMatch = oldMatch;
				}
			}
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

//#{{Audio|sv-Stockholm.ogg|Stockholm}}
{
	name: 'mediaWikiTemplate',
	match: '\\{\\{[^\\{]',
	lookaheadRegExp: /\{\{((?:.|\n)*?)\}\}/mg,
	handler: function(w)
	{
//# mwDebug(w.output,'wt:'+w.matchText+' ws:'+w.matchStart+' wn:'+w.nextMatch+' wl:'+w.matchLength);
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {
//# mwDebug(w.output,'lm:'+lookaheadMatch);
//# mwDebug(w.output,'lmi:'+lookaheadMatch.index+' lI:'+this.lookaheadRegExp.lastIndex);
//# mwDebug(w.output,'lm1:'+lookaheadMatch[1]);
//# mwDebug(w.output,'lm2:'+lookaheadMatch[2]);
			var lastIndex = this.lookaheadRegExp.lastIndex;
			var contents = lookaheadMatch[1];
			if(MediaWikiFormatter.expandVariable(w,contents)) {
				w.nextMatch = lastIndex;
				return;
			}
			var i = contents.indexOf('|');
			var title = i==-1 ? contents : contents.substr(0,i);
			//# normalize title
			title = title.trim().replace(/_/mg,' ');
			title = 'Template:' + title.substr(0,1).toUpperCase() + title.substring(1);
			var tiddler = store.fetchTiddler(title);
			var oldSource = w.source;
			if(tiddler) {
				params = {};
				if(i!=-1) {
					//#w.nextMatch = 0;
					params = MediaWikiFormatter.getTemplateParams(lookaheadMatch[1]);
				}
				w.source = MediaWikiFormatter.expandTemplate(w,tiddler.text,params);
				w.nextMatch = 0;
				w.subWikifyUnterm(w.output);
			} else {
				if(config.options.chkMediaWikiDisplayEmptyTemplateLinks) {
					//# for conveniece, output the name of the template so can click on it and create tiddler
					w.source = '[['+title+']]';
					w.nextMatch = 0;
					w.subWikifyUnterm(w.output);
				}
			}
			w.source = oldSource;
			w.nextMatch = lastIndex;
		}
	}
},

{
	name: 'mediaWikiParagraph',
	match: '\\n{2,}',
	handler: function(w)
	{
		//#var output = w.output.nodeType==1 &amp;&amp; w.output.nodeName=='P' ? w.output.parentNode : w.output;
		w.output = createTiddlyElement2(w.output,'p');
	}
},

{
	name: 'mediaWikiExplicitLineBreak',
	match: '&lt;br ?/?&gt;',
	handler: function(w)
	{
		createTiddlyElement2(w.output,'br');
	}
},

{
	name: 'mediaWikiExplicitLineBreakWithParams',
	match: &quot;&lt;br(?:\\s*(?:(?:.*?)=[\&quot;']?(?:.*?)[\&quot;']?))*?\\s*/?&gt;&quot;,
	lookaheadRegExp: /&lt;br((?:\s+(?:.*?)=[&quot;']?(?:.*?)[&quot;']?)*?)?\s*\/?&gt;/mg,
	handler: function(w)
	{
		//# copes with erroneous &lt;br clear='right'&gt;
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {
			var e =createTiddlyElement2(w.output,'br');
			if(lookaheadMatch[1]) {
				MediaWikiFormatter.setAttributesFromParams(e,lookaheadMatch[1]);
			}
			w.nextMatch = this.lookaheadRegExp.lastIndex;// empty tag
		}
	}
},

{
	name: 'mediaWikiTitledUrlLink',
	match: '\\[' + config.textPrimitives.urlPattern + '(?:\\s+[^\\]]+)?' + '\\]',
	//# eg [http://www.nupedia.com] or [http://www.nupedia.com Nupedia]
	//# &lt;sup id='_ref-1' class='reference'&gt;&lt;a href='#_note-1' title=''&gt;[2]&lt;/a&gt;
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp('\\[(' + config.textPrimitives.urlPattern + ')(?:\\s+([^\[]+))?' + '\\]','mg');
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source);
		if(lookaheadMatch &amp;&amp; lookaheadMatch.index==w.matchStart) {
			var link = lookaheadMatch[1];
			if(lookaheadMatch[2]) {
				var e = createExternalLink(w.output,link);
				var oldSource = w.source; var oldMatch = w.nextMatch;
				w.source = lookaheadMatch[2].trim(); w.nextMatch = 0;
				w.subWikifyUnterm(e);
				w.source = oldSource; w.nextMatch = oldMatch;
			} else {
				e = createExternalLink(createTiddlyElement2(w.output,'sup'),link);
				w.linkCount++;
				createTiddlyText(e,'['+w.linkCount+']');
			}
			w.nextMatch = lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: 'mediaWikiUrlLink',
	match: config.textPrimitives.urlPattern,
	handler: function(w)
	{
		w.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);
	}
},

{
	name: 'mediaWikiBoldItalic',
	match: &quot;'''''&quot;,
	termRegExp: /('''''|(?=\n))/mg,
	element: 'strong',
	handler: function(w)
	{
		var e = createTiddlyElement(w.output,this.element);
		w.subWikifyTerm(createTiddlyElement(e,'em'),this.termRegExp);
	}
},

{
	name: 'mediaWikiBold',
	match: &quot;'''&quot;,
	termRegExp: /('''|(?=\n))/mg,
	element: 'strong',
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: 'mediaWikiItalic',
	match: &quot;''&quot;,
	termRegExp: /((?:''(?!'))|(?=\n))/mg,
	element: 'em',
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: 'mediaWikiUnderline',
	match: '&lt;u&gt;',
	termRegExp: /(&lt;\/u&gt;|(?=\n))/mg,
	element: 'u',
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: 'mediaWikiStrike',
	match: '&lt;s&gt;',
	termRegExp: /(&lt;\/s&gt;|(?=\n))/mg,
	element: 'strike',
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: 'mediaWikiBoldTag',
	match: '&lt;b&gt;',
	termRegExp: /(&lt;\/b&gt;|(?=\n))/mg,
	element: 'b',
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: 'mediaWikiItalicTag',
	match: '&lt;i&gt;',
	termRegExp: /(&lt;\/i&gt;|(?=\n))/mg,
	element: 'i',
	handler: config.formatterHelpers.createElementAndWikify
},

{
	//# note, this only gets invoked when viewing the template
	name: 'mediaWikiTemplateParam',
	match: '\\{\\{\\{',
	lookaheadRegExp: /(\{\{\{(?:.|\n)*?\}\}\})/mg,
	element: 'span',
	handler: config.formatterHelpers.enclosedTextHelper
},

//# See http://en.wikipedia.org/wiki/Wikipedia:Footnotes
//# for an explanation of how to generate footnotes using the &lt;ref(erences/)&gt; tags
{
	name: 'mediaWikiInsertReference',
	match: '&lt;ref[^/]*&gt;',
	lookaheadRegExp: /&lt;ref(\s+(?:.*?)=[&quot;']?(?:.*?)[&quot;']?)?&gt;([^&lt;]*?)&lt;\/ref&gt;/mg,
	//#lookaheadRegExp: /&lt;ref(\s+(?:.*?)=[&quot;']?(?:.*?)[&quot;']?)?&gt;([.\n]*?)&lt;\/ref&gt;/mg,
	handler: function(w)
	{
		if(config.browser.isIE) {
			refRegExp = /&lt;ref[^\/]*&gt;((?:.|\n)*?)&lt;\/ref&gt;/mg;
			refRegExp.lastIndex = w.matchStart;
			var refMatch = refRegExp.exec(w.source);
			if(refMatch &amp;&amp; refMatch.index == w.matchStart) {
				w.nextMatch = refRegExp.lastIndex;
				return;
			}
		}
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {
			var x = {id:'',value:''};
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			if(!w.referenceCount) {
				w.referenceCount = 0;
				w.references = {};
			}
			var s = createTiddlyElement(w.output,'sup',null,'reference');
			var a = createTiddlyElement2(s,'a');
			var prefix = w.tiddler ? w.tiddler.title + ':' : '';
			var name;
			if(lookaheadMatch[1]) {
				//# &lt;ref params&gt;
				//#var r = {};
				var r = MediaWikiFormatter.setFromParams(w,lookaheadMatch[1]);
				name = r.name ? r.name.trim() : '';
				name = name.replace(/ /g,'_');
				s.id = prefix + '_ref-' + name;// + '_' + nameCount;(w.referenceCount+1);
				if(!w.references[name]) {
					w.references[name] = x;
					w.references[name].id = w.referenceCount;
					w.references[name].value = lookaheadMatch[2].trim();
				}
			} else {
				//# &lt;ref&gt;, repeat reference
				w.references[w.referenceCount] = x;
				w.references[w.referenceCount].id = w.referenceCount;
				w.references[w.referenceCount].value = lookaheadMatch[2].trim();
				name = w.referenceCount;
				s.id = prefix + '_ref-' + w.referenceCount;
			}
			w.referenceCount++;
			a.title = lookaheadMatch[2].trim();//mb, extra to wikipedia
			a.href = '#' + prefix + '_note-' + name;
			a.innerHTML = '['+w.referenceCount+']';
//#&lt;sup id='_ref-0' class='reference'&gt;&lt;a href='#_note-0' title=''&gt;[1]&lt;/a&gt;&lt;/sup&gt;
//#&lt;sup id='_ref-foreign_ministry_0' class='reference'&gt;&lt;a href='#_note-foreign_ministry' title=''&gt;[2]&lt;/a&gt;&lt;/sup&gt;
		}
	}
},

{
	name: 'mediaWikiListReferences',
	match: '&lt;references ?/&gt;',
	lookaheadRegExp: /&lt;references ?\/&gt;/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(config.options.chkMediaWikiListReferences &amp;&amp; w.referenceCount) {
			var ol = createTiddlyElement(w.output,'ol',null,'references');
			var oldSource = w.source;
			if(w.referenceCount&gt;0) {
				for(var i in w.references) {
					var li = createTiddlyElement2(ol,'li');
					var prefix = w.tiddler ? w.tiddler.title + ':' : '';
					var b = createTiddlyElement2(li,'b');
					var a = createTiddlyElement2(b,'a');
					li.id = prefix + '_note-' + i;
					a.href = '#' + prefix + '_ref-' + i;
					a.innerHTML = '^';
					w.source = w.references[i].value;
					w.nextMatch = 0;
					w.subWikifyUnterm(li);
				}
			}
			w.source = oldSource;
		}
		w.nextMatch = this.lookaheadRegExp.lastIndex;
	}
},

{
	name: 'mediaWikiRepeatReference',
	match: '&lt;ref[^/]*/&gt;',
	lookaheadRegExp: /&lt;ref(\s+(?:.*?)=[&quot;'](?:.*?)[&quot;'])?\s*\/&gt;/mg,
	handler: function(w)
	{
		if(config.browser.isIE) {
			refRegExp = /&lt;ref.*?\/&gt;/mg;
			refRegExp.lastIndex = w.matchStart;
			var refMatch = refRegExp.exec(w.source);
			if(refMatch &amp;&amp; refMatch.index == w.matchStart) {
				w.nextMatch = refRegExp.lastIndex;
				return;
			}
		}
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {
			var x = {id:'',value:''};
			w.nextMatch = this.lookaheadRegExp.lastIndex;
//#&lt;ref name=&quot;foreign ministry&quot;&gt;
//#&lt;sup id=&quot;_ref-foreign_ministry_1&quot; class=&quot;reference&quot;&gt;&lt;a href=&quot;#_note-foreign_ministry&quot; title=&quot;&quot;&gt;[2]&lt;/a&gt;&lt;/sup&gt;
			var s = createTiddlyElement(w.output,&quot;sup&quot;,null,&quot;reference&quot;);
			var a = createTiddlyElement2(s,&quot;a&quot;);
			var prefix = w.tiddler ? w.tiddler.title : '';
			if(lookaheadMatch[1]) {
				var r = {};
				r = MediaWikiFormatter.setFromParams(w,lookaheadMatch[1]);
				var name = r.name ? r.name.trim() : '';
				name = name.replace(/ /g,'_');
				s.id = prefix + '_ref-' + name +'_' + (w.referenceCount+1);
				var count = w.references &amp;&amp; w.references[name] ? (w.references[name].id+1) : '?';
			}
			a.href = '#' + prefix + '_note-' + name;
			a.innerHTML = '['+count+']';
			a.title = name;
		}
	}//# end handler
},

{
	name: 'mediaWikiHtmlEntitiesEncoding',
	match: '&amp;#?[a-zA-Z0-9]{2,8};',
	handler: function(w)
	{
		if(!config.browser.isIE)
			createTiddlyElement(w.output,&quot;span&quot;).innerHTML = w.matchText;
	}
},

{
	name: 'mediaWikiComment',
	match: '&lt;!\\-\\-',
	lookaheadRegExp: /&lt;!\-\-((?:.|\n)*?)\-\-&gt;/mg,
	//#lookaheadRegExp: /&lt;!\-\-([.\n]*?)\-\-&gt;/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: 'mediaWikiIncludeOnly',
	match: '&lt;includeonly&gt;',
	lookaheadRegExp: /&lt;includeonly&gt;((?:.|\n)*?)&lt;\/includeonly&gt;/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: 'mediaWikiNoWiki',
	match: '&lt;nowiki&gt;',
	lookaheadRegExp: /&lt;nowiki&gt;((?:.|\n)*?)&lt;\/nowiki&gt;/mg,
	element: 'span',
	handler: config.formatterHelpers.enclosedTextHelper
},

{
	name: 'mediaWikiPreNoWiki',
	match: '&lt;pre&gt;\s*&lt;nowiki&gt;',
	lookaheadRegExp: /&lt;pre&gt;\s*&lt;nowiki&gt;((?:.|\n)*?)&lt;\/nowiki&gt;\s*&lt;\/pre&gt;/mg,
	element: 'pre',
	handler: config.formatterHelpers.enclosedTextHelper
},

{
	name: 'mediaWikiPre',
	match: '&lt;pre&gt;',
	lookaheadRegExp: /&lt;pre&gt;((?:.|\n)*?)&lt;\/pre&gt;/mg,
	element: 'pre',
	handler: config.formatterHelpers.enclosedTextHelper
},

{
	name: 'mediaWikiMagicWords',
	match: '__',
	lookaheadRegExp: /__([A-Z]*?)__/mg,
	//# see http://meta.wikimedia.org/wiki/Help:Magic_words
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {
			//# deal with variables by name here
			if(lookaheadMatch[1]=='NOTOC') {
				//# do nothing
			} else if(config.options.chkDisplayMediaWikiMagicWords) {
				//# just output the text of any variables that are not understood
				w.outputText(w.output,w.matchStart,w.nextMatch);
			}
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: 'mediaWikiGallery',
	match: '&lt;gallery&gt;',
	lookaheadRegExp: /[Ii]mage:(.*?)\n/mg,
	handler: function(w)
	{
//#basic syntax is:
//#&lt;gallery&gt;
//#Image:Wiki.png
//#Image:Wiki.png|Captioned
//#Image:Wiki.png|[[Help:Contents/Links|Links]] can be put in captions.
//#Image:Wiki.png|Full [[MediaWiki]]&lt;br /&gt;[[syntax]] may now be used�
//#&lt;/gallery&gt;
//#&lt;table class=&quot;gallery&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot;&gt;
//#&lt;tr&gt;
//#...
//#&lt;/tr&gt;
//#&lt;/table&gt;
		var table = createTiddlyElement(w.output,'table',null,'gallery');
		table.cellspacing = '0';
		table.cellpadding = '0';
		var rowElem = createTiddlyElement2(table,'tr');
		var col = 0;
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var nM = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		var oldSource = w.source;
		while(lookaheadMatch) {
			nM += lookaheadMatch[1].length;
			w.source = lookaheadMatch[1] +']]';//!! ]] is hack until getParams is working
			w.nextMatch = 0;
			var params = MediaWikiFormatter.getParams(w);
			var src = params[1];
			src = src.trim().replace(/ /mg,'_');
			src = src.substr(0,1).toUpperCase() + src.substring(1);
			var palign = 'right'; 
			var psrc = '120px-'+src;
			var px = 120;
			var pframed = false;
			ptitle = null;
			for(var i=2;i&lt;params.length;i++) {
				//# right, left, center, none, sizepx, thumbnail (thumb), frame, and alternate (caption) text.
				var p = params[i];
				if(p=='right'||p=='left'||p=='center'||p=='none') {
					palign = p;
				} else if(p=='framed') {
					pframed = true;
				} else if(/\d{1,4}px/.exec(p)) {
					px = p.substr(0,p.length-2).trim();
					psrc = px + 'px-' + src;
				} else {
					ptitle = p;
				}
			}//#end for
//#&lt;td&gt;
//#&lt;div class=&quot;gallerybox&quot;&gt;
//#	&lt;div class=&quot;thumb&quot; style=&quot;padding: 26px 0;&quot;&gt;
//#		&lt;a href=&quot;/wiki/Image:Paul_C%C3%A9zanne_184.jpg&quot; title=&quot;Image:Paul C�zanne 184.jpg&quot;&gt;
//#		&lt;img src=&quot;http://upload.wikimedia.org/wikipedia/commons/thumb/6/60/Paul_C%C3%A9zanne_184.jpg/120px-Paul_C%C3%A9zanne_184.jpg&quot; width=&quot;120&quot; height=&quot;94&quot; alt=&quot;&quot; /&gt;
//#		&lt;/a&gt;
//#	&lt;/div&gt;
//#	&lt;div class=&quot;gallerytext&quot;&gt;
//#		&lt;p&gt;&lt;i&gt;La Pain et les Oeufs&lt;/i&gt; (Bread and Eggs), thought to present austerity, 1865. Signed and dated. Possibly in Spanish style.&lt;/p&gt;
//#	&lt;/div&gt;
//#&lt;/div&gt;
//#&lt;/td&gt;
			var td = createTiddlyElement2(rowElem,'td');
			var gb = createTiddlyElement(td,'div',null,'gallerybox');
			var t = createTiddlyElement(gb,'div',null,'thumb');
			t.style['padding'] = '26px 0';

			var a = createTiddlyElement2(t,'a');
			if(config.options.chkMediaWikiDisplayEnableThumbZoom) {
				a.href = src;
			}
			a.title = ptitle;
			var img = createTiddlyElement2(a,'img');
			img.src = psrc;
			img.width = px;
			//#ptitle;
			img.alt = '';

			var gt = createTiddlyElement(gb,'div',null,'gallerytext');
			p = createTiddlyElement2(gt,'p');
			var oldSource2 = w.source; var oldMatch = w.nextMatch;
			w.source = ptitle; w.nextMatch = 0;
			w.subWikifyUnterm(p);
			w.source = oldSource2; w.nextMatch = oldMatch;

			col++;
			if(col&gt;3) {
				rowElem = createTiddlyElement2(table,'tr');
				col = 0;
			}
			w.source = oldSource;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
		w.nextMatch = nM + '&lt;gallery&gt;'.length*2+1+'Image:'.length;//!! hack
	}
},

{
	name: 'mediaWikiHtmlTag',
	match: &quot;&lt;[a-zA-Z]{2,}(?:\\s*(?:(?:.*?)=[\&quot;']?(?:.*?)[\&quot;']?))*?&gt;&quot;,
	lookaheadRegExp: /&lt;([a-zA-Z]{2,})((?:\s+(?:.*?)=[&quot;']?(?:.*?)[&quot;']?)*?)?\s*(\/)?&gt;/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {
			var e =createTiddlyElement2(w.output,lookaheadMatch[1]);
			if(lookaheadMatch[2]) {
				MediaWikiFormatter.setAttributesFromParams(e,lookaheadMatch[2]);
			}
			if(lookaheadMatch[3]) {
				//# empty tag
				w.nextMatch = this.lookaheadRegExp.lastIndex;
			} else {
				w.subWikify(e,'&lt;/'+lookaheadMatch[1]+'&gt;');
			}
		}
	}
}
];

config.parsers.mediawikiFormatter = new Formatter(config.mediawiki.formatters);
config.parsers.mediawikiFormatter.format = 'mediawiki';
config.parsers.mediawikiFormatter.formatTag = 'MediaWikiFormat';
} //# end of 'install only once'
//}}}
</pre>
</div>
<div title="Monolith Human Interface Guide" modifier="mikelietz" modified="200807241346" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>Inside out, Habari is being designed to be modern, elegant and user friendly. The administrative interface is representative of this approach, and is meant to provide you with the path of least resistance to your goal, while still letting you retain fine-grained control.

Most of what is described in this document, by its very nature should be intuitive and self-explanatory. However, in an effort to maintain these hard-won properties at the benefit of all involved--users and developers alike--this document serves as a guide for working on or adding to Habari's administration interface.

Habari's compartmentalized approach to development dictates that the core of Habari contain only the most essential functionality, leaving bells and whistles to be provided through its powerful plugin architecture.

This mindset should be kept at the forefront of the interface design aspects of Habari as well.

For developers contributing to the core of Habari's administration interface, this means staying the path, and not giving in to the urge to force upon it, features it doesn't need.

For third-party developers, this means focusing on doing a few things great, rather than a lot of things averagely.

For everyone involved, it means honoring the spirit of Habari's powerful simplicity.

== General Guidelines ==

There are some basic rules that will help integrate most plugin option pages, new media silos and the like into the existing style of the interface:
* Retain Existing Practices
* Reuse Elements
* Less is More

Layout structurally, most elements, be it text or form elements, are held inside a centered column of containers. While this provides structure and segregation, it is generally a good rule of thumb for the elements themselves to imply the structure.

==== A Word on the Use of Colors ====

The majority of Habari's administration interface is kept in the neutral shades of grayscale, with colors being used only when truly needed, or at the very least when they distract the least. This is done to keep the administration interface 'genderless', and to promote the use of shapes and contrast as the primary aides in guiding the user.

Therefore, please consider with great care the addition of color to an element. Does the color serve a user-centric purpose? Does it enhance the use of the elements, or would it do just as well being grayscale? Does it call unwanted attention to itself, at the cost of other, perhaps more important elements?

Related to the use of colors is the use of flat, graded and pseudo-3D elements. Generally speaking, gradients aren't used for anything except to indicate shadows, leaving the vast majority of the elements in the Habari administration interface flat-shaded.

==== A Word on Blueprint CSS ====

The Habari administration interface makes use of a CSS framework called Blueprint CSS to encourage a more coherent and homogeneous look and feel. You can read more about Blueprint CSS and its many virtues elsewhere. Suffice it to say, that it is good practice to stay as much as possible within the confines of its column system whenever possible.

If you do need to lay out differently from what Blueprint CSS allows, consider if there exists a precedent for what you're trying to achieve, and consider adapting or reusing that solution instead, if possible.

==== A Word on Width ====

There are basically three widths in Habari's administration interface:

* '''Single column, 790px wide.'''  This is how most of Habari's administration interface is laid out, including the create, options and manage pages. Most of the content should be kept in individual containers, with new containers for each set of content (as per the Configure pages). 
* '''Multiple column, xxxpx wide.'''  For pages like 'Activity', where the purpose of the page is to present the user with an overview of the site's activity, the data ´might be best presented in multiple columns, both to increase the data intake, but also to save the user from having to scroll, thus speeding up the time it takes to gain an overview.
* '''Full-width pagesplitter. ''' While using it for full-width elements isn't mandatory, the pagesplitter was designed specifically for this particular use, like for instance the timeline on the manage pages or the media silo plugins. A more in-depth description of its use and operation can be found later in this document.

As with everything else, it is suggested that you follow examples already set by the interface layout, if at all possible. And if that isn't possible, to at least stay in the 'spirit' of the layout.


== The Menu Bar ==

Habari's near-black menu bar stays fixed to the top of the browser window, regardless of scrolling, making it always available to the user.. It contains to its extreme left, the menu itself, which is described below. And to its extreme right, a link to and the name of, the site for which this is the administration interface.

=== The Menu === 

The function of The Menu isn't that different from that of the Windows Start button; namely to provide a single point of entry to the entirety of the Habari administration interface. As such any and all pages available in the administration interface are, and should be, available from this menu.
The Menu is a 'dropbutton', which serves both as a menu as well as a title for the page you are currently on. Dropbuttons are described in greater detail later in this document, but the basic gist is that upon hovering the dropbutton, a menu will reveal itself.
One thing differentiates The Menu from the rest of the dropbuttons in Habari; it has sub-menus. Also worth noting is that the parents of these sub-menus are themselves proxy links of the first item in the sub-menu. Because of this behavior, items in a sub-menu should obviously be directly related to the sub-menu's parent, with the most related and most likely to be used item, at the very top.
Aside from appearing as the label on the dropbutton itself, function thus as a title for the current page, the item for the current page is also marked in The Menu listing itself by a small 'V' mark, to differentiate it.

==== The 'Content/Admin' Menu Structure ====

All the available pages in the Habari administration interface fall into one of two categories:

'''Content:''' Create, Comments, Entries, Pages and Tags Habari's raison d'être is the creation, publication and management of content. Whether it be entries, comments or tags.

'''Admin:''' Activity, Configure, Themes, Plugins, Import, Users and Logs Anything not directly related to the creation and management of content is Admin, including the configuration of Habari itself, activating and deactivating themes or plugins, creating and administrating users.

At the bottom of The Menu, the item 'Logout' is to be found. It obviously falls outside of the category system.

==== Adding Custom Pages to the Menu ====

Not only does the addition of new pages to The Menu confuse the users, but The Menu itself can only hold so many items before it becomes confusing, and thus inefficient. Adding new pages to the administration page structure is therefore generally to be avoided unless absolutely necessary.
Habari has a framework in place which allows plugins and themes what essentially amounts to their own page, nestled in the confines of the Configure 'section' of the administration structure.

It is understood however, that some plugins might service the user better by being more readily available, for instance by having a place in the main menu itself. If this is the case, please consider with great care where the menu item best serves the user, rather than where it might get the most exposure.
Use the above section on the Content/Admin structure to determine where your page would work best, and whether or not it might best serve as in a sub-menu.


== Custom Controls ==

To help make Habari's administration interface as efficient as possible, a few custom controls have been created, the operation of which should be self-evident, but the use of which might require some guidance.

=== The Dropbutton ===

To conserve space and speed up the decision-to-action response time, a new control was devised, which operates as a cross between a dropdown menu and a button. Here's how it works:

* When inactive, the dropbutton has a the topmost item in its list as its label.
* Hovering the dropbutton will immediately reveal its list and allow it to be navigated.
* Clicking the dropbutton itself, will activate the topmost link.
* Clicking any link in the dropdown, will obviously activate said link.

When implementing a dropbutton, it is important to pay attention to the order of items in the list, in particular the first item, which will of course be the label of the button, and thus should be the most likely to be used, or at least the most descriptive for the collection of items in the list.

If a dropbutton has only a single item in it, it goes without saying that it won't have its dropmenu (and accompanying arrow).

If it is important for the user to recognize the presence of an item in the dropdown, and there is concern that he or she might overlook it, a separate one-item dropbutton can be placed next to the dropbutton with the individual item. This might be an 'update' item only available under certain circumstances, and which would in all likelihood require action when present.

A feature that needs some usability testing before it can be okay’d is for the dropbuttons, when used in repeating setups, like a list of comments, as on the Comments page, clicking an item in the list (except of course the topmost one), would change all the repeating dropbuttons to use that item as their topmost one. This might help when going through for instance a list of comments and marking individual comments as spam, that it would make the process faster, by adapting the interface to the current task being performed.

Dropbutton Implementation

While the dropbutton employs javascript to hold its menu open for a short while even after the mouse leaves the dropbutton, it works almost as well in a non-JS environment.

While the dropbutton was made to work as a fold-out list of actions, it can work just as well without a list, which may sometimes be a preferable way to present links that represent ‘actions’.

And finally, the dropbutton resizes itself horizontally to accomodate lengthier text, up to 120px. Anything larger than that gets cropped, or in the case of browsers supporting the text-overflow CSS property, cropped and appended with an ellipsis.
Its code looks like this:

&lt;source lang=&quot;html4strict&quot;&gt;
&lt;div class=&quot;dropbutton&quot;&gt;
	&lt;a href=&quot;#&quot;&gt;Action #1&lt;/a&gt;
	&lt;ul&gt;
		&lt;li&gt;&lt;a href=&quot;#&quot;&gt;Action #2&lt;/a&gt;&lt;/li&gt;
		&lt;li&gt;&lt;a href=&quot;#&quot;&gt;Action #3&lt;/a&gt;&lt;/li&gt;
	&lt;/ul&gt;
&lt;/div&gt;
&lt;/source&gt;

For update buttons and other buttons of high importance, the ‘alert’ class can be applied to color the button orange-red, so as to be more visible.

=== Tabs and Pagesplitter ===

The purpose of the tabs, alongside the pagesplitter, is to hide from view sections of a page which are not essential to the basic operation of the page; thus minimizing the amount of clutter. These include advanced settings, media silos, timelines and the like.

Clicking an inactive tab opens its pagesplitter. Clicking an active tab closes its pagesplitter. Clicking an inactive tab when another tab is active closes the active tab and in turn opens the newly selected tab's pagesplitter.

A tab row can include any number of tabs, of which either none or only a single tab can be active at any given time. Up to an including seven tabs (each tab in a row being 100px wide) will display in a row, and beyond that, in a dropbutton, like so:

Tabs are bound to a Pagesplitter, so called because it 'splits' the page, revealing what is behind it. As only a single tab in a row of tabs can be active at any given time, it goes without saying that only a single Pagesplitter can be active at any given time, per tab row.

Multiple tab rows per page are possible, though it is strongly suggested that tab rows not be placed one after the other, without any other page elements in-between.

It is also strongly suggested that tabs be placed in relation to any other content they might be related to, as in the case of media silos being placed just prior to the content area on the Create pages, or the Timeline being placed after the main navigation area, but before the content area on the Comments page. 
Also, due to their full-width nature, they need to be placed outside of any other containers.

A design for vertically-resizable pagesplitters has been suggested, but at the time of writing has not seen implementation.

=== The Timeline ===

The activity timeline is a combined poor-man's statistics graph as well as an indicator of where in the content-archive the currently viewed items belong.
In its default monthly view, the timeline graph basically consists of a number of 1-pixel wide columns, each representative of a single comment or entry. Thus, if one month has seen 100 comments, and another month saw 200 comments, they would be a 100px and 200px wide respectively, showing one month to have been twice as active as the other.

The 'loupe' is a transparent slider, which functions both as an indicator of the current position in the archives timeline, and at the same time as a control for moving around in those archives as well as setting the amount of items viewed. It is per default 20 pixels wide--thus showing 20 items of content--but can be resized in 20 pixel increments up to 100.

The loupe functions as a handle, which can be dragged and dropped on the slider that is the timeline, allowing the user to easily move his view to an approximate point in time.

Here is how the user can interact with it:

* Clicking and holding in the center of the loupe allows it to be dragged and dropped in 20-pixel increments on the timeline, which in turn will reload the results.
* The loupe can be resized in increments of 20 by dragging its sides.
* Clicking on the timeline, will shift the loupe its own length in the direction of the click.
* Double-clicking the timeline will shift the loupe directly to the double-clicked position.

Note: The following is a feature-suggestion only, pending testing of its implementation viability. Concerns are primarily bandwidth needed and the ensuing loading speeds.

Because each listed item corresponds directly to a 1-pixel-wide column in the timeline, elements on the page can interact with the timeline, to provide the user visually with valuable data. By hovering for instance a name, an IP or an entry name, the related items in the timeline highlight themselves, after which they slowly fade out again.

This allows for the user to hover the name of an entry on the Comments page, and have the density of comments for said entry highlighted on the timeline. On mouseout, the timeline items slowly fade out, allowing the user enough time to realign and/or resize the loupe to take a closer look.

=== The Tag Weight Graph ===

Tags themselves have no timestamp, as they are used at will, and so make no sense in a timeline. Tags however have a 'weight', indicative of how many entries they have been used with. On the Tags page, this weight is used to display a timeline-similar graph that can be similarly operated.

=== Inline Labels ===

As seen in particular on the Create pages, some form elements have had their label moved into their content area of their target form element. This was done to create as lean and trim a layout as possible, but comes at the cost of possible confusion on the part of the user once those elements have been filled out with user data, and the labels are no longer accessible.

As an aid, elements with inline labels have small 'glue on' labels attached to them on focus and hover.

When using inline labels, it is very important that to do so with the greatest care, and preferably as sparingly as possible. Here are a few guidelines:

* To the extent possible, elements by its size and position, should describe itself.
* The page should be used often enough that the user easily memorizes the inline labels, based on the sizes and positions of the elements.
* The page should preferably contain few, easily distinguishable elements.

Ideal pages for inline labels are the Login page and the Create pages. Using inline labels on options pages and the like is likely to only confuse the user, and should be avoided.

=== Resize Handles ===

Some elements, like textareas, benefit greatly from being resizable, to allow the user greater overview and a better use of their vertical (or in some cases horizontal) screen space. Wherever the resize handles are visible next to an element, they can be dragged and dropped, resizing the element in the process.
Sliders

A slider consists of a rail with a drag and droppable handle. Changing the position of the handle on the rail, affects the page in some fashion. One such use in the Habari administration interface is on the Manage pages (Comments, Entries, Pages), where a slider controls the amount of content being shown, from everything through excerpts to nothing.

The slider is a powerful and elegant tool when used correctly, and is particularly helpful when the user is called upon to type in values on a scale, like the hue or brightness of a color, or the size of text.

=== Livesearch ===

To speed up the process of filtering results, all search fields in Habari's administration interface use the near-instantaneous 'livesearch', which fetches the results relevant to your query at every keystroke.

=== Search Filtering ===

While not truly a custom control, search filtering is a sibling to livesearch, and is therefore included here.

Using a system similar to Google's advanced operators, the search fields in Habari's administration interface function almost as command lines for filtering content, particularly on the Manage pages. Instead of having a separate page for filtering out draft entries, a simple search for status:draft is made, and only draft entries are shown.

These advanced operators provide an extremely powerful method of filtering, offering the user full control over what is being fetched, and what isn't.
Similarly, all the applicable links on the Manage pages, like the name of a comment author or a date of publication, actually perform a search, which shows up in the search field, and which is subsequently editable by the user.

Similarly to Gmail and Google Reader, the hotkey for switching focus to the Search element is '/'.

For a full description of search filtering, you should refer to the [[Search Filters|search filtering reference]].

== The Dashboard ==

The dashboard is meant to provide the user with an overview of the current activity on, or relating to, the blog. To achieve this, the dashboard consists of a customizable module system in which the user can freely rearrange, add to or remove modules. Here follows a breakdown of the functionality and operation of the dashboard module system.

=== Frontend Functionality ===
The follow operations are possible for the user, preferably without ever reloading the page:

* Rearrange modules by dragging and dropping them.
* View and change options, like the link for a feed, by clicking a module’s options icon in the top-right corner of module.
* Remove module, from within its options.
* Select a module-type from a dropdown and add it.

=== Backend Functionality ===
The dashboard comes with a default set of basic modules, such as:
* Feed
* Latest Entries
* Latest Comments
* Moderation Queue

It should be possible to add new modules as standard Habari plugins.

Plugin-Modules should show up on the dashboard when activated.

The dashboard comes with a default setup of ‘Latest Entries’ (latest entries module), ‘Latest Comments’ (latest comments module) and ‘Habari Developer Blog’ (feed module).


== Code Guidelines ==

=== Percentage Widths === 

The CSS file for the admin (&lt;tt&gt;/system/admin/css/admin.css&lt;/tt&gt;) contains a set of classes from &lt;tt&gt;.pct5&lt;/tt&gt; to &lt;tt&gt;.pct100&lt;/tt&gt;, which when applied to an element, will set that element to the relevant percentage width.

Whenever applicable and possible, the width used in the admin should be set up using these percentage widths, to make it as easy as possible to later revise widths if necessary. This could for instance be the case if a column-based system is found to be needed down the line.

=== Semantic Classes ===

When introducing new containers on pages in the administration interface, you should consider using classes that are descriptive of the content of said container, even if you yourself won't need them for styling purposes. Their precense might very well aid others in either styling or hooking into your output with javascript.

[[Category:Manual]]</pre>
</div>
<div title="Multi-site Installation" modifier="habari" modified="200710161724" created="200707302048" tags="MediaWikiFormat" server.type="file" server.host="file:///Users/blogworks/Sites/MyHabari/Docs/Habari_Manual.20070916.0135310976.html" server.page.revision="200707302048" changecount="1">
<pre>A single installation of the '''Habari''' source code can power multiple, independent sites.

If you have only a single site, then '''Habari''' will use the config.php file that resides in the same directory as index.php.  This is the default configuration file, and will be used if no site-specific configuration can be found.

In order to run multiple sites, you will first need to create a &lt;code&gt;sites&lt;/code&gt; directory inside your &lt;code&gt;user&lt;/code&gt; directory.  Then, inside &lt;code&gt;user/sites&lt;/code&gt; you will create a directory for each site you want to run.  Inside each of these sub-directories you will place a config.php with that site's configuration directives.

The name of the directory to use for each site is constructed in the following way:
* strip off the protocol used to access the site. http://habariproject.org/en/ becomes habariproject.org/en/
* replace all slashes with periods. So habariproject.org/en becomes habariproject.org.en.
* place any non-standard HTTP port at the beginning of the directory. So habariproject.org/en:8080 becomes 8080.habariproject.org.en

'''Habari''' will traverse the directories in /user/sites looking for the closest match.  So, for a request to www.habariproject.org/en, '''Habari''' will look in the following directories in the following order for a config.php
* www.habariproject.org.en
* habariproject.org.en
* org.en
* www.habariproject.org
* habariproject.org
* org

Additional '''Habari'''-powered sites do not need to use the same domain.  Provided the web server is properly configured, a single installation of the '''Habari''' source code can serve www.habariproject.org, www.habarithemes.org, and www.habari-ya-kazi.com.  Likewise, sub-domains and sub-directories are also supported.

Each '''Habari''' site can use its own themes and plugins, as well as the themes and plugins available to the &quot;main&quot; site.  Simply create /themes and /plugins sub-directories inside each site's directory.  A theme or plugin located in a site's directory structure is only available to that site; while themes and plugins in the top-level /user directory will be available to all sites.

== Notes ==
# Each '''Habari''' site is strictly independent.  Although sites may share themes and plugins located in the top-level /user directory, no data is shared between sites.  User accounts, posts, and settings are completely independent.
# In order for the installation routine to work for a site other than the default site, there '''must''' be a &lt;code&gt;config.php&lt;/code&gt; in that site's directory.
</pre>
</div>
<div title="Multisite" modifier="rickc" modified="200807011123" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>A single installation of the '''Habari''' source code can power multiple, independent sites.

If you have only a single site, then '''Habari''' will use the config.php file that resides in the same directory as index.php.  This is the default configuration file, and will be used if no site-specific configuration can be found.

In order to run multiple sites, you will first need to create a &lt;code&gt;sites&lt;/code&gt; directory inside Habari's &lt;code&gt;user&lt;/code&gt; directory.  Then, inside &lt;code&gt;user/sites&lt;/code&gt; you will create a directory for each site you want to run.  Inside each of these sub-directories you will place a config.php with that site's configuration directives.

The name of the directory to use for each site is constructed in the following way:
* strip off the protocol used to access the site. http://habariproject.org/en/ becomes habariproject.org/en/
* replace all slashes with periods. So habariproject.org/en becomes habariproject.org.en.
* place any non-standard HTTP port at the beginning of the directory. So habariproject.org/en:8080 becomes 8080.habariproject.org.en

'''Habari''' will traverse the directories in /user/sites looking for the closest match.  So, for a request to www.habariproject.org/en, '''Habari''' will look in the following directories under user/sites in the following order for a config.php
* www.habariproject.org.en
* habariproject.org.en
* org.en
* www.habariproject.org
* habariproject.org
* org

Additional '''Habari'''-powered sites do not need to use the same domain.  Provided the web server is properly configured, a single installation of the '''Habari''' source code can serve www.habariproject.org, www.habarithemes.org, and www.habari-ya-kazi.com.  Likewise, sub-domains and sub-directories are also supported.

'''Properly configured''' simply mean that all sites running off one habari installation are configured to point to the same directory. Assume you install '''Habari''' in /home/www and /home/www is configured to be your DocumentRoot. You want to run three sites off this one installation of Habari: ''www.mysite.org'', ''themes.mysite.org'', and ''www.example.org''. 

Install ''www.mysite.org'' in the root of the installation by creating a config file in /home/www. This will be the default site.

Install ''themes.mysite.org'' by creating the directory /home/www/user/sites/themes.mysite.org, then place a config file in that directory for the site.

Install ''www.example.org'' by creating the directory /home/www/user/sites/www.example.org, then place a config file in that directory for the site.

When you configure each of these sites on your webserver, point all of them to /home/www by setting /home/www as their DocumentRoot. When a request is made for one of these sites, '''Habari''' will look in the directories in /user/sites for one that matches the name of the site being requested. If it finds a match, the config file in that directory will be used to load the site. If it isn't able to find a match, '''Habari''' will fall back to the config file located in in '''Habari's''' root directory - in this example, using the config file in /home/www. 

Each '''Habari''' site can use its own themes and plugins, as well as the themes and plugins available to the &quot;main&quot; site.  Simply create /themes and /plugins sub-directories inside each site's directory.  A theme or plugin located in a site's directory structure is only available to that site; while themes and plugins in the top-level /user directory will be available to all sites.

== Notes ==
#'''DocumentRoot''' is the directory which web servers use to supply requested files on the internet. It is often named /htdocs or /www, but doesn't have to be. Any subdirectory on a file system can be set up as the DocumentRoot for a given domain.
# Each '''Habari''' site is strictly independent.  Although sites may share themes and plugins located in the top-level /user directory, no data is shared between sites.  User accounts, posts, and settings are completely independent.
# In order for the installation routine to work for a site other than the default site, there '''must''' be a &lt;code&gt;config.php&lt;/code&gt; in that site's directory.
# Each site can use the type of database desired.
#Sub-directory sites do not correctly function at the moment. Independent domains and subdomains function very well.
#The safest way to name a directory in user/sites is to use the same name as the site it will be hosting.
# When installing a sub-site using SQLite as its database, if the config file just contains a database name, the database file will be created in '''Habari's''' root directory.
[[Category:Manual]]</pre>
</div>
<div title="PageTemplate" modifier="YourName" modified="200801052007" created="200701122350" tags="BlackicityTheme" server.type="file" server.host="file:///Users/blogworks/Sites/MyHabari/Docs/Habari_Manual.20070916.0135310976.html" server.page.revision="200701122313" changecount="4">
<pre>&lt;!--{{{--&gt;

&lt;div id='topMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;div id='sidebar'&gt;
&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="Pingbacks" modifier="Pivwan" modified="200802271815" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>As of revision 756 Habari now supports the sending and recieving of Pingbacks. Displaying them on your site is simple. Let's go over the code you will need to add to your comments template.

By default Habari grabs all the comments for a given post (normal comments, trackbacks, etc) and sorts them into &quot;buckets&quot; for later use.  For instance when we want to display all our comments, we would do something like this:
&lt;source lang=&quot;php&quot;&gt;
if ( $post-&gt;comments-&gt;approved-&gt;count ) {
  foreach ( $post-&gt;comments-&gt;comments-&gt;approved as $comment ) { 
&lt;/source&gt;

The code above checks if there are approved comments for this post, and if so begins a loop to process them for display. The code for displaying pingbacks is much the same:

&lt;source lang=&quot;php&quot;&gt;
if ( $post-&gt;comments-&gt;pingbacks-&gt;count ) {
  foreach ( $post-&gt;comments-&gt;pingbacks-&gt;approved as $pingback ) {
&lt;/source&gt;

If there are approved pingbacks for this post they are processed for display.  Here is complete sample code to display pingbacks:

&lt;source lang=&quot;php&quot;&gt;
&lt;?php if ( $post-&gt;comments-&gt;pingbacks-&gt;count ) : ?&gt;
  &lt;h1&gt;
  &lt;?php 
    echo $post-&gt;comments-&gt;pingbacks-&gt;count . ' ';
    echo _n( 'Pingback', 'Pingbacks', $post-&gt;comments-&gt;pingbacks-&gt;count );
    echo ' ' . to ' ' . $post-&gt;title; ?&gt;
  &lt;/h1&gt;
  &lt;div id=&quot;pings&quot;&gt;
    &lt;ol id=&quot;pings-list&quot;&gt;
      &lt;?php foreach ( $post-&gt;comments-&gt;pingbacks-&gt;approved as $pingback ) : ?&gt;
        &lt;li id=&quot;ping-&lt;?php echo $pingback-&gt;id; ?&gt;&quot;&gt;
          &lt;p&gt;
            &lt;?php
              echo &quot;&lt;a href=\&quot;{$pingback-&gt;url}\&quot;&gt;{$pingback-&gt;name}&lt;/a&gt; &amp;raquo; {$pingback-&gt;content}&quot;;
            ?&gt;
          &lt;/p&gt;
        &lt;/li&gt;
      &lt;?php endforeach; ?&gt;
    &lt;/ol&gt;
  &lt;/div&gt;
&lt;?php endif; ?&gt;
&lt;/source&gt;

The default comments template in the k2 theme will show both pingbacks and comments. To show only comments use the following code.

&lt;source lang=&quot;php&quot;&gt;$post-&gt;comments-&gt;pingbacks-&gt;approved-&gt;count;&lt;/source&gt;

[[Category:Manual]]</pre>
</div>
<div title="Plugin Hooks" modifier="rickc" modified="200807241313" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>''The information available on this page are based on revision 1260.''

Habari plugins are divided into two types: '''actions''' and '''filters'''.
* Actions do something.
* Filters modify something.

The above distinction is a little imprecise: actions can modify things, since objects are passed by reference.  But the intent of actions is to perform some task, and filters are designed to return some modified value.

For example, the filter '''post_insert_allow''' is used to determine if a specific post can be inserted.  Plugins that filter against this hook must accept as their parameters a boolean value, and the post object that is to be inserted.  If the plugin determines that the post should not be inserted, the filter should return a boolean false value.

Plugin hooks are (usually) invoked using the format '''class_method_extra'''.  This makes it easy, when reading a plugin's source code, to see where in the core Habari code the plugin is being invoked.

Plugins connect to the Habari hooks using the format '''type_hookname''', where &quot;type&quot; is either '''action''' or '''filter''' and &quot;hookname&quot; is the hook name as described above.  As an example, consider a plugin that prevents anyone from saving new posts after 10 PM.  The plugin will be invoked by the '''post_insert_allow''' filter, so the plugin will contain a function called '''filter_post_insert_allow'''.  When Habari prepares to insert a post, it will trigger the plugin hook, thereby invoking the plugin's filter.  The plugin's filter would check the local time, and if it's after 10 PM the filter would return boolean false.  The post insertion process of Habari would be short-circuited, and the post would not be saved.

== List of Plugin Hooks ==
=== Actions ===
&lt;pre&gt;
admin/footer.php:		Plugins::act( 'admin_footer', $this );
admin/header.php:		Plugins::act( 'admin_header', $this );
admin/login.php:		Plugins::act( 'admin_header', $this );
admin/login.php:		Plugins::act( 'admin_footer', $this );
admin/plugins.php:		Plugins::act( 'plugin_ui', $configure, $action );
admin/user.php:		Plugins::act( 'theme_admin_user', $user );
classes/actionhandler.php:	Plugins::act( $before_action_method );
classes/actionhandler.php:	Plugins::act( $after_action_method );
classes/adminhandler.php:	Plugins::activate_plugin( $plugin );
classes/ajaxhandler.php:	Plugins::act('ajax_' . $this-&gt;handler_vars['context'], $this);
classes/ajaxhandler.php:	Plugins::act('auth_ajax_' . $this-&gt;handler_vars['context'], $this);
classes/atomhandler.php:	Plugins::act('init_atom');
classes/comment.php:		Plugins::act('comment_insert_before', $this);
classes/comment.php:		Plugins::act('comment_update_' . $fieldname, $this, $this-&gt;$fieldname, $value );
classes/comment.php:		Plugins::act('comment_insert_after', $this);
classes/comment.php:		Plugins::act('comment_update_before', $this);
classes/comment.php:		Plugins::act('comment_update_' . $fieldname, $this, $this-&gt;fields[$fieldname], $value);
classes/comment.php:		Plugins::act('comment_update_after', $this);
classes/comment.php:		Plugins::act('comment_delete_before', $this);
classes/comment.php:		Plugins::act('comment_delete_after', $this);
classes/controller.php:	Plugins::act('handler_' . Controller::instance()-&gt;action, Controller::get_handler_vars());
classes/plugins.php:		Plugins::act('plugin_activation', $file); // For the plugin to install itself
classes/plugins.php:		Plugins::act('plugin_activated', $file); // For other plugins to react to a plugin install
classes/plugins.php:		Plugins::act('plugin_deactivation', $file);  // For the plugin to uninstall itself
classes/plugins.php:		Plugins::act('plugin_deactivated', $file);  // For other plugins to react to a plugin uninstallation
classes/post.php:		Plugins::act('post_insert_before', $this);
classes/post.php:		Plugins::act('post_update_' . $fieldname, $this, ($this-&gt;id == 0) ? null : $value, $this-&gt;$fieldname );
classes/post.php:		Plugins::act('post_status_' . self::status_name($this-&gt;status), $this, null );
classes/post.php:		Plugins::act('post_insert_after', $this);
classes/post.php:		Plugins::act('post_update_before', $this);
classes/post.php:		Plugins::act('post_update_' . $fieldname, $this, $this-&gt;fields[$fieldname], $value );
classes/post.php:		Plugins::act('post_status_' . self::status_name($this-&gt;newfields['status']), $this, $this-&gt;fields['status'] );
classes/post.php:		Plugins::act('post_update_after', $this);
classes/post.php:		Plugins::act('post_delete_before', $this);
classes/post.php:		Plugins::act('post_delete_after', $this);
classes/post.php:		Plugins::act('post_publish_before', $this);
classes/post.php:		Plugins::act('post_publish_after', $this);
classes/theme.php:		Plugins::act('add_template_vars', $this, Controller::get_handler()-&gt;handler_vars);
classes/theme.php:		Plugins::act( 'template_header', $this );
classes/theme.php:		Plugins::act( 'template_footer', $this );
classes/theme.php:		Plugins::act('theme_action', $action, $this, $user_filters);
classes/themes.php:		Plugins::act('init_theme');
classes/update.php:		Plugins::act('update_check');
classes/user.php:		Plugins::act('user_insert_before', $this);
classes/user.php:		Plugins::act('user_insert_after', $this);
classes/user.php:		Plugins::act('user_update_before', $this);
classes/user.php:		Plugins::act('user_update_after', $this);
classes/user.php:		Plugins::act('user_delete_before', $this);
classes/user.php:		Plugins::act('user_delete_after', $this);
classes/user.php:		Plugins::act( 'user_authenticate_successful', self::$identity );
classes/user.php:		Plugins::act( 'user_authenticate_successful', self::$identity );
&lt;/pre&gt;

===Filters===
&lt;pre&gt;
admin/dashboard.php:			Plugins::filter( 'statistics_summary', $stats );
admin/import.php:			Plugins::filter('import_names', $import_names);
admin/import.php:			Plugins::filter('import_stage', '', @$_POST['importer'], @$_POST['stage'], @$_POST['step']);
admin/plugins.php:			Plugins::filter( 'plugin_config', $plugin_actions, $plugin['plugin_id'] );
classes/adminhandler.php:		Plugins::filter( 'admin_publish_list_post_statuses', $statuses );
classes/adminhandler.php:		Plugins::filter( 'publish_controls', $controls, $post );
classes/adminhandler.php:		Plugins::filter( 'adminhandler_post_user_fields', $fields );
classes/adminhandler.php:		Plugins::filter( 'plugin_config', $plugin_actions, $plugin_id );
classes/adminhandler.php:		Plugins::filter( 'adminhandler_post_loadplugins_main_menu', $mainmenus );
classes/atomhandler.php:		Plugins::filter('rsd_api_list', $apis_list);
classes/atomhandler.php:		Plugins::filter( 'rsd', $xml, $this-&gt;handler_vars );
classes/atomhandler.php:		Plugins::filter( 'atom_introspection', $xml, $this-&gt;handler_vars );
classes/atomhandler.php:		Plugins::filter( 'atom_get_comments', $xml, $params, $this-&gt;handler_vars );
classes/atomhandler.php:		Plugins::filter( 'atom_get_entry', $xml, $slug, $this-&gt;handler_vars );
classes/atomhandler.php:		Plugins::filter( 'atom_put_entry', $xml, $slug, $this-&gt;handler_vars );
classes/atomhandler.php:		Plugins::filter( 'atom_get_collection_namespaces', $namespaces );
classes/atomhandler.php:		Plugins::filter( 'atom_get_collection_content_type', $params['content_type'] );
classes/atomhandler.php:		Plugins::filter( 'atom_get_collection', $xml, $params, $handler_vars );
classes/atomhandler.php:		Plugins::filter( 'atom_post_collection', $xml, $this-&gt;handler_vars );
classes/comment.php:			Plugins::filter('comment_insert_allow', $allow, $this);
classes/comment.php:			Plugins::filter('comment_update_allow', $allow, $this);
classes/comment.php:			Plugins::filter('comment_delete_allow', $allow, $this);
classes/comment.php:			Plugins::filter( &quot;comment_{$name}&quot;, $out, $this );
classes/comment.php:			Plugins::filter( &quot;comment_{$name}_{$filter}&quot;, $out, $this );
classes/controller.php:		Plugins::filter('rewrite_request', $start_url);
classes/cronjob.php:			Plugins::filter( $this-&gt;callback, $result, $paramarray );
classes/databaseconnection.php:	Plugins::filter( 'query', $query, $args );
classes/databaseconnection.php:	Plugins::filter( 'query_postprocess', $query, $args );
classes/feedbackhandler.php:		Plugins::filter('spam_filter', $spam_rating, $comment, $this-&gt;handler_vars);
classes/formui.php:			Plugins::filter($this-&gt;success_callback, $result, $this);
classes/formui.php:			Plugins::filter($validator, $valid, $this-&gt;value);
classes/logentry.php:			Plugins::filter( 'insert_logentry', $this );
classes/logentry.php:			Plugins::filter( &quot;logentry_{$name}&quot;, $out, $this );
classes/logentry.php:			Plugins::filter( &quot;logentry_{$name}_{$filter}&quot;, $out, $this );
classes/options.php:			Plugins::filter('option_get_value', $option_value, $name);
classes/plugins.php:			Plugins::filter('activate_plugin', $ok, $file);
classes/plugins.php:			Plugins::filter('deactivate_plugin', $ok, $file);
classes/post.php:			Plugins::filter('post_setslug', $value);
classes/post.php:			Plugins::filter('post_insert_allow', $allow, $this);
classes/post.php:			Plugins::filter('post_update_allow', $allow, $this);
classes/post.php:			Plugins::filter('post_delete_allow', $allow, $this);
classes/post.php:			Plugins::filter('post_publish_allow', $allow, $this);
classes/post.php:			Plugins::filter( &quot;post_{$name}&quot;, $out, $this );
classes/post.php:			Plugins::filter( &quot;post_{$name}_{$filter}&quot;, $out, $this );
classes/rawphpengine.php:		Plugins::filter('include_template_file', $this-&gt;template_dir . $template . '.php', $template);
classes/remoterequest.php:		Plugins::filter( 'remoterequest', $data, $url );
classes/rewriterule.php:		Plugins::filter( 'rewrite_args', $args, $this-&gt;name );
classes/rewriterule.php:		Plugins::filter( 'rewrite_args', $args, $this-&gt;name );
classes/rewriterules.php:		Plugins::filter('default_rewrite_rules', $default_rules);
classes/rewriterules.php:		Plugins::filter('rewrite_rules', $system_rules);
classes/session.php:			Plugins::filter( 'session_read', $dodelete, $session, $session_id );
classes/session.php:			Plugins::filter( 'sessions_clean', $sql, 'read', $args );
classes/session.php:			Plugins::filter( 'sessions_clean', $sql, 'destroy', $args );
classes/session.php:			Plugins::filter( 'sessions_clean', $sql, 'gc', $args );
classes/site.php:			Plugins::filter( 'site_url_' . $name, $url );
classes/site.php:			Plugins::filter( 'site_path_' . $name, $path );
classes/site.php:			Plugins::filter( 'site_dir_' . $name, $path );
classes/stack.php:			Plugins::filter( 'stack_out', $stack, $stack_name );
classes/theme.php:			Plugins::filter( 'template_user_filters', $user_filters );
classes/theme.php:			Plugins::filter( 'template_fallback', $fallback );
classes/user.php:			Plugins::filter('user_insert_allow', $allow, $this);
classes/user.php:			Plugins::filter('user_update_allow', $allow, $this);
classes/user.php:			Plugins::filter('user_delete_allow', $allow, $this);
classes/user.php:			Plugins::filter('user_authenticate', $user, $who, $pw);
classes/userthemehandler.php:		Plugins::filter('theme_act_' . $action, $handled, $this-&gt;theme);
classes/utils.php:			Plugins::filter('slugify', $slug, $string);
classes/xmlrpcexception.php:		Plugins::filter( 'xmlrpcexception_get_message', _t('Unknown XMLRPC Exception'), $code );
classes/xmlrpcserver.php:		Plugins::filter('xmlrpc_methods', $res);
&lt;/pre&gt;

{{developer}}

[[Category:Manual]]</pre>
</div>
<div title="Plugins" modifier="ringmaster" modified="200803012243" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>Plugins are intended to be extensions of the core functionality of Habari.  Your installation will come with several, community developed plugins, or you may download other, community and individually developed plugins.  Eventually, a repository on the official site will house freely available plugins, until then, you can check out the [[Available Plugins]].

==Installation &amp; Activation==

The directory structure must be kept in place, that is, do not upload just the php files of the plugin, rather, the entire directory, even if only one file exists.

===System Plugins vs User Plugins===
Core plugins are installed in &lt;tt&gt;/system/plugins&lt;/tt&gt;.  User installed plugins should be installed in &lt;tt&gt;/user/plugins/&lt;/tt&gt;.  This system allows for upgrades, without having to touch the &lt;tt&gt;/user&lt;/tt&gt; directory at all.  If a plugin exists in both locations, the &lt;tt&gt;/user/plugins&lt;/tt&gt; will override the system version. Note, all of the files and directories of a plugin must live in the &lt;tt&gt;/user/plugin&lt;/tt&gt; directory, it will not pull from both. 

To activate and configure your plugins navigate your browser to &lt;tt&gt;/admin/plugins&lt;/tt&gt;, and a list of all plugins in your user directory should be available. To active or deactivate a plugin, simply click the button to the right of the plugin name.  Some plugins also provide configuration settings, clicking the configure link will open the options below the list of your installed plugins (but note that the interface for plugin configuration is still in development). Note that a &quot;sandboxing&quot; function exists to check a plugins syntax before being activated.  If any errors exist, the plugin will not be available for activation.  If this occurs, you should contact the plugin author, or check for a newer version.

==Enabling the Plugin==
Some features provided by plugins will be enabled without you doing anything other than activating the plugin.  However, some plugins will require adding code to your active theme to output some data.  Generally speaking, the plugin author should provide documentation for this, however, in most cases the plugin sets a variable and adds it to the $theme instance, which represents the active theme. Within the template where you want the plugin's data displayed, you simply echo that variable.  This is done so that in the future, when other theme engines are added, specific PHP code isn't required for the plugin to work with that theme engine.  If a plugin sets the variable &lt;code&gt;$my_twitter&lt;/code&gt;, in the raw PHP engine you would add &lt;code&gt;&lt;?php echo $my_twitter; ?&gt;&lt;/code&gt; to the template where you want to show the data.  As other engines are added, this will be updated to reflect those as well.

==Checking for Plugins in Themes==
You can use a conditional statement to see if a particular plugin is active, and if so, do something, else, do something else.  

This is '''not recommended''' for most purposes, especially in template files, because [[Theme Functions]] provide more functionality and have the plugin detection built-in, and [[Theme Dependencies]] allow you to specify Theme Functions and versions that must be present for your theme to work properly before it's even activated.

To test if a plugin is present, use the following function:

&lt;code lang=&quot;php&quot;&gt;&lt;?php Plugins::is_loaded(); ?&gt;&lt;/code&gt;

You need to pass at least one variable to the function, the &lt;code&gt;$name&lt;/code&gt;.  &lt;code&gt;$name&lt;/code&gt; can either be from the plugin info, or the class.  You can also pass a version number, however this is optional.  So for example, if you want to check to see if the Pingback plugin is active, and is at least version 1.0, you would do something to the effect of:
&lt;code lang=&quot;php&quot;&gt;&lt;?php if (Plugins::is_loaded('pingback','1.0')) {
  //do something
}
else {
  //something instead
}

?&gt;&lt;/code&gt;

However, if you do not need to test against a version, you simply need :
&lt;code lang=&quot;php&quot;&gt;&lt;?php if (Plugins::is_loaded('pingback')) {
 //do something
}
else {
  //something instead
}

?&gt;&lt;/code&gt;

[[Category:Manual]]</pre>
</div>
<div title="QueryRecord" modifier="habari" modified="200710161731" created="200710132025" tags="MediaWikiFormat" changecount="7">
<pre>A single instance of QueryRecord represents a single query result row.  QueryRecord also serves as the base class for derivative classes that provide row-level data access.  QueryRecord is, in many ways, the fundamental building block of Habari.

==Using QueryRecord==

QueryRecord provides basic functions that allow Habari to interact with the single row of data.  The properties of a QueryRecord object represent the field values of the row.  

To obtain an instance of QueryRecord with data, call one of these static methods on the DB class:
; get_row():Returns a single QueryRecord instance for the single row retrieved
; get_results():Returns an array of QueryRecord instances, one per row returned in the query

For example:
&lt;pre&gt;$record = DB::get_row('SELECT id, bar FROM foo WHERE id = 1');
 echo $record-&gt;bar;&lt;/pre&gt;

The code above firsts queries the database for a record containing the fields &lt;tt&gt;id&lt;/tt&gt; and &lt;tt&gt;bar&lt;/tt&gt; from the table 'foo' where the 'id' field is equal to 1.  The single record (only one is returned by &lt;tt&gt;DB::get_row()&lt;/tt&gt;) is stored in &lt;tt&gt;$record&lt;/tt&gt; as an instance of the QueryRecord class.  The property &lt;tt&gt;bar&lt;/tt&gt; referenced as &lt;tt&gt;$record-&gt;bar&lt;/tt&gt; contains the value of the 'bar' field returned by the query.  Similarly, although this is not shown, the 'id' field is assigned to &lt;tt&gt;$record-&gt;id&lt;/tt&gt;.

By echoing the value of &lt;tt&gt;$record-&gt;bar&lt;/tt&gt;, the value of that field is output.

==Updating a Record==

By changing the values of these properties and calling the update() method on the object, the QueryRow can commit that data back to the database.  For example:

&lt;pre&gt;$record = DB::get_row('SELECT id, bar FROM foo WHERE id = 1');
 $record-&gt;bar = 'hello';
 $record-&gt;update('foo', array('id'));&lt;/pre&gt;

As with the prior example, the values of the fields 'id' and 'bar' have been queried into an instance of QueryRecord.

The &lt;tt&gt;$record-&gt;bar&lt;/tt&gt; is then assigned the value 'hello'.  This prepares the new data for update in the database.  The value of &lt;tt&gt;$record-&gt;bar&lt;/tt&gt; will contain 'hello' after this assignment.  

To update the record in the database, the &lt;tt&gt;update()&lt;/tt&gt; method is called.  In QueryRecord, update() accepts two parameters.  The first is the table to which the data will be written and the second is an array of fields that will be used to match the data in the object to the correct row in the database.

In this case, the table updated is 'foo', and the value of &lt;tt&gt;$record-&gt;id&lt;/tt&gt; will be matched against the field 'id' in the database.  Any record in the database with a matching id value will have its fields updated to the other property values of &lt;tt&gt;$record&lt;/tt&gt;

==Inserting a Record==

QueryRecord can also be used to insert new records into a table.  For example:

&lt;pre&gt;$record = new QueryRecord(
   array('bar'=&gt;'hello')
 );
 $record-&gt;insert('foo');&lt;/pre&gt;

In the above example, a new instance of QueryRecord is created and asigned to &lt;tt&gt;$record&lt;/tt&gt;.  The values of the properties in the new QueryRecord are built from the associative array that is passed to the QueryRecord constructor.  The keys of the array become the object's properties, and the values of the array become those properties' values.  After creating &lt;tt&gt;$record&lt;/tt&gt; as above, the value of &lt;tt&gt;$record-&gt;bar&lt;/tt&gt; would be set to 'hello'.

Calling &lt;tt&gt;$record-&gt;insert()&lt;/tt&gt; inserts the property values into the specified table, in this case, 'foo'.

In order for this to work correctly, all of the values required to insert a row into a table must have been set as properties of the QueryRecord object.  Note that in this example, the 'id' field is omitted with the assumption that it is an auto_increment primary key in the 'foo' table.

After the row is inserted, the value of 'id' *will not* be set in &lt;tt&gt;$record-&gt;id&lt;/tt&gt;.  This must be done manually using &lt;tt&gt;DB::last_insert_id()&lt;/tt&gt;, which is often handled from a subclass, as described in the Extending QueryRecord section below.

==Deleting a Record==

This is fundamentally the same as updating a row, except it deletes the row from the table that has fields with the matching values.

&lt;pre&gt;$record-&gt;delete('foo', array('id'));&lt;/pre&gt;

==Extending QueryRecord==

As part of Habari's Object-Oriented approach, other classes can extend the QueryRecord class to provide additional methods that interact with QueryRecords that contain a specific type of data.  For example, the Post class extends QueryRecord to provide additional methods that are post-specific.  The class that extends QueryRecord [http://en.wikipedia.org/wiki/Inheritance_%28computer_science%29 inherits] all of the methods of QueryRecord in addition to any that it provides on its own.

In most cases, a QueryRecord is not the class of a row.  A row is usually requested as one of QueryRecord's descendant classes.

Many classes extend the QueryRecord class.  The following classes all inherit from QueryRecord:
; Post: Represents a single post
; Comment: Represents a single comment
; LogEntry: Represents a single entry in the event log
; CronJob: Represents a single periodically executed task
; RewriteRule: Represents a single rewrite rule
; User: Represents a single user

The classes above represent wildly different functionality and and data representations; yet they each extend the base QueryRecord class.  By providing this core functionality for descendant classes, extended classes don't need to duplicate code.  

QueryRecord descendants map to database tables of the same name, and most of the properties of the descendants map the columns of that table.  For example, the Post table is used to store Post object data.  The Post object has fields 'id', 'title', and 'content', among others.  These fields are also columns in the 'posts' table in the database.

The Post class also provides special functionality that is associated only to posts.  For example, every post has a status value.  In the database, this status value is stored as an integer.  Because it's often easier to work with the names of these status, the Post class provides the ability to accept either the integer or the string as the value of the poperty, but always stores the value in the database as an integer.  This is just one example of what additional functionality a subclass of QueryRecord can provide.

One of the more significant additions a subclass can make is to override the &lt;tt&gt;update()&lt;/tt&gt; and &lt;tt&gt;insert()&lt;/tt&gt; methods of QueryRecord.  By creating having its own &lt;tt&gt;update()&lt;/tt&gt; method, a class can identify the correct table and key fields that are used to update that row in the database.  This allows a subclass instance to omit the table and keyfields parameters in the call to update.  So when updating a post, instead of this:

&lt;pre&gt;$record-&gt;update('foo', array('id'));&lt;/pre&gt;

You would simply call this:

&lt;pre&gt;$post-&gt;update();&lt;/pre&gt;

Using a subclass, you can transparently assign the value of DB::last_insert_id() to the keyfield property of the object.  This will allow you to update the object after it is inserted without having to manually retrieve the key values each time.  So when inserting a post, instead of this, where the &lt;tt&gt;id&lt;/tt&gt; property must be set manually:

&lt;pre&gt;$record = new QueryRecord(/* post field data */);
 $record-&gt;insert('posts');
 $record-&gt;id = DB::last_insert_id();
 $record-&gt;title = 'new title';
 $record-&gt;update('post', array('id'));&lt;/pre&gt;

You would simply call this:

&lt;pre&gt;$post = new Post(/* post field data*/);
 $post-&gt;insert();
 $post-&gt;title = 'new title';
 $post-&gt;update();&lt;/pre&gt;

It's not that the assignment doesn't need to be made at all, but that it takes place in the Post class (which extends QueryRecord) so that you need not repeat it whenever you insert a new post.

Please review the documentation for the classes that extend QueryRecord for the details of functionality that they provide beyond QueryRecord itself.


QueryRecord provides the following:
* [http://us.php.net/manual/en/language.oop5.overloading.php overloaded] __get(), __set() and __isset()
* exclude_fields() and list_excluded_fields(), for identifying properties handled exclusively by the database
* insert(), for adding data to the database
* to_array(), to permit array operations on the object (like &lt;code&gt;foreach&lt;/code&gt;)
* get_url_args(), which returns an array of the values represented by the object
* update(), for recording modified values to the database
* delete(), for deleting an item from the database
</pre>
</div>
<div title="Recent Comments" modifier="michaeltwofish" modified="200803140442" created="200807242317" tags="Category:Manual Category:Theming" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>It's really simple to get a listing of recent comments to output in your Habari theme. This page describes how to manually add recent comments support by editing your theme. If you don't want to write code, there is a [http://www.habariproject.org/dist/plugins/recentcomments.zip Recent Comments plugin] available from the Habari Extras repository that lets you customize how many comments to display and how to display them.

There are just two steps to add recent comments to your blog.

First, you need to make an array of recent comments available in your theme template. Add this code to the &lt;tt&gt;theme.php&lt;/tt&gt; file for your theme inside the &lt;tt&gt;add_template_vars&lt;/tt&gt; function:

&lt;code lang=&quot;php&quot;&gt;
 $this-&gt;assign('recent_comments', 
               Comments::get( array('limit'=&gt;25, 'status'=&gt;Comment::STATUS_APPROVED, 'orderby'=&gt;'date DESC' ) ) );
&lt;/code&gt;

If you are using the Pingback plugin, and want to remove those from your recent comments, you can add the &lt;tt&gt;type&lt;/tt&gt; parameter when retrieving comments, like this:
&lt;code lang=&quot;php&quot;&gt;
$this-&gt;assign('recent_comments', 
              Comments::get( array('limit'=&gt;25, 'status'=&gt;Comment::STATUS_APPROVED, 
                                   'type'=&gt;Comment::COMMENT, 'orderby'=&gt;'date DESC' ) ) );
&lt;/code&gt;

This tells Habari to store the 25 most recent approved comments into a variable called &lt;tt&gt;$recent_comments&lt;/tt&gt; that will be accessible in your template. You could separately list most recent pingbacks with a modification of the code.

Second, add this to your theme's template where you want the comment listing to appear:

&lt;code lang=&quot;php&quot;&gt;
&lt;h3&gt;Recent Comments&lt;/h3&gt;
&lt;ul&gt;
  &lt;?php foreach($recent_comments as $comment): ?&gt;
    &lt;li&gt;
      &lt;a href=&quot;&lt;?php echo $comment-&gt;url ?&gt;&quot;&gt;
        &lt;?php echo $comment-&gt;name; ?&gt;
      &lt;/a&gt; on 
      &lt;a href=&quot;&lt;?php echo $comment-&gt;post-&gt;permalink; ?&gt;&quot;&gt;
        &lt;?php echo $comment-&gt;post-&gt;title; ?&gt;
      &lt;/a&gt;
    &lt;/li&gt;
  &lt;?php endforeach; ?&gt;
&lt;/ul&gt;
&lt;/code&gt;

This loops through each of the comment objects in the array of recent comments using a &lt;tt&gt;foreach&lt;/tt&gt; loop and prints them. You can edit the HTML to change how the comments are displayed.

* &lt;tt&gt;$comment-&gt;name&lt;/tt&gt; is the name of the commenter.
* &lt;tt&gt;$comment-&gt;url&lt;/tt&gt; is the URL of the commenter, such as their web site.
* &lt;tt&gt;$comment-&gt;post&lt;/tt&gt; is the post object on which the commenter commented.
* &lt;tt&gt;$comment-&gt;post-&gt;title&lt;/tt&gt; is the title of the post to which the comment applies.

You could even use &lt;tt&gt;$comment-&gt;content&lt;/tt&gt; to output the content of the comment, if you wanted.

[[Category:Manual]]
[[Category:Theming]]</pre>
</div>
<div title="Rewrite Tutorial" modifier="lildude" modified="200805291933" created="200807242317" tags="Category:Manual Category:Outdated" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>==Parts of a rewrite rule==
Rewrite rules are made up of several parts conforming to the fields in
the rewrite_rules table, all with a distinct purpose.

'''name''' - The name of the rule.  Used in the code to reference the rule
to create links.

'''parse_regex''' - A regular expression that attempts to match an incoming
request.  If it does, then the rule is used to determine what to
display.

'''build_str''' - A string used to build a URL from code that will be
matched by the parse_regex.

'''handler''' - The Habari class that handles the request.

'''action''' - The action (&quot;function&quot;) in the handler class that handles the request.

'''priority''' - Rules are tested in order from low to high.  Matching rules
short-circuit the testing process, so higher priorities for rules that
are less restrictive.

'''is_active''' - 1 if the rule is enabled, 0 if the rule is disabled.

'''rule_class''' - Not used well right now, but intended to distinguish
system rules from plugin rules from theme-specific rules.  Just use
the numer &quot;2&quot; for your own rules for now.

'''description''' - Optional description of the purpose of the rule.

==How to build a regex==
Instructions on building regular expressions is well beyond the scope
of what I would write here, but I'll give a very brief primer just to
give you some idea of what's going on.

Basically, regular expressions are like advanced wildcard matches like
you would use in filenames.  Instead of using just * to match &quot;any
characters&quot;, regular expressions have special codes that match
specific characters.

For example, a dot . will match any single character.  A dot followed
by a plus .+ will match one or more characters.  A dot followed by an
asterisk .* will match zero or more characters.

You can match a a specific number of characters by using braces.
.{0,4} will match up to four characters.  .{4} will match exactly four
characters.

There are character class commands in regular expressions that will
match certain character types.  For example \d will match any number.
If you want to match exactly four numbers, combine the matches so far
to get this:  \d{4}

Finally for this tutorial, one of the primary uses for regular
expressions in Habari is subexpression matching.  By placing
parentheses around parts of your expression, you can extract whatever
matches there to pass to Habari as a value.  This is how Habari
figures out that you want the &quot;year&quot; part of your URL to be used to
find the year.

Normally, you use simple subexpression matches, like this:
 /archives/(\d{4})/

That would capture the subexpression \d{4} into the first match.
Habari needs more information, though.  It needs to know what that
expression value should be used for.  So we use named matches.

The syntax for named matches is a little odd, but it's not difficult:
 /archives/(?P&lt;year&gt;\d{4})

You simply add ?P&lt;name&gt; just inside the left paren, and set the &quot;name&quot;
part to the thing that you want to match.

So the regular expression for the URL your requested is this:
 archives/(?P&lt;year&gt;\d{4})/(?P&lt;mon0&gt;\d{2})/(?P&lt;mday0&gt;\d{2})/(?P&lt;slug&gt;[^/]+)/?$

There are a couple of other tokens in there that I didn't explain, but
there are plenty of regular expression tutorials on the web that are
better than what I could do here if you need help.  The names of the
matched things are important.  I'll explain them with the build_str
below.

Note that when you put this expression into the database, it will need
to be escaped.  You'll have to put delimiters around it, and probably
tell the system that it's case-insensitive by tacking an &quot;i&quot; onto the
end.  Like this:

&lt;code&gt;
 %archives/(?P&amp;lt;year&amp;gt;\d{4})/(?P&amp;lt;mon0&amp;gt;\d{2})/(?P&amp;lt;mday0&amp;gt;\d{2})/(?P&amp;lt;slug&amp;gt;[^/]+)/?$%i
&lt;/code&gt;

==build_str==

The next complicated bit for your request is the build_str.

Build strings are actually pretty easy.  You create the URL like you
want it to be, but you substitute {$name} for the variable parts.  In
your case, your build_str becomes this:

&lt;code&gt;
 archives/{$year}/{$mon0}/{$mday0}/{$slug}
&lt;/code&gt;

$mon0 is a 0-padded month.  So January is &quot;01&quot; not &quot;1&quot;.  If you use
$mon then you don't get the zero.  Likewise with $mday0.  Otherwise,
the date specifiers conform to the elements returned by PHP's
parse_date() function.

{$slug} is, uh, the slug of the post.

Ok.  For the rest of the parameters...

Your handler will be &quot;UserThemeHandler&quot;, which is the class that
handles all theme requests.  The action will be &quot;display_post&quot; which
handles displaying posts.  priority can safely be set to &quot;8&quot;, but you
can make it higher if it interferes with other rules (I don't think it
will because of the &quot;archives&quot; on front).  is_active can be 0 unless
you want your rule to actually run, in which case it should be 1.
rule_class is 2.  description is &quot;Porcupines fly over the south pole
quite regularly in spring.&quot;

==SQL statement==

In the end you need to execute this SQL statement:

&lt;code&gt;
 INSERT INTO habari__rewrite_rules (
 	name,
 	parse_regex,
 	build_str,
 	handler,
 	action,
 	priority,
 	is_active,
 	rule_class,
 	description
 )
 VALUES (
 	'display_entry',
 	'%archives/(?P&amp;lt;year&amp;gt;\\d{4})/(?P&amp;lt;mon0&amp;gt;\\d{2})/(?P&amp;lt;mday0&amp;gt;\\d{2})/(?P&amp;lt;slug&amp;gt;[^/]+)/?$%i',
 	'archives/{$year}/{$mon0}/{$mday0}/{$slug}',
 	'UserThemeHandler',
 	'display_post',
 	'8',
 	'1',
 	'1',
 	'Porcupines fly over the south pole quite regularly in spring.'
 );
&lt;/code&gt;

==Helper Functions==

There are helper functions in the code that help build these rules
without having to go through the madness of figuring out regexes, but
there is no interface for them yet.  Also, I'm not sure how well
they're working after some recent changes.  But basically, two
function calls would achieve the same as above:

&lt;code&gt;
 $rule = RewriteRule::create_url_rule('&quot;archives&quot;/year/mon0/mday0/slug',
 'UserThemeHandler', 'display_post');
 $rule-&gt;insert();
&lt;/code&gt;

{{developer}}

[[Category:Manual]]
[[Category:Outdated]]</pre>
</div>
<div title="Security Considerations" modifier="rickc" modified="200807240248" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>Security always involves a trade off with convenience. Habari has been designed to be as secure as possible by default, and every effort has been made to make administrators and users aware of decisions they make that might diminish the security of their Habari installation. When a user logs in to Habari, a cookie is saved onto the user's machine, allowing access to restricted pages without having to enter a username and password again. To protect accounts from unauthorised accessed, without any plugin, Habari logins timeout after non-use for session timeout period defined in php.ini.

==General==
===Staying Logged In===
Many systems implement &quot;Remember me&quot; functionality, allowing users to choose to save their login details in a cookie so that they can log in to subsequent sessions without having to enter their username and password at all. While this may be convenient, it also opens a security hole. For example, on shared workstations, forgetting to log out is a very serious security matter, and users may be unaware that their account could be compromised.

To ensure that administrators and users consider security carefully, Habari does not provide &quot;Remember me&quot; functionality in its core. A plugin that allows this convenience over Habari's default security is available. However, you should only install something that makes your site less secure if you really understand the ramifications. If you have further questions about security, please see the Getting Help section on the [[Main Page]] of this wiki.

==SQLite==
Unlike MySQL, which is a client-server database, SQLite is a simple file living in a directory on your web host. As such, it is subject to all the file permission rules that apply to any file on a computer's hard drive. 

Habari attempts to improve the security of your SQLite installation by adding a ''Files'' section to your '''.htaccess''' file to deny access to your database by the web browsing public.

&lt;pre&gt;
&lt;Files &quot;habari.db&quot;&gt;
Order deny,allow
deny from all
&lt;/Files&gt; 
&lt;/pre&gt;

'''habari.db''' would be replaced with the actual name of your database.

As long as you leave your database somewhere in Habari's directory structure and don't rename it, this section will prevent the browser from directly accessing the database.

Other approaches you take to improving the security of an SQLite installation depends on whether your host runs PHP as a CGI process or as a module of the web server.

===PHP As A CGI Process===
You can check if PHP is being run as a CGI process by running the &lt;tt&gt;phpinfo()&lt;/tt&gt; function on the server and looking for the &lt;tt&gt;SERVER_SOFTWARE&lt;/tt&gt; entry. It will have something like &quot;PHP-CGI&quot; in the value string. If your host runs PHP as a CGI process, PHP normally has the same permissions that you as the site's owner have. It can read the files you can read. It can write to the files you can write to. Security is fairly good. You can do one of two things to make your database even more secure, though.

First, you can move your database file completely out of your public web directory. After you install Habari, copy your SQLite database file to another directory, for example, /home/user/sqlite. Then, change your config file to tell it where to find the database. When you install Habari, it creates your SQLite database in Habari's base directory. As a result, the connection string in your config file will say something like

&lt;pre&gt;'connection_string'=&gt;'sqlite:habari.db'&lt;/pre&gt;

where habari.db is the name of your SQLite database.

When you move your database, change this connection string to read

&lt;pre&gt;'connection_string'=&gt;'sqlite:/home/user/sqlite/habari.db'&lt;/pre&gt;

If you do move your database, you can create an '''.htaccess''' file in the directory to which you move your database file, and in it place a Files directive similar to the one Habari created when it was first installed:

&lt;pre&gt;
&lt;Files habari.db&gt;
Order deny,allow
deny from all
&lt;/Files&gt; 
&lt;/pre&gt;

Replace habari.db with the actual name of your database file. This will keep visitors to your site from directly accessing your database file.

===PHP As A Server Module===
If your host runs PHP as a module to Apache, security is more difficult, and it is impossible to make an SQLite installation as secure as the previous situation unless the server is running mod_suphp, something over which those on shared hosts have no control.

The reason for this is that SQLite requires the directory in which the database resides to be writable by PHP. When PHP is run as a module, it generally doesn't belong to the same group that you as the site's owner belongs to, and won't have the same permissions as you. SQLite needs to be able to create a journal file in the directory in which the database file exists, so if something happens to the server your data won't be lost. As a result, you have to make the database's directory writable by the world. To minimize the security risks that this entails, you can move your database file into it's own directory and make only that directory world writable by giving it the permission 666, leaving all other directories in your public web structure at their usual permissions. Change the connection string in your config file to look for your database file in the proper place. For example, if you move the database file to

&lt;pre&gt;/www/sqlite/habari.db&lt;/pre&gt;

your connection string would read

&lt;pre&gt;'connection_string'=&gt;'sqlite:/www/sqlite/habari.db'&lt;/pre&gt;

In addition, you can create an '''.htaccess''' file in the directory to which you move your database file, and in it place a Files directive similar to the one Habari created when it was first installed:

&lt;pre&gt;
&lt;Files habari.db&gt;
Order deny,allow
deny from all
&lt;/Files&gt; 
&lt;/pre&gt;

Replace habari.db with the actual name of your database file. This will keep visitors to your site from directly accessing your database file.

[[Category:Manual]]</pre>
</div>
<div title="SideBarTabs" modifier="Habari" modified="200803191748" created="200803191747" changecount="2">
<pre>&lt;&lt;tabs txtMainTab &quot;All&quot; &quot;All tiddlers&quot; TabAll  &quot;Timeline&quot; &quot;Timeline&quot; TabTimeline &quot;Tags&quot; &quot;All tags&quot; TabTags &quot;More&quot; &quot;More lists&quot; TabMore&gt;&gt;</pre>
</div>
<div title="SiteSubtitle" modifier="Khaled Abou Alfa" modified="200704162057" created="200703132345" server.type="file" server.host="file:///Users/blogworks/Sites/MyHabari/Docs/Habari_Manual.20070916.0135310976.html" server.page.revision="200704162057">
<pre>| User Manual</pre>
</div>
<div title="SiteTitle" modifier="Khaled Abou Alfa" modified="200704162057" created="200703132346" server.type="file" server.host="file:///Users/blogworks/Sites/MyHabari/Docs/Habari_Manual.20070916.0135310976.html" server.page.revision="200704162057">
<pre>Habari</pre>
</div>
<div title="Stack Class" modifier="Massimiliano" modified="200802022110" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>The Stack class allows a developer to create a &quot;stack&quot; of items for later output.  This can be useful for creating a stack of scripts or CSS file references that should be added to the page output.  Using the naming feature of the Stack class, a developer can ensure that only one script is added to the stack for a specific purpose.

== Output a Stack ==

There are a few ways to generate output using the Stack class.  Like many classes in Habari, Stack has ::get() and ::out() methods.

The ::get() method returns the values generated for a stack, and the ::out() method outputs the same values that would be returned by ::get().

To output a specific stack:

 &lt;code&gt;Stack::out('stack_name');&lt;/code&gt;

This causes all elements of the stack named &lt;tt&gt;stack_name&lt;/tt&gt; to be output to the page in sequence.  The values are not formatted.

To use a simple format of the values, this syntax is useful:

 &lt;code&gt;Stack::out('stack_name', '&lt;link rel=&quot;stylesheet&quot; href=&quot;%s&quot; type=&quot;text/css&quot;&gt;');&lt;/code&gt;

This outputs each element of the stack as if it was called as a parameter to PHP's sprintf() function.  The string supplied as the second parameter to Stack::out() is the formatting string that is used to format each element.

The most complex formatting technique allows callback functions as formatting functions:

 &lt;code&gt;
 function myformatter($text){
   return strrev($text) 
 }
 Stack::out('stack_name', 'myformatter');
 &lt;/code&gt;

The second parameter to Stack:out() in this example is the name of a callback function.  The function is called for each element of the stack, and the return value of that function is used for the stack output.  In this case, the text of every element of the stack is reversed before it is output.

Note that the callback function returns, and does not echo, regardless of whether the call to Stack is ::get() or ::out().  Also, the second parameter can call a class method by using the &lt;tt&gt;array('class_name', 'function_name')&lt;/tt&gt; callback syntax, which may be useful for calling simple functions on the Format class.

== Alter a Stack ==

When you know the name of a stack, it is easy to queue values to it:

 &lt;code&gt;Stack::add('stack_name', $value);&lt;/code&gt;

&lt;tt&gt;$value&lt;/tt&gt; is the value that you want to add to the stack.  Calling ::add() this way will not ensure uniqueness.

To ensure that the element you are adding to the stack is unique for a purpose, use this:

 &lt;code&gt;Stack::add('stack_name', $value, 'element_name');&lt;/code&gt;

&lt;tt&gt;element_name&lt;/tt&gt; is a name for the element that is added to the stack.  Only one value can exist for each name in each stack.  The second call to ::add() with the same element name replaces the existing stack element with a new value.

To remove an existing element from a stack:

 &lt;code&gt;Stack::remove('stack_name', 'element_name');&lt;/code&gt;

In this syntax, note that you are not able to remove values that have not been given names.

{{developer}}

[[Category:Manual]]</pre>
</div>
<div title="StyleSheet" modifier="YourName" modified="200801052006" created="200701122350" tags="BlackicityTheme" server.type="file" server.host="file:///Users/blogworks/Sites/MyHabari/Docs/Habari_Manual.20070916.0135310976.html" server.page.revision="200707302047" changecount="4">
<pre>/*{{{*/
/*Blackicity Theme for TiddlyWiki*/
/*Design and CSS by Saq Imtiaz*/
/*Version 1.0*/
/*}}}*/
/*{{{*/
body{	font-family: &quot;Neue Helvetica&quot;, Helvetica, &quot;Lucida Grande&quot;, Verdana, sans-serif;
	background-color: #fff;
	color: #333;
        font-size: 12px}

#topMenu {position:relative; background:#282826; padding:10px; color:#fff;font-family:'Lucida Grande', Verdana, Sans-Serif;}
#topMenu br {display:none;}

#topMenu a{			color: #999;
			padding: 0px 8px 0px 8px;
			border-right: 1px solid #444;}
#topMenu a:hover {color:#fff; background:transparent;}

#displayArea {margin-left:1em; margin-bottom:2em; margin-top:0.5em;}


a, a:hover{
color:#1398CA;
text-decoration: none;   background:transparent; 
}

.viewer a, .viewer a:hover {border-bottom:1px #1398CA; font-weight:bold;}


.viewer .button, .editorFooter .button{
color: #333;
border: 1px solid #333;
}

.viewer .button:hover,
.editorFooter .button:hover, .viewer .button:active, .viewer .highlight,.editorFooter .button:active, .editorFooter .highlight{
color: #fff;
background: #333;
border-color: #333;
}

.tiddler .viewer {line-height:1.45em;}
.title {color:#222; border-bottom:1px solid#222; font-family:'Lucida Grande', Verdana, Sans-Serif; font-size:1.5em;}
.subtitle, .subtitle a { color: #999999; font-size: 0.95em;margin:0.2em;}
.shadow .title{color:#999;}

.tiddler .subtitle {display: none}

.tagged {display: none}

.toolbar {font-size:90%;}
.selected .toolbar a {color:#999999;}
.selected .toolbar a:hover {color:#333; background:transparent;border:1px solid #fff;}

.toolbar .button:hover, .toolbar .highlight, .toolbar .marked, .toolbar a.button:active{color:#333; background:transparent;border:1px solid #fff;}

/***
!Sidebar
***/
#sidebar { margin-bottom:2em !important; margin-bottom:1em; right:0;
}

/***
!SidebarOptions
***/
#sidebarOptions { padding-top:2em;background:#f3f3f3;padding-left:0.5em;}

#sidebarOptions a {
			color:#333;
                        background:#f3f3f3;
                        border:1px solid #f3f3f3;
			text-decoration: none;
}

#sidebarOptions	a:hover, #sidebarOptions a:active {
			color:#222;
			background-color:#fff;border:1px solid #fff;
		}

#sidebarOptions input {border:1px solid #ccc; }

#sidebarOptions .sliderPanel {
	background: #f3f3f3; 	font-size: .9em;
}

#sidebarOptions .sliderPanel input {border:1px solid #999;}
#sidebarOptions .sliderPanel .txtOptionInput {border:1px solid #999;width:9em;}

#sidebarOptions .sliderPanel a {font-weight:normal; color:#555;background-color: #f3f3f3; border-bottom:1px dotted #333;}


#sidebarOptions .sliderPanel a:hover {
color:#111;
background-color: #f3f3f3;
border:none;
border-bottom:1px dotted #111;
}
/***
!SidebarTabs
***/
 .listTitle {color:#222;}
#sidebarTabs {background:#f3f3f3;}

#sidebarTabs .tabContents {background:#cfcfcf;}

#sidebarTabs .tabUnselected:hover {color:#999;}

#sidebarTabs .tabSelected{background:#cfcfcf;}

#sidebarTabs .tabContents .tiddlyLink, #sidebarTabs .tabContents .button{color:#666;}
#sidebarTabs .tabContents .tiddlyLink:hover,#sidebarTabs .tabContents .button:hover{color:#222;background:transparent; text-decoration:none;border:none;}

#sidebarTabs .tabContents .button:hover, #sidebarTabs .tabContents .highlight, #sidebarTabs .tabContents .marked, #sidebarTabs .tabContents a.button:active{color:#222;background:transparent;}

#sidebarTabs .txtMoreTab .tabSelected,
#sidebarTabs .txtMoreTab .tab:hover,
#sidebarTabs .txtMoreTab .tabContents{
 color: #111;
 background: #f3f3f3; border:1px solid #f3f3f3;
}

#sidebarTabs .txtMoreTab .tabUnselected {
 color: #555;
 background: #AFAFAF;
}



/***
!Tabs
***/
.tabSelected{color:#fefefe; background:#999; padding-bottom:1px;}
 .tabSelected, .tabSelected:hover {
 color: #111;
 background: #fefefe;
 border: solid 1px #cfcfcf;
}

 .tabUnselected {
 color: #999;
 background: #eee;
 border: solid 1px #cfcfcf;
 padding-bottom:1px;
}
.tabUnselected:hover {text-decoration:none; border:1px solid #cfcfcf;}
.tabContents {background:#fefefe;}





.tagging, .tagged {
border: 1px solid #eee;
background-color: #F7F7F7;
}

.selected .tagging, .selected .tagged {
background-color: #f3f3f3;
border: 1px solid #ccc;
}

.tagging .listTitle, .tagged .listTitle {
color: #bbb;
}

.selected .tagging .listTitle, .selected .tagged .listTitle {
color: #333;
}

.tagging .button, .tagged .button {
color:#ccc;
}
.selected .tagging .button, .selected .tagged .button {
color:#aaa;
}

.highlight, .marked {background:transparent; color:#111; border:none; text-decoration:underline;}

.tagging .button:hover, .tagged .button:hover, .tagging .button:active, .tagged .button:active {
border: none; background:transparent; text-decoration:underline; color:#333;
}



.popup {
background: #cfcfcf;
border: 1px solid #333;
}

.popup li.disabled {
color: #000;
}

.popup li a, .popup li a:visited {
color: #555;
border: none;
}

.popup li a:hover {
background: #f3f3f3;
color: #555;
border: none;
}



#messageArea {

border: 4px dotted #282826;
background: #F3F3F3;
color: #333;
font-size:90%;
}

#messageArea a:hover { background:#f5f5f5; border:none;}


#messageArea .button{
color: #333;
border: 1px solid #282826;
}

#messageArea .button:hover {
color: #fff;
background: #282826;
border-color: #282826;
}






.tiddler {padding-bottom:10px;}

.viewer blockquote {
border-left: 5px solid #282826;
}

.viewer table, .viewer td {
border: 1px solid #282826;
}

.viewer th, thead td {
background: #282826;
border: 1px solid #282826;
color: #fff;
}
.viewer pre {
border: 1px solid #ccc;
background: #f5f5f5;
}

.viewer code {
color: #111; background:#f5f5f5;
}

.viewer hr {
border-top: dashed 1px #222; margin:0 1em;
}

.editor input {
border: 1px solid #ccc; margin-top:5px;
}

.editor textarea {
border: 1px solid #ccc;
}

h1,h2,h3,h4,h5 { color: #282826; background: transparent; padding-bottom:2px; font-family: Arial, Helvetica, sans-serif; }
h1 {font-size:18px;}
h2 {font-size:16px;}
h3 {font-size: 14px;}
/*}}}*/</pre>
</div>
<div title="Subversion and applying patches" modifier="YourName" modified="200807250353" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined" changecount="1">
<pre>==Using Subversion and applying patches==

[http://svnbook.red-bean.com/ Subversion] is a source code versioning system that allows developers to concurrently make changes to Habari's source code and reconcile any differences before a release is deployed.

Habari users have access to the current source code as being worked on by developers.  Only  those in the [http://wiki.habariproject.org/en/PMC PMC] have commit access and can commit changes back into the Habari subversion repository, but the repository is open to checkout for anonymous users.

To check out a copy of subversion to the current directory using the command line:

&lt;pre&gt;svn checkout http://svn.habariproject.org/habari/trunk/ .&lt;/pre&gt;

To update an existing working copy to the latest code in the repository, execute this from the command line in the directory containing the working copy:

&lt;pre&gt;svn update&lt;/pre&gt;

There are a number of graphical interfaces to interact with subversion for each operating system.  These may be easier to use if you are not as familiar with running commands from the command line.

==Testing patches that are not yet released==

===What are diff files ?===
A diff file is the difference between a version of the source code in the repository and a working copy. It represents any changes, such as additional features or bug fixes, that have been made by a developer in a working copy. A diff file is generated using the &lt;tt&gt;svn diff&lt;/tt&gt; command.

&lt;pre&gt;svn diff &gt; descriptive_name_of_patch.diff&lt;/pre&gt;

===Applying diff files to your copy of habari===
You can use the &lt;tt&gt;patch&lt;/tt&gt; command to apply the diff file.

For windows systems, you can obtain a copy of &lt;tt&gt;patch&lt;/tt&gt; from the [http://gnuwin32.sourceforge.net/packages/patch.htm gnuwin32 project]

The common execution is &lt;code&gt;patch -p0 &lt; /path/to/file&lt;/code&gt;. This command will apply the differences that have been recorded in &lt;tt&gt;file&lt;/tt&gt; to the appropriate file(s) in the current directory.  As one diff file can contain changes for many files, and it preserves relative paths to sub-directories, the format of the diff file may affect where you need to invoke patch.

===A practical example of diff and patch===
''predominantly from Scott Merrill's answer to Michael Bishop's question....''

I modified a whole bunch of files for the Site class.  When I was done editing, I changed to the htdocs directory of my checkout:
&lt;pre&gt;$ cd /home/skippy/code/habari/trunk/htdocs&lt;/pre&gt;
I then executed &lt;code&gt;svn status&lt;/code&gt; to see (and review) a list of all the files in my local copy that I have changed:
&lt;pre&gt;$ svn status&lt;/pre&gt;
After double-checking the list of files, I executed &lt;code&gt;svn diff&lt;/code&gt; to output a list of all the changes to all the files.  I piped this output into a file:
&lt;pre&gt;$ svn diff &gt; /tmp/site.diff&lt;/pre&gt;
I attached the diff file to an email, or upload it to the Google issue tracker.

You read my email, and save my diff file.  
You transfer this file to your web host, which is running an SVN checkout of Habari.
Because my diff was made from &lt;tt&gt;/trunk/htdocs&lt;/tt&gt;, you should change to that directory in your local copy.  (You may need to discern this from the contents of the diff file, if you don't know otherwise.)

Once in the target directory, you execute:
&lt;pre&gt;$ patch -p0 &lt; /path/to/site.diff&lt;/pre&gt;
The output of patch should report what it's doing:
&lt;pre&gt;skippy@skippy:~/code/habari/trunk/htdocs$ patch -p0 &lt; /tmp/site.diff
patching file system/admin/footer.php
patching file system/admin/content.php
patching file system/admin/dashboard.php
patching file system/admin/header.php
patching file system/classes/url.php
patching file system/classes/site.php
patching file system/classes/plugins.php
patching file system/classes/feedbackhandler.php
patching file system/classes/post.php
patching file system/classes/options.php
patching file system/classes/installhandler.php
patching file system/classes/user.php
patching file system/classes/controller.php
patching file system/installer/db_setup.php
patching file index.php
patching file user/themes/k2/comments.php
patching file user/themes/k2/header.php&lt;/pre&gt;

If there are any problems, patch will report which file(s) failed.  Figuring out what failed for each file, and why, can sometimes be challenging.

When you've determined that the patch works (or not!), and you want to go back to your vanilla Habari, you use the Subversion &lt;tt&gt;revert&lt;/tt&gt; command.   Using the &quot;-R&quot; (recursive) flag lets you easily revert your entire checkout to a clean state:

&lt;pre&gt;skippy@skippy:~/code/habari/trunk/htdocs$ svn -R revert *
Skipped 'config.php'
Reverted 'index.php'
Reverted 'system/admin/footer.php'
Reverted 'system/admin/content.php'
Reverted 'system/admin/dashboard.php'
Reverted 'system/admin/header.php'
Reverted 'system/classes/url.php'
Reverted 'system/classes/site.php'
Reverted 'system/classes/plugins.php'
Reverted 'system/classes/feedbackhandler.php'
Reverted 'system/classes/post.php'
Reverted 'system/classes/options.php'
Reverted 'system/classes/installhandler.php'
Reverted 'system/classes/user.php'
Reverted 'system/classes/controller.php'
Reverted 'system/installer/db_setup.php'
Reverted 'user/themes/k2/comments.php'
Reverted 'user/themes/k2/header.php' &lt;/pre&gt;

==Resources==
[http://subversion.tigris.org/project_packages.html Download Subversion]

[http://gnuwin32.sourceforge.net/packages/patch.htm patch program for windows]

[http://svnbook.org/ Subversion Book]

[[Category:Manual]]</pre>
</div>
<div title="Supported Hosts" modifier="andycowl" modified="200803110812" created="200803130446" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="1463">
<pre>=Known Hosts Supporting Habari requirements=

The following list of hosts are known to have the necessary prerequisites for Habari, and Habari has been reported to us as executing successfully on them.  This list is not an endorsement of these hosts over others.  At this time the Habari Project offers no official recommendation or endorsement of any hosting provider.

*[http://www.1and1.fr/ 1and1 France]
*[http://www.asmallorange.com/ A Small Orange]
*[http://www.aziendeitalia.com/ Aziende Italia]
*[http://www.bluehost.com/ Bluehost]
*[http://www.celeonet.fr/ Celeonet]
*[http://dreamhost.com/ Dreamhost]
*[http://itrebal.com/ Itrebal Webhosting]
*[http://www.jumba.net.au/ Jumba]
*[http://www.mediatemple.net/webhosting/gs/ (mt) Media Temple - (gs) Grid-Server]
*[http://www.nearlyfreespeech.net Nearly Free Speech (with PHP5 requested)]
*[http://www.site5.com/ Site5]
*[http://www.slicehost.com/ Slicehost] (running apache2 or nginx, php5, mysql5 or sqlite3)
*[http://servage.net Servage]

Depending on the hosting provider, there may be additional configuration steps required. Refer to [[Installation/Special_Instructions]] for more information.</pre>
</div>
<div title="Template File Hierarchy" modifier="Massimiliano" modified="200802022106" created="200807242317" tags="Category:Manual Category:Theming" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>Themes in Habari are constructed from several template files.  Each template potentially corresponds to a type of data and the amount of data that is displayed.

A &quot;post&quot; refers to an atomic published unit.  There are different types of posts in the core Habari software.  These types are called &quot;content-types&quot;.

== Filenames ==

Habari supports different template engines.  Out of the box, the only engine provided is the RawPHPEngine.  This template engine is a basic engine that executes native PHP, using PHP itself as a template language.  An alternative engine might support the Smarty template language.

Because different engines will require different file extensions (PHP needs &quot;.php&quot; and Smarty needs &quot;.tpl&quot;, for example) template files are always referred to in Habari without file extension.  It is the job of the engine to apply the appropriate extension to the template name.

== Content-Types ==

&quot;entry&quot; is post content-type that indicates that the post flows chronologically with other entries.  An &quot;entry&quot; would make up the bulk of daily blog posts.  

&quot;page&quot; is a post content-type that indicates that the post is separate from the chronological flow.  

Additional content-types may be defined in the database or in plugins for different purposes.  The style of the output page may be affected by the content-type of the post.  A theme should accommodate these additional content-types by providing distinct templates for those content-types or by providing generic templates that are not specific to any single content type.

=== Use in Themes ===

The use of content-types in themes allows templates to exist for each content-type.

A post of content-type &quot;entry&quot; will be displayed using the &lt;tt&gt;entry.single&lt;/tt&gt; template.  Likewise, a post of content-type &quot;page&quot; will be displayed using the &lt;tt&gt;page.single&lt;/tt&gt; template.

== Post Counts ==

Any request to display output will either be attributed to a single post or multiple posts.  When requesting &quot;posts with a certain tag&quot;, multiple posts would be returned (even if only one post exists with that tag).  When requesting a specific post, a single post would be returned.

A template file containing the text &quot;single&quot; is used to display a single post.  The template will be provided with only a single post item for display.

A template file containing the text &quot;multiple&quot; is used to display multiple posts.  This template should expect to receive a collection of post items for display.  It is possible that this collection will contain only a single post; but since it's a (one-member) collection it will use the &quot;multiple&quot; template file.

=== Use in Themes ===

When a request is made for a group of posts, Habari will attempt to find the best matching template name using a &quot;multiple&quot; template.  For example, when displaying multiple posts of content-type &quot;entry&quot;, Habari will look for the &lt;tt&gt;entry.multiple&lt;/tt&gt; template.

If only one post of content-type &quot;entry&quot; is requested, Habari will look for the &lt;tt&gt;entry.single&lt;/tt&gt; template.

If multiple posts are requested, but only one post exists to fill the request, Habari should still use the &lt;tt&gt;entry.multiple&lt;/tt&gt; template, because that was the request.  It should not use &lt;tt&gt;entry.single&lt;/tt&gt; unless only a single post was specifically requested.

== Special Pages ==

A couple of requests have unique templates that Habari can display specifically for those requests.

=== 404 ===

404 Error will cause Habari to display results using the &lt;tt&gt;404&lt;/tt&gt; template.  Put something meaning for visitors when URL can't be reached.

=== Search ===

The request of a search page will cause Habari to display results using the &lt;tt&gt;search&lt;/tt&gt; template.  The search template should act like a &quot;multiple&quot; template: it should expect to receive a collection of items, possibly of different content-types.  The collection of items to display in the search template may contain zero, one, or more items.

=== Home ===

The request of the home page will cause Habari to display results using the &lt;tt&gt;home&lt;/tt&gt; template.  The home template can be configured to display zero, one, or more items of any content-type, as you see fit.

=== Post-specific ===

When requesting any specific post, 

1. Habari will either check for a template that is specific to that post's id, using the content-type of the post.  For example, when requesting an entry with the id #35, Habari will attempt to display that single post's content using the &lt;tt&gt;entry.35&lt;/tt&gt; template.  For a page with id #36, Habari would attempt to use &lt;tt&gt;page.36&lt;/tt&gt; template.

2. Or Habari will check for a template that is specific to that post's slug, using the content-type of the post.  For example, when requesting an entry with the slug &quot;foo&quot;, Habari will attempt to display that single post's content using the &lt;tt&gt;entry.foo&lt;/tt&gt; template.  For a page with slug &quot;bar&quot;, Habari would attempt to use &lt;tt&gt;page.bar&lt;/tt&gt; template.

=== Tag-specific ===

When requesting any post with a specific tag, Habari will check for a template that is specific to that tag, using the content-type of the post.  For example, when requesting an entry with tag &quot;foo&quot;, Habari will attempt to display that post's content using the &lt;tt&gt;entry.tag.foo&lt;/tt&gt; template.  For a page with tag &quot;bar&quot;, Habari would attempt to use &lt;tt&gt;page.tag.bar&lt;/tt&gt; template.

== Failover ==

When Habari fails to find the most specific template needed to display content for a request, it searches for the next less-specific template that could display that content.

For example, when failing to find an explicit template for entry #35 (&lt;tt&gt;entry.35&lt;/tt&gt;), Habari would then look for a &quot;single&quot; type template for that content type.  In this case, the &lt;tt&gt;entry.single&lt;/tt&gt; template.

Each request has a chain of templates that it tries, getting more generic as the possible templates fail to exist.  Eventually, Habari attempts to display the content using the &lt;tt&gt;home&lt;/tt&gt; template.  The &lt;tt&gt;home&lt;/tt&gt; template is the minimum required template for a functioning theme.  (That is to say, a theme may have ''only'' a &lt;tt&gt;home&lt;/tt&gt; template file, which will be used to display all content.)

The failover order for any request is determined in the core system Theme class (not necessarily the user Theme class), and is specific to the type of request made.  The failover order can be overridden by using a custom Theme class, but this is not required for failover to work as described.

=== List of supported filenames ===

Below is the list of files that Habari will look for in order based on the type of request.  The template engine will likely use the first file listed that exists, and will continue through the list to the end until it finds a matching file for that request.

These substitutions should be used for elements of the template name that begin with a dollar sign:

;&lt;tt&gt;$type&lt;/tt&gt;: The content type of the post, usually &lt;tt&gt;entry&lt;/tt&gt; or &lt;tt&gt;page&lt;/tt&gt;
;&lt;tt&gt;$id&lt;/tt&gt;: The id of the post
;&lt;tt&gt;$tag&lt;/tt&gt;: The requested tag.
;&lt;tt&gt;$year&lt;/tt&gt;: The requested year.
;&lt;tt&gt;$month&lt;/tt&gt;: The requested month.
;&lt;tt&gt;$day&lt;/tt&gt;: The requested day.

==== Display the homepage (/) ====
#home
#multiple

==== Display an entry or a page (/first-post) ====
#$type.$id
#$type.slug
#$type.tag.$tag
#$type.single
#$type.multiple
#single
#multiple
#home

==== Display entries by tag (/tag/deleteme) ====
#tag.$tag
#tag
#multiple
#home

==== Display search results (/search/hello+world) ====
#search
#multiple
#home

==== Display entries by date (/2007/12/02) ====
#year.$year.month.$month.day.$day
#year.month.day
#month.$month.day.$day
#year.$year.month.$month
#year.$year.day.$day
#month.day
#year.day
#year.month
#month.$month
#day.$day
#year.$year
#year
#month
#day
#multiple
#home

==== Error 404 ====
#404
#home

[[Category:Manual]]
[[Category:Theming]]</pre>
</div>
<div title="Themes" modifier="Massimiliano" modified="200802022115" created="200803130446" tags="Category:Asides Category:Theming" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="1197">
<pre>Currently, Habari only supports one theme engine, the rawphpengine.  Eventually, it will support additional engines (such as Smarty and PHPTAL).  

A modified version of the popular [http://getk2.com/ K2] theme currently comes as the default theme upon installation, however, the goal is to offer several themes with the download.  A few publicly [[Available Themes|available themes]] are currently available, with many more on the horizon.

==Installation==
Included themes are installed in &lt;code&gt;system/themes&lt;/code&gt;.  This allows for upgrading without touching the &lt;code&gt;/user&lt;/code&gt; directory at all.  If you would like to use a system theme, but make modifications, you can copy '''all of the files and directories''' into user/themes.  The &lt;code&gt;user/themes/k2&lt;/code&gt; would override the &lt;code&gt;system/k2&lt;/code&gt;.  Again, this allows for upgrading, and any changes to the distributed version K2 not over write your modified version.  You could then migrate any changes to your user copy.

Additional themes can be uploaded to your &lt;code&gt;/user/themes&lt;/code&gt; directory.  Themes must include a theme.xml file in order to be activated in &lt;code&gt;/admin/themes&lt;/code&gt;.  See [[Creating a Custom Theme]] for details about this file, and about how to create your own themes.

===Additional Information about themes and customization:===

* [[Template File Hierarchy]]

* [[Customizing Theme Behavior]]

* [[Using Excerpts]]

* [[Recent Comments|Show Recent Comments]]

* [[Asides]]

* [[Pingbacks|Show Pingbacks]]

[[Category:Asides]]
[[Category:Theming]]</pre>
</div>
<div title="Upgrading" modifier="YourName" modified="200807250031" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined" changecount="1">
<pre>=Before You Upgrade=
Before making any major change in your Habari installation, it would be prudent to create a backup of your database and your installation, in particular all the files in your Habari /user directory. The /user directory should contain all files which you have customized - plugins you have installed, themes you have installed, and class files you may have modified. The only exception to the Habari /user directory containing all custom files is if you are not using a locale that is distributed with Habari. In this case, you will have placed your language file in the /system/locale directory.

=The Upgrade Process=
# Download the new version of Habari that you will be installing. Unzip it into the location of your choice.
# Deactivate your active plugins. Some of the system plugins may have been changed. Some of the plugins you got in other places may not be compatible with the new version of Habari.
# Delete the following directories
## /3rdparty
## /scripts
## /doc
## /system (Unless you have installed a national language file. In that case delete everything from /system except for /system/locale/''name of your language''.
# Delete the index.php, LICENSE, and NOTICE files from the root of your installation. Do '''not''' delete your config.php file if it is in the root of your Habari installation, or the .htaccess file.
# Copy the new version of Habari to the same location as the old version.
# Using your web browser, navigate to your site. If there are any database changes that need to be made, they will be made automatically at this time.
# Log into your Habari administrative area. Navigate to the plugins page and reactivate the plugins one by one. 
# Celebrate and enjoy the new features of your latest version of Habari!

=Version Specific Instructions=

==Upgrading from Version 0.4.1 To Version 0.5==
Many changes have been incorporated into version 0.5. For details of the changes that have been made see the [http://wiki.habariproject.org/en/Releases/0.5 release notes].

In particular, upgrade functions have been incorporated into the install handler, so when you upgrade your Habari installation, any required base database changes will be automatically handled without user intervention.

One area that will require attention is plugin configuration. Version 0.5 incorporates updates to Habari's [http://wiki.habariproject.org/en/Classes/FormUI form creation system] that changes how the options for plugins are stored. This means that you will need to reconfigure any of your plugins that require configuration for them to work properly. 

==[http://wiki.habariproject.org/en/Releases/0.4/Upgrading Upgrading From Version 0.3.3 to 0.4]==
==Upgrading From Version 0.2 To Version 0.3==
===Before Upgrading===
This upgrade process assumes you are somewhat familiar with accessing your database, via an admin interface like phpMyAdmin, if you are unfamiliar with this, you should contact your host and completely familiarize yourself with their database administration.

'''It is recommended that you rename your version of K2 if you are using that (change the name in the theme.xml file and the /user/themes directory).'''

===Upgrading===
It is safe to use the same database as 0.2, but if possible, the following actions should be taken:
*Remove the `themes` table.
*Clear the `rewrite_rules` table.

====MySQL====
The upgrading process with MySQL is transparent as of the 0.3 release.

====SQLite====
''Please note: If you need a web manager for SQLite dabases, [http://www.sqlitemanager.org/ SQLite Manager] looks like a sane solution.''

#Move the database file to a different location.
#Install Habari.
#Overwrite the created database file with the one from step 1.
#Create the tables: `groups`, `groups_permissions`, `permissions` and `users_groups`. Refer to the SQL schema files for the CREATE statements.

The only difference left is the tables' structure. From 0.2 to 0.3 we modified column types, INT became SMALLINT and such. It should not affect your installation.

[[Category:Manual]]</pre>
</div>
<div title="User Documentation" modifier="rickc" modified="200807240355" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>=Intallation and Configuration=
* [[Installation]]: what we know so far
* [[Upgrading]]
* [[Multisite|Multisite configuration]]: how to drive many sites from a single '''Habari''' installation
* [[Importing Content]]
* [[Security Considerations]]

=Content=
* [[User Manual]]

* [[Desktop Blogging]]

=Extending and Customizing=
* [[Themes]]: how themers can use '''Habari'''
* [[Plugins]]: User documentation for Plugins


[[Category:Manual]]</pre>
</div>
<div title="User Manual" modifier="YourName" modified="200807250042" created="200807242331" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" changecount="14">
<pre>== Introduction ==
Welcome to Habari, the next-generation online publishing platform!

Habari was built from the ground-up with a firm understanding of the current state of blogging, and with a strong eye toward the future of internet publishing.  Habari strives to make it as easy as possible to publish your content.  It stays out of your way as much as it can, and lends a hand where it's needed.

The word &quot;Habari&quot; is Swahili for &quot;news&quot;, as in &quot;What's the news?&quot;  We feel this is an appropriate name for a blogging package not just because of the clever tagline, but because blogs are so often used to tell others what's the news in your life or your business.

As a Free Software project, Habari's most valuable asset is the community of users and developers who collaborate to improve the product.  Habari is built by people just like you: folks with an interest in blogging and internet publishing.

== Installation ==
Habari has a few [[Installation#Before_You_Install|Server Requirements]], which you will need to meet to be able to run Habari. If you have what is required, (or better), you are good to go! As Habari is still in development, no guarantees are made that these are fully stable versions, or that updating won't break the current database structure.

To install the latest stable version of Habari:

*Download http://habariproject.org/en/download and unzip the Habari package.
*If you are using MySQL or PostgreSQL, obtain the connection settings needed below, or create a database for Habari on your web server.
*Upload Habari files on your web server.
*Point your web browser at http://example.com/ to begin installation with the Database Setup.

Depending on the Database Type you set, you will need to enter the following information:
You can click on the question mark at the top of the page to reveal more information on each field.

*Database Type: You can choose between MySQL, PostgreSQL, or SQLite. Your hosting company should be able to tell you what you should use.
*Database Host: Again your hosting company should have provided this information when you first joined.
*Username: This is the username used to connect Habari to the MySQL database.
*Password: This is the password used to connect Habari to the MySQL database.
*Database Name: Again your hosting company should have provided this information when you first joined.
*Table Prefix: You will only need to change this if you have more than one version of Habari installed.

The Site Configuration settings you will need to set are:

*Site Name: The name of your blog.
*Username: The name or alias you wish to use to administer your blog. This should not be the same as the username for the database.
*Password: The password associated to the above Username. Enter this in the second box, just to make sure you get it right.
*Admin Email: This is the email address associated with the above Username. Habari will email you to let you know everything is working.

The End! Habari should now be installed.

There are full [[Installation|Installation Instructions]] available, including some specific configuration for several popular hosting companies.
If you are happy to use the current development version of Habari, there are full instructions on how to access the Habari subversion repository, however, for most normal users you will need to download the latest stable version of Habari.

== Using Habari ==
After you have installed Habari, go to http://example.com/admin/. You will be taken to a login page. Enter your user name and password to open up Habari's administration interface. You will be greeted by the Dashboard.  This page provides a snapshot of useful information, such as the total number of posts and comments on your site, the number of posts you've made, and more. Later you can install plugins to add new modules to the dashboard, greatly expanding its usefulness.

The primary way you will interact with Habari is through the main menu.  The main menu is accessed by placing your mouse at the top left of the window.  The menu should automatically drop down, to reveal to you the available choices.  The menu items users see will be controlled by the permissions assigned to them by the site administrator.  Clicking on any menu item will take you to the corresponding page within the administrative interface.  For details on each menu item, see the corresponding section of this manual.

It should be noted that the main menu can also be accessed by keyboard shortcuts.  If you press the Q key on your keyboard, the menu should expand.  Press the Q key again to hide the menu.  When the menu is displayed, each menu item has a keyboard shortcut displayed to the right.  Using the keyboard shortcuts you can quickly navigate through Habari.  Want to create a new entry?  Press Q, then the 1 key.  Want to change your site's theme?  Press Q, then T.  Want to add a new user?  Q U.

== Your First Post ==
You can create your first post by clicking on the main menu, then selecting &quot;Create Entry&quot;.

You are now looking at the publish entry page, by default you have three fields into which to enter information.

&lt;img src=&quot;create_entry.jpg&quot; height=&quot;300&quot; width=&quot;300&quot; align=&quot;right&quot;/&gt;

*The Title box is the name of your entry, this can contain a single word, a sentence, numbers, or symbols producable by your keyboard.  By default, the title you supply will be used to create the URL by which this post will be accessed.

*The Content box contains the main body of your entry. In here you can put almost anything imaginable, although currently you will have to manually enter HTML for URL links and formatting such as bold or underlining.  Beneath the content box is a small handlebar, which you may click and drag to adjust the amount of space used by the box.

*The Tag box contains the 'tags', or free-form labels, you apply to your content. You can use as many different tags are you like to describe your entry.  If you are writing a post about a recipe you want to try, you might tag the post with the key ingredients.  This allows visitors to navigate your site by the tag words, to find other recipes that use the selected ingredient.  See the '''tags''' section for a more thorough description of tags.

Pressing the Save button will save your work into the Habari database.  The post will still be a Draft, which means it is not available for the public to read.  You can edit and save drafts as many times as you like, to make sure you get the post just right before letting the world read it.  When you are satisfied with your post, click the Publish button.  This will make the post visible to the world on your front page, as well as in your [http://en.wikipedia.org/wiki/Atom_(standard) Atom] syndication feed.  Congratulations, you've posted your first entry!

You also have two additional buttons between the Tag box and the Save/Publish buttons, these contain optional extras you may wish to use.
Beneath the Tags input box are two buttons, labeled Settings and Tags.  Clicking on either of these opens a pagesplitter (so called because it splits the page).

*Settings:
**Content State: You may manually adjust the status of your post.  Instead of clicking the Publish button, you may select &quot;Published&quot; from the content state drop-down, and then click the Save button.  If you want to unpublish something -- that it, keep it in the Habari database but prevent readers from seeing it -- you may change a Published post to Draft and then click Save.  Plugins may add new content statuses.
**Comments Allowed: This tick box determines whether or not your visitors can leave comments on this item.  When the box is ticked comments are allowed. By default this is set to ticked.  If you remove the tick and click Save, no new comments will be accepted on this item.  Any existing comments will be preserved and displayed.
**Publication Time: This is the time your post is set to be published. This is normally set by Habari. When you first begin a post, Habari will set the publication time to the current time. When you publish the post for public viewing, Habari sets the publication time to the time you hit the Publish button. The only instance when you should change the publication time is when you wish to create a scheduled post. If you set the publication time to a date and time in the future, then click the Publish button, Habari will make that post available for public viewing at the time you indicated.
**Content Address: This box lets you set a different title of your entry. This is useful in case the main title of your entry contains unusual characters or is excessively long. The name you provide in this box will appear in the address window in your web browser, not the title of the entry.

*Tags:
**This provides a quick reference of all the tags used on your blog. This list will be populated by more tags as you use them. You can click on a tag in the tag window, and it will appear in the tag box above. You can also clear the currently used tags, using the ‘Clear’ button.

== Key Terms and Ideas ==
=== Content Types ===
As a tool for managing content, Habari defines two default types of content.

*'''Entries''' are the most commonly used content type.  These are the content type you use when creating a new blog post.  They are displayed in reverse chronological order (newest first) on your home page and in your Atom syndication feed.  You would use entries to post a review of the movie you watched yesterday, or what your weekend plans are.
*'''Pages''' are used for more static information in your site.  Pages typically live outside of the date-based chronology of your site.  You would use a Page to describe something that isn't associated with a specific date or time, like an &quot;About The Author&quot; biography.

Plugins have the ability to add additional content types.

'''NOTE''': When discussing Habari, the term &quot;post&quot; will frequently be used to mean any kind of content.  If the content type matters for documentation or example purposes, a specific content type will be used.  Entries and Pages are both Posts.

=== Content Statuses ===

Out of the box Habari maintains three post statuses - '''draft''', '''published''', and '''scheduled'''. Plugins have the option of adding further statuses to this list. The Undelete plugin that comes with Habari, for example, adds the '''deleted''' status.
*'''Draft'''. Drafts are unfinished, unpublished works.  Drafts are not visible to regular visitors of your site.  All new posts default to the &quot;draft&quot; status and remain that way until you explicitly change their status.  As long as you don't publish the post, it will remain in this state so you can add to it, edit it, and change it as much as you want without being concerned that others will see it.
*'''Published'''. Published items are available for the entire world to read, and are included in your Atom syndication feed.  As soon as you click the Publish button on Habari's post composition page, the status of the post is set to published. At this point it is viewable by the public at large. You can still edit the post.
*'''Scheduled'''. If you change a post's publication time to a future date, then click the Publish button, Habari sets its status to scheduled. The post will be visible to you when you are logged in to Habari's administrative section, but not to the general public. When the time you set for publication arrives, Habari will automatically change the status to published and make the post available for public viewing.

=== Tags ===

Tagging is a non-hierarchical way to categorize your content. When you create a post, you label it with one or more tags to show readers what other posts on your site it is related to. Tags have only a general semantic meaning, because the context of a label can change it's meaning, and this context isn't a part of the tag. Tags do, however, allow you to show the general categories of your work without forcing it into a hierarchical system of categories.

=== Comments ===
Readers can add feedback to published posts via '''comments'''. Habari requires all comments to be moderated before they are displayed on the site. Plugins can change this situations so that comments from frequent commenters are automatically approved, or comments left as spam are automatically marked as spam.

Out of the box Habari maintains three comment statuses - '''approved''','''unapproved''' and '''spam'''.
*'''Approved''' - These are comments that you have either manually approved for display on the site, or that have been filtered by a plugin and accepted for display on the site.
*'''Unapproved''' - All comments are unapproved when they are first made. It is up to you as the site administrator to either mark them for approval so they are displayed on the site, mark them as spam, or delete them.
*'''Spam''' - Spam comments are made in the hopes that someone will click through the links that they contain. Often spam is related to gambling or sexually oriented products, but can also be random comments that bear no relation to the post on which they are made. Spam is the reason that all comments are not automatically approved. As said above, you can install plugins in your Habari installation that filter all comments examining them for the characteristics of spam. If the comment fits the spam profile, it will either be automatically deleted or marked as spam and retained to further train the spam filtering plugin. It is strongly recommended that you install some kind of spam filtering plugin to save your time and to protect your site.

=== Feeds ===
The term '''feed''' indicates a stream of data which is &quot;consumed&quot; by a special application called a '''feed reader''' or '''aggregator'''.  Your blog's feed contains the same data that is presented to visitors viewing your site, but it is composed in a way that is suitable for machine-to-machine communication, as opposed to machine-to-human communication.  There are several formats for this machine-to-machine transmission, with the two most popular being [http://en.wikipedia.org/wiki/RSS_(file_format) RSS] and [http://atomenabled.org/ Atom].  Out of the box, Habari only speaks the Atom format.

RSS and Atom allow users to subscribe to your web site in their aggregator, like Bloglines or Google Reader.  Their aggregator will periodically poll your website (usually once every couple of hours), checking to see if you've published any new content.  If you have, your Habari installation will transmit that new content to the aggregator using the Atom format, and your posts will show up in the aggregator's list of new items.

Your main Atom feed can be located by appending &lt;tt&gt;/atom/1&lt;/tt&gt; to your site's URL. Separate feeds are available for comments.

=== Themes ===
Themes allow you to customize the look and feel of the site for your readers. Habari includes several themes to choose from after installation, and many more are available from the community.

=== Plugins ===
By design, Habari by itself has a basic set of capabilities. Plugins add functionality, new capabilities, or additional content types to Habari. Habari includes several out of the box...

=== Loupe ===
&lt;img src=&quot;timeline.jpg&quot; height=&quot;50%&quot; width=&quot;50%&quot; align=&quot;right&quot; /&gt;

On certain administration pages, the loupe is a sliding, expandable window that operates on the timeline of a group of data. The default position for the loupe is the far right: the most recent items of the collection. The default width of the loupe encompasses 20 items. You can click inside the loupe and drag it left and right across the timeline: this will change the items shown beneath the loupe based on the date range highlighted by the loupe. On the left and right of the loupe are handlebars, which you can click to drag left or right to expand or shrink the size of the loupe: this will increase or decrease the number of items shown below.

The loupe makes it extremely easy to display and select specific timelines of data. You can drag and expand the loupe to display all the items from June of last year to June of this year. Or you can narrow the loupe to only display items from last month, or yesterday.

== Administration ==

=== The Dashboard ===
The Dashboard is the first page you see after you log in to Habari's administrative interface. The dashboard can be reached from any page of Habari's administrative interface by choosing '''Dashboard''' from the main menu, or by typing '''Q''' followed by '''D'''.

&lt;img src=&quot;dashboard_with_modules.jpg&quot; height=&quot;300&quot; width=&quot;300&quot; align=&quot;right&quot; /&gt;

The dashboard provides a summary of useful information for your site. The top section contains a couple of sentences telling you how long your site has been active, a series of high level statistics about your site, how many drafts you have awaiting completion, how many scheduled posts you have, and how many comments you have awaiting moderation.

Next is a series of '''modules'''. Modules are small sub-blocks that focus on specific details about your site. Habari comes with modules that contain lists of your recent published posts, recent comments on your blog, and recent activity that has been logged. Plugins can add various other modules dedicated to specific purposes. A plugin that redirects your feeds through the Feedburner service, for example, may use a module to let you know how many subscribers you have, while a plugin that tracks links to your site may use a module to show you the recent links.

Modules can be moved and rearranged, added, and hidden, so they stay in the positions that is most logical to you and show you the information you want to see. If you don't care about recent log activity, click the '''x''' in the upper left corner of the log module to hide it. If the first thing you want to see is any recent comments on your site, move the recent comments module to the top left of the modules section by clicking on the grey rectangle in the upper right of the module and dragging the module .

After all the visible modules, the dashboard has a dropdown list of all the modules that are available to show. To show a module you don't currently have displayed, choose the module then click the button with a + on it to the right of the list to display the module.

=== Managing Content ===
To manage your content -- draft or published, entry or page -- select one of the Manage links from the main menu.  Habari creates a Manage menu item for each type of content in your system, providing a convenient way to access a specific type of content.  The destination for each of these menu links is, in fact, the same page: the menus merely provide a shortcut to filter the display by the specified content type.

&lt;img src=&quot;manage_posts.jpg&quot; height=&quot;300&quot; width=&quot;300&quot; align=&quot;right&quot; /&gt;

Habari strives to make it as easy as possible to find and manage your content.  The first thing to note when visiting the &quot;Manage Content&quot; page is the '''loupe'''.

Beneath the loupe are the posts returned by the current filters.  Above the loupe are the filter controls, and additional navigation controls.  By default, 20 posts will be presented beneath the loupe in reverse chronological order (newest first).  If you have more than 20 items that satisfy the filters, you can page forward and backward to see the next or previous set of 20 posts using the &quot;Older&quot; and &quot;Newer&quot; links at the top left and right, respectively.  To the right of the &quot;Older&quot; link is a report of the number of posts that match the current filter, and where your current display falls within that set.

In the top center of the Manage Content page is the filter box.  You can use this box to type in search terms to find content.  To find all posts that include the word &quot;Habari&quot;, simply type &quot;Habari&quot; into the filter box and wait a moment.  The list of posts below will be updated, and the quantity indicator to the left of the filter box will be updated.  Beneath the filter box are several links that provide shortcut filter controls.  To see only entries, click the &quot;Entry&quot; link:  this will add &lt;tt&gt;type:entry&lt;/tt&gt; into the filter box, restricting the list of posts to only those of type Entry.  Click the &quot;Entry&quot; link again to remove that filter from the list.  Using these buttons, you can quickly drill down to see all your content.  Click the &quot;Entry&quot; link and the &quot;Draft&quot; link to see all your unpublished entries.  Click the &quot;Entry&quot; link again to see all draft posts, regardless of content type.

Additional filters are available for manual entry.  To see all posts authored by Scott, type &quot;author:scott&quot; into the filter box.  There is no shortcut link for these other filters because it's possible that a single site might have, for example, a sufficiently large number of authors as to make the links dominate the screen.

You can combine the filter links with manual filter controls.  To see all drafts about pizza, click the &quot;Draft&quot; button, and then type in &quot;pizza&quot;.  Or, manually type in &quot;status:draft pizza&quot;.

The loupe will update for the current set of filtered posts.  The combination of filter controls and loupe provide for extremely flexible content navigation.

Beneath the loupe is the list of posts that match the current filters.  The post title, status, author, and date are displayed above a brief snippet of the post.  This snippet should provide a bit of context about the post if you can't remember it from the title.  The title of the post is a hyperlink, allowing you to click it to view that post.  The status, author, and date are also hyperlinks that show you similar items (same status, same author, or same publication date).  To the right of the post is a &quot;drop button&quot;.  This is a special control mechanism that acts like both a button and a drop-down list.  If you place your mouse over the drop button it will expand to reveal all of the options available to you.  The first item -- the one displayed before you placed your mouse over the drop button -- is the default action that will occur if you click your mouse.  You may select one of the other items from the list, though, if you don't want to take the default action.  When managing content, the usual values of the drop buttons will be &quot;Delete&quot; and &quot;Edit&quot;.

To the left of the post is a checkbox.  You can tick the boxes to mark one or more posts, allowing you to execute actions against groups of posts.  The number of posts marked will be indicated at the bottom of the screen.  The posts you select will be remembered, allowing you to page through all the posts that match the current filter.  The number at the bottom of the screen will remind you that you have posts selected that might not be displayed on the current page.  Next to the number of selected posts (which says &quot;None selected&quot; if you've not yet selected any) is another checkbox.  If you tick this box, all posts that match the current filter will be selected.  Note: this '''will''' select posts not displayed on the current page!

Once you have some group of posts selected, you can execute a single action against them.  Select the action from the drop-down at the bottom of the page and then click the Submit button.

=== Comments ===
To manage your comments select the Comments link from the main menu.

As with posts, the first thing to note when visiting the Comments page is the loupe and the timeline at the top of the page. The loupe works with comments the same way as it does with posts.

&lt;img src=&quot;manage_comments.jpg&quot; height=&quot;300&quot; width=&quot;300&quot; align=&quot;right&quot; /&gt;

Beneath the loupe are the comments returned by the current filters.  Above the loupe are the filter controls, and additional navigation controls.  By default, 20 comments will be presented beneath the loupe in reverse chronological order (newest first).  If you have more than 20 items that satisfy the filters, you can page forward and backward to see the next or previous set of 20 comments using the &quot;Older&quot; and &quot;Newer&quot; links at the top left and right, respectively.  To the right of the &quot;Older&quot; link is a report of the number of comments that match the current filter, and where your current display falls within that set.

In the top center of the Comments page is the filter box.  You can use this box to type in search terms to find comments.  To find all comments that include the word ''Habari'', simply type ''Habari'' into the filter box and wait a moment.  The list of comments will be updated, and the quantity indicator to the left of the filter box will be updated.  Beneath the filter box are several links that provide shortcut filter controls to the different statuses and types a comment may have.  To see only Approved comments, click the '''Approved''' link:  this will add &lt;tt&gt;status:Approved&lt;/tt&gt; to the filter box, restricting the list of comments to only those which are approved.  Click the '''Approved''' link again to remove that filter from the list.  Using these , you can quickly drill down to see all your comments.  Click the '''Unapproved''' link and the '''Pingback''' link to see all your unapproved pingbacks.  Click the '''Unapproved''' link again to see all pingbacks, regardless of status.

You can combine the filter links with manual filter controls.  To see all approved comments containing the word ''terrific'', click the '''Approved''' link, and then type in ''terrific''.  Or, manually type in '''status:Approved terrific'''.

The loupe will update for the current set of filtered posts.  The combination of filter controls and loupe provide for extremely flexible content navigation.

Beneath the loupe are the comments that match the current filters, with a set of buttons and a checkbox located above and below the comments. Each comment shows the commenter's name, url, and email address if they left them, the title of the post the comment was made on, the time and date of the comment, and the text of the comment. The commenter's url serves as direct link to the commenter's site, the email address serves as a link to send them an email, and the post title serves as a link to the comment and the post on which it was made.

To the right of each comment is a drop button, as seen with on the Manage Posts pages.  The default action for comments on the drop button is '''Delete''' - to delete the comment.  You may select one of the other items from the list, though, if you don't want to take the default action.  These other actions are '''Spam''' - to mark the comment as spam, '''Approve''' - to approve the comment, '''Unapprove''' - to unapprove a previously approved comment, and '''Edit''' - to modify a comment.

To the left of the comment is a checkbox.  You can tick the boxes to mark one or more comments, allowing you to execute actions against groups of comments.  The number of comments marked will be indicated above and below the list of comments.  The comments you select will be remembered, allowing you to page through all the comments that match the current filter.  The number will remind you that you have comments selected that might not be displayed on the current page.  Next to the number of selected comments (which says &quot;None selected&quot; if you've not yet selected any) is another checkbox.  If you tick this box, all comments that match the current filter will be selected.  If you clear this checkbox, all comments that were previously selected will be unselected. 

'''Note''': this '''will''' select comments not displayed on the current page!

Once you have some group of comments selected, you can execute a single action against them.  Just click the button at the top or bottom of the page for the action you wish to perform. As with the drop button, your choices are to '''Delete''' the comment, mark the comments as '''Spam''', '''Unapprove''' previously approved comments, and '''Approve''' unapproved comments.

=== Tags ===

To manage your site's tags, select '''Tags''' from the main menu, or type '''Q''', then '''6'''.

&lt;img src=&quot;manage_tags.jpg&quot; height=&quot;200&quot; width=&quot;300&quot; align=&quot;right&quot; /&gt;

At the very top of the tags page is a '''search box'''. After your site has been in use for a long time, you can have quite a few tags. Use the search box to narrow the number of tags which you are viewing.

Below the search box you will see the tags which you have used on your site. These will be of various heights, as a visual cue to how frequently they have been used, and each one will have a number beside it denoting the exact number of times it has been used.

Select tags by clicking on them. A second click on a tag de-selects it.

To '''rename''' a tag, click on it, type the new name in the text box below the tags, then click the '''Rename''' button.

To '''merge''' multiple tags into one tag, click on each tag you want to merge, type the name you want to give the tags in the text box below the tags, then click the '''Rename''' button.

To '''delete''' one or more tags, click on each tag you want to delete, then click the '''Delete Selected''' button beneath the tags.

=== Options ===

&lt;img src=&quot;options.jpg&quot; height=&quot;300&quot; width=&quot;300&quot; align=&quot;right&quot; /&gt;

Options for your site include such things as the site title, tagline, number of posts per page, time zone, etc.

To edit your site's options, either select '''Options''' from the main menu, or type '''Q''', then '''O'''.

Options are searchable by using the search form at the top right of the page.

=== Themes ===

&lt;img src=&quot;manage_themes.jpg&quot; height=&quot;300&quot; width=&quot;300&quot; align=&quot;left&quot; /&gt;

To change your theme select '''Themes''' from the main menu. This will take you to the themes page.

The themes page is divided into two section. The top section contains one item, your current active theme. The bottom section contains all the themes that are available for you to use. 

Each theme will show several pieces of information. To the far left is the name of the theme, its developer, and a screenshot of what it looks like in use. In the middle is a short description of the theme. For inactive themes, to the right is a dropbutton containing available actions for the theme. Your active theme will not have a dropbutton.

If a theme is inactive, the only available action is to '''Activate''' it. Clicking on an inactive theme's dropbutton automatically deactivates the theme that is currently active, and activates the theme you selected.

=== Plugins ===

&lt;img src=&quot;manage_plugins.jpg&quot; height=&quot;300&quot; width=&quot;300&quot; align=&quot;right&quot;  /&gt;

To manage your plugins, select '''Plugins''' from the main menu. You will be taken to your plugins page.

The plugins page is divided into two main sections. At the top of the page is a list of the plugins you have activated. The bottom of the page contains a list of the plugins you have installed, but have not yet activated. Even if you have not added any plugins yourself, this section will contain the plugins that come with Habari.

To the right of each plugin is a dropdown button containing the actions that it is possible for you to perform with the plugin. For inactive plugins, the only possible action is '''Activate''', which you may do by clicking on the dropdown button. Once you do so, the plugin is removed from the list of inactivate plugins and transferred to the list of active plugins.

Active plugins can have several actions associated with them. The most common are '''Configure''', which opens a form in which you can set the configuration options for that plugin, and '''Deactivate''', which removes the plugin from the list of active plugins and returns it to the list of inactive plugins. If there is no configuration possible for a plugin, the only action you will be able to perform with it is to deactivate it.

Each plugin that needs to be configured will have different options, but they all work the same general way. There will be a series of fields to fill in, then a '''Save''' and a '''Close''' button. After setting the plugin options to your satisfaction, click the '''Save''' button to save the changes to the database. Click the '''Close''' button to close the configuration dialog.

=== Users and Groups ===
=== Logs ===
Habari keeps records of most of the interesting things about which it knows.  It records each time someone logs in, each time a new item is posted, and the like.  By selecting Logs from the main menu (shortcut: Q L), you can review the recent activity on your site.  

At the top of the page is the familiar loupe and filter input box, allowing you to control what log messages to display.  At the top of each column of data is a drop-down allowing you to filter the logs by specific elements.  For example, you can select all the log entries generated by a specific IP address, or all logs generated by a specific user.  You can apply multiple filter controls, allowing you to drill down to all authentication messages from a specific IP address and a specific user.

To the left of each log entry is a checkbox, allowing you to select one or more log entries.  Selected entries can be manually deleted.

It is important to note that these logs are not permanent, and will expire after some time (usually a few weeks).

== Importing Content ==
Habari is able to import post, comment, category/tag, and user data from a growing [[list of importable platforms]]. To import content, first activate the corresponding Importer plugin on the plugins page (Q P in the Main Menu) and then follow the steps detailed on the Import page.

Once the import process is complete your old data has been copied and can be managed through Habari, and can be deleted from the other platform if desired.

== Extending Habari ==
By design, Habari is built with the basic set of capabilities needed by everyone to create and maintain a blog or simple website. It is, however, also designed to be highly extensible through the use of plugins and themes other than those with which it ships.

=== Themes ===
Your site's theme is it's basic look and feel as seen by your visitors. Habari comes with several themes.
* Charcoal - Charcoal is a unique theme designed to highlight some of Habari's capabilites. 
* Mzingi - Mzingi is a basic theme designed to serve as a foundation from which you can create your own themes.
* K2 - K2 is one of the most popular themes in the blogging world. 

You aren't limited to these themes in your choices. There are many more themes listed in Habari's theme repository at http://wiki.habariproject.org/en/Available_Themes

=== Plugins ===

Habari comes packaged with several plugins. These are intended to serve as examples of best practices in plugin creation for developers, and to provide useful functionality to everyone.

====Miscellaneous Plugins====

* Core Dash Modules - These included a latest posts module, a latest comments module, and a log module. Activate this plugin to get an overview of the latest activity on your site whenever you log in.
* Pingback - Enable this plugin to send pingbacks to sites to which you link in your posts.
* Spamchecker - Activate this plugin to perform a basic spam check on comments that your site receives.
* Undelete - We all make mistakes, including deleting posts that we later wish we had kept. Activate this plugin to retain deleted posts, so if you change your mind or discover you made a mistake after deleting something, you can recover it.
* ThemeHelper - This plugin is relied on by some themes. It is especially helpful if you create your own themes.

====Media Plugins====
* Habari Media Silo - In Habari, a media silo is a way to manage media that you would wish to embed into your posts. Activate the Habari Media Silo in order to be able to upload images to your site and embed them in your posts with the proper HTML tags with a simple click of the mouse.
* Flickr Silo - Activate the Flickr Silo to access the images you have stored on Flickr with the same ease with which you manage locally stored images.
* Viddler Silo - Activate the Viddler Silo to access the videos you have stored on Viddler.

====Importers====
* Wordpress Importer - Activate the Wordpress Importer to import your content from Wordpress into Habari.
* Serendipity Importer - Activate the Seredipity Importer to import your content from Serendipity into Habari.

In addition to the plugins that are packaged with Habari, dozens of other plugins have been created to extended the software's functionality. These cover everything from WYSIWYG editors, to contact forms, to plugins to allow you to implement custom URLs for your site. Your can find an extensive list on the [http://wiki.habariproject.org/en/Available_Plugins wiki plugin page], and even more at the [http://www.habariproject.org/dist/plugins/ Habari Distribution Directory].

== Getting Help ==
=== Forums and Mailing Lists ===
There exist two mailing lists for Habari, one focused on end-user support, and the other focused on nitty-gritty development and programming issues.

[http://groups.google.com/group/habari-users habari-users] is entirely focused on Habari end-user support.  This is the first place to ask for help.  When reporting problems, please provide as much information as you can.  Be sure to accurately copy any specific error messages you receive.  If you can reliably reproduce a problem, describe in detail the steps necessary to do so.  It is often helpful to provide a link to your site, so that others can see the problem first-hand, but at the least please indicate who your hosting provider is.

[http://groups.google.com/group/habari-dev habari-dev] is focused on Habari development: programming, plugin design, and the like.  All of Habari's long-term development takes place on this list, and ideas and suggested, debated, and revised.  If you're interested in helping Habari programming, this is the list for you.

=== Reporting Bugs / Suggesting Improvements ===
Habari succeeds because people like you help improve it every day.  One of the easiest ways to contribute to the success of Habari is to report problems.  The [http://groups.google.com/group/habari-users habari-users] mailing list is the first place that problems should be reported: if the issue is known, you'll be provided with confirmation of that fact and hopefully some information to help you work around the problem until it is fixed.  If you identify a new problem, you may be asked to file a bug report.  It's easy to do!

[http://trac.habariproject.org/ Habari Trac] is the place to file bug reports.  Before you can file bugs, you need to register an account with the system.  Click the &lt;tt&gt;Register&lt;/tt&gt; link at the far right of the screen.  Once you've created an account you can log in by clicking on the &lt;tt&gt;Login&lt;/tt&gt; link.  Once logged in, you can file a new ticket!

The first thing you need to provide is a succinct summary of the problem.  Be concise, but don't be vague: the summary you provide is the first thing people will read when reviewing bugs to be fixed, so make sure that the developers get a jumpstart on your problem by supplying them with a meaningful summary.  If you see an HTTP 500 error page every time you try to log in, a good summary might be
&lt;pre&gt;
HTTP 500 error every time I try to log in
&lt;/pre&gt;
This immediately indicates the specific error and the action that produces it.  A poor summary for this problem would be
&lt;pre&gt;
Can't log in!
&lt;/pre&gt;
This does not indicate the specific error you see.

Summaries are important!  Please try hard to provide a meaningful summary.

Next you indicate whether your ticket is due to a defect with Habari, or if you're simply making a suggestion for enhancement.  The Habari developers love to see suggestions for enhancements because they help steer the long-term growth of Habari.

Below this you enter a full description of the problem or suggestion.  Be as verbose as possible.  If you have a specific error message, paste it here.  If you have log data, paste it here.  If you can reproduce the problem in one or more ways, describe in detail each of the ways to do so.  The more information you can provide, the greater the chance of a developer fixing the problem!  You can also upload screenshots if that helps to describe the problem: click the checkbox labeled &quot;I have files to attach to this ticket&quot;.  This will allow you to upload files that will be attached to your report.

In the section labeled &lt;tt&gt;Ticket Properties&lt;/tt&gt; you can fine-tune some details about your ticket.  If you're not sure what any of these mean, leave them all at the default values.  
* Priority is how severe the problem is: most items can be left at &quot;major&quot;, though issues involving data loss or security considerations can certainly be escalated to &quot;critical&quot; or &quot;blocker&quot;.
* Most of the issues you open will likely be about the Habari software itself, but we also like to be alerted to bugs in our documentation and our website!  Suggestions for improvement for the documentation and website are also warmly encouraged.
* Keywords are tags you can assign to your ticket.  If you report a problem logging in, you might supply the keyword &quot;login&quot;, for example.
* Ignore the CC field for now.
* It's usually best to leave the Milestone drop-down to &quot;unassigned&quot;, and allow a Habari developer to set this as they estimate when the problem will be fixed.
* Select the version of Habari that you're using from the Version drop-down.
* Leave the &quot;Assign to&quot; field blank.

When you're all done, click &quot;Submit ticket&quot;.  This will add your ticket to the system, and a Habari developer will eventually review it.  You might want to bookmark your ticket, and come back to check on it periodically: the Habari developers might ask you questions in comments to your ticket, seeking additional information or asking you to try a proposed fix to confirm that it works for you.

Please keep in mind when filing tickets for bug reports or feature enhancements that the list of tickets is completely public.  '''DO NOT''' post any passwords or other sensitive information.

==== A note about security issues ====
As mentioned above, all items filed in the Habari Trac are public.  If you are reporting a security problem, or a potential security problem, we respectfully ask that you first contact security@habariproject.org so that we can review the situation with you without jeopardizing our users' sites.  If you open a ticket with details of how to execute an attack against a Habari installation, someone somewhere '''will''' see that information and exploit it.

[[Category:Manual]]
</pre>
</div>
<div title="User Overrides" modifier="skippy" modified="200802262231" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>The core files used by Habari reside in /system/classes.  In general, each file represents a single class: post.php defined the Post object, posts.php defines the Posts object, etc.  In order to make Habari as flexible as possible, the developers have made it possible to easily override the default classes.  Any file placed in /user/classes will override the system file of the same name.

So, if you wanted to redesign the way the Post object operates internally, while still preserving the external interfaces, you could create your own Post class in /user/classes/post.php.  Habari will detect the presence of your file, and will load it in place of the system file.

This is a terrific way to test changes to the core Habari code without trouncing the system: you can copy the file(s) you want to modify from /system/classes to /user/classes and make whatever changes you need.  When you're finished, you can delete your local files and Habari will automatically use the system classes!

== Themes ==

Habari will look in each of these directories for themes that can be activated:

* &lt;tt&gt;/user/sites/{sitename}/themes&lt;/tt&gt;
* &lt;tt&gt;/user/themes&lt;/tt&gt;
* &lt;tt&gt;/3rdparty/themes&lt;/tt&gt;
* &lt;tt&gt;/system/themes&lt;/tt&gt;

The first theme with a given name found from these directories (in order from top to bottom) will be available to Habari for selection. Other themes with the same name but in later directories will not be available for activation. This allows a theme in the user directory (one modified by the user) to override one of the same name in subsequent directories.

== Plugins ==

Habari will look in each of these directories for plugins that can be activated:

* &lt;tt&gt;/user/sites/{sitename}/plugins&lt;/tt&gt;
* &lt;tt&gt;/user/plugins&lt;/tt&gt;
* &lt;tt&gt;/3rdparty/plugins&lt;/tt&gt;
* &lt;tt&gt;/system/plugins&lt;/tt&gt;

The first plugin with a given name found from these directories (in order from top to bottom) will be available to Habari for selection.  Other plugins with the same name but in later directories will not be available for activation.  This allows a plugin in the &lt;tt&gt;user&lt;/tt&gt; directory (one modified by the user) to override one of the same name in subsequent directories.

As with the theme directories, the &lt;tt&gt;user&lt;/tt&gt; directory is for user-created content.  The &lt;tt&gt;system&lt;/tt&gt; directory is for content supplied by the core software.  The &lt;tt&gt;3rdparty&lt;/tt&gt; directory is for contributed content that is external to the core software, such as that which can be updated by subversion checkout from a non-Habari repository.

{{developer}}

[[Category:Manual]]</pre>
</div>
<div title="Using Excerpts" modifier="mikelietz" modified="200807241323" created="200807242317" tags="Category:Manual Category:Theming" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>By default, the k2 theme will &quot;summarize&quot; all posts.  This is controlled via the theme.php file in the theme directory.  The three parameters in the default code are 'more', 100, 1. 'more' is the text you want on the page to link to the full post, 100 is the number of characters, and 1 is the number of paragraphs.  Which ever the function sees first (either 100 characters, or 1 paragraph), it will invoke the 'more' link.  So if you want longer excerpts, you would change that to something like 500, 3, or what ever you were comfortable with.  Conversely, you can drop the number of characters and paragraphs in function, and simply manually add &lt;code&gt;&lt;!--more--&gt;&lt;/code&gt; inside the post.

''Note, there may be formatting issues with custom themes'' 

The first, is to simply comment out the line in your theme.php file that applies the summarize function to the posts.  Line 23 of k2's theme.php file reads:
&lt;source lang=&quot;php&quot;&gt;Format::apply_with_hook_params( 'more', 'post_content_out', 'more', 100, 1 );&lt;/source&gt;

Simply change that to:
&lt;source lang=&quot;php&quot;&gt;// Format::apply_with_hook_params( 'more', 'post_content_out', 'more', 100, 1 );&lt;/source&gt;

Commenting out versus removing would be best, if for no other reason than it would make it easier to add back later.  Now all of your posts should be full posts, not the truncated &quot;excerpts&quot;.

A second, and more versatile method of using this function, would be to change how the summarize function is applied, there by giving you both excerpts, and full post output.  It might be best to make a backup of this file before making changes, just in case you make any errors, or decide to revert to the default file.

In line 23 in the above example, we simply commented out the entire thing.  Now we are going to change how the function is applied, so that you can have both full length and excerpt posts.

Before line 23 add a line:
&lt;source lang=&quot;php&quot;&gt;Format::apply( 'autop', 'post_content_excerpt' );&lt;/source&gt;

Then change line 23 to:
&lt;source lang=&quot;php&quot;&gt;Format::apply_with_hook_params( 'more', 'post_content_excerpt', 'more', 100, 1 );&lt;/source&gt;

''note, you can use excerpt, summary, what ever you care to call it, you just need to be sure that you make the necessary changes in the following code''

Now, if you notice in your home.php file (or entry.multiple.php), the content is being called using:

&lt;source lang=&quot;php&quot;&gt;&lt;?php echo $post-&gt;content_out; ?&gt;&lt;/source&gt;

If you have made the previous change, your posts should now be full length.  Now suppose you have somewhere you want to have excerpts.  You can simply call:
&lt;source lang=&quot;php&quot;&gt;&lt;?php echo $post-&gt;content_excerpt; ?&gt;&lt;/source&gt;
and your posts will be excerpts.

[[Category:Manual]]
[[Category:Theming]]</pre>
</div>
<div title="What's New" modifier="YourName" modified="200807250337" created="200711050122" tags="MediaWikiFormat" changecount="9">
<pre>== Introduction ==
Welcome to Habari Version 0.5!

This latest release of Habari contains some major improvements and feature changes.

* There is a new administrative interface, lovingly named Monolith
* Several translations are being shipped with Habari. These include the default English, as well as German, Japanese, and Taiwan Chinese
* We now include three themes in the download
* In addition to using MySQL and SQLite, you now have the choice of using PostgreSQL as your backend database
* Session handling has been improved
* Limited UTF8 support has been added
* There are importers for both WordPress and Serendipity
* Improved SQLite security out of the box
* Habari's form creation interface has been revamped, allowing for more customization of forms by plugins and creating an infrastructure for creating new content types.


== Known Bugs ==
Close to 300 bug fixes and improvements have been made since the last release, but many are still listed on [http://trac.habariproject.org/habari/timeline trac]. Many of these revolved around dealing with multibyte character set.

==Credits==
These release notes were compiled by the [http://wiki.habariproject.org/en/Habari_Project:Community_Portal Habari Community].

On behalf of the community, we give our warmest thanks to the developers and contributors who made this Habari release possible.</pre>
</div>
<div title="XHTML vs HTML" modifier="Massimiliano" modified="200802022109" created="200807242317" tags="Category:Manual" wikiformat="mediawiki" server.host="wiki.habariproject.org/w" server.page.revision="undefined">
<pre>This page has been created to house points relating to the XHTML vs HTML debate. In the context of this page, we're talking about REAL XHTML, served with the correct mime-type and all the fun and problems that come with it.

Let's start it off with a lovely quote from a post to the Habari-dev mailing list by Mark Pilgram:

&quot;If you want to produce application/xhtml+xml, you are free to do so. If you get it right, no one will notice.  If you get it wrong, no one will forgive you.&quot;

'''Faux XHTML:''' &quot;XHTML&quot; sent as text/html. It may look like XHTML, it may even validate (unlikely, but possible), but it's parsed as HTML by browsers. It conveys none of the advantages for which XHTML was invented. Since it's usually not well-formed, it cannot easily be converted to &quot;real&quot; XHTML.

'''Real XHTML:''' XHTML sent as application/xhtml+xml to compatible browsers (and, perhaps, as text/html to Internet Explorer). Parsed as XML, it must be well-formed, or the user receives a fatal parsing error. Its XML nature allows, among other things, extensions by other XML dialects, like SVG and MathML.

To focus the discussion, let us look at some blogs which actually ''do'' use real XHTML.

1. [http://intertwingly.net/blog/ Sam Ruby's blog]. Software is home-grown, written in python. Extensively uses inline SVG.

2. [http://golem.ph.utexas.edu/~distler/blog/ Musings], [http://golem.ph.utexas.edu/category/ the n-Category Cafe] and [http://golem.ph.utexas.edu/string/ the String Coffee Table]. Software is a heavily-modified version of MovableType. Extensively use inline MathML and the odd bit of SVG.

You'll note two things

a) Both have a use-case which justifies the extra effort of producing '''real''' XHTML.

b) Both assemble their pages by string concatenation.

c) Both go to extraordinary lengths to ensure well-formedness, in software. 

If you are going to build your pages by concatenating strings, achieving well-formedness is '''difficult'''. And it's ''fragile''. A misbehaving plugin, or a simple failure to properly sanitize user input and ... boom! ... visitors are staring at a Yellow Screen of Death.

If you are going to produce real XHTML in a tool usable by ordinary users, then you '''cannot''' do it by string concatenation. You need to assemble your content by serializing an XML DOM tree.

If you want to allow plugins, then your plugin API ''cannot'' allow plugin authors to stick arbitrary strings in the output. Rather, they should be allowed to add nodes to the DOM tree, or to manipulate existing ones.

And so forth... It requires a programming discipline entirely different from that employed in the Habari project heretofore.

I don't have any examples of blog software constructed this way.

I can, however, point to some [http://golem.ph.utexas.edu/instiki/show/HomePage Wiki software] that assembles its content that way. It's written in Ruby-on-Rails, and so it still uses templates (i.e., string concatenation) for its output. But the content is assembled by serializing an XML tree using REXML.

Again, there's a compelling use-case -- the ability to freely write equations in LaTeX, rendered to MathML -- for going to the extra trouble software-wise. But, more relevant, it's much ''less fragile,'' and was much easier to implement, than the previous examples, which used string concatenation.

It seems to me that, if you are going to produce XHTML, that's what you need to do. If you are going to produce faux XHTML (served as text/html) by crappy old string-concatenation techniques, then you might as well produce HTML4. Browser are going to consume it as malformed HTML4 anyway.

Probably, there are too few potential users who are interested in MathML or SVG (or whatever) to make the extra effort required to produce real XHML worth it. (Personally, I think there's a chicken-or-egg aspect to that question: the only way to find out how many people would like having SVG on their blog is to provide a blogging tool which allows them to do it.)

[[Category:Manual]]</pre>
</div>
<div title="XHTML_vs_HTML" modifier="miklb" created="200710132022" tags="MediaWikiFormat" changecount="1">
<pre>This page has been created to house points relating to the XHTML vs HTML debate. In the context of this page, we're talking about REAL XHTML, served with the correct mime-type and all the fun and problems that come with it.

Let's start it off with a lovely quote from a post to the Habari-dev mailing list by Mark Pilgram:

&quot;If you want to produce application/xhtml+xml, you are free to do so. If you get it right, no one will notice.  If you get it wrong, no one will forgive you.&quot;

'''Faux XHTML:''' &quot;XHTML&quot; sent as text/html. It may look like XHTML, it may even validate (unlikely, but possible), but it's parsed as HTML by browsers. It conveys none of the advantages for which XHTML was invented. Since it's usually not well-formed, it cannot easily be converted to &quot;real&quot; XHTML.

'''Real XHTML:''' XHTML sent as application/xhtml+xml to compatible browsers (and, perhaps, as text/html to Internet Explorer). Parsed as XML, it must be well-formed, or the user receives a fatal parsing error. Its XML nature allows, among other things, extensions by other XML dialects, like SVG and MathML.

To focus the discussion, let us look at some blogs which actually ''do'' use real XHTML.

1. [http://intertwingly.net/blog/ Sam Ruby's blog]. Software is home-grown, written in python. Extensively uses inline SVG.

2. [http://golem.ph.utexas.edu/~distler/blog/ Musings], [http://golem.ph.utexas.edu/category/ the n-Category Cafe] and [http://golem.ph.utexas.edu/string/ the String Coffee Table]. Software is a heavily-modified version of MovableType. Extensively use inline MathML and the odd bit of SVG.

You'll note two things

a) Both have a use-case which justifies the extra effort of producing '''real''' XHTML.

b) Both assemble their pages by string concatenation.

c) Both go to extraordinary lengths to ensure well-formedness, in software. 

If you are going to build your pages by concatenating strings, achieving well-formedness is '''difficult'''. And it's ''fragile''. A misbehaving plugin, or a simple failure to properly sanitize user input and ... boom! ... visitors are staring at a Yellow Screen of Death.

If you are going to produce real XHTML in a tool usable by ordinary users, then you '''cannot''' do it by string concatenation. You need to assemble your content by serializing an XML DOM tree.

If you want to allow plugins, then your plugin API ''cannot'' allow plugin authors to stick arbitrary strings in the output. Rather, they should be allowed to add nodes to the DOM tree, or to manipulate existing ones.

And so forth... It requires a programming discipline entirely different from that employed in the Habari project heretofore.

I don't have any examples of blog software constructed this way.

I can, however, point to some [http://golem.ph.utexas.edu/instiki/show/HomePage Wiki software] that assembles its content that way. It's written in Ruby-on-Rails, and so it still uses templates (i.e., string concatenation) for its output. But the content is assembled by serializing an XML tree using REXML.

Again, there's a compelling use-case -- the ability to freely write equations in LaTeX, rendered to MathML -- for going to the extra trouble software-wise. But, more relevant, it's much ''less fragile,'' and was much easier to implement, than the previous examples, which used string concatenation.

It seems to me that, if you are going to produce XHTML, that's what you need to do. If you are going to produce faux XHTML (served as text/html) by crappy old string-concatenation techniques, then you might as well produce HTML4. Browser are going to consume it as malformed HTML4 anyway.

Probably, there are too few potential users who are interested in MathML or SVG (or whatever) to make the extra effort required to produce real XHML worth it. (Personally, I think there's a chicken-or-egg aspect to that question: the only way to find out how many people would like having SVG on their blog is to provide a blogging tool which allows them to do it.)
</pre>
</div>
</div>
<!--POST-STOREAREA-->
<!--POST-BODY-START-->

<!--POST-BODY-END-->
<script type="text/javascript">
//<![CDATA[
//
// Please note:
// 
// * This code is designed to be readable but for compactness it only includes brief comments. You can see fuller comments
//   in the project Subversion repository at http://svn.tiddlywiki.org/Trunk/core/
//
// * You should never need to modify this source code directly. TiddlyWiki is carefully designed to allow deep customisation
//   without changing the core code. Please consult the development group at http://groups.google.com/group/TiddlyWikiDev
// 

//--
//-- Configuration repository
//--

// Miscellaneous options
var config = {
	numRssItems: 20, // Number of items in the RSS feed
	animDuration: 400, // Duration of UI animations in milliseconds
	cascadeFast: 20, // Speed for cascade animations (higher == slower)
	cascadeSlow: 60, // Speed for EasterEgg cascade animations
	cascadeDepth: 5 // Depth of cascade animation
};

// Adaptors
config.adaptors = {};

// Backstage tasks
config.tasks = {};

// Annotations
config.annotations = {};

// Custom fields to be automatically added to new tiddlers
config.defaultCustomFields = {};

// Messages
config.messages = {
	messageClose: {},
	dates: {},
	tiddlerPopup: {}
};

// Options that can be set in the options panel and/or cookies
config.options = {
	chkRegExpSearch: false,
	chkCaseSensitiveSearch: false,
	chkAnimate: true,
	chkSaveBackups: true,
	chkAutoSave: false,
	chkGenerateAnRssFeed: false,
	chkSaveEmptyTemplate: false,
	chkOpenInNewWindow: true,
	chkToggleLinks: false,
	chkHttpReadOnly: true,
	chkForceMinorUpdate: false,
	chkConfirmDelete: true,
	chkInsertTabs: false,
	chkUsePreForStorage: true, // Whether to use <pre> format for storage
	chkDisplayStartupTime: false,
	txtBackupFolder: "",
	txtMainTab: "tabTimeline",
	txtMoreTab: "moreTabAll",
	txtMaxEditRows: "30",
	txtFileSystemCharSet: "UTF-8"
	};
config.optionsDesc = {};
	
// List of notification functions to be called when certain tiddlers are changed or deleted
config.notifyTiddlers = [
	{name: "StyleSheetLayout", notify: refreshStyles},
	{name: "StyleSheetColors", notify: refreshStyles},
	{name: "StyleSheet", notify: refreshStyles},
	{name: "StyleSheetPrint", notify: refreshStyles},
	{name: "PageTemplate", notify: refreshPageTemplate},
	{name: "SiteTitle", notify: refreshPageTitle},
	{name: "SiteSubtitle", notify: refreshPageTitle},
	{name: "ColorPalette", notify: refreshColorPalette},
	{name: null, notify: refreshDisplay}
];

// Default tiddler templates
var DEFAULT_VIEW_TEMPLATE = 1;
var DEFAULT_EDIT_TEMPLATE = 2;
config.tiddlerTemplates = {
	1: "ViewTemplate",
	2: "EditTemplate"
};

// More messages (rather a legacy layout that shouldn't really be like this)
config.views = {
	wikified: {
		tag: {}
	},
	editor: {
		tagChooser: {}
	}
};

// Backstage tasks
config.backstageTasks = ["save","sync","importTask","tweak","plugins"];

// Macros; each has a 'handler' member that is inserted later
config.macros = {
	today: {},
	version: {},
	search: {sizeTextbox: 15},
	tiddler: {},
	tag: {},
	tags: {},
	tagging: {},
	timeline: {},
	allTags: {},
	list: {
		all: {},
		missing: {},
		orphans: {},
		shadowed: {},
		touched: {}
	},
	closeAll: {},
	permaview: {},
	saveChanges: {},
	slider: {},
	option: {},
	options: {},
	newTiddler: {},
	newJournal: {},
	sparkline: {},
	tabs: {},
	gradient: {},
	message: {},
	view: {},
	edit: {},
	tagChooser: {},
	toolbar: {},
	br: {},
	plugins: {},
	refreshDisplay: {},
	importTiddlers: {},
	sync: {},
	annotations: {}
};

// Commands supported by the toolbar macro
config.commands = {
	closeTiddler: {},
	closeOthers: {},
	editTiddler: {},
	saveTiddler: {hideReadOnly: true},
	cancelTiddler: {},
	deleteTiddler: {hideReadOnly: true},
	permalink: {},
	references: {type: "popup"},
	jump: {type: "popup"},
	syncing: {type: "popup"},
	fields: {type: "popup"}
};

// Browser detection... In a very few places, there's nothing else for it but to know what browser we're using.
config.userAgent = navigator.userAgent.toLowerCase();
config.browser = {
	isIE: config.userAgent.indexOf("msie") != -1 && config.userAgent.indexOf("opera") == -1,
	isGecko: config.userAgent.indexOf("gecko") != -1,
	ieVersion: /MSIE (\d.\d)/i.exec(config.userAgent), // config.browser.ieVersion[1], if it exists, will be the IE version string, eg "6.0"
	isSafari: config.userAgent.indexOf("applewebkit") != -1,
	isBadSafari: !((new RegExp("[\u0150\u0170]","g")).test("\u0150")),
	firefoxDate: /gecko\/(\d{8})/i.exec(config.userAgent), // config.browser.firefoxDate[1], if it exists, will be Firefox release date as "YYYYMMDD"
	isOpera: config.userAgent.indexOf("opera") != -1,
	isLinux: config.userAgent.indexOf("linux") != -1,
	isUnix: config.userAgent.indexOf("x11") != -1,
	isMac: config.userAgent.indexOf("mac") != -1,
	isWindows: config.userAgent.indexOf("win") != -1
};

// Basic regular expressions
config.textPrimitives = {
	upperLetter: "[A-Z\u00c0-\u00de\u0150\u0170]",
	lowerLetter: "[a-z0-9_\\-\u00df-\u00ff\u0151\u0171]",
	anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]",
	anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]"
};
if(config.browser.isBadSafari) {
	config.textPrimitives = {
		upperLetter: "[A-Z\u00c0-\u00de]",
		lowerLetter: "[a-z0-9_\\-\u00df-\u00ff]",
		anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff]",
		anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff]"
	};
}
config.textPrimitives.sliceSeparator = "::";
config.textPrimitives.urlPattern = "[a-z]{3,8}:[^\\s:'\"][^\\s'\"]*(?:/|\\b)";
config.textPrimitives.unWikiLink = "~";
config.textPrimitives.wikiLink = "(?:(?:" + config.textPrimitives.upperLetter + "+" +
	config.textPrimitives.lowerLetter + "+" +
	config.textPrimitives.upperLetter +
	config.textPrimitives.anyLetter + "*)|(?:" +
	config.textPrimitives.upperLetter + "{2,}" +
	config.textPrimitives.lowerLetter + "+))";

config.textPrimitives.cssLookahead = "(?:(" + config.textPrimitives.anyLetter + "+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:(" + config.textPrimitives.anyLetter + "+):([^;\\|\\n]+);)";
config.textPrimitives.cssLookaheadRegExp = new RegExp(config.textPrimitives.cssLookahead,"mg");

config.textPrimitives.brackettedLink = "\\[\\[([^\\]]+)\\]\\]";
config.textPrimitives.titledBrackettedLink = "\\[\\[([^\\[\\]\\|]+)\\|([^\\[\\]\\|]+)\\]\\]";
config.textPrimitives.tiddlerForcedLinkRegExp = new RegExp("(?:" + config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" + 
	config.textPrimitives.urlPattern + ")","mg");
config.textPrimitives.tiddlerAnyLinkRegExp = new RegExp("("+ config.textPrimitives.wikiLink + ")|(?:" +
	config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")","mg");

config.glyphs = {
	browsers: [
		function() {return config.browser.isIE;},
		function() {return true}
	],
	currBrowser: null,
	codes: {
		downTriangle: ["\u25BC","\u25BE"],
		downArrow: ["\u2193","\u2193"],
		bentArrowLeft: ["\u2190","\u21A9"],
		bentArrowRight: ["\u2192","\u21AA"]
	}
};

//--
//-- Shadow tiddlers
//--

config.shadowTiddlers = {
	StyleSheet: "",
	MarkupPreHead: "<!--{{{-->\n<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml'/>\n<!--}}}-->",
	MarkupPostHead: "",
	MarkupPreBody: "",
	MarkupPostBody: "",
	TabTimeline: '<<timeline>>',
	TabAll: '<<list all>>',
	TabTags: '<<allTags excludeLists>>',
	TabMoreMissing: '<<list missing>>',
	TabMoreOrphans: '<<list orphans>>',
	TabMoreShadowed: '<<list shadowed>>',
	AdvancedOptions: '<<options>>',
	PluginManager: '<<plugins>>',
	ImportTiddlers: '<<importTiddlers>>'
};

//--
//-- Translateable strings
//--

// Strings in "double quotes" should be translated; strings in 'single quotes' should be left alone

merge(config.options,{
	txtUserName: "YourName"});

merge(config.tasks,{
	save: {text: "save", tooltip: "Save your changes to this TiddlyWiki", action: saveChanges},
	sync: {text: "sync", tooltip: "Synchronise changes with other TiddlyWiki files and servers", content: '<<sync>>'},
	importTask: {text: "import", tooltip: "Import tiddlers and plugins from other TiddlyWiki files and servers", content: '<<importTiddlers>>'},
	tweak: {text: "tweak", tooltip: "Tweak the appearance and behaviour of TiddlyWiki", content: '<<options>>'},
	plugins: {text: "plugins", tooltip: "Manage installed plugins", content: '<<plugins>>'}
});

// Options that can be set in the options panel and/or cookies
merge(config.optionsDesc,{
	txtUserName: "Username for signing your edits",
	chkRegExpSearch: "Enable regular expressions for searches",
	chkCaseSensitiveSearch: "Case-sensitive searching",
	chkAnimate: "Enable animations",
	chkSaveBackups: "Keep backup file when saving changes",
	chkAutoSave: "Automatically save changes",
	chkGenerateAnRssFeed: "Generate an RSS feed when saving changes",
	chkSaveEmptyTemplate: "Generate an empty template when saving changes",
	chkOpenInNewWindow: "Open external links in a new window",
	chkToggleLinks: "Clicking on links to open tiddlers causes them to close",
	chkHttpReadOnly: "Hide editing features when viewed over HTTP",
	chkForceMinorUpdate: "Don't update modifier username and date when editing tiddlers",
	chkConfirmDelete: "Require confirmation before deleting tiddlers",
	chkInsertTabs: "Use the tab key to insert tab characters instead of moving between fields",
	txtBackupFolder: "Name of folder to use for backups",
	txtMaxEditRows: "Maximum number of rows in edit boxes",
	txtFileSystemCharSet: "Default character set for saving changes (Firefox/Mozilla only)"});

merge(config.messages,{
	customConfigError: "Problems were encountered loading plugins. See PluginManager for details",
	pluginError: "Error: %0",
	pluginDisabled: "Not executed because disabled via 'systemConfigDisable' tag",
	pluginForced: "Executed because forced via 'systemConfigForce' tag",
	pluginVersionError: "Not executed because this plugin needs a newer version of TiddlyWiki",
	nothingSelected: "Nothing is selected. You must select one or more items first",
	savedSnapshotError: "It appears that this TiddlyWiki has been incorrectly saved. Please see http://www.tiddlywiki.com/#DownloadSoftware for details",
	subtitleUnknown: "(unknown)",
	undefinedTiddlerToolTip: "The tiddler '%0' doesn't yet exist",
	shadowedTiddlerToolTip: "The tiddler '%0' doesn't yet exist, but has a pre-defined shadow value",
	tiddlerLinkTooltip: "%0 - %1, %2",
	externalLinkTooltip: "External link to %0",
	noTags: "There are no tagged tiddlers",
	notFileUrlError: "You need to save this TiddlyWiki to a file before you can save changes",
	cantSaveError: "It's not possible to save changes. Possible reasons include:\n- your browser doesn't support saving (Firefox, Internet Explorer, Safari and Opera all work if properly configured)\n- the pathname to your TiddlyWiki file contains illegal characters\n- the TiddlyWiki HTML file has been moved or renamed",
	invalidFileError: "The original file '%0' does not appear to be a valid TiddlyWiki",
	backupSaved: "Backup saved",
	backupFailed: "Failed to save backup file",
	rssSaved: "RSS feed saved",
	rssFailed: "Failed to save RSS feed file",
	emptySaved: "Empty template saved",
	emptyFailed: "Failed to save empty template file",
	mainSaved: "Main TiddlyWiki file saved",
	mainFailed: "Failed to save main TiddlyWiki file. Your changes have not been saved",
	macroError: "Error in macro <<\%0>>",
	macroErrorDetails: "Error while executing macro <<\%0>>:\n%1",
	missingMacro: "No such macro",
	overwriteWarning: "A tiddler named '%0' already exists. Choose OK to overwrite it",
	unsavedChangesWarning: "WARNING! There are unsaved changes in TiddlyWiki\n\nChoose OK to save\nChoose CANCEL to discard",
	confirmExit: "--------------------------------\n\nThere are unsaved changes in TiddlyWiki. If you continue you will lose those changes\n\n--------------------------------",
	saveInstructions: "SaveChanges",
	unsupportedTWFormat: "Unsupported TiddlyWiki format '%0'",
	tiddlerSaveError: "Error when saving tiddler '%0'",
	tiddlerLoadError: "Error when loading tiddler '%0'",
	wrongSaveFormat: "Cannot save with storage format '%0'. Using standard format for save.",
	invalidFieldName: "Invalid field name %0",
	fieldCannotBeChanged: "Field '%0' cannot be changed",
	loadingMissingTiddler: "Attempting to retrieve the tiddler '%0' from the '%1' server at:\n\n'%2' in the workspace '%3'"});

merge(config.messages.messageClose,{
	text: "close",
	tooltip: "close this message area"});

config.messages.backstage = {
	open: {text: "backstage", tooltip: "Open the backstage area to perform authoring and editing tasks"},
	close: {text: "close", tooltip: "Close the backstage area"},
	prompt: "backstage: ",
	decal: {
		edit: {text: "edit", tooltip: "Edit the tiddler '%0'"}
	}
};

config.messages.listView = {
	tiddlerTooltip: "Click for the full text of this tiddler",
	previewUnavailable: "(preview not available)"
};

config.messages.dates.months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November","December"];
config.messages.dates.days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
config.messages.dates.shortMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
config.messages.dates.shortDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
// suffixes for dates, eg "1st","2nd","3rd"..."30th","31st"
config.messages.dates.daySuffixes = ["st","nd","rd","th","th","th","th","th","th","th",
		"th","th","th","th","th","th","th","th","th","th",
		"st","nd","rd","th","th","th","th","th","th","th",
		"st"];
config.messages.dates.am = "am";
config.messages.dates.pm = "pm";

merge(config.messages.tiddlerPopup,{
	});

merge(config.views.wikified.tag,{
	labelNoTags: "no tags",
	labelTags: "tags: ",
	openTag: "Open tag '%0'",
	tooltip: "Show tiddlers tagged with '%0'",
	openAllText: "Open all",
	openAllTooltip: "Open all of these tiddlers",
	popupNone: "No other tiddlers tagged with '%0'"});

merge(config.views.wikified,{
	defaultText: "The tiddler '%0' doesn't yet exist. Double-click to create it",
	defaultModifier: "(missing)",
	shadowModifier: "(built-in shadow tiddler)",
	dateFormat: "DD MMM YYYY",
	createdPrompt: "created"});

merge(config.views.editor,{
	tagPrompt: "Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing",
	defaultText: "Type the text for '%0'"});

merge(config.views.editor.tagChooser,{
	text: "tags",
	tooltip: "Choose existing tags to add to this tiddler",
	popupNone: "There are no tags defined",
	tagTooltip: "Add the tag '%0'"});

merge(config.messages,{
	sizeTemplates:
		[
		{unit: 1024*1024*1024, template: "%0\u00a0GB"},
		{unit: 1024*1024, template: "%0\u00a0MB"},
		{unit: 1024, template: "%0\u00a0KB"},
		{unit: 1, template: "%0\u00a0B"}
		]});

merge(config.macros.search,{
	label: "search",
	prompt: "Search this TiddlyWiki",
	accessKey: "F",
	successMsg: "%0 tiddlers found matching %1",
	failureMsg: "No tiddlers found matching %0"});

merge(config.macros.tagging,{
	label: "tagging: ",
	labelNotTag: "not tagging",
	tooltip: "List of tiddlers tagged with '%0'"});

merge(config.macros.timeline,{
	dateFormat: "DD MMM YYYY"});

merge(config.macros.allTags,{
	tooltip: "Show tiddlers tagged with '%0'",
	noTags: "There are no tagged tiddlers"});

config.macros.list.all.prompt = "All tiddlers in alphabetical order";
config.macros.list.missing.prompt = "Tiddlers that have links to them but are not defined";
config.macros.list.orphans.prompt = "Tiddlers that are not linked to from any other tiddlers";
config.macros.list.shadowed.prompt = "Tiddlers shadowed with default contents";
config.macros.list.touched.prompt = "Tiddlers that have been modified locally";

merge(config.macros.closeAll,{
	label: "close all",
	prompt: "Close all displayed tiddlers (except any that are being edited)"});

merge(config.macros.permaview,{
	label: "permaview",
	prompt: "Link to an URL that retrieves all the currently displayed tiddlers"});

merge(config.macros.saveChanges,{
	label: "save changes",
	prompt: "Save all tiddlers to create a new TiddlyWiki",
	accessKey: "S"});

merge(config.macros.newTiddler,{
	label: "new tiddler",
	prompt: "Create a new tiddler",
	title: "New Tiddler",
	accessKey: "N"});

merge(config.macros.newJournal,{
	label: "new journal",
	prompt: "Create a new tiddler from the current date and time",
	accessKey: "J"});

merge(config.macros.options,{
	wizardTitle: "Tweak advanced options",
	step1Title: "These options are saved in cookies in your browser",
	step1Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='false' name='chkUnknown'>Show unknown options</input>",
	unknownDescription: "//(unknown)//",
	listViewTemplate: {
		columns: [
			{name: 'Option', field: 'option', title: "Option", type: 'String'},
			{name: 'Description', field: 'description', title: "Description", type: 'WikiText'},
			{name: 'Name', field: 'name', title: "Name", type: 'String'}
			],
		rowClasses: [
			{className: 'lowlight', field: 'lowlight'} 
			]}
	});

merge(config.macros.plugins,{
	wizardTitle: "Manage plugins",
	step1Title: "Currently loaded plugins",
	step1Html: "<input type='hidden' name='markList'></input>", // DO NOT TRANSLATE
	skippedText: "(This plugin has not been executed because it was added since startup)",
	noPluginText: "There are no plugins installed",
	confirmDeleteText: "Are you sure you want to delete these plugins:\n\n%0",
	removeLabel: "remove systemConfig tag",
	removePrompt: "Remove systemConfig tag",
	deleteLabel: "delete",
	deletePrompt: "Delete these tiddlers forever",
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
			{name: 'Forced', field: 'forced', title: "Forced", tag: 'systemConfigForce', type: 'TagCheckbox'},
			{name: 'Disabled', field: 'disabled', title: "Disabled", tag: 'systemConfigDisable', type: 'TagCheckbox'},
			{name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No"},
			{name: 'Startup Time', field: 'startupTime', title: "Startup Time", type: 'String'},
			{name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK"},
			{name: 'Log', field: 'log', title: "Log", type: 'StringList'}
			],
		rowClasses: [
			{className: 'error', field: 'error'},
			{className: 'warning', field: 'warning'}
			]}
	});

merge(config.macros.toolbar,{
	moreLabel: "more",
	morePrompt: "Reveal further commands"
	});

merge(config.macros.refreshDisplay,{
	label: "refresh",
	prompt: "Redraw the entire TiddlyWiki display"
	});

merge(config.macros.importTiddlers,{
	readOnlyWarning: "You cannot import into a read-only TiddlyWiki file. Try opening it from a file:// URL",
	wizardTitle: "Import tiddlers from another file or server",
	step1Title: "Step 1: Locate the server or TiddlyWiki file",
	step1Html: "Specify the type of the server: <select name='selTypes'><option value=''>Choose...</option></select><br>Enter the URL or pathname here: <input type='text' size=50 name='txtPath'><br>...or browse for a file: <input type='file' size=50 name='txtBrowse'><br><hr>...or select a pre-defined feed: <select name='selFeeds'><option value=''>Choose...</option></select>",
	openLabel: "open",
	openPrompt: "Open the connection to this file or server",
	openError: "There were problems fetching the tiddlywiki file",
	statusOpenHost: "Opening the host",
	statusGetWorkspaceList: "Getting the list of available workspaces",
	step2Title: "Step 2: Choose the workspace",
	step2Html: "Enter a workspace name: <input type='text' size=50 name='txtWorkspace'><br>...or select a workspace: <select name='selWorkspace'><option value=''>Choose...</option></select>",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel this import",
	statusOpenWorkspace: "Opening the workspace",
	statusGetTiddlerList: "Getting the list of available tiddlers",
	step3Title: "Step 3: Choose the tiddlers to import",
	step3Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='true' name='chkSync'>Keep these tiddlers linked to this server so that you can synchronise subsequent changes</input><br><input type='checkbox' name='chkSave'>Save the details of this server in a 'systemServer' tiddler called:</input> <input type='text' size=25 name='txtSaveTiddler'>",
	importLabel: "import",
	importPrompt: "Import these tiddlers",
	confirmOverwriteText: "Are you sure you want to overwrite these tiddlers:\n\n%0",
	step4Title: "Step 4: Importing %0 tiddler(s)",
	step4Html: "<input type='hidden' name='markReport'></input>", // DO NOT TRANSLATE
	doneLabel: "done",
	donePrompt: "Close this wizard",
	statusDoingImport: "Importing tiddlers",
	statusDoneImport: "All tiddlers imported",
	systemServerNamePattern: "%2 on %1",
	systemServerNamePatternNoWorkspace: "%1",
	confirmOverwriteSaveTiddler: "The tiddler '%0' already exists. Click 'OK' to overwrite it with the details of this server, or 'Cancel' to leave it unchanged",
	serverSaveTemplate: "|''Type:''|%0|\n|''URL:''|%1|\n|''Workspace:''|%2|\n\nThis tiddler was automatically created to record the details of this server",
	serverSaveModifier: "(System)",
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
			{name: 'Tags', field: 'tags', title: "Tags", type: 'Tags'}
			],
		rowClasses: [
			]}
	});

merge(config.macros.sync,{
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Server Type', field: 'serverType', title: "Server type", type: 'String'},
			{name: 'Server Host', field: 'serverHost', title: "Server host", type: 'String'},
			{name: 'Server Workspace', field: 'serverWorkspace', title: "Server workspace", type: 'String'},
			{name: 'Status', field: 'status', title: "Synchronisation status", type: 'String'},
			{name: 'Server URL', field: 'serverUrl', title: "Server URL", text: "View", type: 'Link'}
			],
		rowClasses: [
			],
		buttons: [
			{caption: "Sync these tiddlers", name: 'sync'}
			]},
	wizardTitle: "Synchronize with external servers and files",
	step1Title: "Choose the tiddlers you want to synchronize",
	step1Html: "<input type='hidden' name='markList'></input>", // DO NOT TRANSLATE
	syncLabel: "sync",
	syncPrompt: "Sync these tiddlers",
	hasChanged: "Changed while unplugged",
	hasNotChanged: "Unchanged while unplugged",
	syncStatusList: {
		none: {text: "...", color: "none"},
		changedServer: {text: "Changed on server", color: '#80ff80'},
		changedLocally: {text: "Changed while unplugged", color: '#80ff80'},
		changedBoth: {text: "Changed while unplugged and on server", color: '#ff8080'},
		notFound: {text: "Not found on server", color: '#ffff80'},
		putToServer: {text: "Saved update on server", color: '#ff80ff'},
		gotFromServer: {text: "Retrieved update from server", color: '#80ffff'}
		}
	});

merge(config.macros.annotations,{
	});

merge(config.commands.closeTiddler,{
	text: "close",
	tooltip: "Close this tiddler"});

merge(config.commands.closeOthers,{
	text: "close others",
	tooltip: "Close all other tiddlers"});

merge(config.commands.editTiddler,{
	text: "edit",
	tooltip: "Edit this tiddler",
	readOnlyText: "view",
	readOnlyTooltip: "View the source of this tiddler"});

merge(config.commands.saveTiddler,{
	text: "done",
	tooltip: "Save changes to this tiddler"});

merge(config.commands.cancelTiddler,{
	text: "cancel",
	tooltip: "Undo changes to this tiddler",
	warning: "Are you sure you want to abandon your changes to '%0'?",
	readOnlyText: "done",
	readOnlyTooltip: "View this tiddler normally"});

merge(config.commands.deleteTiddler,{
	text: "delete",
	tooltip: "Delete this tiddler",
	warning: "Are you sure you want to delete '%0'?"});

merge(config.commands.permalink,{
	text: "permalink",
	tooltip: "Permalink for this tiddler"});

merge(config.commands.references,{
	text: "references",
	tooltip: "Show tiddlers that link to this one",
	popupNone: "No references"});

merge(config.commands.jump,{
	text: "jump",
	tooltip: "Jump to another open tiddler"});

merge(config.commands.syncing,{
	text: "syncing",
	tooltip: "Control synchronisation of this tiddler with a server or external file",
	currentlySyncing: "<div>Currently syncing via <span class='popupHighlight'>'%0'</span> to:</"+"div><div>host: <span class='popupHighlight'>%1</span></"+"div><div>workspace: <span class='popupHighlight'>%2</span></"+"div>", // Note escaping of closing <div> tag
	notCurrentlySyncing: "Not currently syncing",
	captionUnSync: "Stop synchronising this tiddler",
	chooseServer: "Synchronise this tiddler with another server:",
	currServerMarker: "\u25cf ",
	notCurrServerMarker: "  "});

merge(config.commands.fields,{
	text: "fields",
	tooltip: "Show the extended fields of this tiddler",
	emptyText: "There are no extended fields for this tiddler",
	listViewTemplate: {
		columns: [
			{name: 'Field', field: 'field', title: "Field", type: 'String'},
			{name: 'Value', field: 'value', title: "Value", type: 'String'}
			],
		rowClasses: [
			],
		buttons: [
			]}});

merge(config.shadowTiddlers,{
	DefaultTiddlers: "GettingStarted",
	MainMenu: "GettingStarted",
	SiteTitle: "My TiddlyWiki",
	SiteSubtitle: "a reusable non-linear personal web notebook",
	SiteUrl: "http://www.tiddlywiki.com/",
	SideBarOptions: '<<search>><<closeAll>><<permaview>><<newTiddler>><<newJournal "DD MMM YYYY">><<saveChanges>><<slider chkSliderOptionsPanel OptionsPanel "options »" "Change TiddlyWiki advanced options">>',
	SideBarTabs: '<<tabs txtMainTab "Timeline" "Timeline" TabTimeline "All" "All tiddlers" TabAll "Tags" "All tags" TabTags "More" "More lists" TabMore>>',
	TabMore: '<<tabs txtMoreTab "Missing" "Missing tiddlers" TabMoreMissing "Orphans" "Orphaned tiddlers" TabMoreOrphans "Shadowed" "Shadowed tiddlers" TabMoreShadowed>>'});

merge(config.annotations,{
	AdvancedOptions: "This shadow tiddler provides access to several advanced options",
	ColorPalette: "These values in this shadow tiddler determine the colour scheme of the ~TiddlyWiki user interface",
	DefaultTiddlers: "The tiddlers listed in this shadow tiddler will be automatically displayed when ~TiddlyWiki starts up",
	EditTemplate: "The HTML template in this shadow tiddler determines how tiddlers look while they are being edited",
	GettingStarted: "This shadow tiddler provides basic usage instructions",
	ImportTiddlers: "This shadow tiddler provides access to importing tiddlers",
	MainMenu: "This shadow tiddler is used as the contents of the main menu in the left-hand column of the screen",
	MarkupPreHead: "This tiddler is inserted at the top of the <head> section of the TiddlyWiki HTML file",
	MarkupPostHead: "This tiddler is inserted at the bottom of the <head> section of the TiddlyWiki HTML file",
	MarkupPreBody: "This tiddler is inserted at the top of the <body> section of the TiddlyWiki HTML file",
	MarkupPostBody: "This tiddler is inserted at the end of the <body> section of the TiddlyWiki HTML file immediately before the script block",
	OptionsPanel: "This shadow tiddler is used as the contents of the options panel slider in the right-hand sidebar",
	PageTemplate: "The HTML template in this shadow tiddler determines the overall ~TiddlyWiki layout",
	PluginManager: "This shadow tiddler provides access to the plugin manager",
	SideBarOptions: "This shadow tiddler is used as the contents of the option panel in the right-hand sidebar",
	SideBarTabs: "This shadow tiddler is used as the contents of the tabs panel in the right-hand sidebar",
	SiteSubtitle: "This shadow tiddler is used as the second part of the page title",
	SiteTitle: "This shadow tiddler is used as the first part of the page title",
	SiteUrl: "This shadow tiddler should be set to the full target URL for publication",
	StyleSheetColours: "This shadow tiddler contains CSS definitions related to the color of page elements",
	StyleSheet: "This tiddler can contain custom CSS definitions",
	StyleSheetLayout: "This shadow tiddler contains CSS definitions related to the layout of page elements",
	StyleSheetLocale: "This shadow tiddler contains CSS definitions related to the translation locale",
	StyleSheetPrint: "This shadow tiddler contains CSS definitions for printing",
	TabAll: "This shadow tiddler contains the contents of the 'All' tab in the right-hand sidebar",
	TabMore: "This shadow tiddler contains the contents of the 'More' tab in the right-hand sidebar",
	TabMoreMissing: "This shadow tiddler contains the contents of the 'Missing' tab in the right-hand sidebar",
	TabMoreOrphans: "This shadow tiddler contains the contents of the 'Orphans' tab in the right-hand sidebar",
	TabMoreShadowed: "This shadow tiddler contains the contents of the 'Shadowed' tab in the right-hand sidebar",
	TabTags: "This shadow tiddler contains the contents of the 'Tags' tab in the right-hand sidebar",
	TabTimeline: "This shadow tiddler contains the contents of the 'Timeline' tab in the right-hand sidebar",
	ViewTemplate: "The HTML template in this shadow tiddler determines how tiddlers look"
	});

//--
//-- Main
//--

var params = null; // Command line parameters
var store = null; // TiddlyWiki storage
var story = null; // Main story
var formatter = null; // Default formatters for the wikifier
config.parsers = {}; // Hashmap of alternative parsers for the wikifier
var anim = new Animator(); // Animation engine
var readOnly = false; // Whether we're in readonly mode
var highlightHack = null; // Embarrassing hack department...
var hadConfirmExit = false; // Don't warn more than once
var safeMode = false; // Disable all plugins and cookies
var installedPlugins = []; // Information filled in when plugins are executed
var startingUp = false; // Whether we're in the process of starting up
var pluginInfo,tiddler; // Used to pass information to plugins in loadPlugins()

// Whether to use the JavaSaver applet
var useJavaSaver = config.browser.isSafari || config.browser.isOpera;

// Starting up
function main()
{
	var t9,t8,t7,t6,t5,t4,t3,t2,t1,t0 = new Date();
	startingUp = true;
	window.onbeforeunload = function(e) {if(window.confirmExit) return confirmExit();};
	params = getParameters();
	if(params)
		params = params.parseParams("open",null,false);
	store = new TiddlyWiki();
	invokeParamifier(params,"oninit");
	story = new Story("tiddlerDisplay","tiddler");
	addEvent(document,"click",Popup.onDocumentClick);
	saveTest();
	loadOptionsCookie();
	for(var s=0; s<config.notifyTiddlers.length; s++)
		store.addNotification(config.notifyTiddlers[s].name,config.notifyTiddlers[s].notify);
	t1 = new Date();
	store.loadFromDiv("storeArea","store",true);
	t2 = new Date();
	loadShadowTiddlers();
	t3 = new Date();
	invokeParamifier(params,"onload");
	t4 = new Date();
	readOnly = (window.location.protocol == "file:") ? false : config.options.chkHttpReadOnly;
	var pluginProblem = loadPlugins();
	t5 = new Date();
	formatter = new Formatter(config.formatters);
	invokeParamifier(params,"onconfig");
	t6 = new Date();
	store.notifyAll();
	t7 = new Date();
	restart();
	t8 = new Date();
	if(pluginProblem) {
		story.displayTiddler(null,"PluginManager");
		displayMessage(config.messages.customConfigError);
	}
	for(var m in config.macros) {
		if(config.macros[m].init)
			config.macros[m].init();
	}
	if(!readOnly)
		backstage.init();
	t9 = new Date();
	if(config.options.chkDisplayStartupTime) {
		displayMessage("Load in " + (t2-t1) + " ms");
		displayMessage("Loadshadows in " + (t3-t2) + " ms");
		displayMessage("Loadplugins in " + (t5-t4) + " ms");
		displayMessage("Notify in " + (t7-t6) + " ms");
		displayMessage("Restart in " + (t8-t7) + " ms");
		displayMessage("Total startup in " + (t9-t0) + " ms");
	}
	startingUp = false;
}

// Restarting
function restart()
{
	invokeParamifier(params,"onstart");
	if(story.isEmpty()) {
		var defaultParams = store.getTiddlerText("DefaultTiddlers").parseParams("open",null,false);
		invokeParamifier(defaultParams,"onstart");
	}
	window.scrollTo(0,0);
}

function saveTest()
{
	var s = document.getElementById("saveTest");
	if(s.hasChildNodes())
		alert(config.messages.savedSnapshotError);
	s.appendChild(document.createTextNode("savetest"));
}

function loadShadowTiddlers()
{
	var shadows = new TiddlyWiki();
	shadows.loadFromDiv("shadowArea","shadows",true);
	shadows.forEachTiddler(function(title,tiddler){config.shadowTiddlers[title] = tiddler.text;});
	delete shadows;
}

function loadPlugins()
{
	if(safeMode)
		return false;
	var tiddlers = store.getTaggedTiddlers("systemConfig");
	var toLoad = [];
	var nLoaded = 0;
	var map = {};
	var nPlugins = tiddlers.length;
	installedPlugins = [];
	for(var i=0; i<nPlugins; i++) {
		var p = getPluginInfo(tiddlers[i]);
		installedPlugins[i] = p;
		var n = p.Name;
		if(n) 
			map[n] = p;
		if(n = p.Source) 
			map[n] = p;
	}
	var visit = function(p) {
		if(!p || p.done)
			return;
		p.done = 1;
		var reqs = p.Requires;
		if(reqs) {
			reqs = reqs.readBracketedList();
			for(var i=0; i<reqs.length; i++)
				visit(map[reqs[i]]);
		}
		toLoad.push(p);
	};
	for(i=0; i<nPlugins; i++) 
		visit(installedPlugins[i]);	
	for(i=0; i<toLoad.length; i++) {
		p = toLoad[i];
		pluginInfo = p;
		tiddler = p.tiddler;
		if(isPluginExecutable(p)) {
			if(isPluginEnabled(p)) {
				p.executed = true;
				var startTime = new Date();
				try {
					if(tiddler.text)
						window.eval(tiddler.text);
					nLoaded++;
				} catch(ex) {
					p.log.push(config.messages.pluginError.format([exceptionText(ex)]));
					p.error = true;
				}
				pluginInfo.startupTime = String((new Date()) - startTime) + "ms"; 
			} else {
				nPlugins--;
			}
		} else {
			p.warning = true;
		}
	}
	return nLoaded != nPlugins;
}

function getPluginInfo(tiddler)
{
	var p = store.getTiddlerSlices(tiddler.title,["Name","Description","Version","Requires","CoreVersion","Date","Source","Author","License","Browsers"]);
	p.tiddler = tiddler;
	p.title = tiddler.title;
	p.log = [];
	return p;
}

// Check that a particular plugin is valid for execution
function isPluginExecutable(plugin)
{
	if(plugin.tiddler.isTagged("systemConfigForce"))
		return verifyTail(plugin,true,config.messages.pluginForced);
	if(plugin["CoreVersion"]) {
		var coreVersion = plugin["CoreVersion"].split(".");
		var w = parseInt(coreVersion[0]) - version.major;
		if(w == 0 && coreVersion[1])
			w = parseInt(coreVersion[1]) - version.minor;
		if(w == 0 && coreVersion[2])
		 	w = parseInt(coreVersion[2]) - version.revision;
		if(w > 0)
			return verifyTail(plugin,false,config.messages.pluginVersionError);
		}
	return true;
}

function isPluginEnabled(plugin)
{
	if(plugin.tiddler.isTagged("systemConfigDisable"))
		return verifyTail(plugin,false,config.messages.pluginDisabled);
	return true;
}

function verifyTail(plugin,result,message)
{
	plugin.log.push(message);
	return result;
}

function invokeMacro(place,macro,params,wikifier,tiddler)
{
	try {
		var m = config.macros[macro];
		if(m && m.handler)
			m.handler(place,macro,params.readMacroParams(),wikifier,params,tiddler);
		else
			createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,config.messages.missingMacro]));
	} catch(ex) {
		createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,ex.toString()]));
	}
}

//--
//-- Paramifiers
//--

function getParameters()
{
	var p = null;
	if(window.location.hash) {
		p = decodeURI(window.location.hash.substr(1));
		if(config.browser.firefoxDate != null && config.browser.firefoxDate[1] < "20051111")
			p = convertUTF8ToUnicode(p);
	}
	return p;
}

function invokeParamifier(params,handler)
{
	if(!params || params.length == undefined || params.length <= 1)
		return;
	for(var t=1; t<params.length; t++) {
		var p = config.paramifiers[params[t].name];
		if(p && p[handler] instanceof Function)
			p[handler](params[t].value);
	}
}

config.paramifiers = {};

config.paramifiers.start = {
	oninit: function(v) {
		safeMode = v.toLowerCase() == "safe";
	}
};

config.paramifiers.open = {
	onstart: function(v) {
		story.displayTiddler("bottom",v,null,false,null);
	}
};

config.paramifiers.story = {
	onstart: function(v) {
		var list = store.getTiddlerText(v,"").parseParams("open",null,false);
		invokeParamifier(list,"onstart");
	}
};

config.paramifiers.search = {
	onstart: function(v) {
		story.search(v,false,false);
	}
};

config.paramifiers.searchRegExp = {
	onstart: function(v) {
		story.prototype.search(v,false,true);
	}
};

config.paramifiers.tag = {
	onstart: function(v) {
		var tagged = store.getTaggedTiddlers(v,"title");
		for(var t=0; t<tagged.length; t++)
			story.displayTiddler("bottom",tagged[t].title,null,false,null);
	}
};

config.paramifiers.newTiddler = {
	onstart: function(v) {
		if(!readOnly) {
			story.displayTiddler(null,v,DEFAULT_EDIT_TEMPLATE);
			story.focusTiddler(v,"text");
		}
	}
};

config.paramifiers.newJournal = {
	onstart: function(v) {
		if(!readOnly) {
			var now = new Date();
			var title = now.formatString(v.trim());
			story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE);
			story.focusTiddler(title,"text");
		}
	}
};

config.paramifiers.readOnly = {
	onconfig: function(v) {
		var p = v.toLowerCase();
		readOnly = p == "yes" ? true : (p == "no" ? false : readOnly);
	}
};

//--
//-- Formatter helpers
//--

function Formatter(formatters)
{
	this.formatters = [];
	var pattern = [];
	for(var n=0; n<formatters.length; n++) {
		pattern.push("(" + formatters[n].match + ")");
		this.formatters.push(formatters[n]);
	}
	this.formatterRegExp = new RegExp(pattern.join("|"),"mg");
}

config.formatterHelpers = {

	createElementAndWikify: function(w)
	{
		w.subWikifyTerm(createTiddlyElement(w.output,this.element),this.termRegExp);
	},
	
	inlineCssHelper: function(w)
	{
		var styles = [];
		config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var s,v;
			if(lookaheadMatch[1]) {
				s = lookaheadMatch[1].unDash();
				v = lookaheadMatch[2];
			} else {
				s = lookaheadMatch[3].unDash();
				v = lookaheadMatch[4];
			}
			if (s=="bgcolor")
				s = "backgroundColor";
			styles.push({style: s, value: v});
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		}
		return styles;
	},

	applyCssHelper: function(e,styles)
	{
		for(var t=0; t< styles.length; t++) {
			try {
				e.style[styles[t].style] = styles[t].value;
			} catch (ex) {
			}
		}
	},

	enclosedTextHelper: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var text = lookaheadMatch[1];
			if(config.browser.isIE)
				text = text.replace(/\n/g,"\r");
			createTiddlyElement(w.output,this.element,null,null,text);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
		}
	},

	isExternalLink: function(link)
	{
		if(store.tiddlerExists(link) || store.isShadowTiddler(link)) {
			return false;
		}
		var urlRegExp = new RegExp(config.textPrimitives.urlPattern,"mg");
		if(urlRegExp.exec(link)) {
			return true;
		}
		if (link.indexOf(".")!=-1 || link.indexOf("\\")!=-1 || link.indexOf("/")!=-1){
			return true;
		}
		return false;
	}

};

//--
//-- Standard formatters
//--

config.formatters = [
{
	name: "table",
	match: "^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",
	lookaheadRegExp: /^\|([^\n]*)\|([fhck]?)$/mg,
	rowTermRegExp: /(\|(?:[fhck]?)$\n?)/mg,
	cellRegExp: /(?:\|([^\n\|]*)\|)|(\|[fhck]?$\n?)/mg,
	cellTermRegExp: /((?:\x20*)\|)/mg,
	rowTypes: {"c":"caption", "h":"thead", "":"tbody", "f":"tfoot"},

	handler: function(w)
	{
		var table = createTiddlyElement(w.output,"table",null,"twtable");
		var prevColumns = [];
		var currRowType = null;
		var rowContainer;
		var rowCount = 0;
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var nextRowType = lookaheadMatch[2];
			if(nextRowType == "k") {
				table.className = lookaheadMatch[1];
				w.nextMatch += lookaheadMatch[0].length+1;
			} else {
				if(nextRowType != currRowType) {
					rowContainer = createTiddlyElement(table,this.rowTypes[nextRowType]);
					currRowType = nextRowType;
				}
				if(currRowType == "c") {
					// Caption
					w.nextMatch++;
					if(rowContainer != table.firstChild)
						table.insertBefore(rowContainer,table.firstChild);
					rowContainer.setAttribute("align",rowCount == 0?"top":"bottom");
					w.subWikifyTerm(rowContainer,this.rowTermRegExp);
				} else {
					this.rowHandler(w,createTiddlyElement(rowContainer,"tr",null,(rowCount&1)?"oddRow":"evenRow"),prevColumns);
					rowCount++;
				}
			}
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	},
	rowHandler: function(w,e,prevColumns)
	{
		var col = 0;
		var colSpanCount = 1;
		var prevCell = null;
		this.cellRegExp.lastIndex = w.nextMatch;
		var cellMatch = this.cellRegExp.exec(w.source);
		while(cellMatch && cellMatch.index == w.nextMatch) {
			if(cellMatch[1] == "~") {
				// Rowspan
				var last = prevColumns[col];
				if(last) {
					last.rowSpanCount++;
					last.element.setAttribute("rowspan",last.rowSpanCount);
					last.element.setAttribute("rowSpan",last.rowSpanCount); // Needed for IE
					last.element.valign = "center";
				}
				w.nextMatch = this.cellRegExp.lastIndex-1;
			} else if(cellMatch[1] == ">") {
				// Colspan
				colSpanCount++;
				w.nextMatch = this.cellRegExp.lastIndex-1;
			} else if(cellMatch[2]) {
				// End of row
				if(prevCell && colSpanCount > 1) {
					prevCell.setAttribute("colspan",colSpanCount);
					prevCell.setAttribute("colSpan",colSpanCount); // Needed for IE
				}
				w.nextMatch = this.cellRegExp.lastIndex;
				break;
			} else {
				// Cell
				w.nextMatch++;
				var styles = config.formatterHelpers.inlineCssHelper(w);
				var spaceLeft = false;
				var chr = w.source.substr(w.nextMatch,1);
				while(chr == " ") {
					spaceLeft = true;
					w.nextMatch++;
					chr = w.source.substr(w.nextMatch,1);
				}
				var cell;
				if(chr == "!") {
					cell = createTiddlyElement(e,"th");
					w.nextMatch++;
				} else {
					cell = createTiddlyElement(e,"td");
				}
				prevCell = cell;
				prevColumns[col] = {rowSpanCount:1,element:cell};
				if(colSpanCount > 1) {
					cell.setAttribute("colspan",colSpanCount);
					cell.setAttribute("colSpan",colSpanCount); // Needed for IE
					colSpanCount = 1;
				}
				config.formatterHelpers.applyCssHelper(cell,styles);
				w.subWikifyTerm(cell,this.cellTermRegExp);
				if(w.matchText.substr(w.matchText.length-2,1) == " ") // spaceRight
					cell.align = spaceLeft ? "center" : "left";
				else if(spaceLeft)
					cell.align = "right";
				w.nextMatch--;
			}
			col++;
			this.cellRegExp.lastIndex = w.nextMatch;
			cellMatch = this.cellRegExp.exec(w.source);
		}
	}
},

{
	name: "heading",
	match: "^!{1,6}",
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		w.subWikifyTerm(createTiddlyElement(w.output,"h" + w.matchLength),this.termRegExp);
	}
},

{
	name: "list",
	match: "^(?:[\\*#;:]+)",
	lookaheadRegExp: /^(?:(?:(\*)|(#)|(;)|(:))+)/mg,
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		var stack = [w.output];
		var currLevel = 0, currType = null;
		var listLevel, listType, itemType;
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			if(lookaheadMatch[1]) {
				listType = "ul";
				itemType = "li";
			} else if(lookaheadMatch[2]) {
				listType = "ol";
				itemType = "li";
			} else if(lookaheadMatch[3]) {
				listType = "dl";
				itemType = "dt";
			} else if(lookaheadMatch[4]) {
				listType = "dl";
				itemType = "dd";
			}
			listLevel = lookaheadMatch[0].length;
			w.nextMatch += lookaheadMatch[0].length;
			var t;
			if(listLevel > currLevel) {
				for(t=currLevel; t<listLevel; t++) {
					var target = (currLevel == 0) ? stack[stack.length-1] : stack[stack.length-1].lastChild;
					stack.push(createTiddlyElement(target,listType));
				}
			} else if(listLevel < currLevel) {
				for(t=currLevel; t>listLevel; t--)
					stack.pop();
			} else if(listLevel == currLevel && listType != currType) {
				stack.pop();
				stack.push(createTiddlyElement(stack[stack.length-1].lastChild,listType));
			}
			currLevel = listLevel;
			currType = listType;
			var e = createTiddlyElement(stack[stack.length-1],itemType);
			w.subWikifyTerm(e,this.termRegExp);
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	}
},

{
	name: "quoteByBlock",
	match: "^<<<\\n",
	termRegExp: /(^<<<(\n|$))/mg,
	element: "blockquote",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "quoteByLine",
	match: "^>+",
	lookaheadRegExp: /^>+/mg,
	termRegExp: /(\n)/mg,
	element: "blockquote",
	handler: function(w)
	{
		var stack = [w.output];
		var currLevel = 0;
		var newLevel = w.matchLength;
		var t;
		do {
			if(newLevel > currLevel) {
				for(t=currLevel; t<newLevel; t++)
					stack.push(createTiddlyElement(stack[stack.length-1],this.element));
			} else if(newLevel < currLevel) {
				for(t=currLevel; t>newLevel; t--)
					stack.pop();
			}
			currLevel = newLevel;
			w.subWikifyTerm(stack[stack.length-1],this.termRegExp);
			createTiddlyElement(stack[stack.length-1],"br");
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			var matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if(matched) {
				newLevel = lookaheadMatch[0].length;
				w.nextMatch += lookaheadMatch[0].length;
			}
		} while(matched);
	}
},

{
	name: "rule",
	match: "^----+$\\n?",
	handler: function(w)
	{
		createTiddlyElement(w.output,"hr");
	}
},

{
	name: "monospacedByLine",
	match: "^\\{\\{\\{\\n",
	lookaheadRegExp: /^\{\{\{\n((?:^[^\n]*\n)+?)(^\}\}\}$\n?)/mg,
	element: "pre",
	handler: config.formatterHelpers.enclosedTextHelper
},

{
	name: "monospacedByLineForCSS",
	match: "^/\\*\\{\\{\\{\\*/\\n",
	lookaheadRegExp: /\/\*\{\{\{\*\/\n*((?:^[^\n]*\n)+?)(\n*^\/\*\}\}\}\*\/$\n?)/mg,
	element: "pre",
	handler: config.formatterHelpers.enclosedTextHelper
},

{
	name: "monospacedByLineForPlugin",
	match: "^//\\{\\{\\{\\n",
	lookaheadRegExp: /^\/\/\{\{\{\n\n*((?:^[^\n]*\n)+?)(\n*^\/\/\}\}\}$\n?)/mg,
	element: "pre",
	handler: config.formatterHelpers.enclosedTextHelper
},

{
	name: "monospacedByLineForTemplate",
	match: "^<!--\\{\\{\\{-->\\n",
	lookaheadRegExp: /<!--\{\{\{-->\n*((?:^[^\n]*\n)+?)(\n*^<!--\}\}\}-->$\n?)/mg,
	element: "pre",
	handler: config.formatterHelpers.enclosedTextHelper
},

{
	name: "wikifyCommentForPlugin",
	match: "^/\\*\\*\\*\\n",
	termRegExp: /(^\*\*\*\/\n)/mg,
	handler: function(w)
	{
		w.subWikifyTerm(w.output,this.termRegExp);
	}
},

{
	name: "wikifyCommentForTemplate",
	match: "^<!---\\n",
	termRegExp: /(^--->\n)/mg,
	handler: function(w) 
	{
		w.subWikifyTerm(w.output,this.termRegExp);
	}
},

{
	name: "macro",
	match: "<<",
	lookaheadRegExp: /<<([^>\s]+)(?:\s*)((?:[^>]|(?:>(?!>)))*)>>/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1]) {
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			invokeMacro(w.output,lookaheadMatch[1],lookaheadMatch[2],w,w.tiddler);
		}
	}
},

{
	name: "prettyLink",
	match: "\\[\\[",
	lookaheadRegExp: /\[\[(.*?)(?:\|(~)?(.*?))?\]\]/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var e;
			var text = lookaheadMatch[1];
			if(lookaheadMatch[3]) {
				// Pretty bracketted link
				var link = lookaheadMatch[3];
				e = (!lookaheadMatch[2] && config.formatterHelpers.isExternalLink(link)) ?
						createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
			} else {
				// Simple bracketted link
				e = createTiddlyLink(w.output,text,false,null,w.isStatic,w.tiddler);
			}
			createTiddlyText(e,text);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "unWikiLink",
	match: config.textPrimitives.unWikiLink+config.textPrimitives.wikiLink,
	handler: function(w)
	{
		w.outputText(w.output,w.matchStart+1,w.nextMatch);
	}
},

{
	name: "wikiLink",
	match: config.textPrimitives.wikiLink,
	handler: function(w)
	{
		if(w.matchStart > 0) {
			var preRegExp = new RegExp(config.textPrimitives.anyLetterStrict,"mg");
			preRegExp.lastIndex = w.matchStart-1;
			var preMatch = preRegExp.exec(w.source);
			if(preMatch.index == w.matchStart-1) {
				w.outputText(w.output,w.matchStart,w.nextMatch);
				return;
			}
		}
		if(w.autoLinkWikiWords == true || store.isShadowTiddler(w.matchText)) {
			var link = createTiddlyLink(w.output,w.matchText,false,null,w.isStatic,w.tiddler);
			w.outputText(link,w.matchStart,w.nextMatch);
		} else {
			w.outputText(w.output,w.matchStart,w.nextMatch);
		}
	}
},

{
	name: "urlLink",
	match: config.textPrimitives.urlPattern,
	handler: function(w)
	{
		w.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);
	}
},

{
	name: "image",
	match: "\\[[<>]?[Ii][Mm][Gg]\\[",
	lookaheadRegExp: /\[([<]?)(>?)[Ii][Mm][Gg]\[(?:([^\|\]]+)\|)?([^\[\]\|]+)\](?:\[([^\]]*)\])?\]/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var e = w.output;
			if(lookaheadMatch[5]) {
				var link = lookaheadMatch[5];
				e = config.formatterHelpers.isExternalLink(link) ? createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
				addClass(e,"imageLink");
			}
			var img = createTiddlyElement(e,"img");
			if(lookaheadMatch[1])
				img.align = "left";
			else if(lookaheadMatch[2])
				img.align = "right";
			if(lookaheadMatch[3])
				img.title = lookaheadMatch[3];
			img.src = lookaheadMatch[4];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "html",
	match: "<[Hh][Tt][Mm][Ll]>",
	lookaheadRegExp: /<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"span").innerHTML = lookaheadMatch[1];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "commentByBlock",
	match: "/%",
	lookaheadRegExp: /\/%((?:.|\n)*?)%\//mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			w.nextMatch = this.lookaheadRegExp.lastIndex;
	}
},

{
	name: "boldByChar",
	match: "''",
	termRegExp: /('')/mg,
	element: "strong",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "italicByChar",
	match: "//",
	termRegExp: /(\/\/)/mg,
	element: "em",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "underlineByChar",
	match: "__",
	termRegExp: /(__)/mg,
	element: "u",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "strikeByChar",
	match: "--(?!\\s|$)",
	termRegExp: /((?!\s)--|(?=\n\n))/mg,
	element: "strike",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "superscriptByChar",
	match: "\\^\\^",
	termRegExp: /(\^\^)/mg,
	element: "sup",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "subscriptByChar",
	match: "~~",
	termRegExp: /(~~)/mg,
	element: "sub",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "monospacedByChar",
	match: "\\{\\{\\{",
	lookaheadRegExp: /\{\{\{((?:.|\n)*?)\}\}\}/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"code",null,null,lookaheadMatch[1]);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "styleByChar",
	match: "@@",
	termRegExp: /(@@)/mg,
	handler: function(w)
	{
		var e = createTiddlyElement(w.output,"span");
		var styles = config.formatterHelpers.inlineCssHelper(w);
		if(styles.length == 0)
			e.className = "marked";
		else
			config.formatterHelpers.applyCssHelper(e,styles);
		w.subWikifyTerm(e,this.termRegExp);
	}
},

{
	name: "lineBreak",
	match: "\\n|<br ?/?>",
	handler: function(w)
	{
		createTiddlyElement(w.output,"br");
	}
},

{
	name: "rawText",
	match: "\\\"{3}|<nowiki>",
	lookaheadRegExp: /(?:\"{3}|<nowiki>)((?:.|\n)*?)(?:\"{3}|<\/nowiki>)/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"span",null,null,lookaheadMatch[1]);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "mdash",
	match: "--",
	handler: function(w)
	{
		createTiddlyElement(w.output,"span").innerHTML = "&mdash;";
	}
},

{
	name: "htmlEntitiesEncoding",
	match: "(?:(?:&#?[a-zA-Z0-9]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9a-fA-F]|1D[c-fC-F][0-9a-fA-F]|20[d-fD-F][0-9a-fA-F]|FE2[0-9a-fA-F])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[a-zA-Z0-9]{2,8};)",
	handler: function(w)
	{
		createTiddlyElement(w.output,"span").innerHTML = w.matchText;
	}
},

{
	name: "customClasses",
	match: "\\{\\{",
	termRegExp: /(\}\}\})/mg,
	lookaheadRegExp: /\{\{[\s]*([\w]+[\s\w]*)[\s]*\{(\n?)/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch) {
			var e = createTiddlyElement(w.output,lookaheadMatch[2] == "\n" ? "div" : "span",null,lookaheadMatch[1]);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			w.subWikifyTerm(e,this.termRegExp);
		}
	}
}

];

//--
//-- Wikifier
//--

function getParser(tiddler,format)
{
	if(tiddler) {
		if(!format)
			format = tiddler.fields["wikiformat"];
		if(format) {
			for(var i in config.parsers) {
				if(format == config.parsers[i].format)
					return config.parsers[i];
			}
		} else {
			for(var i in config.parsers) {
				if(tiddler.isTagged(config.parsers[i].formatTag))
					return config.parsers[i];
			}
		}
	}
	return formatter;
}

function wikify(source,output,highlightRegExp,tiddler)
{
	if(source && source != "") {
		var wikifier = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);
		wikifier.subWikifyUnterm(output);
	}
}

function wikifyStatic(source,highlightRegExp,tiddler,format)
{
	var e = createTiddlyElement(document.body,"div");
	e.style.display = "none";
	var html = "";
	if(source && source != "") {
		var wikifier = new Wikifier(source,getParser(tiddler,format),highlightRegExp,tiddler);
		wikifier.isStatic = true;
		wikifier.subWikifyUnterm(e);
		html = e.innerHTML;
		removeNode(e);
	}
	return html;
}

function wikifyPlain(title,theStore,limit)
{
	if(!theStore)
		theStore = store;
	if(theStore.tiddlerExists(title) || theStore.isShadowTiddler(title)) {
		return wikifyPlainText(theStore.getTiddlerText(title),limit,tiddler);
	} else {
		return "";
	}
}

function wikifyPlainText(text,limit,tiddler)
{
	if(limit > 0)
		text = text.substr(0,limit);
	var wikifier = new Wikifier(text,formatter,null,tiddler);
	return wikifier.wikifyPlain();
}

function highlightify(source,output,highlightRegExp,tiddler)
{
	if(source && source != "") {
		var wikifier = new Wikifier(source,formatter,highlightRegExp,tiddler);
		wikifier.outputText(output,0,source.length);
	}
}

function Wikifier(source,formatter,highlightRegExp,tiddler)
{
	this.source = source;
	this.output = null;
	this.formatter = formatter;
	this.nextMatch = 0;
	this.autoLinkWikiWords = tiddler && tiddler.autoLinkWikiWords() == false ? false : true;
	this.highlightRegExp = highlightRegExp;
	this.highlightMatch = null;
	this.isStatic = false;
	if(highlightRegExp) {
		highlightRegExp.lastIndex = 0;
		this.highlightMatch = highlightRegExp.exec(source);
	}
	this.tiddler = tiddler;
}

Wikifier.prototype.wikifyPlain = function()
{
	var e = createTiddlyElement(document.body,"div");
	this.subWikify(e);
	var text = getPlainText(e);
	removeNode(e);
	return text;
};

Wikifier.prototype.subWikify = function(output,terminator)
{
	if(terminator)
		this.subWikifyTerm(output,new RegExp("(" + terminator + ")","mg"));
	else
		this.subWikifyUnterm(output);
};

Wikifier.prototype.subWikifyUnterm = function(output)
{
	// subWikify() can be indirectly recursive, so we need to save the old output pointer
	var oldOutput = this.output;
	this.output = output;
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	while(formatterMatch) {
		// Output any text before the match
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		// Set the match parameters for the handler
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		for(var t=1; t<formatterMatch.length; t++) {
			if(formatterMatch[t]) {
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.subWikifyTerm = function(output,terminatorRegExp)
{
	// subWikify() can be indirectly recursive, so we need to save the old output pointer
	var oldOutput = this.output;
	this.output = output;
	// Get the first matches for the formatter and terminator RegExps
	terminatorRegExp.lastIndex = this.nextMatch;
	var terminatorMatch = terminatorRegExp.exec(this.source);
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	while(terminatorMatch || formatterMatch) {
		if(terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index)) {
			if(terminatorMatch.index > this.nextMatch)
				this.outputText(this.output,this.nextMatch,terminatorMatch.index);
			this.matchText = terminatorMatch[1];
			this.matchLength = terminatorMatch[1].length;
			this.matchStart = terminatorMatch.index;
			this.nextMatch = this.matchStart + this.matchLength;
			this.output = oldOutput;
			return;
		}
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		for(var t=1; t<formatterMatch.length; t++) {
			if(formatterMatch[t]) {
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		terminatorRegExp.lastIndex = this.nextMatch;
		terminatorMatch = terminatorRegExp.exec(this.source);
		formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.outputText = function(place,startPos,endPos)
{
	while(this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) && (this.highlightMatch.index < endPos) && (startPos < endPos)) {
		if(this.highlightMatch.index > startPos) {
			createTiddlyText(place,this.source.substring(startPos,this.highlightMatch.index));
			startPos = this.highlightMatch.index;
		}
		var highlightEnd = Math.min(this.highlightRegExp.lastIndex,endPos);
		var theHighlight = createTiddlyElement(place,"span",null,"highlight",this.source.substring(startPos,highlightEnd));
		startPos = highlightEnd;
		if(startPos >= this.highlightRegExp.lastIndex)
			this.highlightMatch = this.highlightRegExp.exec(this.source);
	}
	if(startPos < endPos) {
		createTiddlyText(place,this.source.substring(startPos,endPos));
	}
};

//--
//-- Macro definitions
//--

config.macros.today.handler = function(place,macroName,params)
{
	var now = new Date();
	var text;
	if(params[0])
		text = now.formatString(params[0].trim());
	else
		text = now.toLocaleString();
	createTiddlyElement(place,"span",null,null,text);
};

config.macros.version.handler = function(place)
{
	createTiddlyElement(place,"span",null,null,version.major + "." + version.minor + "." + version.revision + (version.beta ? " (beta " + version.beta + ")" : ""));
};

config.macros.list.handler = function(place,macroName,params)
{
	var type = params[0] ? params[0] : "all";
	var list = document.createElement("ul");
	place.appendChild(list);
	if(this[type].prompt)
		createTiddlyElement(list,"li",null,"listTitle",this[type].prompt);
	var results;
	if(this[type].handler)
		results = this[type].handler(params);
	for(var t = 0; t < results.length; t++) {
		var li = document.createElement("li");
		list.appendChild(li);
		createTiddlyLink(li,typeof results[t] == "string" ? results[t] : results[t].title,true);
	}
};

config.macros.list.all.handler = function(params)
{
	return store.reverseLookup("tags","excludeLists",false,"title");
};

config.macros.list.missing.handler = function(params)
{
	return store.getMissingLinks();
};

config.macros.list.orphans.handler = function(params)
{
	return store.getOrphans();
};

config.macros.list.shadowed.handler = function(params)
{
	return store.getShadowed();
};

config.macros.list.touched.handler = function(params)
{
	return store.getTouched();
};

config.macros.allTags.handler = function(place,macroName,params)
{
	var tags = store.getTags(params[0]);
	var ul = createTiddlyElement(place,"ul");
	if(tags.length == 0)
		createTiddlyElement(ul,"li",null,"listTitle",this.noTags);
	for(var t=0; t<tags.length; t++) {
		var title = tags[t][0];
		var info = getTiddlyLinkInfo(title);
		var li =createTiddlyElement(ul,"li");
		var btn = createTiddlyButton(li,title + " (" + tags[t][1] + ")",this.tooltip.format([title]),onClickTag,info.classes);
		btn.setAttribute("tag",title);
		btn.setAttribute("refresh","link");
		btn.setAttribute("tiddlyLink",title);
	}
};

config.macros.timeline.handler = function(place,macroName,params)
{
	var field = params[0] ? params[0] : "modified";
	var tiddlers = store.reverseLookup("tags","excludeLists",false,field);
	var lastDay = "";
	var last = params[1] ? tiddlers.length-Math.min(tiddlers.length,parseInt(params[1])) : 0;
	for(var t=tiddlers.length-1; t>=last; t--) {
		var tiddler = tiddlers[t];
		var theDay = tiddler[field].convertToLocalYYYYMMDDHHMM().substr(0,8);
		if(theDay != lastDay) {
			var theDateList = document.createElement("ul");
			place.appendChild(theDateList);
			createTiddlyElement(theDateList,"li",null,"listTitle",tiddler[field].formatString(this.dateFormat));
			lastDay = theDay;
		}
		var theDateListItem = createTiddlyElement(theDateList,"li",null,"listLink");
		theDateListItem.appendChild(createTiddlyLink(place,tiddler.title,true));
	}
};

config.macros.search.handler = function(place,macroName,params)
{
	var searchTimeout = null;
	var btn = createTiddlyButton(place,this.label,this.prompt,this.onClick);
	var txt = createTiddlyElement(place,"input",null,"txtOptionInput");
	if(params[0])
		txt.value = params[0];
	txt.onkeyup = this.onKeyPress;
	txt.onfocus = this.onFocus;
	txt.setAttribute("size",this.sizeTextbox);
	txt.setAttribute("accessKey",this.accessKey);
	txt.setAttribute("autocomplete","off");
	txt.setAttribute("lastSearchText","");
	if(config.browser.isSafari) {
		txt.setAttribute("type","search");
		txt.setAttribute("results","5");
	} else {
		txt.setAttribute("type","text");
	}
};

// Global because there's only ever one outstanding incremental search timer
config.macros.search.timeout = null;

config.macros.search.doSearch = function(txt)
{
	if(txt.value.length > 0) {
		story.search(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);
		txt.setAttribute("lastSearchText",txt.value);
	}
};

config.macros.search.onClick = function(e)
{
	config.macros.search.doSearch(this.nextSibling);
	return false;
};

config.macros.search.onKeyPress = function(e)
{
	if(!e) var e = window.event;
	switch(e.keyCode) {
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
			config.macros.search.doSearch(this);
			break;
		case 27: // Escape
			this.value = "";
			clearMessage();
			break;
	}
	if(this.value.length > 2) {
		if(this.value != this.getAttribute("lastSearchText")) {
			if(config.macros.search.timeout)
				clearTimeout(config.macros.search.timeout);
			var txt = this;
			config.macros.search.timeout = setTimeout(function() {config.macros.search.doSearch(txt);},500);
		}
	} else {
		if(config.macros.search.timeout)
			clearTimeout(config.macros.search.timeout);
	}
};

config.macros.search.onFocus = function(e)
{
	this.select();
};

config.macros.tiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("name",null,true,false,true);
	var names = params[0]["name"];
	var tiddlerName = names[0];
	var className = names[1] ? names[1] : null;
	var args = params[0]["with"];
	var wrapper = createTiddlyElement(place,"span",null,className);
	if(!args) {
		wrapper.setAttribute("refresh","content");
		wrapper.setAttribute("tiddler",tiddlerName);
	}
	var text = store.getTiddlerText(tiddlerName);
	if(text) {
		var stack = config.macros.tiddler.tiddlerStack;
		if(stack.indexOf(tiddlerName) !== -1)
			return;
		stack.push(tiddlerName);
		try {
			var n = args ? Math.min(args.length,9) : 0;
			for(var i=0; i<n; i++) {
				var placeholderRE = new RegExp("\\$" + (i + 1),"mg");
				text = text.replace(placeholderRE,args[i]);
			}
			config.macros.tiddler.renderText(wrapper,text,tiddlerName,params);
		} finally {
			stack.pop();
		}
	}
};

config.macros.tiddler.renderText = function(place,text,tiddlerName,params) 
{
	wikify(text,place,null,store.getTiddler(tiddlerName));
};

config.macros.tiddler.tiddlerStack = [];

config.macros.tag.handler = function(place,macroName,params)
{
	createTagButton(place,params[0]);
};

config.macros.tags.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var theList = createTiddlyElement(place,"ul");
	var title = getParam(params,"anon","");
	if(title && store.tiddlerExists(title))
		tiddler = store.getTiddler(title);
	var sep = getParam(params,"sep"," ");
	var lingo = config.views.wikified.tag;
	var prompt = tiddler.tags.length == 0 ? lingo.labelNoTags : lingo.labelTags;
	createTiddlyElement(theList,"li",null,"listTitle",prompt.format([tiddler.title]));
	for(var t=0; t<tiddler.tags.length; t++) {
		createTagButton(createTiddlyElement(theList,"li"),tiddler.tags[t],tiddler.title);
		if(t<tiddler.tags.length-1)
			createTiddlyText(theList,sep);
	}
};

config.macros.tagging.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var theList = createTiddlyElement(place,"ul");
	var title = getParam(params,"anon","");
	if(title == "" && tiddler instanceof Tiddler)
		title = tiddler.title;
	var sep = getParam(params,"sep"," ");
	theList.setAttribute("title",this.tooltip.format([title]));
	var tagged = store.getTaggedTiddlers(title);
	var prompt = tagged.length == 0 ? this.labelNotTag : this.label;
	createTiddlyElement(theList,"li",null,"listTitle",prompt.format([title,tagged.length]));
	for(var t=0; t<tagged.length; t++) {
		createTiddlyLink(createTiddlyElement(theList,"li"),tagged[t].title,true);
		if(t<tagged.length-1)
			createTiddlyText(theList,sep);
	}
};

config.macros.closeAll.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.closeAll.onClick = function(e)
{
	story.closeAllTiddlers();
	return false;
};

config.macros.permaview.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.permaview.onClick = function(e)
{
	story.permaView();
	return false;
};

config.macros.saveChanges.handler = function(place)
{
	if(!readOnly)
		createTiddlyButton(place,this.label,this.prompt,this.onClick,null,null,this.accessKey);
};

config.macros.saveChanges.onClick = function(e)
{
	saveChanges();
	return false;
};

config.macros.slider.onClickSlider = function(e)
{
	if(!e) var e = window.event;
	var n = this.nextSibling;
	var cookie = n.getAttribute("cookie");
	var isOpen = n.style.display != "none";
	if(config.options.chkAnimate && anim && typeof Slider == "function")
		anim.startAnimating(new Slider(n,!isOpen,null,"none"));
	else
		n.style.display = isOpen ? "none" : "block";
	config.options[cookie] = !isOpen;
	saveOptionCookie(cookie);
	return false;
};

config.macros.slider.createSlider = function(place,cookie,title,tooltip)
{
	var cookie = cookie ? cookie : "";
	var btn = createTiddlyButton(place,title,tooltip,this.onClickSlider);
	var panel = createTiddlyElement(null,"div",null,"sliderPanel");
	panel.setAttribute("cookie",cookie);
	panel.style.display = config.options[cookie] ? "block" : "none";
	place.appendChild(panel);
	return panel;
};

config.macros.slider.handler = function(place,macroName,params)
{
	var panel = this.createSlider(place,params[0],params[2],params[3]);
	var text = store.getTiddlerText(params[1]);
	panel.setAttribute("refresh","content");
	panel.setAttribute("tiddler",params[1]);
	if(text)
		wikify(text,panel,null,store.getTiddler(params[1]));
};

config.macros.option.genericCreate = function(place,type,opt,className,desc)
{
	var typeInfo = config.macros.option.types[type];
	var c = document.createElement(typeInfo.elementType);
	if(typeInfo.typeValue)
		c.setAttribute("type",typeInfo.typeValue);
	c[typeInfo.eventName] = typeInfo.onChange;
	c.setAttribute("option",opt);
	if(className)
		c.className = className;
	else
		c.className = typeInfo.className;
	if(config.optionsDesc[opt])
		c.setAttribute("title",config.optionsDesc[opt]);
	place.appendChild(c);
	if(desc != "no")
		createTiddlyText(place,config.optionsDesc[opt] ? config.optionsDesc[opt] : opt);
	c[typeInfo.valueField] = config.options[opt];
	return c;
};

config.macros.option.genericOnChange = function(e)
{
	var opt = this.getAttribute("option");
	if(opt) {
		var optType = opt.substr(0,3);
		var handler = config.macros.option.types[optType];
		if (handler.elementType && handler.valueField)
			config.macros.option.propagateOption(opt,handler.valueField,this[handler.valueField],handler.elementType);
		}
	return true;
};

config.macros.option.types = {
	'txt': {
		elementType: "input",
		valueField: "value",
		eventName: "onkeyup",
		className: "txtOptionInput",
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	},
	'chk': {
		elementType: "input",
		valueField: "checked",
		eventName: "onclick",
		className: "chkOptionInput",
		typeValue: "checkbox",
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	}
};

config.macros.option.propagateOption = function(opt,valueField,value,elementType)
{
	config.options[opt] = value;
	saveOptionCookie(opt);
	var nodes = document.getElementsByTagName(elementType);
	for(var t=0; t<nodes.length; t++) {
		var optNode = nodes[t].getAttribute("option");
		if(opt == optNode)
			nodes[t][valueField] = value;
		}
};

config.macros.option.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var opt = (params[1] && params[1].name == "anon") ? params[1].value : getParam(params,"name",null);
	var className = (params[2] && params[2].name == "anon") ? params[2].value : getParam(params,"class",null);
	var desc = getParam(params,"desc","no");
	var type = opt.substr(0,3);
	var h = config.macros.option.types[type];
	if (h && h.create)
		h.create(place,type,opt,className,desc);
};

config.macros.options.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var showUnknown = getParam(params,"showUnknown","no");
	var wizard = new Wizard();
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement("markList");
	var chkUnknown = wizard.getElement("chkUnknown");
	chkUnknown.checked = showUnknown == "yes";
	chkUnknown.onchange = this.onChangeUnknown;
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	wizard.setValue("listWrapper",listWrapper);
	this.refreshOptions(listWrapper,showUnknown == "yes");
};

config.macros.options.refreshOptions = function(listWrapper,showUnknown)
{	
	var opts = [];
	for(var n in config.options) {
		var opt = {};
		opt.option = "";
		opt.name = n;
		opt.lowlight = !config.optionsDesc[n];
		opt.description = opt.lowlight ? this.unknownDescription : config.optionsDesc[n];
		if(!opt.lowlight || showUnknown)
			opts.push(opt);
	}
	opts.sort(function(a,b) {return a.name.substr(3) < b.name.substr(3) ? -1 : (a.name.substr(3) == b.name.substr(3) ? 0 : +1);});
	var listview = ListView.create(listWrapper,opts,this.listViewTemplate);
	for(n=0; n<opts.length; n++) {
		var type = opts[n].name.substr(0,3);
		var h = config.macros.option.types[type];
		if (h && h.create) {
			h.create(opts[n].colElements['option'],type,opts[n].name,null,"no");
		}
	}
};

config.macros.options.onChangeUnknown = function(e)
{
	var wizard = new Wizard(this);
	var listWrapper = wizard.getValue("listWrapper");
	removeChildren(listWrapper);
	config.macros.options.refreshOptions(listWrapper,this.checked);
	return false;
};

config.macros.newTiddler.createNewTiddlerButton = function(place,title,params,label,prompt,accessKey,newFocus,isJournal)
{
	var tags = [];
	for(var t=1; t<params.length; t++) {
		if((params[t].name == "anon" && t != 1) || (params[t].name == "tag"))
			tags.push(params[t].value);
	}
	label = getParam(params,"label",label);
	prompt = getParam(params,"prompt",prompt);
	accessKey = getParam(params,"accessKey",accessKey);
	newFocus = getParam(params,"focus",newFocus);
	var customFields = getParam(params,"fields","");
	if(!customFields && !store.isShadowTiddler(title))
		customFields = String.encodeHashMap(config.defaultCustomFields);
	var btn = createTiddlyButton(place,label,prompt,this.onClickNewTiddler,null,null,accessKey);
	btn.setAttribute("newTitle",title);
	btn.setAttribute("isJournal",isJournal ? "true" : "false");
	if(tags.length > 0)
		btn.setAttribute("params",tags.join("|"));
	btn.setAttribute("newFocus",newFocus);
	btn.setAttribute("newTemplate",getParam(params,"template",DEFAULT_EDIT_TEMPLATE));
	if(customFields !== "")
		btn.setAttribute("customFields",customFields);
	var text = getParam(params,"text");
	if(text !== undefined) 
		btn.setAttribute("newText",text);
	return btn;
};

config.macros.newTiddler.onClickNewTiddler = function()
{
	var title = this.getAttribute("newTitle");
	if(this.getAttribute("isJournal") == "true") {
		var now = new Date();
		title = now.formatString(title.trim());
	}
	var params = this.getAttribute("params");
	var tags = params ? params.split("|") : [];
	var focus = this.getAttribute("newFocus");
	var template = this.getAttribute("newTemplate");
	var customFields = this.getAttribute("customFields");
	story.displayTiddler(null,title,template,false,null,null);
	var tiddlerElem = document.getElementById(story.idPrefix + title);
	if(customFields)
		story.addCustomFields(tiddlerElem,customFields);
	var text = this.getAttribute("newText");
	if(typeof text == "string")
		story.getTiddlerField(title,"text").value = text.format([title]);
	for(var t=0;t<tags.length;t++)
		story.setTiddlerTag(title,tags[t],+1);
	story.focusTiddler(title,focus);
	return false;
};

config.macros.newTiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(!readOnly) {
		params = paramString.parseParams("anon",null,true,false,false);
		var title = params[1] && params[1].name == "anon" ? params[1].value : this.title;
		title = getParam(params,"title",title);
		this.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"title",false);
	}
};

config.macros.newJournal.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(!readOnly) {
		params = paramString.parseParams("anon",null,true,false,false);
		var title = params[1] && params[1].name == "anon" ? params[1].value : "";
		title = getParam(params,"title",title);
		config.macros.newTiddler.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"text",true);
	}
};

config.macros.sparkline.handler = function(place,macroName,params)
{
	var data = [];
	var min = 0;
	var max = 0;
	for(var t=0; t<params.length; t++) {
		var v = parseInt(params[t]);
		if(v < min)
			min = v;
		if(v > max)
			max = v;
		data.push(v);
	}
	if(data.length < 1)
		return;
	var box = createTiddlyElement(place,"span",null,"sparkline",String.fromCharCode(160));
	box.title = data.join(",");
	var w = box.offsetWidth;
	var h = box.offsetHeight;
	box.style.paddingRight = (data.length * 2 - w) + "px";
	box.style.position = "relative";
	for(var d=0; d<data.length; d++) {
		var tick = document.createElement("img");
		tick.border = 0;
		tick.className = "sparktick";
		tick.style.position = "absolute";
		tick.src = "data:image/gif,GIF89a%01%00%01%00%91%FF%00%FF%FF%FF%00%00%00%C0%C0%C0%00%00%00!%F9%04%01%00%00%02%00%2C%00%00%00%00%01%00%01%00%40%02%02T%01%00%3B";
		tick.style.left = d*2 + "px";
		tick.style.width = "2px";
		var v = Math.floor(((data[d] - min)/(max-min)) * h);
		tick.style.top = (h-v) + "px";
		tick.style.height = v + "px";
		box.appendChild(tick);
	}
};

config.macros.tabs.handler = function(place,macroName,params)
{
	var cookie = params[0];
	var numTabs = (params.length-1)/3;
	var wrapper = createTiddlyElement(null,"div",null,cookie);
	var tabset = createTiddlyElement(wrapper,"div",null,"tabset");
	tabset.setAttribute("cookie",cookie);
	var validTab = false;
	for(var t=0; t<numTabs; t++) {
		var label = params[t*3+1];
		var prompt = params[t*3+2];
		var content = params[t*3+3];
		var tab = createTiddlyButton(tabset,label,prompt,this.onClickTab,"tab tabUnselected");
		tab.setAttribute("tab",label);
		tab.setAttribute("content",content);
		tab.title = prompt;
		if(config.options[cookie] == label)
			validTab = true;
	}
	if(!validTab)
		config.options[cookie] = params[1];
	place.appendChild(wrapper);
	this.switchTab(tabset,config.options[cookie]);
};

config.macros.tabs.onClickTab = function(e)
{
	config.macros.tabs.switchTab(this.parentNode,this.getAttribute("tab"));
	return false;
};

config.macros.tabs.switchTab = function(tabset,tab)
{
	var cookie = tabset.getAttribute("cookie");
	var theTab = null;
	var nodes = tabset.childNodes;
	for(var t=0; t<nodes.length; t++) {
		if(nodes[t].getAttribute && nodes[t].getAttribute("tab") == tab) {
			theTab = nodes[t];
			theTab.className = "tab tabSelected";
		} else {
			nodes[t].className = "tab tabUnselected";
		}
	}
	if(theTab) {
		if(tabset.nextSibling && tabset.nextSibling.className == "tabContents")
			removeNode(tabset.nextSibling);
		var tabContent = createTiddlyElement(null,"div",null,"tabContents");
		tabset.parentNode.insertBefore(tabContent,tabset.nextSibling);
		var contentTitle = theTab.getAttribute("content");
		wikify(store.getTiddlerText(contentTitle),tabContent,null,store.getTiddler(contentTitle));
		if(cookie) {
			config.options[cookie] = tab;
			saveOptionCookie(cookie);
		}
	}
};

// <<gradient [[tiddler name]] vert|horiz rgb rgb rgb rgb... >>
config.macros.gradient.handler = function(place,macroName,params,wikifier)
{
	var terminator = ">>";
	var panel;
	if(wikifier)
		panel = createTiddlyElement(place,"div",null,"gradient");
	else
		panel = place;
	panel.style.position = "relative";
	panel.style.overflow = "hidden";
	panel.style.zIndex = "0";
	var t;
	if(wikifier) {
		var styles = config.formatterHelpers.inlineCssHelper(wikifier);
		config.formatterHelpers.applyCssHelper(panel,styles);
	}
	var colours = [];
	for(t=1; t<params.length; t++) {
		var c = new RGB(params[t]);
		if(c)
			colours.push(c);
	}
	drawGradient(panel,params[0] != "vert",colours);
	if(wikifier)
		wikifier.subWikify(panel,terminator);
	if(document.all) {
		panel.style.height = "100%";
		panel.style.width = "100%";
	}
};

config.macros.message.handler = function(place,macroName,params)
{
	if(params[0]) {
		var m = config;
		var p = params[0].split(".");
		for(var t=0; t<p.length; t++) {
			if(p[t] in m)
				m = m[p[t]];
			else
				break;
		}
		createTiddlyText(place,m.toString().format(params.splice(1)));
	}
};

config.macros.view.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if((tiddler instanceof Tiddler) && params[0]) {
		var value = store.getValue(tiddler,params[0]);
		if(value != undefined) {
			switch(params[1]) {
				case undefined:
					highlightify(value,place,highlightHack,tiddler);
					break;
				case "link":
					createTiddlyLink(place,value,true);
					break;
				case "wikified":
					wikify(value,place,highlightHack,tiddler);
					break;
				case "date":
					value = Date.convertFromYYYYMMDDHHMM(value);
					createTiddlyText(place,value.formatString(params[2] ? params[2] : config.views.wikified.dateFormat));
					break;
			}
		}
	}
};

config.macros.edit.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var field = params[0];
	var rows = params[1];
	if((tiddler instanceof Tiddler) && field) {
		story.setDirty(tiddler.title,true);
		if(field != "text" && !rows) {
			var e = createTiddlyElement(null,"input");
			if(tiddler.isReadOnly())
				e.setAttribute("readOnly","readOnly");
			e.setAttribute("edit",field);
			e.setAttribute("type","text");
			var v = store.getValue(tiddler,field);
			if(!v) 
				v = "";
			e.value = v;
			e.setAttribute("size","40");
			e.setAttribute("autocomplete","off");
			place.appendChild(e);
		} else {
			var wrapper1 = createTiddlyElement(null,"fieldset",null,"fieldsetFix");
			var wrapper2 = createTiddlyElement(wrapper1,"div");
			var e = createTiddlyElement(wrapper2,"textarea");
			if(tiddler.isReadOnly())
				e.setAttribute("readOnly","readOnly");
			var v = store.getValue(tiddler,field);
			if(!v) 
				v = "";
			e.value = v;
			var rows = rows ? rows : 10;
			var lines = v.match(/\n/mg);
			var maxLines = Math.max(parseInt(config.options.txtMaxEditRows),5);
			if(lines != null && lines.length > rows)
				rows = lines.length + 5;
			rows = Math.min(rows,maxLines);
			e.setAttribute("rows",rows);
			e.setAttribute("edit",field);
			place.appendChild(wrapper1);
		}
	}
};

config.macros.tagChooser.onClick = function(e)
{
	if(!e) var e = window.event;
	var lingo = config.views.editor.tagChooser;
	var popup = Popup.create(this);
	var tags = store.getTags();
	if(tags.length == 0)
		createTiddlyText(createTiddlyElement(popup,"li"),lingo.popupNone);
	for(var t=0; t<tags.length; t++) {
		var theTag = createTiddlyButton(createTiddlyElement(popup,"li"),tags[t][0],lingo.tagTooltip.format([tags[t][0]]),config.macros.tagChooser.onTagClick);
		theTag.setAttribute("tag",tags[t][0]);
		theTag.setAttribute("tiddler",this.getAttribute("tiddler"));
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
};

config.macros.tagChooser.onTagClick = function(e)
{
	if(!e) var e = window.event;
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(!readOnly)
		story.setTiddlerTag(title,tag,0);
	return false;
};

config.macros.tagChooser.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(tiddler instanceof Tiddler) {
		var title = tiddler.title;
		var lingo = config.views.editor.tagChooser;
		var btn = createTiddlyButton(place,lingo.text,lingo.tooltip,this.onClick);
		btn.setAttribute("tiddler",title);
	}
};

// Create a toolbar command button
config.macros.toolbar.createCommand = function(place,commandName,tiddler,theClass)
{
	if(typeof commandName != "string") {
		var c = null;
		for(var t in config.commands) {
			if(config.commands[t] == commandName)
				c = t;
		}
		commandName = c;
	}
	if((tiddler instanceof Tiddler) && (typeof commandName == "string")) {
		var command = config.commands[commandName];
		if(command.isEnabled ? command.isEnabled(tiddler) : this.isCommandEnabled(command,tiddler)) {
			var text = command.getText ? command.getText(tiddler) : this.getCommandText(command,tiddler);
			var tooltip = command.getTooltip ? command.getTooltip(tiddler) : this.getCommandTooltip(command,tiddler);
			var cmd;
			switch(command.type) {
				case "popup":
					cmd = this.onClickPopup;
					break;
				case "command":
				default:
					cmd = this.onClickCommand;
					break;
			}
			var btn = createTiddlyButton(null,text,tooltip,cmd);
			btn.setAttribute("commandName",commandName);
			btn.setAttribute("tiddler",tiddler.title);
			if(theClass)
				addClass(btn,theClass);
			place.appendChild(btn);
		}
	}
};

config.macros.toolbar.isCommandEnabled = function(command,tiddler)
{
	var title = tiddler.title;
	var ro = tiddler.isReadOnly();
	var shadow = store.isShadowTiddler(title) && !store.tiddlerExists(title);
	return (!ro || (ro && !command.hideReadOnly)) && !(shadow && command.hideShadow);
};

config.macros.toolbar.getCommandText = function(command,tiddler)
{
	return tiddler.isReadOnly() && command.readOnlyText ? command.readOnlyText : command.text;
};

config.macros.toolbar.getCommandTooltip = function(command,tiddler)
{
	return tiddler.isReadOnly() && command.readOnlyTooltip ? command.readOnlyTooltip : command.tooltip;
};

config.macros.toolbar.onClickCommand = function(e)
{
	if(!e) var e = window.event;
	e.cancelBubble = true;
	if (e.stopPropagation) e.stopPropagation();
	var command = config.commands[this.getAttribute("commandName")];
	return command.handler(e,this,this.getAttribute("tiddler"));
};

config.macros.toolbar.onClickPopup = function(e)
{
	if(!e) var e = window.event;
	e.cancelBubble = true;
	if (e.stopPropagation) e.stopPropagation();
	var popup = Popup.create(this);
	var command = config.commands[this.getAttribute("commandName")];
	var title = this.getAttribute("tiddler");
	var tiddler = store.fetchTiddler(title);
	popup.setAttribute("tiddler",title);
	command.handlePopup(popup,title);
	Popup.show();
	return false;
};

// Invoke the first command encountered from a given place that is tagged with a specified class
config.macros.toolbar.invokeCommand = function(place,theClass,event)
{
	var children = place.getElementsByTagName("a");
	for(var t=0; t<children.length; t++) {
		var c = children[t];
		if(hasClass(c,theClass) && c.getAttribute && c.getAttribute("commandName")) {
			if(c.onclick instanceof Function)
				c.onclick.call(c,event);
			break;
		}
	}
};

config.macros.toolbar.onClickMore = function(e)
{
	var e = this.nextSibling;
	e.style.display = "inline";
	removeNode(this);
	return false;
};

config.macros.toolbar.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	for(var t=0; t<params.length; t++) {
		var c = params[t];
		switch(c) {
			case '>':
				var btn = createTiddlyButton(place,this.moreLabel,this.morePrompt,config.macros.toolbar.onClickMore);
				addClass(btn,"moreCommand");
				var e = createTiddlyElement(place,"span",null,"moreCommand");
				e.style.display = "none";
				place = e;
				break;
			default:
				var theClass = "";
				switch(c.substr(0,1)) {
					case "+":
						theClass = "defaultCommand";
						c = c.substr(1);
						break;
					case "-":
						theClass = "cancelCommand";
						c = c.substr(1);
						break;
				}
				if(c in config.commands)
					this.createCommand(place,c,tiddler,theClass);
				break;
		}
	}
};

config.macros.refreshDisplay.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.refreshDisplay.onClick = function(e)
{
	refreshAll();
	return false;
};

config.macros.annotations.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var title = tiddler ? tiddler.title : null;
	var a = title ? config.annotations[title] : null;
	if(!tiddler || !title || !a)
		return;
	var text = a.format([title]);
	wikify(text,createTiddlyElement(place,"div",null,"annotation"),null,tiddler);
};

//--
//-- Menu and toolbar commands
//--

config.commands.closeTiddler.handler = function(event,src,title)
{
	story.closeTiddler(title,true);
	return false;
};

config.commands.closeOthers.handler = function(event,src,title)
{
	story.closeAllTiddlers(title);
	return false;
};

config.commands.editTiddler.handler = function(event,src,title)
{
	clearMessage();
	var tiddlerElem = document.getElementById(story.idPrefix + title);
	var fields = tiddlerElem.getAttribute("tiddlyFields");
	story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE,false,null,fields);
	story.focusTiddler(title,"text");
	return false;
};

config.commands.saveTiddler.handler = function(event,src,title)
{
	var newTitle = story.saveTiddler(title,event.shiftKey);
	if(newTitle)
		story.displayTiddler(null,newTitle);
	return false;
};

config.commands.cancelTiddler.handler = function(event,src,title)
{
	if(story.hasChanges(title) && !readOnly) {
		if(!confirm(this.warning.format([title])))
			return false;
	}
	story.setDirty(title,false);
	story.displayTiddler(null,title);
	return false;
};

config.commands.deleteTiddler.handler = function(event,src,title)
{
	var deleteIt = true;
	if (config.options.chkConfirmDelete)
		deleteIt = confirm(this.warning.format([title]));
	if (deleteIt) {
		store.removeTiddler(title);
		story.closeTiddler(title,true);
		autoSaveChanges();
	}
	return false;
};

config.commands.permalink.handler = function(event,src,title)
{
	var t = encodeURIComponent(String.encodeTiddlyLink(title));
	if(window.location.hash != t)
		window.location.hash = t;
	return false;
};

config.commands.references.handlePopup = function(popup,title)
{
	var references = store.getReferringTiddlers(title);
	var c = false;
	for(var r=0; r<references.length; r++) {
		if(references[r].title != title && !references[r].isTagged("excludeLists")) {
			createTiddlyLink(createTiddlyElement(popup,"li"),references[r].title,true);
			c = true;
		}
	}
	if(!c)
		createTiddlyText(createTiddlyElement(popup,"li",null,"disabled"),this.popupNone);
};

config.commands.jump.handlePopup = function(popup,title)
{
	story.forEachTiddler(function(title,element) {
		createTiddlyLink(createTiddlyElement(popup,"li"),title,true,null,false,null,true);
		});
};

config.commands.syncing.handlePopup = function(popup,title)
{
	var tiddler = store.fetchTiddler(title);
	if(!tiddler)
		return;
	var serverType = tiddler.getServerType();
	var serverHost = tiddler.fields['server.host'];
	var serverWorkspace = tiddler.fields['server.workspace'];
	if(!serverWorkspace)
		serverWorkspace = "";
	if(serverType) {
		var e = createTiddlyElement(popup,"li",null,"popupMessage");
		e.innerHTML = config.commands.syncing.currentlySyncing.format([serverType,serverHost,serverWorkspace]);
	} else {
		createTiddlyElement(popup,"li",null,"popupMessage",config.commands.syncing.notCurrentlySyncing);
	}
	if(serverType) {
		createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
		var btn = createTiddlyButton(createTiddlyElement(popup,"li"),this.captionUnSync,null,config.commands.syncing.onChooseServer);
		btn.setAttribute("tiddler",title);
		btn.setAttribute("server.type","");
	}
	createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
	createTiddlyElement(popup,"li",null,"popupMessage",config.commands.syncing.chooseServer);
	var feeds = store.getTaggedTiddlers("systemServer","title");
	for(var t=0; t<feeds.length; t++) {
		var f = feeds[t];
		var feedServerType = store.getTiddlerSlice(f.title,"Type");
		if(!feedServerType)
			feedServerType = "file";
		var feedServerHost = store.getTiddlerSlice(f.title,"URL");
		if(!feedServerHost)
			feedServerHost = "";
		var feedServerWorkspace = store.getTiddlerSlice(f.title,"Workspace");
		if(!feedServerWorkspace)
			feedServerWorkspace = "";
		var caption = f.title;
		if(serverType == feedServerType && serverHost == feedServerHost && serverWorkspace == feedServerWorkspace) {
			caption = config.commands.syncing.currServerMarker + caption;
		} else {
			caption = config.commands.syncing.notCurrServerMarker + caption;
		}
		btn = createTiddlyButton(createTiddlyElement(popup,"li"),caption,null,config.commands.syncing.onChooseServer);
		btn.setAttribute("tiddler",title);
		btn.setAttribute("server.type",feedServerType);
		btn.setAttribute("server.host",feedServerHost);
		btn.setAttribute("server.workspace",feedServerWorkspace);
	}
};

config.commands.syncing.onChooseServer = function(e)
{
	var tiddler = this.getAttribute("tiddler");
	var serverType = this.getAttribute("server.type");
	if(serverType) {
		store.addTiddlerFields(tiddler,{
			'server.type': serverType,
			'server.host': this.getAttribute("server.host"),
			'server.workspace': this.getAttribute("server.workspace")
			});
	} else {
		store.setValue(tiddler,'server',null);
	}
	return false;
};

config.commands.fields.handlePopup = function(popup,title)
{
	var tiddler = store.fetchTiddler(title);
	if(!tiddler)
		return;
	var fields = {};
	store.forEachField(tiddler,function(tiddler,fieldName,value) {fields[fieldName] = value;},true);
	var items = [];
	for(var t in fields) {
		items.push({field: t,value: fields[t]});
	}
	items.sort(function(a,b) {return a.field < b.field ? -1 : (a.field == b.field ? 0 : +1);});
	if(items.length > 0)
		ListView.create(popup,items,this.listViewTemplate);
	else
		createTiddlyElement(popup,"div",null,null,this.emptyText);
};

//--
//-- Tiddler() object
//--

function Tiddler(title)
{
	this.title = title;
	this.text = null;
	this.modifier = null;
	this.modified = new Date();
	this.created = new Date();
	this.links = [];
	this.linksUpdated = false;
	this.tags = [];
	this.fields = {};
	return this;
}

Tiddler.prototype.getLinks = function()
{
	if(this.linksUpdated==false)
		this.changed();
	return this.links;
};

// Returns the fields that are inherited in string field:"value" field2:"value2" format
Tiddler.prototype.getInheritedFields = function()
{
	var f = {};
	for(i in this.fields) {
		if(i=="server.host" || i=="server.workspace" || i=="wikiformat"|| i=="server.type") {
			f[i] = this.fields[i];
		}
	}
	return String.encodeHashMap(f);
};

// Increment the changeCount of a tiddler
Tiddler.prototype.incChangeCount = function()
{
	var c = this.fields['changecount'];
	c = c ? parseInt(c) : 0;
	this.fields['changecount'] = String(c+1);
};

// Clear the changeCount of a tiddler
Tiddler.prototype.clearChangeCount = function()
{
	if(this.fields['changecount']) {
		delete this.fields['changecount'];
	}
};

// Returns true if the tiddler has been updated since the tiddler was created or downloaded
Tiddler.prototype.isTouched = function()
{
	var changeCount = this.fields['changecount'];
	if(changeCount === undefined)
		changeCount = 0;
	return changeCount > 0;
};

// Format the text for storage in an RSS item
Tiddler.prototype.saveToRss = function(url)
{
	var s = [];
	s.push("<item>");
	s.push("<title" + ">" + this.title.htmlEncode() + "</title" + ">");
	s.push("<description>" + wikifyStatic(this.text,null,this).htmlEncode() + "</description>");
	for(var t=0; t<this.tags.length; t++)
		s.push("<category>" + this.tags[t] + "</category>");
	s.push("<link>" + url + "#" + encodeURIComponent(String.encodeTiddlyLink(this.title)) + "</link>");
	s.push("<pubDate>" + this.modified.toGMTString() + "</pubDate>");
	s.push("</item>");
	return s.join("\n");
};

// Change the text and other attributes of a tiddler
Tiddler.prototype.set = function(title,text,modifier,modified,tags,created,fields)
{
	this.assign(title,text,modifier,modified,tags,created,fields);
	this.changed();
	return this;
};

// Change the text and other attributes of a tiddler without triggered a tiddler.changed() call
Tiddler.prototype.assign = function(title,text,modifier,modified,tags,created,fields)
{
	if(title != undefined)
		this.title = title;
	if(text != undefined)
		this.text = text;
	if(modifier != undefined)
		this.modifier = modifier;
	if(modified != undefined)
		this.modified = modified;
	if(created != undefined)
		this.created = created;
	if(fields != undefined)
		this.fields = fields;
	if(tags != undefined)
		this.tags = (typeof tags == "string") ? tags.readBracketedList() : tags;
	else if(this.tags == undefined)
		this.tags = [];
	return this;
};

// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)
Tiddler.prototype.getTags = function()
{
	return String.encodeTiddlyLinkList(this.tags);
};

// Test if a tiddler carries a tag
Tiddler.prototype.isTagged = function(tag)
{
	return this.tags.indexOf(tag) != -1;
};

// Static method to convert "\n" to newlines, "\s" to "\"
Tiddler.unescapeLineBreaks = function(text)
{
	return text ? text.unescapeLineBreaks() : "";
};

// Convert newlines to "\n", "\" to "\s"
Tiddler.prototype.escapeLineBreaks = function()
{
	return this.text.escapeLineBreaks();
};

// Updates the secondary information (like links[] array) after a change to a tiddler
Tiddler.prototype.changed = function()
{
	this.links = [];
	var t = this.autoLinkWikiWords() ? 0 : 1;
	var tiddlerLinkRegExp = t==0 ? config.textPrimitives.tiddlerAnyLinkRegExp : config.textPrimitives.tiddlerForcedLinkRegExp;
	tiddlerLinkRegExp.lastIndex = 0;
	var formatMatch = tiddlerLinkRegExp.exec(this.text);
	while(formatMatch) {
		var lastIndex = tiddlerLinkRegExp.lastIndex;
		if(t==0 && formatMatch[1] && formatMatch[1] != this.title) {
			// wikiWordLink
			if(formatMatch.index > 0) {
				var preRegExp = new RegExp(config.textPrimitives.unWikiLink+"|"+config.textPrimitives.anyLetter,"mg");
				preRegExp.lastIndex = formatMatch.index-1;
				var preMatch = preRegExp.exec(this.text);
				if(preMatch.index != formatMatch.index-1)
					this.links.pushUnique(formatMatch[1]);
			} else {
				this.links.pushUnique(formatMatch[1]);
			}
		}
		else if(formatMatch[2-t] && !config.formatterHelpers.isExternalLink(formatMatch[3-t])) // titledBrackettedLink
			this.links.pushUnique(formatMatch[3-t]);
		else if(formatMatch[4-t] && formatMatch[4-t] != this.title) // brackettedLink
			this.links.pushUnique(formatMatch[4-t]);
		tiddlerLinkRegExp.lastIndex = lastIndex;
		formatMatch = tiddlerLinkRegExp.exec(this.text);
	}
	this.linksUpdated = true;
};

Tiddler.prototype.getSubtitle = function()
{
	var theModifier = this.modifier;
	if(!theModifier)
		theModifier = config.messages.subtitleUnknown;
	var theModified = this.modified;
	if(theModified)
		theModified = theModified.toLocaleString();
	else
		theModified = config.messages.subtitleUnknown;
	return config.messages.tiddlerLinkTooltip.format([this.title,theModifier,theModified]);
};

Tiddler.prototype.isReadOnly = function()
{
	return readOnly;
};

Tiddler.prototype.autoLinkWikiWords = function()
{
	return !(this.isTagged("systemConfig") || this.isTagged("excludeMissing"));
};

Tiddler.prototype.generateFingerprint = function()
{
	return "0x" + Crypto.hexSha1Str(this.text);
};

Tiddler.prototype.getServerType = function()
{
	var serverType = null;
	if(this.fields && this.fields['server.type'])
		serverType = this.fields['server.type'];
	if(!serverType)
		serverType = this.fields['wikiformat'];
	if(serverType && !config.adaptors[serverType])
		serverType = null;
	return serverType;
};

Tiddler.prototype.getAdaptor = function()
{
	var serverType = this.getServerType();
	if(serverType)
		return new config.adaptors[serverType];
	else
		return null;
};

//--
//-- TiddlyWiki() object contains Tiddler()s
//--

function TiddlyWiki()
{
	var tiddlers = {}; // Hashmap by name of tiddlers
	this.tiddlersUpdated = false;
	this.namedNotifications = []; // Array of {name:,notify:} of notification functions
	this.notificationLevel = 0;
	this.slices = {}; // map tiddlerName->(map sliceName->sliceValue). Lazy.
	this.clear = function() {
		tiddlers = {};
		this.setDirty(false);
	};
	this.fetchTiddler = function(title) {
		return tiddlers[title];
	};
	this.deleteTiddler = function(title) {
		delete this.slices[title];
		delete tiddlers[title];
	};
	this.addTiddler = function(tiddler) {
		delete this.slices[tiddler.title];
		tiddlers[tiddler.title] = tiddler;
	};
	this.forEachTiddler = function(callback) {
		for(var t in tiddlers) {
			var tiddler = tiddlers[t];
			if(tiddler instanceof Tiddler)
				callback.call(this,t,tiddler);
		}
	};
}

TiddlyWiki.prototype.setDirty = function(dirty)
{
	this.dirty = dirty;
};

TiddlyWiki.prototype.isDirty = function()
{
	return this.dirty;
};

TiddlyWiki.prototype.suspendNotifications = function()
{
	this.notificationLevel--;
};

TiddlyWiki.prototype.resumeNotifications = function()
{
	this.notificationLevel++;
};

// Invoke the notification handlers for a particular tiddler
TiddlyWiki.prototype.notify = function(title,doBlanket)
{
	if(!this.notificationLevel) {
		for(var t=0; t<this.namedNotifications.length; t++) {
			var n = this.namedNotifications[t];
			if((n.name == null && doBlanket) || (n.name == title))
				n.notify(title);
		}
	}
};

// Invoke the notification handlers for all tiddlers
TiddlyWiki.prototype.notifyAll = function()
{
	if(!this.notificationLevel) {
		for(var t=0; t<this.namedNotifications.length; t++) {
			var n = this.namedNotifications[t];
			if(n.name)
				n.notify(n.name);
		}
	}
};

// Add a notification handler to a tiddler
TiddlyWiki.prototype.addNotification = function(title,fn)
{
	for(var i=0; i<this.namedNotifications.length; i++) {
		if((this.namedNotifications[i].name == title) && (this.namedNotifications[i].notify == fn))
			return this;
	}
	this.namedNotifications.push({name: title, notify: fn});
	return this;
};

TiddlyWiki.prototype.removeTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		this.deleteTiddler(title);
		this.notify(title,true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.tiddlerExists = function(title)
{
	var t = this.fetchTiddler(title);
	return t != undefined;
};

TiddlyWiki.prototype.isShadowTiddler = function(title)
{
	return typeof config.shadowTiddlers[title] == "string";
};

TiddlyWiki.prototype.getTiddler = function(title)
{
	var t = this.fetchTiddler(title);
	if(t != undefined)
		return t;
	else
		return null;
};

TiddlyWiki.prototype.getTiddlerText = function(title,defaultText)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		return tiddler.text;
	if(!title)
		return defaultText;
	var pos = title.indexOf(config.textPrimitives.sliceSeparator);
	if(pos != -1) {
		var slice = this.getTiddlerSlice(title.substr(0,pos),title.substr(pos + config.textPrimitives.sliceSeparator.length));
		if(slice)
			return slice;
	}
	if(this.isShadowTiddler(title))
		return config.shadowTiddlers[title];
	if(defaultText != undefined)
		return defaultText;
	return null;
};

TiddlyWiki.prototype.slicesRE = /(?:[\'\/]*~?([\.\w]+)[\'\/]*\:[\'\/]*\s*(.*?)\s*$)|(?:\|[\'\/]*~?([\.\w]+)\:?[\'\/]*\|\s*(.*?)\s*\|)/gm;

// @internal
TiddlyWiki.prototype.calcAllSlices = function(title)
{
	var slices = {};
	var text = this.getTiddlerText(title,"");
	this.slicesRE.lastIndex = 0;
	do {
		var m = this.slicesRE.exec(text);
		if(m) {
			if(m[1])
				slices[m[1]] = m[2];
			else
				slices[m[3]] = m[4];
		}
	} while(m);
	return slices;
};

// Returns the slice of text of the given name
TiddlyWiki.prototype.getTiddlerSlice = function(title,sliceName)
{
	var slices = this.slices[title];
	if(!slices) {
		slices = this.calcAllSlices(title);
		this.slices[title] = slices;
	}
	return slices[sliceName];
};

// Build an hashmap of the specified named slices of a tiddler
TiddlyWiki.prototype.getTiddlerSlices = function(title,sliceNames)
{
	var r = {};
	for(var t=0; t<sliceNames.length; t++) {
		var slice = this.getTiddlerSlice(title,sliceNames[t]);
		if(slice)
			r[sliceNames[t]] = slice;
	}
	return r;
};

TiddlyWiki.prototype.getRecursiveTiddlerText = function(title,defaultText,depth)
{
	var bracketRegExp = new RegExp("(?:\\[\\[([^\\]]+)\\]\\])","mg");
	var text = this.getTiddlerText(title,null);
	if(text == null)
		return defaultText;
	var textOut = [];
	var lastPos = 0;
	do {
		var match = bracketRegExp.exec(text);
		if(match) {
			textOut.push(text.substr(lastPos,match.index-lastPos));
			if(match[1]) {
				if(depth <= 0)
					textOut.push(match[1]);
				else
					textOut.push(this.getRecursiveTiddlerText(match[1],"[[" + match[1] + "]]",depth-1));
			}
			lastPos = match.index + match[0].length;
		} else {
			textOut.push(text.substr(lastPos));
		}
	} while(match);
	return textOut.join("");
};

TiddlyWiki.prototype.setTiddlerTag = function(title,status,tag)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		var t = tiddler.tags.indexOf(tag);
		if(t != -1)
			tiddler.tags.splice(t,1);
		if(status)
			tiddler.tags.push(tag);
		tiddler.changed();
		this.incChangeCount(title);
		this.notify(title,true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.addTiddlerFields = function(title,fields)
{
	var tiddler = this.fetchTiddler(title);
	if(!tiddler)
		return;
	merge(tiddler.fields,fields);
	tiddler.changed();
	this.incChangeCount(title);
	this.notify(title,true);
	this.setDirty(true);
};

TiddlyWiki.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags,fields,clearChangeCount,created)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		created = created ? created : tiddler.created; // Preserve created date
		this.deleteTiddler(title);
	} else {
		created = created ? created : modified;
		tiddler = new Tiddler();
	}
	tiddler.set(newTitle,newBody,modifier,modified,tags,created,fields);
	this.addTiddler(tiddler);
	if(clearChangeCount)
		tiddler.clearChangeCount();
	else
		tiddler.incChangeCount();
	if(title != newTitle)
		this.notify(title,true);
	this.notify(newTitle,true);
	this.setDirty(true);
	return tiddler;
};

// Reset the sync status of a freshly synced tiddler
TiddlyWiki.prototype.resetTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		tiddler.clearChangeCount();
		this.notify(title,true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.incChangeCount = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		tiddler.incChangeCount();
};

TiddlyWiki.prototype.createTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(!tiddler) {
		tiddler = new Tiddler();
		tiddler.title = title;
		this.addTiddler(tiddler);
		this.setDirty(true);
	}
	return tiddler;
};

// Load contents of a TiddlyWiki from an HTML DIV
TiddlyWiki.prototype.loadFromDiv = function(src,idPrefix,noUpdate)
{
	this.idPrefix = idPrefix;
	var storeElem = (typeof src == "string") ? document.getElementById(src) : src;
	if(!storeElem)
		return;
	var tiddlers = this.getLoader().loadTiddlers(this,storeElem.childNodes);
	this.setDirty(false);
	if(!noUpdate) {
		for(var i = 0;i<tiddlers.length; i++)
			tiddlers[i].changed();
	}
};

// Load contents of a TiddlyWiki from a string
// Returns null if there's an error
TiddlyWiki.prototype.importTiddlyWiki = function(text)
{
	var posDiv = locateStoreArea(text);
	if(!posDiv)
		return null;
	var content = "<" + "html><" + "body>" + text.substring(posDiv[0],posDiv[1] + endSaveArea.length) + "<" + "/body><" + "/html>";
	// Create the iframe
	var iframe = document.createElement("iframe");
	iframe.style.display = "none";
	document.body.appendChild(iframe);
	var doc = iframe.document;
	if(iframe.contentDocument)
		doc = iframe.contentDocument; // For NS6
	else if(iframe.contentWindow)
		doc = iframe.contentWindow.document; // For IE5.5 and IE6
	// Put the content in the iframe
	doc.open();
	doc.writeln(content);
	doc.close();
	// Load the content into a TiddlyWiki() object
	var storeArea = doc.getElementById("storeArea");
	this.loadFromDiv(storeArea,"store");
	// Get rid of the iframe
	iframe.parentNode.removeChild(iframe);
	return this;
};

TiddlyWiki.prototype.updateTiddlers = function()
{
	this.tiddlersUpdated = true;
	this.forEachTiddler(function(title,tiddler) {
		tiddler.changed();
	});
};

// Return all tiddlers formatted as an HTML string
TiddlyWiki.prototype.allTiddlersAsHtml = function()
{
	return store.getSaver().externalize(store);
};

// Return an array of tiddlers matching a search regular expression
TiddlyWiki.prototype.search = function(searchRegExp,sortField,excludeTag)
{
	var candidates = this.reverseLookup("tags",excludeTag,false);
	var results = [];
	for(var t=0; t<candidates.length; t++) {
		if((candidates[t].title.search(searchRegExp) != -1) || (candidates[t].text.search(searchRegExp) != -1))
			results.push(candidates[t]);
	}
	if(!sortField)
		sortField = "title";
	results.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});
	return results;
};

// Return an array of all the tags in use. Each member of the array is another array where [0] is the name of the tag and [1] is the number of occurances
TiddlyWiki.prototype.getTags = function(excludeTag)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		for(var g=0; g<tiddler.tags.length; g++) {
			var tag = tiddler.tags[g];
			if(excludeTag) {
				var t = store.fetchTiddler(tag);
				if(t && t.isTagged(excludeTag))
					return false;
			}
			var f = false;
			for(var c=0; c<results.length; c++) {
				if(results[c][0] == tag) {
					f = true;
					results[c][1]++;
				}
			}
			if(!f)
				results.push([tag,1]);
		}
	});
	results.sort(function(a,b) {return a[0].toLowerCase() < b[0].toLowerCase() ? -1 : (a[0].toLowerCase() == b[0].toLowerCase() ? 0 : +1);});
	return results;
};

// Return an array of the tiddlers that are tagged with a given tag
TiddlyWiki.prototype.getTaggedTiddlers = function(tag,sortField)
{
	return this.reverseLookup("tags",tag,true,sortField);
};

// Return an array of the tiddlers that link to a given tiddler
TiddlyWiki.prototype.getReferringTiddlers = function(title,unusedParameter,sortField)
{
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	return this.reverseLookup("links",title,true,sortField);
};

// Return an array of the tiddlers that do or do not have a specified entry in the specified storage array (ie, "links" or "tags")
// lookupMatch == true to match tiddlers, false to exclude tiddlers
TiddlyWiki.prototype.reverseLookup = function(lookupField,lookupValue,lookupMatch,sortField)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		var f = !lookupMatch;
		for(var lookup=0; lookup<tiddler[lookupField].length; lookup++) {
			if(tiddler[lookupField][lookup] == lookupValue)
				f = lookupMatch;
		}
		if(f)
			results.push(tiddler);
	});
	if(!sortField)
		sortField = "title";
	results.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});
	return results;
};

// Return the tiddlers as a sorted array
TiddlyWiki.prototype.getTiddlers = function(field,excludeTag)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(excludeTag == undefined || !tiddler.isTagged(excludeTag))
			results.push(tiddler);
	});
	if(field)
		results.sort(function(a,b) {return a[field] < b[field] ? -1 : (a[field] == b[field] ? 0 : +1);});
	return results;
};

// Return array of names of tiddlers that are referred to but not defined
TiddlyWiki.prototype.getMissingLinks = function(sortField)
{
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		if(tiddler.isTagged("excludeMissing") || tiddler.isTagged("systemConfig"))
			return;
		for(var n=0; n<tiddler.links.length;n++) {
			var link = tiddler.links[n];
			if(this.fetchTiddler(link) == null && !this.isShadowTiddler(link))
				results.pushUnique(link);
		}
	});
	results.sort();
	return results;
};

// Return an array of names of tiddlers that are defined but not referred to
TiddlyWiki.prototype.getOrphans = function()
{
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		if(this.getReferringTiddlers(title).length == 0 && !tiddler.isTagged("excludeLists"))
			results.push(title);
	});
	results.sort();
	return results;
};

// Return an array of names of all the shadow tiddlers
TiddlyWiki.prototype.getShadowed = function()
{
	var results = [];
	for(var t in config.shadowTiddlers) {
		if(typeof config.shadowTiddlers[t] == "string")
			results.push(t);
	}
	results.sort();
	return results;
};

// Return an array of tiddlers that have been touched since they were downloaded or created
TiddlyWiki.prototype.getTouched = function()
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(tiddler.isTouched())
			results.push(tiddler);
		});
	results.sort();
	return results;
};

// Resolves a Tiddler reference or tiddler title into a Tiddler object, or null if it doesn't exist
TiddlyWiki.prototype.resolveTiddler = function(tiddler)
{
	var t = (typeof tiddler == 'string') ? this.getTiddler(tiddler) : tiddler;
	return t instanceof Tiddler ? t : null;
};

TiddlyWiki.prototype.getLoader = function()
{
	if(!this.loader)
		this.loader = new TW21Loader();
	return this.loader;
};

TiddlyWiki.prototype.getSaver = function()
{
	if(!this.saver)
		this.saver = new TW21Saver();
	return this.saver;
};

// Returns true if path is a valid field name (path),
// i.e. a sequence of identifiers, separated by '.'
TiddlyWiki.isValidFieldName = function(name)
{
	var match = /[a-zA-Z_]\w*(\.[a-zA-Z_]\w*)*/.exec(name);
	return match && (match[0] == name);
};

// Throws an exception when name is not a valid field name.
TiddlyWiki.checkFieldName = function(name)
{
	if(!TiddlyWiki.isValidFieldName(name))
		throw config.messages.invalidFieldName.format([name]);
};

function StringFieldAccess(n,readOnly)
{
	this.set = readOnly ?
			function(t,v) {if(v != t[n]) throw config.messages.fieldCannotBeChanged.format([n]);} :
			function(t,v) {if(v != t[n]) {t[n] = v; return true;}};
	this.get = function(t) {return t[n];};
}

function DateFieldAccess(n)
{
	this.set = function(t,v) {
		var d = v instanceof Date ? v : Date.convertFromYYYYMMDDHHMM(v);
		if(d != t[n]) {
			t[n] = d; return true;
		}
	};
	this.get = function(t) {return t[n].convertToYYYYMMDDHHMM();};
}

function LinksFieldAccess(n)
{
	this.set = function(t,v) {
		var s = (typeof v == "string") ? v.readBracketedList() : v;
		if(s.toString() != t[n].toString()) {
			t[n] = s; return true;
		}
	};
	this.get = function(t) {return String.encodeTiddlyLinkList(t[n]);};
}

TiddlyWiki.standardFieldAccess = {
	// The set functions return true when setting the data has changed the value.
	"title":    new StringFieldAccess("title",true),
	// Handle the "tiddler" field name as the title
	"tiddler":  new StringFieldAccess("title",true),
	"text":     new StringFieldAccess("text"),
	"modifier": new StringFieldAccess("modifier"),
	"modified": new DateFieldAccess("modified"),
	"created":  new DateFieldAccess("created"),
	"tags":     new LinksFieldAccess("tags")
};

TiddlyWiki.isStandardField = function(name)
{
	return TiddlyWiki.standardFieldAccess[name] != undefined;
};

// Sets the value of the given field of the tiddler to the value.
// Setting an ExtendedField's value to null or undefined removes the field.
// Setting a namespace to undefined removes all fields of that namespace.
// The fieldName is case-insensitive.
// All values will be converted to a string value.
TiddlyWiki.prototype.setValue = function(tiddler,fieldName,value)
{
	TiddlyWiki.checkFieldName(fieldName);
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return;
	fieldName = fieldName.toLowerCase();
	var isRemove = (value === undefined) || (value === null);
	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if(accessor) {
		if(isRemove)
			// don't remove StandardFields
			return;
		var h = TiddlyWiki.standardFieldAccess[fieldName];
		if(!h.set(t,value))
			return;
	} else {
		var oldValue = t.fields[fieldName];
		if(isRemove) {
			if(oldValue !== undefined) {
				// deletes a single field
				delete t.fields[fieldName];
			} else {
				// no concrete value is defined for the fieldName
				// so we guess this is a namespace path.
				// delete all fields in a namespace
				var re = new RegExp('^'+fieldName+'\\.');
				var dirty = false;
				for(var n in t.fields) {
					if(n.match(re)) {
						delete t.fields[n];
						dirty = true;
					}
				}
				if(!dirty)
					return;
			}
		} else {
			// the "normal" set case. value is defined (not null/undefined)
			// For convenience provide a nicer conversion Date->String
			value = value instanceof Date ? value.convertToYYYYMMDDHHMMSSMMM() : String(value);
			if(oldValue == value)
				return;
			t.fields[fieldName] = value;
		}
	}
	// When we are here the tiddler/store really was changed.
	this.notify(t.title,true);
	if(!fieldName.match(/^temp\./))
		this.setDirty(true);
};

// Returns the value of the given field of the tiddler.
// The fieldName is case-insensitive.
// Will only return String values (or undefined).
TiddlyWiki.prototype.getValue = function(tiddler,fieldName)
{
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return undefined;
	fieldName = fieldName.toLowerCase();
	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if(accessor) {
		return accessor.get(t);
	}
	return t.fields[fieldName];
};

// Calls the callback function for every field in the tiddler.
// When callback function returns a non-false value the iteration stops
// and that value is returned.
// The order of the fields is not defined.
// @param callback a function(tiddler,fieldName,value).
TiddlyWiki.prototype.forEachField = function(tiddler,callback,onlyExtendedFields)
{
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return undefined;
	for(var n in t.fields) {
		var result = callback(t,n,t.fields[n]);
		if(result)
			return result;
		}
	if(onlyExtendedFields)
		return undefined;
	for(var n in TiddlyWiki.standardFieldAccess) {
		if(n == "tiddler")
			// even though the "title" field can also be referenced through the name "tiddler"
			// we only visit this field once.
			continue;
		var result = callback(t,n,TiddlyWiki.standardFieldAccess[n].get(t));
		if(result)
			return result;
	}
	return undefined;
};

//--
//-- Story functions
//--

function Story(container,idPrefix)
{
	this.container = container;
	this.idPrefix = idPrefix;
	this.highlightRegExp = null;
}

Story.prototype.forEachTiddler = function(fn)
{
	var place = document.getElementById(this.container);
	if(!place)
		return;
	var e = place.firstChild;
	while(e) {
		var n = e.nextSibling;
		var title = e.getAttribute("tiddler");
		fn.call(this,title,e);
		e = n;
	}
};

Story.prototype.displayTiddlers = function(srcElement,titles,template,animate,unused,customFields,toggle)
{
	for(var t = titles.length-1;t>=0;t--)
		this.displayTiddler(srcElement,titles[t],template,animate,unused,customFields);
};

Story.prototype.displayTiddler = function(srcElement,title,template,animate,unused,customFields,toggle)
{
	var place = document.getElementById(this.container);
	var tiddlerElem = document.getElementById(this.idPrefix + title);
	if(tiddlerElem) {
		if(toggle)
			this.closeTiddler(title,true);
		else
			this.refreshTiddler(title,template,false,customFields);
	} else {
		var before = this.positionTiddler(srcElement);
		tiddlerElem = this.createTiddler(place,before,title,template,customFields);
	}
	if(srcElement && typeof srcElement !== "string") {
		if(config.options.chkAnimate && (animate == undefined || animate == true) && anim && typeof Zoomer == "function" && typeof Scroller == "function")
			anim.startAnimating(new Zoomer(title,srcElement,tiddlerElem),new Scroller(tiddlerElem));
		else
			window.scrollTo(0,ensureVisible(tiddlerElem));
	}
};

Story.prototype.positionTiddler = function(srcElement)
{
	var place = document.getElementById(this.container);
	var before = null;
	if(typeof srcElement == "string") {
		switch(srcElement) {
			case "top":
				before = place.firstChild;
				break;
			case "bottom":
				before = null;
				break;
		}
	} else {
		var after = this.findContainingTiddler(srcElement);
		if(after == null) {
			before = place.firstChild;
		} else if(after.nextSibling) {
			before = after.nextSibling;
			if(before.nodeType != 1)
				before = null;
		}
	}
	return before;
};

Story.prototype.createTiddler = function(place,before,title,template,customFields)
{
	var tiddlerElem = createTiddlyElement(null,"div",this.idPrefix + title,"tiddler");
	tiddlerElem.setAttribute("refresh","tiddler");
	if(customFields)
		tiddlerElem.setAttribute("tiddlyFields",customFields);
	place.insertBefore(tiddlerElem,before);
	var defaultText = null;
	if(!store.tiddlerExists(title) && !store.isShadowTiddler(title))
		defaultText = this.loadMissingTiddler(title,customFields,tiddlerElem);
	this.refreshTiddler(title,template,false,customFields,defaultText);
	return tiddlerElem;
};

Story.prototype.loadMissingTiddler = function(title,fields,tiddlerElem)
{
	var tiddler = new Tiddler(title);
	tiddler.fields = typeof fields == "string" ?  fields.decodeHashMap() : (fields ? fields : {});
	var serverType = tiddler.getServerType();
	var host = tiddler.fields['server.host'];
	var workspace = tiddler.fields['server.workspace'];
	if(!serverType | !host)
		return null;
	var sm = new SyncMachine(serverType,{
			start: function() {
				return this.openHost(host,"openWorkspace");
			},
			openWorkspace: function() {
				return this.openWorkspace(workspace,"getTiddler");
			},
			getTiddler: function() {
				return this.getTiddler(title,"gotTiddler");
			},
			gotTiddler: function(tiddler) {
				if(tiddler && tiddler.text) {
					var downloaded = new Date();
					if(!tiddler.created)
						tiddler.created = downloaded;
					if(!tiddler.modified)
						tiddler.modified = tiddler.created;
					store.saveTiddler(tiddler.title,tiddler.title,tiddler.text,tiddler.modifier,tiddler.modified,tiddler.tags,tiddler.fields,true,tiddler.created);
					autoSaveChanges();
				}
				delete this;
				return true;
			},
			error: function(message) {
				displayMessage("Error loading missing tiddler from %0: %1".format([host,message]));
			}
		});
	sm.go();
	return config.messages.loadingMissingTiddler.format([title,serverType,host,workspace]);
};

Story.prototype.chooseTemplateForTiddler = function(title,template)
{
	if(!template)
		template = DEFAULT_VIEW_TEMPLATE;
	if(template == DEFAULT_VIEW_TEMPLATE || template == DEFAULT_EDIT_TEMPLATE)
		template = config.tiddlerTemplates[template];
	return template;
};

Story.prototype.getTemplateForTiddler = function(title,template,tiddler)
{
	return store.getRecursiveTiddlerText(template,null,10);
};

Story.prototype.refreshTiddler = function(title,template,force,customFields,defaultText)
{
	var tiddlerElem = document.getElementById(this.idPrefix + title);
	if(tiddlerElem) {
		if(tiddlerElem.getAttribute("dirty") == "true" && !force)
			return tiddlerElem;
		template = this.chooseTemplateForTiddler(title,template);
		var currTemplate = tiddlerElem.getAttribute("template");
		if((template != currTemplate) || force) {
			var tiddler = store.getTiddler(title);
			if(!tiddler) {
				tiddler = new Tiddler();
				if(store.isShadowTiddler(title)) {
					tiddler.set(title,store.getTiddlerText(title),config.views.wikified.shadowModifier,version.date,[],version.date);
				} else {
					var text = template=="EditTemplate" ?
								config.views.editor.defaultText.format([title]) :
								config.views.wikified.defaultText.format([title]);
					text = defaultText ? defaultText : text;
					var fields = customFields ? customFields.decodeHashMap() : null;
					tiddler.set(title,text,config.views.wikified.defaultModifier,version.date,[],version.date,fields);
				}
			}
			tiddlerElem.setAttribute("tags",tiddler.tags.join(" "));
			tiddlerElem.setAttribute("tiddler",title);
			tiddlerElem.setAttribute("template",template);
			var me = this;
			tiddlerElem.onmouseover = this.onTiddlerMouseOver;
			tiddlerElem.onmouseout = this.onTiddlerMouseOut;
			tiddlerElem.ondblclick = this.onTiddlerDblClick;
			tiddlerElem[window.event?"onkeydown":"onkeypress"] = this.onTiddlerKeyPress;
			var html = this.getTemplateForTiddler(title,template,tiddler);
			tiddlerElem.innerHTML = html;
			applyHtmlMacros(tiddlerElem,tiddler);
			if(store.getTaggedTiddlers(title).length > 0)
				addClass(tiddlerElem,"isTag");
			else
				removeClass(tiddlerElem,"isTag");
			if(!store.tiddlerExists(title)) {
				if(store.isShadowTiddler(title))
					addClass(tiddlerElem,"shadow");
				else
					addClass(tiddlerElem,"missing");
			} else {
				removeClass(tiddlerElem,"shadow");
				removeClass(tiddlerElem,"missing");
			}
			if(customFields)
				this.addCustomFields(tiddlerElem,customFields);
			forceReflow();
		}
	}
	return tiddlerElem;
};

Story.prototype.addCustomFields = function(place,customFields)
{
	var fields = customFields.decodeHashMap();
	var w = document.createElement("div");
	w.style.display = "none";
	place.appendChild(w);
	for(var t in fields) {
		var e = document.createElement("input");
		e.setAttribute("type","text");
		e.setAttribute("value",fields[t]);
		w.appendChild(e);
		e.setAttribute("edit",t);
	}
};

Story.prototype.refreshAllTiddlers = function() 
{
	var place = document.getElementById(this.container);
	var e = place.firstChild;
	if(!e)
		return;
	this.refreshTiddler(e.getAttribute("tiddler"),e.getAttribute("template"),true);
	while((e = e.nextSibling) != null) 
		this.refreshTiddler(e.getAttribute("tiddler"),e.getAttribute("template"),true);
};

Story.prototype.onTiddlerMouseOver = function(e)
{
	if(window.addClass instanceof Function)
		addClass(this,"selected");
};

Story.prototype.onTiddlerMouseOut = function(e)
{
	if(window.removeClass instanceof Function)
		removeClass(this,"selected");
};

Story.prototype.onTiddlerDblClick = function(e)
{
	if(!e) var e = window.event;
	var theTarget = resolveTarget(e);
	if(theTarget && theTarget.nodeName.toLowerCase() != "input" && theTarget.nodeName.toLowerCase() != "textarea") {
		if(document.selection && document.selection.empty)
			document.selection.empty();
		config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
		e.cancelBubble = true;
		if(e.stopPropagation) e.stopPropagation();
		return true;
	} else {
		return false;
	}
};

Story.prototype.onTiddlerKeyPress = function(e)
{
	if(!e) var e = window.event;
	clearMessage();
	var consume = false; 
	var title = this.getAttribute("tiddler");
	var target = resolveTarget(e);
	switch(e.keyCode) {
		case 9: // Tab
			if(config.options.chkInsertTabs && target.tagName.toLowerCase() == "textarea") {
				replaceSelection(target,String.fromCharCode(9));
				consume = true; 
			}
			if(config.isOpera) {
				target.onblur = function() {
					this.focus();
					this.onblur = null;
				};
			}
			break;
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
		case 77: // Ctrl-Enter is "M" on some platforms
			if(e.ctrlKey) {
				blurElement(this);
				config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
				consume = true;
			}
			break; 
		case 27: // Escape
			blurElement(this);
			config.macros.toolbar.invokeCommand(this,"cancelCommand",e);
			consume = true;
			break;
	}
	e.cancelBubble = consume;
	if(consume) {
		if(e.stopPropagation) e.stopPropagation(); // Stop Propagation
		e.returnValue = true; // Cancel The Event in IE
		if(e.preventDefault ) e.preventDefault(); // Cancel The Event in Moz
	}
	return !consume;
};

Story.prototype.getTiddlerField = function(title,field)
{
	var tiddlerElem = document.getElementById(this.idPrefix + title);
	var e = null;
	if(tiddlerElem != null) {
		var children = tiddlerElem.getElementsByTagName("*");
		for(var t=0; t<children.length; t++) {
			var c = children[t];
			if(c.tagName.toLowerCase() == "input" || c.tagName.toLowerCase() == "textarea") {
				if(!e)
					e = c;
				if(c.getAttribute("edit") == field)
					e = c;
			}
		}
	}
	return e;
};

Story.prototype.focusTiddler = function(title,field)
{
	var e = this.getTiddlerField(title,field);
	if(e) {
		e.focus();
		e.select();
	}
};

Story.prototype.blurTiddler = function(title)
{
	var tiddlerElem = document.getElementById(this.idPrefix + title);
	if(tiddlerElem != null && tiddlerElem.focus && tiddlerElem.blur) {
		tiddlerElem.focus();
		tiddlerElem.blur();
	}
};

Story.prototype.setTiddlerField = function(title,tag,mode,field)
{
	var c = story.getTiddlerField(title,field);

	var tags = c.value.readBracketedList();
	tags.setItem(tag,mode);
	c.value = String.encodeTiddlyLinkList(tags);
};

Story.prototype.setTiddlerTag = function(title,tag,mode)
{
	Story.prototype.setTiddlerField(title,tag,mode,"tags");
};

Story.prototype.closeTiddler = function(title,animate,unused)
{
	var tiddlerElem = document.getElementById(this.idPrefix + title);
	if(tiddlerElem != null) {
		clearMessage();
		this.scrubTiddler(tiddlerElem);
		if(config.options.chkAnimate && animate && anim && typeof Slider == "function")
			anim.startAnimating(new Slider(tiddlerElem,false,null,"all"));
		else {
			removeNode(tiddlerElem);
			forceReflow();
		}
	}
};

Story.prototype.scrubTiddler = function(tiddlerElem)
{
	tiddlerElem.id = null;
};

Story.prototype.setDirty = function(title,dirty)
{
	var tiddlerElem = document.getElementById(this.idPrefix + title);
	if(tiddlerElem != null)
		tiddlerElem.setAttribute("dirty",dirty ? "true" : "false");
};

Story.prototype.isDirty = function(title)
{
	var tiddlerElem = document.getElementById(this.idPrefix + title);
	if(tiddlerElem != null)
		return tiddlerElem.getAttribute("dirty") == "true";
	return null;
};

Story.prototype.areAnyDirty = function()
{
	var r = false;
	this.forEachTiddler(function(title,element) {
		if(this.isDirty(title))
			r = true;
	});
	return r;
};

Story.prototype.closeAllTiddlers = function(exclude)
{
	clearMessage();
	this.forEachTiddler(function(title,element) {
		if((title != exclude) && element.getAttribute("dirty") != "true")
			this.closeTiddler(title);
	});
	window.scrollTo(0,ensureVisible(this.container));
};

Story.prototype.isEmpty = function()
{
	var place = document.getElementById(this.container);
	return place && place.firstChild == null;
};

Story.prototype.search = function(text,useCaseSensitive,useRegExp)
{
	this.closeAllTiddlers();
	highlightHack = new RegExp(useRegExp ?	 text : text.escapeRegExp(),useCaseSensitive ? "mg" : "img");
	var matches = store.search(highlightHack,"title","excludeSearch");
	var titles = [];
	for(var t=0;t<matches.length;t++)
		titles.push(matches[t].title);
	this.displayTiddlers(null,titles);
	highlightHack = null;
	var q = useRegExp ? "/" : "'";
	if(matches.length > 0)
		displayMessage(config.macros.search.successMsg.format([titles.length.toString(),q + text + q]));
	else
		displayMessage(config.macros.search.failureMsg.format([q + text + q]));
};

Story.prototype.findContainingTiddler = function(e)
{
	while(e && !hasClass(e,"tiddler"))
		e = e.parentNode;
	return e;
};

Story.prototype.gatherSaveFields = function(e,fields)
{
	if(e && e.getAttribute) {
		var f = e.getAttribute("edit");
		if(f)
			fields[f] = e.value.replace(/\r/mg,"");
		if(e.hasChildNodes()) {
			var c = e.childNodes;
			for(var t=0; t<c.length; t++)
				this.gatherSaveFields(c[t],fields);
		}
	}
};

Story.prototype.hasChanges = function(title)
{
	var e = document.getElementById(this.idPrefix + title);
	if(e != null) {
		var fields = {};
		this.gatherSaveFields(e,fields);
		var tiddler = store.fetchTiddler(title);
		if(!tiddler)
			return false;
		for(var n in fields) {
			if(store.getValue(title,n) != fields[n])
				return true;
		}
	}
	return false;
};

Story.prototype.saveTiddler = function(title,minorUpdate)
{
	var tiddlerElem = document.getElementById(this.idPrefix + title);
	if(tiddlerElem != null) {
		var fields = {};
		this.gatherSaveFields(tiddlerElem,fields);
		var newTitle = fields.title ? fields.title : title;
		if(store.tiddlerExists(newTitle) && newTitle != title) {
			if(!confirm(config.messages.overwriteWarning.format([newTitle.toString()])))
				return null;
		}
		if(newTitle != title)
			this.closeTiddler(newTitle,false);
		tiddlerElem.id = this.idPrefix + newTitle;
		tiddlerElem.setAttribute("tiddler",newTitle);
		tiddlerElem.setAttribute("template",DEFAULT_VIEW_TEMPLATE);
		tiddlerElem.setAttribute("dirty","false");
		if(config.options.chkForceMinorUpdate)
			minorUpdate = !minorUpdate;
		if(!store.tiddlerExists(newTitle))
			minorUpdate = false;
		var newDate = new Date();
		var extendedFields = store.tiddlerExists(newTitle) ? store.fetchTiddler(newTitle).fields : {};
		for(var n in fields) {
			if(!TiddlyWiki.isStandardField(n))
				extendedFields[n] = fields[n];
			}
		var tiddler = store.saveTiddler(title,newTitle,fields.text,minorUpdate ? undefined : config.options.txtUserName,minorUpdate ? undefined : newDate,fields.tags,extendedFields);
		autoSaveChanges(null,[tiddler]);
		return newTitle;
	}
	return null;
};

Story.prototype.permaView = function()
{
	var links = [];
	this.forEachTiddler(function(title,element) {
		links.push(String.encodeTiddlyLink(title));
	});
	var t = encodeURIComponent(links.join(" "));
	if(t == "")
		t = "#";
	if(window.location.hash != t)
		window.location.hash = t;
};

//--
//-- Backstage
//--

var backstage = {
	area: null,
	toolbar: null,
	button: null,
	showButton: null,
	hideButton: null,
	cloak: null,
	panel: null,
	panelBody: null,
	panelFooter: null,
	currTabName: null,
	currTabElem: null,
	content: null,

	init: function() {
		var cmb = config.messages.backstage;
		this.area = document.getElementById("backstageArea");
		this.toolbar = document.getElementById("backstageToolbar");
		this.button = document.getElementById("backstageButton");
		this.button.style.display = "block";
		var t = cmb.open.text + " " + glyph("bentArrowLeft");
		this.showButton = createTiddlyButton(this.button,t,cmb.open.tooltip,
						function (e) {backstage.show(); return false;},null,"backstageShow");
		t = glyph("bentArrowRight") + " " + cmb.close.text;
		this.hideButton = createTiddlyButton(this.button,t,cmb.close.tooltip,
						function (e) {backstage.hide(); return false;},null,"backstageHide");
		this.cloak = document.getElementById("backstageCloak");
		this.panel = document.getElementById("backstagePanel");
		this.panelFooter = createTiddlyElement(this.panel,"div",null,"backstagePanelFooter");
		this.panelBody = createTiddlyElement(this.panel,"div",null,"backstagePanelBody");
		this.cloak.onmousedown = function(e) {
			backstage.switchTab(null);
		};
		createTiddlyText(this.toolbar,cmb.prompt);
		for(t=0; t<config.backstageTasks.length; t++) {
			var taskName = config.backstageTasks[t];
			var task = config.tasks[taskName];
			var handler = task.action ? this.onClickCommand : this.onClickTab;
			var text = task.text + (task.action ? "" : glyph("downTriangle"));
			var btn = createTiddlyButton(this.toolbar,text,task.tooltip,handler,"backstageTab");
			btn.setAttribute("task",taskName);
			addClass(btn,task.action ? "backstageAction" : "backstageTask");
			}
		this.content = document.getElementById("contentWrapper");
		if(config.options.chkBackstage)
			this.show();
		else
			this.hide();
	},
	
	isVisible: function () {
		return this.area ? this.area.style.display == "block" : false;
	},
	
	show: function() {
		this.area.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.toolbar.style.left = findWindowWidth() + "px";
			var p = [
				{style: "left", start: findWindowWidth(), end: 0, template: "%0px"}
			];
			anim.startAnimating(new Morpher(backstage.toolbar,config.animDuration,p));
		} else {
			backstage.area.style.left = "0px";
		}
		this.showButton.style.display = "none";
		this.hideButton.style.display = "block";
		config.options.chkBackstage = true;
		saveOptionCookie("chkBackstage");
		addClass(this.content,"backstageVisible");
	},

	hide: function() {
		if(this.currTabElem) {
			this.switchTab(null);
		} else {
			backstage.toolbar.style.left = "0px";
			if(anim && config.options.chkAnimate) {
				var p = [
					{style: "left", start: 0, end: findWindowWidth(), template: "%0px"}
				];
				var c = function(element,properties) {backstage.area.style.display = "none";};
				anim.startAnimating(new Morpher(backstage.toolbar,config.animDuration,p,c));
			} else {
				this.area.style.display = "none";
			}
			this.showButton.style.display = "block";
			this.hideButton.style.display = "none";
			config.options.chkBackstage = false;
			saveOptionCookie("chkBackstage");
			removeClass(this.content,"backstageVisible");
		}
	},

	onClickCommand: function(e) {
		var task = config.tasks[this.getAttribute("task")];
		displayMessage(task);
		if(task.action) {
			backstage.switchTab(null);
			task.action();
		}
		return false;
	},

	onClickTab: function(e) {
		backstage.switchTab(this.getAttribute("task"));
		return false;
	},

	// Switch to a given tab, or none if null is passed
	switchTab: function(tabName) {
		var tabElem = null;
		var e = this.toolbar.firstChild;
		while(e)
			{
			if(e.getAttribute && e.getAttribute("task") == tabName)
				tabElem = e;
			e = e.nextSibling;
			}
		if(tabName == backstage.currTabName)
			return;
		if(backstage.currTabElem) {
			removeClass(this.currTabElem,"backstageSelTab");
		}
		if(tabElem && tabName) {
			backstage.preparePanel();
			addClass(tabElem,"backstageSelTab");
			var task = config.tasks[tabName];
			wikify(task.content,backstage.panelBody,null,null);
			backstage.showPanel();
		} else if(backstage.currTabElem) {
			backstage.hidePanel();
		}
		backstage.currTabName = tabName;
		backstage.currTabElem = tabElem;
	},

	isPanelVisible: function() {
		return backstage.panel ? backstage.panel.style.display == "block" : false;
	},

	preparePanel: function() {
		backstage.cloak.style.height = findWindowHeight() + "px";
		backstage.cloak.style.display = "block";
		removeChildren(backstage.panelBody);
		return backstage.panelBody;
	},
	
	showPanel: function() {
		backstage.panel.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.panel.style.top = (-backstage.panel.offsetHeight) + "px";
			var p = [
				{style: "top", start: -backstage.panel.offsetHeight, end: 0, template: "%0px"}
			];
			anim.startAnimating(new Morpher(backstage.panel,config.animDuration,p),new Scroller(backstage.panel,false));
		} else {
			backstage.panel.style.top = "0px";
		}
		return backstage.panelBody;
	},
	
	hidePanel: function() {
		backstage.currTabName = null;
		backstage.currTabElem = null;
		if(anim && config.options.chkAnimate) {
			var p = [
				{style: "top", start: 0, end: -(backstage.panel.offsetHeight), template: "%0px"},
				{style: "display", atEnd: "none"}
			];
			var c = function(element,properties) {backstage.cloak.style.display = "none";};
			anim.startAnimating(new Morpher(backstage.panel,config.animDuration,p,c));
		 } else {
			backstage.panel.style.display = "none";
			backstage.cloak.style.display = "none";
		}
	}
};

config.macros.backstage = {};

config.macros.backstage.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var backstageTask = config.tasks[params[0]];
	if(backstageTask)
		createTiddlyButton(place,backstageTask.text,backstageTask.tooltip,function(e) {backstage.switchTab(params[0]); return false;});
};

//--
//-- ImportTiddlers macro
//--

config.macros.importTiddlers.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(readOnly) {
		createTiddlyElement(place,"div",null,"marked",this.readOnlyWarning);
		return;
	}
	var w = new Wizard();
	w.createWizard(place,this.wizardTitle);
	this.restart(w);
};

config.macros.importTiddlers.onCancel = function(e)
{
	var wizard = new Wizard(this);
	var place = wizard.clear();
	config.macros.importTiddlers.restart(wizard);
	return false;
};

config.macros.importTiddlers.restart = function(wizard)
{
	wizard.addStep(this.step1Title,this.step1Html);
	var s = wizard.getElement("selTypes");
	for(var t in config.adaptors) {
		var e = createTiddlyElement(s,"option",null,null,t);
		e.value = t;
	}
	s = wizard.getElement("selFeeds");
	var feeds = this.getFeeds();
	for(t in feeds) {
		e = createTiddlyElement(s,"option",null,null,t);
		e.value = t;
	}
	wizard.setValue("feeds",feeds);
	s.onchange = config.macros.importTiddlers.onFeedChange;
	var fileInput = wizard.getElement("txtBrowse");
	fileInput.onchange = config.macros.importTiddlers.onBrowseChange;
	fileInput.onkeyup = config.macros.importTiddlers.onBrowseChange;
	wizard.setButtons([{caption: this.openLabel, tooltip: this.openPrompt, onClick: config.macros.importTiddlers.onOpen}]);
};

config.macros.importTiddlers.getFeeds = function()
{
	var feeds = {};
	var tagged = store.getTaggedTiddlers("systemServer","title");
	for(var t=0; t<tagged.length; t++) {
		var title = tagged[t].title;
		var serverType = store.getTiddlerSlice(title,"Type");
		if(!serverType)
			serverType = "file";
		feeds[title] = {title: title,
						url: store.getTiddlerSlice(title,"URL"),
						workspace: store.getTiddlerSlice(title,"Workspace"),
						workspaceList: store.getTiddlerSlice(title,"WorkspaceList"),
						tiddlerFilter: store.getTiddlerSlice(title,"TiddlerFilter"),
						serverType: serverType,
						description: store.getTiddlerSlice(title,"Description")};
	}
	return feeds;
};

config.macros.importTiddlers.onFeedChange = function(e)
{
	var wizard = new Wizard(this);
	var selTypes = wizard.getElement("selTypes");
	var fileInput = wizard.getElement("txtPath");
	var feeds = wizard.getValue("feeds");
	var f = feeds[this.value];
	if(f) {
		selTypes.value = f.serverType;
		fileInput.value = f.url;
		this.selectedIndex = 0;
		wizard.setValue("feedName",f.serverType);
		wizard.setValue("feedHost",f.url);
		wizard.setValue("feedWorkspace",f.workspace);
		wizard.setValue("feedWorkspaceList",f.workspaceList);
		wizard.setValue("feedTiddlerFilter",f.tiddlerFilter);
	}
	return false;
};

config.macros.importTiddlers.onBrowseChange = function(e)
{
	var wizard = new Wizard(this);
	var fileInput = wizard.getElement("txtPath");
	fileInput.value = "file://" + this.value;
	var serverType = wizard.getElement("selTypes");
	serverType.value = "file";
	return false;
};

config.macros.importTiddlers.onOpen = function(e)
{
	var wizard = new Wizard(this);
	var fileInput = wizard.getElement("txtPath");
	var url = fileInput.value;
	var serverType = wizard.getElement("selTypes").value;
	var adaptor = new config.adaptors[serverType];
	wizard.setValue("adaptor",adaptor);
	wizard.setValue("serverType",serverType);
	wizard.setValue("host",url);
	var context = {};
	var ret = adaptor.openHost(url,context,wizard,config.macros.importTiddlers.onOpenHost);
	if(ret !== true)
		displayMessage(ret);
	wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusOpenHost);
	return false;
};

config.macros.importTiddlers.onOpenHost = function(context,wizard)
{
	var adaptor = wizard.getValue("adaptor");
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenHost: " + context.statusText);
	var ret = adaptor.getWorkspaceList(context,wizard,config.macros.importTiddlers.onGetWorkspaceList);
	if(ret !== true)
		displayMessage(ret);
	wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusGetWorkspaceList);
};

config.macros.importTiddlers.onGetWorkspaceList = function(context,wizard)
{
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onGetWorkspaceList: " + context.statusText);
	wizard.addStep(config.macros.importTiddlers.step2Title,config.macros.importTiddlers.step2Html);
	var s = wizard.getElement("selWorkspace");
	s.onchange = config.macros.importTiddlers.onWorkspaceChange;
	for(var t=0; t<context.workspaces.length; t++) {
		var e = createTiddlyElement(s,"option",null,null,context.workspaces[t].title);
		e.value = context.workspaces[t].title;
	}
	var workspaceList = wizard.getValue("feedWorkspaceList");
	if(workspaceList) {
		var list = workspaceList.parseParams("workspace",null,false,true);
		for(var n=1; n<list.length; n++) {
			if(context.workspaces.findByField("title",list[n].value) == null) {
				e = createTiddlyElement(s,"option",null,null,list[n].value);
				e.value = list[n].value;
			}
		}
	}
	var workspace = wizard.getValue("feedWorkspace");
	if(workspace) {
		t = wizard.getElement("txtWorkspace");
		t.value = workspace;
	}
	wizard.setButtons([{caption: config.macros.importTiddlers.openLabel, tooltip: config.macros.importTiddlers.openPrompt, onClick: config.macros.importTiddlers.onChooseWorkspace}]);
};

config.macros.importTiddlers.onWorkspaceChange = function(e)
{
	var wizard = new Wizard(this);
	var t = wizard.getElement("txtWorkspace");
	t.value  = this.value;
	this.selectedIndex = 0;
	return false;
};

config.macros.importTiddlers.onChooseWorkspace = function(e)
{
	var wizard = new Wizard(this);
	var adaptor = wizard.getValue("adaptor");
	var workspace = wizard.getElement("txtWorkspace").value;
	wizard.setValue("workspace",workspace);
	var context = {};
	var ret = adaptor.openWorkspace(workspace,context,wizard,config.macros.importTiddlers.onOpenWorkspace);
	if(ret !== true)
		displayMessage(ret);
	wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusOpenWorkspace);
	return false;
};

config.macros.importTiddlers.onOpenWorkspace = function(context,wizard)
{
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenWorkspace: " + context.statusText);
	var adaptor = wizard.getValue("adaptor");
	var ret = adaptor.getTiddlerList(context,wizard,config.macros.importTiddlers.onGetTiddlerList,wizard.getValue("feedTiddlerFilter"));
	if(ret !== true)
		displayMessage(ret);
	wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusGetTiddlerList);
};

config.macros.importTiddlers.onGetTiddlerList = function(context,wizard)
{
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onGetTiddlerList: " + context.statusText);
	// Extract data for the listview
	var listedTiddlers = [];
	if(context.tiddlers) {
		for(var n=0; n<context.tiddlers.length; n++) {
			var tiddler = context.tiddlers[n];
			listedTiddlers.push({
				title: tiddler.title,
				modified: tiddler.modified,
				modifier: tiddler.modifier,
				text: tiddler.text ? wikifyPlainText(tiddler.text,100) : "",
				tags: tiddler.tags,
				size: tiddler.text ? tiddler.text.length : 0,
				tiddler: tiddler
			});
		}
	}
	listedTiddlers.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1);});
	// Display the listview
	wizard.addStep(config.macros.importTiddlers.step3Title,config.macros.importTiddlers.step3Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	var listView = ListView.create(listWrapper,listedTiddlers,config.macros.importTiddlers.listViewTemplate);
	wizard.setValue("listView",listView);
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler");
	txtSaveTiddler.value = config.macros.importTiddlers.generateSystemServerName(wizard);
	wizard.setButtons([
			{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel},
			{caption: config.macros.importTiddlers.importLabel, tooltip: config.macros.importTiddlers.importPrompt, onClick:  config.macros.importTiddlers.doImport}
		]);
};

config.macros.importTiddlers.generateSystemServerName = function(wizard)
{
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var pattern = config.macros.importTiddlers[workspace ? "systemServerNamePattern" : "systemServerNamePatternNoWorkspace"];
	return pattern.format([serverType,host,workspace]);
};

config.macros.importTiddlers.saveServerTiddler = function(wizard)
{
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler").value;
	if(store.tiddlerExists(txtSaveTiddler)) {
		if(!confirm(config.macros.importTiddlers.confirmOverwriteSaveTiddler.format([txtSaveTiddler])))
			return;
		store.suspendNotifications();
		store.removeTiddler(txtSaveTiddler);
		store.resumeNotifications();
	}
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var text = config.macros.importTiddlers.serverSaveTemplate.format([serverType,host,workspace]);
	store.saveTiddler(txtSaveTiddler,txtSaveTiddler,text,config.macros.importTiddlers.serverSaveModifier,new Date(),["systemServer"]);
};

config.macros.importTiddlers.doImport = function(e)
{
	var wizard = new Wizard(this);
	if(wizard.getElement("chkSave").checked)
		config.macros.importTiddlers.saveServerTiddler(wizard);
	var chkSync = wizard.getElement("chkSync").checked;
	wizard.setValue("sync",chkSync);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	var adaptor = wizard.getValue("adaptor");
	var overwrite = new Array();
	var t;
	for(t=0; t<rowNames.length; t++) {
		if(store.tiddlerExists(rowNames[t]))
			overwrite.push(rowNames[t]);
	}
	if(overwrite.length > 0) {
		if(!confirm(config.macros.importTiddlers.confirmOverwriteText.format([overwrite.join(", ")])))
			return false;
	}
	wizard.addStep(config.macros.importTiddlers.step4Title.format([rowNames.length]),config.macros.importTiddlers.step4Html);
	for(t=0; t<rowNames.length; t++) {
		var link = document.createElement("div");
		createTiddlyLink(link,rowNames[t],true);
		var place = wizard.getElement("markReport");
		place.parentNode.insertBefore(link,place);
	}
	wizard.setValue("remainingImports",rowNames.length);
	wizard.setButtons([
			{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}
		],config.macros.importTiddlers.statusDoingImport);
	for(t=0; t<rowNames.length; t++) {
		var context = {};
		context.allowSynchronous = true;
		var inbound = adaptor.getTiddler(rowNames[t],context,wizard,config.macros.importTiddlers.onGetTiddler);
	}
	return false;
};

config.macros.importTiddlers.onGetTiddler = function(context,wizard)
{
	if(!context.status)
		displayMessage("Error in importTiddlers.onGetTiddler: " + context.statusText);
	var tiddler = context.tiddler;
	store.suspendNotifications();
	store.saveTiddler(tiddler.title, tiddler.title, tiddler.text, tiddler.modifier, tiddler.modified, tiddler.tags, tiddler.fields, true, tiddler.created);
	if(!wizard.getValue("sync")) {
		store.setValue(tiddler.title,'server',null);
	}
	store.resumeNotifications();
	if(!context.isSynchronous) 
		store.notify(tiddler.title,true);
	var remainingImports = wizard.getValue("remainingImports")-1;
	wizard.setValue("remainingImports",remainingImports);
	if(remainingImports == 0) {
		if(context.isSynchronous) {
			store.notifyAll();
			refreshDisplay();
		}
		wizard.setButtons([
				{caption: config.macros.importTiddlers.doneLabel, tooltip: config.macros.importTiddlers.donePrompt, onClick: config.macros.importTiddlers.onCancel}
			],config.macros.importTiddlers.statusDoneImport);
		autoSaveChanges();
	}
};

//--
//-- Sync macro
//--

// Synchronisation handlers
config.syncers = {};

// Sync state.
var currSync = null;

// sync macro
config.macros.sync.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(!wikifier.isStatic)
		this.startSync(place);
};

config.macros.sync.startSync = function(place)
{
	if(currSync)
		config.macros.sync.cancelSync();
	currSync = {};
	currSync.syncList = this.getSyncableTiddlers();
	this.createSyncTasks();
	this.preProcessSyncableTiddlers();
	var wizard = new Wizard();
	currSync.wizard = wizard;
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	currSync.listView = ListView.create(listWrapper,currSync.syncList,this.listViewTemplate);
	this.processSyncableTiddlers();
	wizard.setButtons([
			{caption: this.syncLabel, tooltip: this.syncPrompt, onClick: this.doSync}
		]);
};

config.macros.sync.getSyncableTiddlers = function ()
{
	var list = [];
	store.forEachTiddler(function(title,tiddler) {
		var syncItem = {};
		syncItem.serverType = tiddler.getServerType();
		syncItem.serverHost = tiddler.fields['server.host'];
		syncItem.serverWorkspace = tiddler.fields['server.workspace'];
		syncItem.tiddler = tiddler;
		syncItem.title = tiddler.title;
		syncItem.isTouched = tiddler.isTouched();
		syncItem.selected = syncItem.isTouched;
		syncItem.syncStatus = config.macros.sync.syncStatusList[syncItem.isTouched ? "changedLocally" : "none"];
		syncItem.status = syncItem.syncStatus.text;
		if(syncItem.serverType && syncItem.serverHost)
			list.push(syncItem);
		});
	list.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1);});
	return list;
};

config.macros.sync.preProcessSyncableTiddlers = function()
{
	for(var t=0; t<currSync.syncList.length; t++) {
		si = currSync.syncList[t];
		var ti = si.syncTask.syncMachine.generateTiddlerInfo(si.tiddler);
		si.serverUrl = ti.uri;
	}
};

config.macros.sync.processSyncableTiddlers = function()
{
	for(var t=0; t<currSync.syncList.length; t++) {
		si = currSync.syncList[t];
		si.rowElement.style.backgroundColor = si.syncStatus.color;
	}
};

config.macros.sync.createSyncTasks = function()
{
	currSync.syncTasks = [];
	for(var t=0; t<currSync.syncList.length; t++) {
		var si = currSync.syncList[t];
		var r = null;
		for(var st=0; st<currSync.syncTasks.length; st++) {
			var cst = currSync.syncTasks[st];
			if(si.serverType == cst.serverType && si.serverHost == cst.serverHost && si.serverWorkspace == cst.serverWorkspace)
				r = cst;
		}
		if(r == null) {
			si.syncTask = this.createSyncTask(si);
			currSync.syncTasks.push(si.syncTask);
		} else {
			si.syncTask = r;
			r.syncItems.push(si);
		}
	}
};

config.macros.sync.createSyncTask = function(syncItem)
{
	var st = {};
	st.serverType = syncItem.serverType;
	st.serverHost = syncItem.serverHost;
	st.serverWorkspace = syncItem.serverWorkspace;
	st.syncItems = [syncItem];
	st.syncMachine = new SyncMachine(st.serverType,{
		start: function() {
			return this.openHost(st.serverHost,"openWorkspace");
		},
		openWorkspace: function() {
			return this.openWorkspace(st.serverWorkspace,"getTiddlerList");
		},
		getTiddlerList: function() {
			return this.getTiddlerList("gotTiddlerList");
		},
		gotTiddlerList: function(tiddlers) {
			for(var t=0; t<st.syncItems.length; t++) {
				var si = st.syncItems[t];
				var f = tiddlers.findByField("title",si.title);
				if(f !== null) {
					if(tiddlers[f].fields['server.page.revision'] > si.tiddler.fields['server.page.revision']) {
						si.syncStatus = config.macros.sync.syncStatusList[si.isTouched ? 'changedBoth' : 'changedServer'];
					}
				} else {
					si.syncStatus = config.macros.sync.syncStatusList.notFound;
				}
				config.macros.sync.updateSyncStatus(si);
			}
		},
		getTiddler: function(title) {
			return this.getTiddler(title,"onGetTiddler");
		},
		onGetTiddler: function(tiddler) {
			var syncItem = st.syncItems.findByField("title",tiddler.title);
			if(syncItem !== null) {
				syncItem = st.syncItems[syncItem];
				store.saveTiddler(tiddler.title, tiddler.title, tiddler.text, tiddler.modifier, tiddler.modified, tiddler.tags, tiddler.fields, true, tiddler.created);
				syncItem.syncStatus = config.macros.sync.syncStatusList.gotFromServer;
				config.macros.sync.updateSyncStatus(syncItem);
			}
		},
		putTiddler: function(tiddler) {
			return this.putTiddler(tiddler,"onPutTiddler");
		},
		onPutTiddler: function(tiddler) {
			var syncItem = st.syncItems.findByField("title",tiddler.title);
			if(syncItem !== null) {
				syncItem = st.syncItems[syncItem];
				store.resetTiddler(tiddler.title);
				syncItem.syncStatus = config.macros.sync.syncStatusList.putToServer;
				config.macros.sync.updateSyncStatus(syncItem);
			}
		}
	});
	st.syncMachine.go();
	return st;
};

config.macros.sync.updateSyncStatus = function(syncItem)
{
	var e = syncItem.colElements["status"];
	removeChildren(e);
	createTiddlyText(e,syncItem.syncStatus.text);
	syncItem.rowElement.style.backgroundColor = syncItem.syncStatus.color;
};

config.macros.sync.doSync = function(e)
{
	var rowNames = ListView.getSelectedRows(currSync.listView);
	for(var t=0; t<currSync.syncList.length; t++) {
		var si = currSync.syncList[t];
		if(rowNames.indexOf(si.title) != -1) {
			config.macros.sync.doSyncItem(si);
		}
	}
	return false;
};

config.macros.sync.doSyncItem = function(syncItem)
{
	var r = true;
	var sl = config.macros.sync.syncStatusList;
	switch(syncItem.syncStatus) {
		case sl.changedServer:
			r = syncItem.syncTask.syncMachine.go("getTiddler",syncItem.title);
			break;
		case sl.notFound:
		case sl.changedLocally:
		case sl.changedBoth:
			r = syncItem.syncTask.syncMachine.go("putTiddler",syncItem.tiddler);
			break;
		default:
			break;
	}
	if(r !== true)
		displayMessage("Error in doSyncItem: " + r);
};

config.macros.sync.cancelSync = function()
{
	currSync = null;
};

function SyncMachine(serverType,steps)
{
	this.serverType = serverType;
	this.adaptor = new config.adaptors[serverType];
	this.steps = steps;
}

SyncMachine.prototype.go = function(step,varargs)
{
	if(!step)
		step = "start";
	var h = this.steps[step];
	if(!h)
		return null;
	var a = [];
	for(var t=1; t<arguments.length; t++)
		a.push(arguments[t]);
	var r = h.apply(this,a);
	if(typeof r == "string")
		this.invokeError(r);
	return r;
};

SyncMachine.prototype.invokeError = function(message)
{
	if(this.steps.error)
		this.steps.error(message);
};

SyncMachine.prototype.openHost = function(host,nextStep)
{
	var me = this;
	return me.adaptor.openHost(host,null,null,function(context) {
		if(typeof context.status == "string")
			me.invokeError(context.status);
		else
			me.go(nextStep);
	});
};

SyncMachine.prototype.getWorkspaceList = function(nextStep)
{
	var me = this;
	return me.adaptor.getWorkspaceList(null,null,function(context) {
		if(typeof context.status == "string")
			me.invokeError(context.status);
		else
			me.go(nextStep,context.workspaces);
	});
};

SyncMachine.prototype.openWorkspace = function(workspace,nextStep)
{
	var me = this;
	return me.adaptor.openWorkspace(workspace,null,null,function(context) {
		if(typeof context.status == "string")
			me.invokeError(context.status);
		else
			me.go(nextStep);
	});
};

SyncMachine.prototype.getTiddlerList = function(nextStep)
{
	var me = this;
	return me.adaptor.getTiddlerList(null,null,function(context) {
		if(typeof context.status == "string")
			me.invokeError(context.status);
		else
			me.go(nextStep,context.tiddlers);
	});
};

SyncMachine.prototype.generateTiddlerInfo = function(tiddler)
{
	return this.adaptor.generateTiddlerInfo(tiddler);
};

SyncMachine.prototype.getTiddler = function(title,nextStep)
{
	var me = this;
	return me.adaptor.getTiddler(title,null,null,function(context) {
		if(typeof context.status == "string")
			me.invokeError(context.status);
		else
			me.go(nextStep,context.tiddler);
	});
};

SyncMachine.prototype.putTiddler = function(tiddler,nextStep)
{
	var me = this;
	return me.adaptor.putTiddler(tiddler,null,null,function(context) {
		if(typeof context.status == "string")
			me.invokeError(context.status);
		else
			me.go(nextStep,tiddler);
	});
};

//--
//-- Manager UI for groups of tiddlers
//--

config.macros.plugins.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var wizard = new Wizard();
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	listWrapper.setAttribute("refresh","macro");
	listWrapper.setAttribute("macroName","plugins");
	listWrapper.setAttribute("params",paramString);
	this.refresh(listWrapper,paramString);
};

config.macros.plugins.refresh = function(listWrapper,params)
{
	var wizard = new Wizard(listWrapper);
	var selectedRows = [];
	ListView.forEachSelector(listWrapper,function(e,rowName) {
			if(e.checked)
				selectedRows.push(e.getAttribute("rowName"));
		});
	removeChildren(listWrapper);
	params = params.parseParams("anon");
	var plugins = installedPlugins.slice(0);
	var t,tiddler,p;
	var configTiddlers = store.getTaggedTiddlers("systemConfig");
	for(t=0; t<configTiddlers.length; t++) {
		tiddler = configTiddlers[t];
		if(plugins.findByField("title",tiddler.title) == null) {
			p = getPluginInfo(tiddler);
			p.executed = false;
			p.log.splice(0,0,this.skippedText);
			plugins.push(p);
		}
	}
	for(t=0; t<plugins.length; t++) {
		p = plugins[t];
		p.size = p.tiddler.text ? p.tiddler.text.length : 0;
		p.forced = p.tiddler.isTagged("systemConfigForce");
		p.disabled = p.tiddler.isTagged("systemConfigDisable");
		p.Selected = selectedRows.indexOf(plugins[t].title) != -1;
	}
	if(plugins.length == 0) {
		createTiddlyElement(listWrapper,"em",null,null,this.noPluginText);
		wizard.setButtons([]);
	} else {
		var listView = ListView.create(listWrapper,plugins,this.listViewTemplate,this.onSelectCommand);
		wizard.setValue("listView",listView);
		wizard.setButtons([
				{caption: config.macros.plugins.removeLabel, tooltip: config.macros.plugins.removePrompt, onClick:  config.macros.plugins.doRemoveTag},
				{caption: config.macros.plugins.deleteLabel, tooltip: config.macros.plugins.deletePrompt, onClick:  config.macros.plugins.doDelete}
			]);
	}
};

config.macros.plugins.doRemoveTag = function(e)
{
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		for(var t=0; t<rowNames.length; t++)
			store.setTiddlerTag(rowNames[t],false,"systemConfig");
	}
};

config.macros.plugins.doDelete = function(e)
{
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		if(confirm(config.macros.plugins.confirmDeleteText.format([rowNames.join(", ")]))) {
			for(t=0; t<rowNames.length; t++) {
				store.removeTiddler(rowNames[t]);
				story.closeTiddler(rowNames[t],true);
			}
		}
	}
};

//--
//-- Message area
//--

function getMessageDiv()
{
	var msgArea = document.getElementById("messageArea");
	if(!msgArea)
		return null;
	if(!msgArea.hasChildNodes())
		createTiddlyButton(createTiddlyElement(msgArea,"div",null,"messageToolbar"),
			config.messages.messageClose.text,
			config.messages.messageClose.tooltip,
			clearMessage);
	msgArea.style.display = "block";
	return createTiddlyElement(msgArea,"div");
}

function displayMessage(text,linkText)
{
	var e = getMessageDiv();
	if(!e) {
		alert(text);
		return;
	}
	if(linkText) {
		var link = createTiddlyElement(e,"a",null,null,text);
		link.href = linkText;
		link.target = "_blank";
	} else {
		e.appendChild(document.createTextNode(text));
	}
}

function clearMessage()
{
	var msgArea = document.getElementById("messageArea");
	if(msgArea) {
		removeChildren(msgArea);
		msgArea.style.display = "none";
	}
	return false;
}

//--
//-- Refresh mechanism
//--

config.refreshers = {
	link: function(e,changeList)
		{
		var title = e.getAttribute("tiddlyLink");
		refreshTiddlyLink(e,title);
		return true;
		},
	
	tiddler: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var template = e.getAttribute("template");
		if(changeList && changeList.indexOf(title) != -1 && !story.isDirty(title))
			story.refreshTiddler(title,template,true);
		else
			refreshElements(e,changeList);
		return true;
		},

	content: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var force = e.getAttribute("force");
		if(force != null || changeList == null || changeList.indexOf(title) != -1) {
			removeChildren(e);
			wikify(store.getTiddlerText(title,title),e,null);
			return true;
		} else
			return false;
		},

	macro: function(e,changeList)
		{
		var macro = e.getAttribute("macroName");
		var params = e.getAttribute("params");
		if(macro)
			macro = config.macros[macro];
		if(macro && macro.refresh)
			macro.refresh(e,params);
		return true;
		}
};

function refreshElements(root,changeList)
{
	var nodes = root.childNodes;
	for(var c=0; c<nodes.length; c++) {
		var e = nodes[c], type = null;
		if(e.getAttribute  && (e.tagName ? e.tagName != "IFRAME" : true))
			type = e.getAttribute("refresh");
		var refresher = config.refreshers[type];
		var refreshed = false;
		if(refresher != undefined)
			refreshed = refresher(e,changeList);
		if(e.hasChildNodes() && !refreshed)
			refreshElements(e,changeList);
	}
}

function applyHtmlMacros(root,tiddler)
{
	var e = root.firstChild;
	while(e) {
		var nextChild = e.nextSibling;
		if(e.getAttribute) {
			var macro = e.getAttribute("macro");
			if(macro) {
				var params = "";
				var p = macro.indexOf(" ");
				if(p != -1) {
					params = macro.substr(p+1);
					macro = macro.substr(0,p);
				}
				invokeMacro(e,macro,params,null,tiddler);
			}
		}
		if(e.hasChildNodes())
			applyHtmlMacros(e,tiddler);
		e = nextChild;
	}
}

function refreshPageTemplate(title)
{
	var stash = createTiddlyElement(document.body,"div");
	stash.style.display = "none";
	var display = document.getElementById("tiddlerDisplay");
	var nodes,t;
	if(display) {
		nodes = display.childNodes;
		for(t=nodes.length-1; t>=0; t--)
			stash.appendChild(nodes[t]);
	}
	var wrapper = document.getElementById("contentWrapper");
	if(!title)
		title = "PageTemplate";
	var html = store.getRecursiveTiddlerText(title,null,10);
	wrapper.innerHTML = html;
	applyHtmlMacros(wrapper);
	refreshElements(wrapper);
	display = document.getElementById("tiddlerDisplay");
	removeChildren(display);
	if(!display)
		display = createTiddlyElement(wrapper,"div","tiddlerDisplay");
	nodes = stash.childNodes;
	for(t=nodes.length-1; t>=0; t--)
		display.appendChild(nodes[t]);
	removeNode(stash);
}

function refreshDisplay(hint)
{
	if(typeof hint == "string")
		hint = [hint];
	var e = document.getElementById("contentWrapper");
	refreshElements(e,hint);
	if(backstage.isPanelVisible()) {
		e = document.getElementById("backstage");
		refreshElements(e,hint);
	}
}

function refreshPageTitle()
{
	document.title = getPageTitle();
}

function getPageTitle()
{
	var st = wikifyPlain("SiteTitle");
	var ss = wikifyPlain("SiteSubtitle");
	return st + ((st == "" || ss == "") ? "" : " - ") + ss;
}

function refreshStyles(title,doc)
{
	if(!doc)
		doc = document;
	setStylesheet(title == null ? "" : store.getRecursiveTiddlerText(title,"",10),title,doc);
}

function refreshColorPalette(title)
{
	if(!startingUp)
		refreshAll();
}

function refreshAll()
{
	refreshPageTemplate();
	refreshDisplay();
	refreshStyles("StyleSheetLayout");
	refreshStyles("StyleSheetColors");
	refreshStyles("StyleSheet");
	refreshStyles("StyleSheetPrint");
}

//--
//-- Options cookie stuff
//--

config.optionHandlers = {
	'txt': {
		get: function(name) {return encodeCookie(config.options[name].toString());},
		set: function(name,value) {config.options[name] = decodeCookie(value);}
	},
	'chk': {
		get: function(name) {return config.options[name] ? "true" : "false";},
		set: function(name,value) {config.options[name] = value == "true";}
	}
};

function loadOptionsCookie()
{
	if(safeMode)
		return;
	var cookies = document.cookie.split(";");
	for(var c=0; c<cookies.length; c++) {
		var p = cookies[c].indexOf("=");
		if(p != -1) {
			var name = cookies[c].substr(0,p).trim();
			var value = cookies[c].substr(p+1).trim();
			var optType = name.substr(0,3);
			if(config.optionHandlers[optType] && config.optionHandlers[optType].set)
				config.optionHandlers[optType].set(name,value);
		}
	}
}

function saveOptionCookie(name)
{
	if(safeMode)
		return;
	var c = name + "=";
	var optType = name.substr(0,3);
	if(config.optionHandlers[optType] && config.optionHandlers[optType].get)
		c += config.optionHandlers[optType].get(name);
	c += "; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/";
	document.cookie = c;
}

function encodeCookie(s)
{
	return escape(manualConvertUnicodeToUTF8(s));
}

function decodeCookie(s)
{
	s = unescape(s);
	var re = /&#[0-9]{1,5};/g;
	return s.replace(re,function($0) {return String.fromCharCode(eval($0.replace(/[&#;]/g,"")));});
}

//--
//-- Saving
//--

var saveUsingSafari = false;

var startSaveArea = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
var endSaveArea = '</d' + 'iv>';

// If there are unsaved changes, force the user to confirm before exitting
function confirmExit()
{
	hadConfirmExit = true;
	if((store && store.isDirty && store.isDirty()) || (story && story.areAnyDirty && story.areAnyDirty()))
		return config.messages.confirmExit;
}

// Give the user a chance to save changes before exitting
function checkUnsavedChanges()
{
	if(store && store.isDirty && store.isDirty() && window.hadConfirmExit === false) {
		if(confirm(config.messages.unsavedChangesWarning))
			saveChanges();
	}
}

function updateLanguageAttribute(s)
{
	if(config.locale) {
		var mRE = /(<html(?:.*?)?)(?: xml:lang\="([a-z]+)")?(?: lang\="([a-z]+)")?>/;
		var m = mRE.exec(s);
		if(m) {
			var t = m[1];
			if(m[2])
				t += ' xml:lang="' + config.locale + '"';
			if(m[3])
				t += ' lang="' + config.locale + '"';
			t += ">";
			s = s.substr(0,m.index) + t + s.substr(m.index+m[0].length);
		}
	}
	return s;
}

function updateMarkupBlock(s,blockName,tiddlerName)
{
	return s.replaceChunk(
			"<!--%0-START-->".format([blockName]),
			"<!--%0-END-->".format([blockName]),
			"\n" + store.getRecursiveTiddlerText(tiddlerName,"") + "\n");
}

function updateOriginal(original,posDiv)
{
	if(!posDiv)
		posDiv = locateStoreArea(original);
	if(!posDiv) {
		alert(config.messages.invalidFileError.format([localPath]));
		return null;
	}
	var revised = original.substr(0,posDiv[0] + startSaveArea.length) + "\n" +
				convertUnicodeToUTF8(store.allTiddlersAsHtml()) + "\n" +
				original.substr(posDiv[1]);
	var newSiteTitle = convertUnicodeToUTF8(getPageTitle()).htmlEncode();
	revised = revised.replaceChunk("<title"+">","</title"+">"," " + newSiteTitle + " ");
	revised = updateLanguageAttribute(revised);
	revised = updateMarkupBlock(revised,"PRE-HEAD","MarkupPreHead");
	revised = updateMarkupBlock(revised,"POST-HEAD","MarkupPostHead");
	revised = updateMarkupBlock(revised,"PRE-BODY","MarkupPreBody");
	revised = updateMarkupBlock(revised,"POST-SCRIPT","MarkupPostBody");
	return revised;
}

function locateStoreArea(original)
{
	// Locate the storeArea div's
	var posOpeningDiv = original.indexOf(startSaveArea);
	var limitClosingDiv = original.indexOf("<"+"!--POST-STOREAREA--"+">");
	if(limitClosingDiv == -1)
		limitClosingDiv = original.indexOf("<"+"!--POST-BODY-START--"+">");
	var posClosingDiv = original.lastIndexOf(endSaveArea,limitClosingDiv == -1 ? original.length : limitClosingDiv);
	return (posOpeningDiv != -1 && posClosingDiv != -1) ? [posOpeningDiv,posClosingDiv] : null;
}

function autoSaveChanges(onlyIfDirty,tiddlers)
{
	if(config.options.chkAutoSave)
		saveChanges(onlyIfDirty,tiddlers);
}

// Save this tiddlywiki with the pending changes
function saveChanges(onlyIfDirty,tiddlers)
{
	if(onlyIfDirty && !store.isDirty())
		return;
	clearMessage();
	// Get the URL of the document
	var originalPath = document.location.toString();
	// Check we were loaded from a file URL
	if(originalPath.substr(0,5) != "file:") {
		alert(config.messages.notFileUrlError);
		if(store.tiddlerExists(config.messages.saveInstructions))
			story.displayTiddler(null,config.messages.saveInstructions);
		return;
	}
	var localPath = getLocalPath(originalPath);
	// Load the original file
	var original = loadFile(localPath);
	if(original == null) {
		alert(config.messages.cantSaveError);
		if(store.tiddlerExists(config.messages.saveInstructions))
			story.displayTiddler(null,config.messages.saveInstructions);
		return;
	}
	// Locate the storeArea div's
	var posDiv = locateStoreArea(original);
	if(!posDiv) {
		alert(config.messages.invalidFileError.format([localPath]));
		return;
	}
	saveBackup(localPath,original);
	saveRss(localPath);
	saveEmpty(localPath,original,posDiv);
	saveMain(localPath,original,posDiv);
}

function saveBackup(localPath,original)
{
	// Save the backup
	if(config.options.chkSaveBackups) {
		var backupPath = getBackupPath(localPath);
		var backup = config.browser.isIE ? ieCopyFile(backupPath,localPath) : saveFile(backupPath,original);
		if(backup)
			displayMessage(config.messages.backupSaved,"file://" + backupPath);
		else
			alert(config.messages.backupFailed);
	}
}

function saveRss(localPath)
{
	if(config.options.chkGenerateAnRssFeed) {
		var rssPath = localPath.substr(0,localPath.lastIndexOf(".")) + ".xml";
		var rssSave = saveFile(rssPath,convertUnicodeToUTF8(generateRss()));
		if(rssSave)
			displayMessage(config.messages.rssSaved,"file://" + rssPath);
		else
			alert(config.messages.rssFailed);
	}
}

function saveEmpty(localPath,original,posDiv)
{
	if(config.options.chkSaveEmptyTemplate) {
		var emptyPath,p;
		if((p = localPath.lastIndexOf("/")) != -1)
			emptyPath = localPath.substr(0,p) + "/empty.html";
		else if((p = localPath.lastIndexOf("\\")) != -1)
			emptyPath = localPath.substr(0,p) + "\\empty.html";
		else
			emptyPath = localPath + ".empty.html";
		var empty = original.substr(0,posDiv[0] + startSaveArea.length) + original.substr(posDiv[1]);
		var emptySave = saveFile(emptyPath,empty);
		if(emptySave)
			displayMessage(config.messages.emptySaved,"file://" + emptyPath);
		else
			alert(config.messages.emptyFailed);
	}
}

function saveMain(localPath,original,posDiv)
{
	var save;
	try {
		var revised = updateOriginal(original,posDiv);
		save = saveFile(localPath,revised);
	} catch (ex) {
		showException(ex);
	}
	if(save) {
		displayMessage(config.messages.mainSaved,"file://" + localPath);
		store.setDirty(false);
	} else {
		alert(config.messages.mainFailed);
	}
}

function getLocalPath(origPath)
{
	var originalPath = convertUriToUTF8(origPath,config.options.txtFileSystemCharSet);
	// Remove any location or query part of the URL
	var argPos = originalPath.indexOf("?");
	if(argPos != -1)
		originalPath = originalPath.substr(0,argPos);
	var hashPos = originalPath.indexOf("#");
	if(hashPos != -1)
		originalPath = originalPath.substr(0,hashPos);
	// Convert file://localhost/ to file:///
	if(originalPath.indexOf("file://localhost/") == 0)
		originalPath = "file://" + originalPath.substr(16);
	// Convert to a native file format
	var localPath;
	if(originalPath.charAt(9) == ":") // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file://///") == 0) // FireFox pc network file
		localPath = "\\\\" + unescape(originalPath.substr(10)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file:///") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf("file:/") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = "\\\\" + unescape(originalPath.substr(7)).replace(new RegExp("/","g"),"\\");
	return localPath;
}

function getBackupPath(localPath)
{
	var backSlash = true;
	var dirPathPos = localPath.lastIndexOf("\\");
	if(dirPathPos == -1) {
		dirPathPos = localPath.lastIndexOf("/");
		backSlash = false;
	}
	var backupFolder = config.options.txtBackupFolder;
	if(!backupFolder || backupFolder == "")
		backupFolder = ".";
	var backupPath = localPath.substr(0,dirPathPos) + (backSlash ? "\\" : "/") + backupFolder + localPath.substr(dirPathPos);
	backupPath = backupPath.substr(0,backupPath.lastIndexOf(".")) + "." + (new Date()).convertToYYYYMMDDHHMMSSMMM() + ".html";
	return backupPath;
}

function generateRss()
{
	var s = [];
	var d = new Date();
	var u = store.getTiddlerText("SiteUrl");
	// Assemble the header
	s.push("<" + "?xml version=\"1.0\"?" + ">");
	s.push("<rss version=\"2.0\">");
	s.push("<channel>");
	s.push("<title" + ">" + wikifyPlain("SiteTitle").htmlEncode() + "</title" + ">");
	if(u)
		s.push("<link>" + u.htmlEncode() + "</link>");
	s.push("<description>" + wikifyPlain("SiteSubtitle").htmlEncode() + "</description>");
	s.push("<language>en-us</language>");
	s.push("<copyright>Copyright " + d.getFullYear() + " " + config.options.txtUserName.htmlEncode() + "</copyright>");
	s.push("<pubDate>" + d.toGMTString() + "</pubDate>");
	s.push("<lastBuildDate>" + d.toGMTString() + "</lastBuildDate>");
	s.push("<docs>http://blogs.law.harvard.edu/tech/rss</docs>");
	s.push("<generator>TiddlyWiki " + version.major + "." + version.minor + "." + version.revision + "</generator>");
	// The body
	var tiddlers = store.getTiddlers("modified","excludeLists");
	var n = config.numRssItems > tiddlers.length ? 0 : tiddlers.length-config.numRssItems;
	for (var t=tiddlers.length-1; t>=n; t--)
		s.push(tiddlers[t].saveToRss(u));
	// And footer
	s.push("</channel>");
	s.push("</rss>");
	// Save it all
	return s.join("\n");
}

//--
//-- Filesystem code
//--

function convertUTF8ToUnicode(u)
{
	if(window.netscape == undefined)
		return manualConvertUTF8ToUnicode(u);
	else
		return mozConvertUTF8ToUnicode(u);
}

function manualConvertUTF8ToUnicode(utf)
{
	var uni = utf;
	var src = 0;
	var dst = 0;
	var b1, b2, b3;
	var c;
	while(src < utf.length) {
		b1 = utf.charCodeAt(src++);
		if(b1 < 0x80) {
			dst++;
		} else if(b1 < 0xE0) {
			b2 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
		} else {
			b2 = utf.charCodeAt(src++);
			b3 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
		}
	}
	return uni;
}

function mozConvertUTF8ToUnicode(u)
{
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUTF8ToUnicode(u);
	} // fallback
	var s = converter.ConvertToUnicode(u);
	var fin = converter.Finish();
	return (fin.length > 0) ? s+fin : s;
}

function convertUnicodeToUTF8(s)
{
	if(window.netscape == undefined)
		return manualConvertUnicodeToUTF8(s);
	else
		return mozConvertUnicodeToUTF8(s);
}

function manualConvertUnicodeToUTF8(s)
{
	var re = /[^\u0000-\u007F]/g ;
	return s.replace(re,function($0) {return "&#" + $0.charCodeAt(0).toString() + ";";});
}

function mozConvertUnicodeToUTF8(s)
{
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUnicodeToUTF8(s);
	} // fallback
	var u = converter.ConvertFromUnicode(s);
	var fin = converter.Finish();
	if(fin.length > 0)
		return u + fin;
	else
		return u;
}

function convertUriToUTF8(uri,charSet)
{
	if(window.netscape == undefined || charSet == undefined || charSet == "")
		return uri;
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/utf8converterservice;1"].getService(Components.interfaces.nsIUTF8ConverterService);
	} catch(ex) {
		return uri;
	}
	return converter.convertURISpecToUTF8(uri,charSet);
}

function saveFile(fileUrl,content)
{
	var r = null;
	if(!r)
		r = mozillaSaveFile(fileUrl,content);
	if(!r)
		r = ieSaveFile(fileUrl,content);
	if(!r)
		r = javaSaveFile(fileUrl,content);
	return r;
}

function loadFile(fileUrl)
{
	var r = null;
	if((r == null) || (r == false))
		r = mozillaLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = ieLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = javaLoadFile(fileUrl);
	return r;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function ieSaveFile(filePath,content)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}
	var file = fso.OpenTextFile(filePath,2,-1,0);
	file.Write(content);
	file.Close();
	return true;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function ieLoadFile(filePath)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		var file = fso.OpenTextFile(filePath,1);
		var content = file.ReadAll();
		file.Close();
	} catch(ex) {
		return null;
	}
	return content;
}

function ieCopyFile(dest,source)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		fso.GetFile(source).Copy(dest);
	} catch(ex) {
		return false;
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function mozillaSaveFile(filePath,content)
{
	if(window.Components) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if(!file.exists())
				file.create(0,0664);
			var out = Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);
			out.init(file,0x20|0x02,00004,null);
			out.write(content,content.length);
			out.flush();
			out.close();
			return true;
		} catch(ex) {
			return false;
		}
	}
	return null;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function mozillaLoadFile(filePath)
{
	if(window.Components) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if(!file.exists())
				return null;
			var inputStream = Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);
			inputStream.init(file,0x01,00004,null);
			var sInputStream = Components.classes["@mozilla.org/scriptableinputstream;1"].createInstance(Components.interfaces.nsIScriptableInputStream);
			sInputStream.init(inputStream);
			return sInputStream.read(sInputStream.available());
		} catch(ex) {
			return false;
		}
	}
	return null;
}

function javaUrlToFilename(url)
{
	var f = "//localhost";
	if(url.indexOf(f) == 0)
		return url.substring(f.length);
	var i = url.indexOf(":");
	if(i > 0)
		return url.substring(i-1);
	return url;
}

function javaSaveFile(filePath,content)
{
	try {
		if(document.applets["TiddlySaver"])
			return document.applets["TiddlySaver"].saveFile(javaUrlToFilename(filePath),"UTF-8",content);
	} catch(ex) {
	}
	try {
		var s = new java.io.PrintStream(new java.io.FileOutputStream(javaUrlToFilename(filePath)));
		s.print(content);
		s.close();
	} catch(ex) {
		return null;
	}
	return true;
}

function javaLoadFile(filePath)
{
	try {
		if(document.applets["TiddlySaver"])
			return String(document.applets["TiddlySaver"].loadFile(javaUrlToFilename(filePath),"UTF-8"));
	} catch(ex) {
	}
	var content = [];
	try {
		var r = new java.io.BufferedReader(new java.io.FileReader(javaUrlToFilename(filePath)));
		var line;
		while((line = r.readLine()) != null)
			content.push(new String(line));
		r.close();
	} catch(ex) {
		return null;
	}
	return content.join("\n");
}

//--
//-- Server adaptor for talking to static files
//--

function FileAdaptor()
{
	this.host = null;
	this.store = null;
	return this;
}

FileAdaptor.NotLoadedError = "TiddlyWiki file has not been loaded";
FileAdaptor.serverType = 'file';

// Open the specified host/server
FileAdaptor.prototype.openHost = function(host,context,userParams,callback)
{
	this.host = host;
	if(!context)
		context = {};
	context.adaptor = this;
	context.callback = callback;
	context.userParams = userParams;
	var ret = loadRemoteFile(host,FileAdaptor.openHostCallback,context);
	return typeof(ret) == "string" ? ret : true;
};

FileAdaptor.openHostCallback = function(status,context,responseText,url,xhr)
{
	var adaptor = context.adaptor;
	context.status = status;
	if(!status) {
		context.statusText = "Error reading file: " + xhr.statusText;
	} else {
		// Load the content into a TiddlyWiki() object
		adaptor.store = new TiddlyWiki();
		if(!adaptor.store.importTiddlyWiki(responseText))
			context.statusText = config.messages.invalidFileError.format([url]);
	}
	context.callback(context,context.userParams);
};

// Gets the list of workspaces on a given server
FileAdaptor.prototype.getWorkspaceList = function(context,userParams,callback)
{
	if(!context)
		context = {};
	context.workspaces = [{title:"(default)"}];
	context.status = true;
	window.setTimeout(function() {callback(context,userParams);},10);
	return true;
};

// Open the specified workspace
FileAdaptor.prototype.openWorkspace = function(workspace,context,userParams,callback)
{
	if(!context)
		context = {};
	context.status = true;
	window.setTimeout(function() {callback(context,userParams);},10);
	return true;
};

// Gets the list of tiddlers within a given workspace
FileAdaptor.prototype.getTiddlerList = function(context,userParams,callback)
{
	if(!this.store)
		return FileAdaptor.NotLoadedError;
	if(!context)
		context = {};
	context.tiddlers = [];
	this.store.forEachTiddler(function(title,tiddler)
		{
		var t = new Tiddler(title);
		t.text = tiddler.text;
		t.modified = tiddler.modified;
		t.modifier = tiddler.modifier;
		t.fields['server.page.revision'] = tiddler.modified.convertToYYYYMMDDHHMM();
		t.tags = tiddler.tags;
		context.tiddlers.push(t);
		});
	context.status = true;
	window.setTimeout(function() {callback(context,userParams);},10);
	return true;
};

FileAdaptor.prototype.generateTiddlerInfo = function(tiddler)
{
	var info = {};
	info.uri = tiddler.fields['server.host'] + "#" + tiddler.title;
	return info;
};

// Retrieves a tiddler from a given workspace on a given server
FileAdaptor.prototype.getTiddler = function(title,context,userParams,callback)
{
	if(!this.store)
		return FileAdaptor.NotLoadedError;
	if(!context)
		context = {};
	context.tiddler = this.store.fetchTiddler(title);
	if(context.tiddler) {
		context.tiddler.fields['server.type'] = FileAdaptor.serverType;
		context.tiddler.fields['server.host'] = this.host;
		context.tiddler.fields['server.page.revision'] = context.tiddler.modified.convertToYYYYMMDDHHMM();
	}
	context.status = true;
	if(context.allowSynchronous) {
		context.isSynchronous = true;
		callback(context,userParams);
	} else {
		window.setTimeout(function() {callback(context,userParams);},10);
	}
	return true;
};

FileAdaptor.prototype.close = function()
{
	delete this.store;
	this.store = null;
};

config.adaptors[FileAdaptor.serverType] = FileAdaptor;

//--
//-- Remote HTTP requests
//--

function loadRemoteFile(url,callback,params)
{
	return doHttp("GET",url,null,null,null,null,callback,params,null);
}

// HTTP status codes
var httpStatus = {
	OK: 200,
	ContentCreated: 201,
	NoContent: 204,
	Unauthorized: 401,
	Forbidden: 403,
	NotFound: 404,
	MethodNotAllowed: 405
};

function doHttp(type,url,data,contentType,username,password,callback,params,headers)
{
	// Get an xhr object
	var x = getXMLHttpRequest();
	if(!x)
		return "Can't create XMLHttpRequest object";
	// Install callback
	x.onreadystatechange = function() {
		if (x.readyState == 4 && callback && (x.status !== undefined)) {
			if([0, httpStatus.OK, httpStatus.ContentCreated, httpStatus.NoContent].contains(x.status))
				callback(true,params,x.responseText,url,x);
			else
				callback(false,params,null,url,x);
			x.onreadystatechange = function(){};
			x = null;
		}
	};
	// Send request
	if(window.Components && window.netscape && window.netscape.security && document.location.protocol.indexOf("http") == -1)
		window.netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
	try {
		url = url + (url.indexOf("?") < 0 ? "?" : "&") + "nocache=" + Math.random();
		x.open(type,url,true,username,password);
		if (data)
			x.setRequestHeader("Content-Type", contentType ? contentType : "application/x-www-form-urlencoded");
		if (x.overrideMimeType)
			x.setRequestHeader("Connection", "close");
		if(headers) {
			for(n in headers)
				x.setRequestHeader(n,headers[n]);
		}
		x.setRequestHeader("X-Requested-With", "TiddlyWiki " + version.major + "." + version.minor + "." + version.revision + (version.beta ? " (beta " + version.beta + ")" : ""));
		x.send(data);
	} catch (ex) {
		return exceptionText(ex);
	}
	return x;
}

function getXMLHttpRequest()
{
	try {
		var x = new XMLHttpRequest(); // Modern
	} catch(ex) {
		try {
			x = new ActiveXObject("Msxml2.XMLHTTP"); // IE 6
		} catch (ex2) {
			return null;
		}
	}
	return x;
}

//--
//-- TiddlyWiki-specific utility functions
//--

function createTiddlyButton(theParent,theText,theTooltip,theAction,theClass,theId,theAccessKey)
{
	var theButton = document.createElement("a");
	if(theAction) {
		theButton.onclick = theAction;
		theButton.setAttribute("href","javascript:;");
	}
	if(theTooltip)
		theButton.setAttribute("title",theTooltip);
	if(theText)
		theButton.appendChild(document.createTextNode(theText));
	if(theClass)
		theButton.className = theClass;
	else
		theButton.className = "button";
	if(theId)
		theButton.id = theId;
	if(theParent)
		theParent.appendChild(theButton);
	if(theAccessKey)
		theButton.setAttribute("accessKey",theAccessKey);
	return theButton;
}

function createTiddlyLink(place,title,includeText,theClass,isStatic,linkedFromTiddler,noToggle)
{
	var text = includeText ? title : null;
	var i = getTiddlyLinkInfo(title,theClass);
	var btn = isStatic ? createExternalLink(place,store.getTiddlerText("SiteUrl",null) + "#" + title) : createTiddlyButton(place,text,i.subTitle,onClickTiddlerLink,i.classes);
	btn.setAttribute("refresh","link");
	btn.setAttribute("tiddlyLink",title);
	if(noToggle)
		btn.setAttribute("noToggle","true");
	if(linkedFromTiddler) {
		var fields = linkedFromTiddler.getInheritedFields();
		if(fields)
			btn.setAttribute("tiddlyFields",fields);
	}
	return btn;
}

function refreshTiddlyLink(e,title)
{
	var i = getTiddlyLinkInfo(title,e.className);
	e.className = i.classes;
	e.title = i.subTitle;
}

function getTiddlyLinkInfo(title,currClasses)
{
	var classes = currClasses ? currClasses.split(" ") : [];
	classes.pushUnique("tiddlyLink");
	var tiddler = store.fetchTiddler(title);
	var subTitle;
	if(tiddler) {
		subTitle = tiddler.getSubtitle();
		classes.pushUnique("tiddlyLinkExisting");
		classes.remove("tiddlyLinkNonExisting");
		classes.remove("shadow");
	} else {
		classes.remove("tiddlyLinkExisting");
		classes.pushUnique("tiddlyLinkNonExisting");
		if(store.isShadowTiddler(title)) {
			subTitle = config.messages.shadowedTiddlerToolTip.format([title]);
			classes.pushUnique("shadow");
		} else {
			subTitle = config.messages.undefinedTiddlerToolTip.format([title]);
			classes.remove("shadow");
		}
	}
	if(config.annotations[title])
		subTitle = config.annotations[title];
	return {classes: classes.join(" "),subTitle: subTitle};
}

function createExternalLink(place,url)
{
	var theLink = document.createElement("a");
	theLink.className = "externalLink";
	theLink.href = url;
	theLink.title = config.messages.externalLinkTooltip.format([url]);
	if(config.options.chkOpenInNewWindow)
		theLink.target = "_blank";
	place.appendChild(theLink);
	return theLink;
}

// Event handler for clicking on a tiddly link
function onClickTiddlerLink(e)
{
	if(!e) e = window.event;
	var theTarget = resolveTarget(e);
	var theLink = theTarget;
	var title = null;
	var fields = null;
	var noToggle = null;
	do {
		title = theLink.getAttribute("tiddlyLink");
		fields = theLink.getAttribute("tiddlyFields");
		noToggle = theLink.getAttribute("noToggle");
		theLink = theLink.parentNode;
	} while(title == null && theLink != null);
	if(!fields && !store.isShadowTiddler(title))
		fields = String.encodeHashMap(config.defaultCustomFields);
	if(title) {
		var toggling = e.metaKey || e.ctrlKey;
		if(config.options.chkToggleLinks)
			toggling = !toggling;
		if(noToggle)
			toggling = false;
		story.displayTiddler(theTarget,title,null,true,null,fields,toggling);
	}
	clearMessage();
	return false;
}

// Create a button for a tag with a popup listing all the tiddlers that it tags
function createTagButton(place,tag,excludeTiddler)
{
	var theTag = createTiddlyButton(place,tag,config.views.wikified.tag.tooltip.format([tag]),onClickTag);
	theTag.setAttribute("tag",tag);
	if(excludeTiddler)
		theTag.setAttribute("tiddler",excludeTiddler);
	return theTag;
}

// Event handler for clicking on a tiddler tag
function onClickTag(e)
{
	if(!e) var e = window.event;
	var theTarget = resolveTarget(e);
	var popup = Popup.create(this);
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(popup && tag) {
		var tagged = store.getTaggedTiddlers(tag);
		var titles = [];
		var li,r;
		for(r=0;r<tagged.length;r++) {
			if(tagged[r].title != title)
				titles.push(tagged[r].title);
		}
		var lingo = config.views.wikified.tag;
		if(titles.length > 0) {
			var openAll = createTiddlyButton(createTiddlyElement(popup,"li"),lingo.openAllText.format([tag]),lingo.openAllTooltip,onClickTagOpenAll);
			openAll.setAttribute("tag",tag);
			createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
			for(r=0; r<titles.length; r++) {
				createTiddlyLink(createTiddlyElement(popup,"li"),titles[r],true);
			}
		} else {
			createTiddlyText(createTiddlyElement(popup,"li",null,"disabled"),lingo.popupNone.format([tag]));
		}
		createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
		var h = createTiddlyLink(createTiddlyElement(popup,"li"),tag,false);
		createTiddlyText(h,lingo.openTag.format([tag]));
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

// Event handler for 'open all' on a tiddler popup
function onClickTagOpenAll(e)
{
	if(!e) var e = window.event;
	var tag = this.getAttribute("tag");
	var tagged = store.getTaggedTiddlers(tag);
	var titles = [];
	for(var t=0; t<tagged.length; t++)
		titles.push(tagged[t].title);
	story.displayTiddlers(this,titles);
	return false;
}

function onClickError(e)
{
	if(!e) var e = window.event;
	var popup = Popup.create(this);
	var lines = this.getAttribute("errorText").split("\n");
	for(var t=0; t<lines.length; t++)
		createTiddlyElement(popup,"li",null,null,lines[t]);
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyDropDown(place,onchange,options,defaultValue)
{
	var sel = createTiddlyElement(place,"select");
	sel.onchange = onchange;
	for(var t=0; t<options.length; t++) {
		var e = createTiddlyElement(sel,"option",null,null,options[t].caption);
		e.value = options[t].name;
		if(options[t].name == defaultValue)
			e.selected = true;
	}
	return sel;
}

function createTiddlyPopup(place,caption,tooltip,tiddler)
{
	if(tiddler.text) {
		createTiddlyLink(place,caption,true);
		var btn = createTiddlyButton(place,glyph("downArrow"),tooltip,onClickTiddlyPopup,"tiddlerPopupButton");
		btn.tiddler = tiddler;
	} else {
		createTiddlyText(place,caption);
	}
}

function onClickTiddlyPopup(e)
{
	if(!e) var e = window.event;
	var tiddler = this.tiddler;
	if(tiddler.text) {
		var popup = Popup.create(this,"div","popupTiddler");
		wikify(tiddler.text,popup,null,tiddler);
		Popup.show();
	}
	if(e) e.cancelBubble = true;
	if(e && e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyError(place,title,text)
{
	var btn = createTiddlyButton(place,title,null,onClickError,"errorButton");
	if(text) btn.setAttribute("errorText",text);
}

function merge(dst,src,preserveExisting)
{
	for(p in src) {
		if(!preserveExisting || dst[p] === undefined)
			dst[p] = src[p];
	}
	return dst;
}

// Returns a string containing the description of an exception, optionally prepended by a message
function exceptionText(e,message)
{
	var s = e.description ? e.description : e.toString();
	return message ? "%0:\n%1".format([message,s]) : s;
}

// Displays an alert of an exception description with optional message
function showException(e,message)
{
	alert(exceptionText(e,message));
}

function alertAndThrow(m)
{
	alert(m);
	throw(m);
}

function glyph(name)
{
	var g = config.glyphs;
	var b = g.currBrowser;
	if(b == null) {
		b = 0;
		while(!g.browsers[b]() && b < g.browsers.length-1)
			b++;
		g.currBrowser = b;
	}
	if(!g.codes[name])
		return "";
	return g.codes[name][b];
}
//-
//- Animation engine
//-

function Animator()
{
	this.running = 0; // Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled
	this.timerID = 0; // ID of the timer used for animating
	this.animations = []; // List of animations in progress
	return this;
}

// Start animation engine
Animator.prototype.startAnimating = function() // Variable number of arguments
{
	for(var t=0; t<arguments.length; t++)
		this.animations.push(arguments[t]);
	if(this.running == 0) {
		var me = this;
		this.timerID = window.setInterval(function() {me.doAnimate(me);},10);
	}
	this.running += arguments.length;
};

// Perform an animation engine tick, calling each of the known animation modules
Animator.prototype.doAnimate = function(me)
{
	var a = 0;
	while(a < me.animations.length) {
		var animation = me.animations[a];
		if(animation.tick()) {
			a++;
		} else {
			me.animations.splice(a,1);
			if(--me.running == 0)
				window.clearInterval(me.timerID);
		}
	}
};

// Map a 0..1 value to 0..1, but slow down at the start and end
Animator.slowInSlowOut = function(progress)
{
	return(1-((Math.cos(progress * Math.PI)+1)/2));
};

//--
//-- Morpher animation
//--

// Animate a set of properties of an element
function Morpher(element,duration,properties,callback)
{
	this.element = element;
	this.duration = duration;
	this.properties = properties;
	this.startTime = new Date();
	this.endTime = Number(this.startTime) + duration;
	this.callback = callback;
	this.tick();
	return this;
}

Morpher.prototype.assignStyle = function(element,style,value)
{
	switch(style) {
		case "-tw-vertScroll":
			window.scrollTo(findScrollX(),value);
			break;
		case "-tw-horizScroll":
			window.scrollTo(value,findScrollY());
			break;
		default:
			element.style[style] = value;
			break;
	}
};

Morpher.prototype.stop = function()
{
	for(var t=0; t<this.properties.length; t++) {
		var p = this.properties[t];
		if(p.atEnd !== undefined) {
			this.assignStyle(this.element,p.style,p.atEnd);
		}
	}
	if(this.callback)
		this.callback(this.element,this.properties);
};

Morpher.prototype.tick = function()
{
	var currTime = Number(new Date());
	progress = Animator.slowInSlowOut(Math.min(1,(currTime-this.startTime)/this.duration));
	for(var t=0; t<this.properties.length; t++) {
		var p = this.properties[t];
		if(p.start !== undefined && p.end !== undefined) {
			var template = p.template ? p.template : "%0";
			switch(p.format) {
				case undefined:
				case "style":
					var v = p.start + (p.end-p.start) * progress;
					this.assignStyle(this.element,p.style,template.format([v]));
					break;
				case "color":
					break;
			}
		}
	}
	if(currTime >= this.endTime) {
		this.stop();
		return false;
	}
	return true;
};

//--
//-- Zoomer animation
//--

function Zoomer(text,startElement,targetElement,unused)
{
	var e = createTiddlyElement(document.body,"div",null,"zoomer");
	createTiddlyElement(e,"div",null,null,text);
	var winWidth = findWindowWidth();
	var winHeight = findWindowHeight();
	var p = [
		{style: 'left', start: findPosX(startElement), end: findPosX(targetElement), template: '%0px'},
		{style: 'top', start: findPosY(startElement), end: findPosY(targetElement), template: '%0px'},
		{style: 'width', start: Math.min(startElement.scrollWidth,winWidth), end: Math.min(targetElement.scrollWidth,winWidth), template: '%0px', atEnd: 'auto'},
		{style: 'height', start: Math.min(startElement.scrollHeight,winHeight), end: Math.min(targetElement.scrollHeight,winHeight), template: '%0px', atEnd: 'auto'},
		{style: 'fontSize', start: 8, end: 24, template: '%0pt'}
	];
	var c = function(element,properties) {removeNode(element);};
	return new Morpher(e,config.animDuration,p,c);
}

//--
//-- Scroller animation
//--

function Scroller(targetElement,unused)
{
	var p = [
		{style: '-tw-vertScroll', start: findScrollY(), end: ensureVisible(targetElement)}
	];
	return new Morpher(targetElement,config.animDuration,p);
}

//--
//-- Slider animation
//--

// deleteMode - "none", "all" [delete target element and it's children], [only] "children" [but not the target element]
function Slider(element,opening,unused,deleteMode)
{
	element.style.overflow = 'hidden';
	if(opening)
		element.style.height = '0px'; // Resolves a Firefox flashing bug
	element.style.display = 'block';
	var left = findPosX(element);
	var width = element.scrollWidth;
	var height = element.scrollHeight;
	var winWidth = findWindowWidth();
	var p = [];
	var c = null;
	if(opening) {
		p.push({style: 'height', start: 0, end: height, template: '%0px', atEnd: 'auto'});
		p.push({style: 'opacity', start: 0, end: 1, template: '%0'});
		p.push({style: 'filter', start: 0, end: 100, template: 'alpha(opacity:%0)'});
	} else {
		p.push({style: 'height', start: height, end: 0, template: '%0px'});
		p.push({style: 'display', atEnd: 'none'});
		p.push({style: 'opacity', start: 1, end: 0, template: '%0'});
		p.push({style: 'filter', start: 100, end: 0, template: 'alpha(opacity:%0)'});
		switch(deleteMode) {
			case "all":
				c = function(element,properties) {removeNode(element);};
				break;
			case "children":
				c = function(element,properties) {removeChildren(element);};
				break;
		}
	}
	return new Morpher(element,config.animDuration,p,c);
}

//--
//-- Popup menu
//--

var Popup = {
	stack: [] // Array of objects with members root: and popup:
	};

Popup.create = function(root,elem,theClass)
{
	Popup.remove();
	var popup = createTiddlyElement(document.body,elem ? elem : "ol","popup",theClass ? theClass : "popup");
	Popup.stack.push({root: root, popup: popup});
	return popup;
};

Popup.onDocumentClick = function(e)
{
	if (!e) var e = window.event;
	var target = resolveTarget(e);
	if(e.eventPhase == undefined)
		Popup.remove();
	else if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)
		Popup.remove();
	return true;
};

Popup.show = function(unused1,unused2)
{
	var curr = Popup.stack[Popup.stack.length-1];
	this.place(curr.root,curr.popup);
	addClass(curr.root,"highlight");
	if(config.options.chkAnimate && anim && typeof Scroller == "function")
		anim.startAnimating(new Scroller(curr.popup));
	else
		window.scrollTo(0,ensureVisible(curr.popup));
};

Popup.place = function(root,popup,offset)
{
	if(!offset) var offset = {x:0, y:0};
	var rootLeft = findPosX(root);
	var rootTop = findPosY(root);
	var rootHeight = root.offsetHeight;
	var popupLeft = rootLeft + offset.x;
	var popupTop = rootTop + rootHeight + offset.y;
	var winWidth = findWindowWidth();
	if(popup.offsetWidth > winWidth*0.75)
		popup.style.width = winWidth*0.75 + "px";
	var popupWidth = popup.offsetWidth;
	if(popupLeft + popupWidth > winWidth)
		popupLeft = winWidth - popupWidth;
	popup.style.left = popupLeft + "px";
	popup.style.top = popupTop + "px";
	popup.style.display = "block";
}

Popup.remove = function()
{
	if(Popup.stack.length > 0) {
		Popup.removeFrom(0);
	}
};

Popup.removeFrom = function(from)
{
	for(var t=Popup.stack.length-1; t>=from; t--) {
		var p = Popup.stack[t];
		removeClass(p.root,"highlight");
		removeNode(p.popup);
	}
	Popup.stack = Popup.stack.slice(0,from);
};

//--
//-- Wizard support
//--

function Wizard(elem)
{
	if(elem) {
		this.formElem = findRelated(elem,"wizard","className");
		this.bodyElem = findRelated(this.formElem.firstChild,"wizardBody","className","nextSibling");
		this.footElem = findRelated(this.formElem.firstChild,"wizardFooter","className","nextSibling");
	} else {
		this.formElem = null;
		this.bodyElem = null;
		this.footElem = null;
	}
}

Wizard.prototype.setValue = function(name,value)
{
	if(this.formElem)
		this.formElem[name] = value;
};

Wizard.prototype.getValue = function(name)
{
	return this.formElem ? this.formElem[name] : null;
};

Wizard.prototype.createWizard = function(place,title)
{
	this.formElem = createTiddlyElement(place,"form",null,"wizard");
	createTiddlyElement(this.formElem,"h1",null,null,title);
	this.bodyElem = createTiddlyElement(this.formElem,"div",null,"wizardBody");
	this.footElem = createTiddlyElement(this.formElem,"div",null,"wizardFooter");
};

Wizard.prototype.clear = function()
{
	removeChildren(this.bodyElem);
};

Wizard.prototype.setButtons = function(buttonInfo,status)
{
	removeChildren(this.footElem);
	for(var t=0; t<buttonInfo.length; t++) {
		createTiddlyButton(this.footElem,buttonInfo[t].caption,buttonInfo[t].tooltip,buttonInfo[t].onClick);
		insertSpacer(this.footElem);
		}
	if(typeof status == "string") {
		createTiddlyElement(this.footElem,"span",null,"status",status);
	}
};

Wizard.prototype.addStep = function(stepTitle,html)
{
	removeChildren(this.bodyElem);
	var w = createTiddlyElement(this.bodyElem,"div");
	createTiddlyElement(w,"h2",null,null,stepTitle);
	var step = createTiddlyElement(w,"div",null,"wizardStep");
	step.innerHTML = html;
	applyHtmlMacros(step,tiddler);
};

Wizard.prototype.getElement = function(name)
{
	return this.formElem.elements[name];
};

//--
//-- ListView gadget
//--

var ListView = {};

// Create a listview
ListView.create = function(place,listObject,listTemplate,callback,className)
{
	var table = createTiddlyElement(place,"table",null,className ? className : "listView twtable");
	var thead = createTiddlyElement(table,"thead");
	var r = createTiddlyElement(thead,"tr");
	for(var t=0; t<listTemplate.columns.length; t++) {
		var columnTemplate = listTemplate.columns[t];
		var c = createTiddlyElement(r,"th");
		var colType = ListView.columnTypes[columnTemplate.type];
		if(colType && colType.createHeader)
			colType.createHeader(c,columnTemplate,t);
	}
	var tbody = createTiddlyElement(table,"tbody");
	for(var rc=0; rc<listObject.length; rc++) {
		rowObject = listObject[rc];
		r = createTiddlyElement(tbody,"tr");
		for(c=0; c<listTemplate.rowClasses.length; c++) {
			if(rowObject[listTemplate.rowClasses[c].field])
				addClass(r,listTemplate.rowClasses[c].className);
		}
		rowObject.rowElement = r;
		rowObject.colElements = {};
		for(var cc=0; cc<listTemplate.columns.length; cc++) {
			c = createTiddlyElement(r,"td");
			columnTemplate = listTemplate.columns[cc];
			var field = columnTemplate.field;
			colType = ListView.columnTypes[columnTemplate.type];
			if(colType && colType.createItem)
				colType.createItem(c,rowObject,field,columnTemplate,cc,rc);
			rowObject.colElements[field] = c;
		}
	}
	if(callback && listTemplate.actions)
		createTiddlyDropDown(place,ListView.getCommandHandler(callback),listTemplate.actions);
	if(callback && listTemplate.buttons) {
		for(t=0; t<listTemplate.buttons.length; t++) {
			var a = listTemplate.buttons[t];
			if(a && a.name != "")
				createTiddlyButton(place,a.caption,null,ListView.getCommandHandler(callback,a.name,a.allowEmptySelection));
		}
	}
	return table;
};

ListView.getCommandHandler = function(callback,name,allowEmptySelection)
{
	return function(e) {
		var view = findRelated(this,"TABLE",null,"previousSibling");
		var tiddlers = [];
		ListView.forEachSelector(view,function(e,rowName) {
					if(e.checked)
						tiddlers.push(rowName);
					});
		if(tiddlers.length == 0 && !allowEmptySelection) {
			alert(config.messages.nothingSelected);
		} else {
			if(this.nodeName.toLowerCase() == "select") {
				callback(view,this.value,tiddlers);
				this.selectedIndex = 0;
			} else {
				callback(view,name,tiddlers);
			}
		}
	};
};

// Invoke a callback for each selector checkbox in the listview
ListView.forEachSelector = function(view,callback)
{
	var checkboxes = view.getElementsByTagName("input");
	var hadOne = false;
	for(var t=0; t<checkboxes.length; t++) {
		var cb = checkboxes[t];
		if(cb.getAttribute("type") == "checkbox") {
			var rn = cb.getAttribute("rowName");
			if(rn) {
				callback(cb,rn);
				hadOne = true;
			}
		}
	}
	return hadOne;
};

ListView.getSelectedRows = function(view)
{
	var rowNames = [];
	ListView.forEachSelector(view,function(e,rowName) {
				if(e.checked)
					rowNames.push(rowName);
				});
	return rowNames;
};

ListView.columnTypes = {};

ListView.columnTypes.String = {
	createHeader: function(place,columnTemplate,col)
		{
			createTiddlyText(place,columnTemplate.title);
		},
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				createTiddlyText(place,v);
		}
};

ListView.columnTypes.WikiText = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				wikify(v,place,null,null);
		}
};

ListView.columnTypes.Tiddler = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined && v.title)
				createTiddlyPopup(place,v.title,config.messages.listView.tiddlerTooltip,v);
		}
};

ListView.columnTypes.Size = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined) {
				var t = 0;
				while(t<config.messages.sizeTemplates.length-1 && v<config.messages.sizeTemplates[t].unit)
					t++;
				createTiddlyText(place,config.messages.sizeTemplates[t].template.format([Math.round(v/config.messages.sizeTemplates[t].unit)]));
			}
		}
};

ListView.columnTypes.Link = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			var c = columnTemplate.text;
			if(v != undefined)
				createTiddlyText(createExternalLink(place,v),c ? c : v);
		}
};

ListView.columnTypes.Date = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				createTiddlyText(place,v.formatString(columnTemplate.dateFormat));
		}
};

ListView.columnTypes.StringList = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined) {
				for(var t=0; t<v.length; t++) {
					createTiddlyText(place,v[t]);
					createTiddlyElement(place,"br");
				}
			}
		}
};

ListView.columnTypes.Selector = {
	createHeader: function(place,columnTemplate,col)
		{
			createTiddlyCheckbox(place,null,false,this.onHeaderChange);
		},
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var e = createTiddlyCheckbox(place,null,listObject[field],null);
			e.setAttribute("rowName",listObject[columnTemplate.rowName]);
		},
	onHeaderChange: function(e)
		{
			var state = this.checked;
			var view = findRelated(this,"TABLE");
			if(!view)
				return;
			ListView.forEachSelector(view,function(e,rowName) {
								e.checked = state;
							});
		}
};

ListView.columnTypes.Tags = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var tags = listObject[field];
			createTiddlyText(place,String.encodeTiddlyLinkList(tags));
		}
};

ListView.columnTypes.Boolean = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			if(listObject[field] == true)
				createTiddlyText(place,columnTemplate.trueText);
			if(listObject[field] == false)
				createTiddlyText(place,columnTemplate.falseText);
		}
};

ListView.columnTypes.TagCheckbox = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var e = createTiddlyCheckbox(place,null,listObject[field],this.onChange);
			e.setAttribute("tiddler",listObject.title);
			e.setAttribute("tag",columnTemplate.tag);
		},
	onChange : function(e)
		{
			var tag = this.getAttribute("tag");
			var tiddler = this.getAttribute("tiddler");
			store.setTiddlerTag(tiddler,this.checked,tag);
		}
};

ListView.columnTypes.TiddlerLink = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined) {
				var link = createTiddlyLink(place,listObject[columnTemplate.tiddlerLink],false,null);
				createTiddlyText(link,listObject[field]);
			}
		}
};

//--
//-- Augmented methods for the JavaScript Number(), Array(), String() and Date() objects
//--

// Clamp a number to a range
Number.prototype.clamp = function(min,max)
{
	var c = this;
	if(c < min)
		c = min;
	if(c > max)
		c = max;
	return c;
};

// Add indexOf function if browser does not support it
if(!Array.indexOf) {
Array.prototype.indexOf = function(item,from)
{
	if(!from)
		from = 0;
	for(var i=from; i<this.length; i++) {
		if(this[i] === item)
			return i;
	}
	return -1;
};}

// Find an entry in a given field of the members of an array
Array.prototype.findByField = function(field,value)
{
	for(var t=0; t<this.length; t++) {
		if(this[t][field] == value)
			return t;
	}
	return null;
};

// Return whether an entry exists in an array
Array.prototype.contains = function(item)
{
	return this.indexOf(item) != -1;
};

// Adds, removes or toggles a particular value within an array
//  value - value to add
//  mode - +1 to add value, -1 to remove value, 0 to toggle it
Array.prototype.setItem = function(value,mode)
{
	var p = this.indexOf(value);
	if(mode == 0)
		mode = (p == -1) ? +1 : -1;
	if(mode == +1) {
		if(p == -1)
			this.push(value);
	} else if(mode == -1) {
		if(p != -1)
			this.splice(p,1);
	}
};

// Return whether one of a list of values exists in an array
Array.prototype.containsAny = function(items)
{
	for(var i=0; i<items.length; i++) {
		if (this.indexOf(items[i]) != -1)
			return true;
	}
	return false;
};

// Return whether all of a list of values exists in an array
Array.prototype.containsAll = function(items)
{
	for (var i = 0; i<items.length; i++) {
		if (this.indexOf(items[i]) == -1)
			return false;
	}
	return true;
};

// Push a new value into an array only if it is not already present in the array. If the optional unique parameter is false, it reverts to a normal push
Array.prototype.pushUnique = function(item,unique)
{
	if(unique === false) {
		this.push(item);
	} else {
		if(this.indexOf(item) == -1)
			this.push(item);
	}
};

Array.prototype.remove = function(item)
{
	var p = this.indexOf(item);
	if(p != -1)
		this.splice(p,1);
};

// Get characters from the right end of a string
String.prototype.right = function(n)
{
	return n < this.length ? this.slice(this.length-n) : this;
};

// Trim whitespace from both ends of a string
String.prototype.trim = function()
{
	return this.replace(/^\s*|\s*$/g,"");
};

// Convert a string from a CSS style property name to a JavaScript style name ("background-color" -> "backgroundColor")
String.prototype.unDash = function()
{
	var s = this.split("-");
	if(s.length > 1) {
		for(var t=1; t<s.length; t++)
			s[t] = s[t].substr(0,1).toUpperCase() + s[t].substr(1);
	}
	return s.join("");
};

// Substitute substrings from an array into a format string that includes '%1'-type specifiers
String.prototype.format = function(substrings)
{
	var subRegExp = /(?:%(\d+))/mg;
	var currPos = 0;
	var r = [];
	do {
		var match = subRegExp.exec(this);
		if(match && match[1]) {
			if(match.index > currPos)
				r.push(this.substring(currPos,match.index));
			r.push(substrings[parseInt(match[1])]);
			currPos = subRegExp.lastIndex;
		}
	} while(match);
	if(currPos < this.length)
		r.push(this.substring(currPos,this.length));
	return r.join("");
};

// Escape any special RegExp characters with that character preceded by a backslash
String.prototype.escapeRegExp = function()
{
	var s = "\\^$*+?()=!|,{}[].";
	var c = this;
	for(var t=0; t<s.length; t++)
		c = c.replace(new RegExp("\\" + s.substr(t,1),"g"),"\\" + s.substr(t,1));
	return c;
};

// Convert "\" to "\s", newlines to "\n" (and remove carriage returns)
String.prototype.escapeLineBreaks = function()
{
	return this.replace(/\\/mg,"\\s").replace(/\n/mg,"\\n").replace(/\r/mg,"");
};

// Convert "\n" to newlines, "\b" to " ", "\s" to "\" (and remove carriage returns)
String.prototype.unescapeLineBreaks = function()
{
	return this.replace(/\\n/mg,"\n").replace(/\\b/mg," ").replace(/\\s/mg,"\\").replace(/\r/mg,"");
};

// Convert & to "&amp;", < to "&lt;", > to "&gt;" and " to "&quot;"
String.prototype.htmlEncode = function()
{
	return this.replace(/&/mg,"&amp;").replace(/</mg,"&lt;").replace(/>/mg,"&gt;").replace(/\"/mg,"&quot;");
};

// Convert "&amp;" to &, "&lt;" to <, "&gt;" to > and "&quot;" to "
String.prototype.htmlDecode = function()
{
	return this.replace(/&lt;/mg,"<").replace(/&gt;/mg,">").replace(/&quot;/mg,"\"").replace(/&amp;/mg,"&");
};

// Convert a string to it's JSON representation by encoding control characters, double quotes and backslash. See json.org
String.prototype.toJSONString = function()
{
	var m = {
		'\b': '\\b',
		'\f': '\\f',
		'\n': '\\n',
		'\r': '\\r',
		'\t': '\\t',
		'"' : '\\"',
		'\\': '\\\\'
		};
	var replaceFn = function(a,b) {
		var c = m[b];
		if(c)
			return c;
		c = b.charCodeAt();
		return '\\u00' + Math.floor(c / 16).toString(16) + (c % 16).toString(16);
		};
	if(/["\\\x00-\x1f]/.test(this))
		return '"' + this.replace(/([\x00-\x1f\\"])/g,replaceFn) + '"';
	return '"' + this + '"';
};

// Parse a space-separated string of name:value parameters
// The result is an array of objects:
//   result[0] = object with a member for each parameter name, value of that member being an array of values
//   result[1..n] = one object for each parameter, with 'name' and 'value' members
String.prototype.parseParams = function(defaultName,defaultValue,allowEval,noNames,cascadeDefaults)
{
	var parseToken = function(match,p) {
		var n;
		if(match[p]) // Double quoted
			n = match[p];
		else if(match[p+1]) // Single quoted
			n = match[p+1];
		else if(match[p+2]) // Double-square-bracket quoted
			n = match[p+2];
		else if(match[p+3]) // Double-brace quoted
			try {
				n = match[p+3];
				if(allowEval)
					n = window.eval(n);
			} catch(ex) {
				throw "Unable to evaluate {{" + match[p+3] + "}}: " + exceptionText(ex);
			}
		else if(match[p+4]) // Unquoted
			n = match[p+4];
		else if(match[p+5]) // empty quote
			n = "";
		return n;
	};
	var r = [{}];
	var dblQuote = "(?:\"((?:(?:\\\\\")|[^\"])+)\")";
	var sngQuote = "(?:'((?:(?:\\\\\')|[^'])+)')";
	var dblSquare = "(?:\\[\\[((?:\\s|\\S)*?)\\]\\])";
	var dblBrace = "(?:\\{\\{((?:\\s|\\S)*?)\\}\\})";
	var unQuoted = noNames ? "([^\"'\\s]\\S*)" : "([^\"':\\s][^\\s:]*)";
	var emptyQuote = "((?:\"\")|(?:''))";
	var skipSpace = "(?:\\s*)";
	var token = "(?:" + dblQuote + "|" + sngQuote + "|" + dblSquare + "|" + dblBrace + "|" + unQuoted + "|" + emptyQuote + ")";
	var re = noNames ? new RegExp(token,"mg") : new RegExp(skipSpace + token + skipSpace + "(?:(\\:)" + skipSpace + token + ")?","mg");
	var params = [];
	do {
		var match = re.exec(this);
		if(match) {
			var n = parseToken(match,1);
			if(noNames) {
				r.push({name:"",value:n});
			} else {
				var v = parseToken(match,8);
				if(v == null && defaultName) {
					v = n;
					n = defaultName;
				} else if(v == null && defaultValue) {
					v = defaultValue;
				}
				r.push({name:n,value:v});
				if(cascadeDefaults) {
					defaultName = n;
					defaultValue = v;
				}
			}
		}
	} while(match);
	// Summarise parameters into first element
	for(var t=1; t<r.length; t++) {
		if(r[0][r[t].name])
			r[0][r[t].name].push(r[t].value);
		else
			r[0][r[t].name] = [r[t].value];
	}
	return r;
};

// Process a string list of macro parameters into an array. Parameters can be quoted with "", '',
// [[]], {{ }} or left unquoted (and therefore space-separated). Double-braces {{}} results in
// an *evaluated* parameter: e.g. {{config.options.txtUserName}} results in the current user's name.
String.prototype.readMacroParams = function()
{
	var p = this.parseParams("list",null,true,true);
	var n = [];
	for(var t=1; t<p.length; t++)
		n.push(p[t].value);
	return n;
};

// Process a string list of unique tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]
String.prototype.readBracketedList = function(unique)
{
	var p = this.parseParams("list",null,false,true);
	var n = [];
	for(var t=1; t<p.length; t++)
		n.pushUnique(p[t].value,unique);
	return n;
};

// Returns array with start and end index of chunk between given start and end marker, or undefined.
String.prototype.getChunkRange = function(start,end) 
{
	var s = this.indexOf(start);
	if(s != -1) {
		s += start.length;
		var e = this.indexOf(end,s);
		if(e != -1)
			return [s,e];
	}
};

// Replace a chunk of a string given start and end markers
String.prototype.replaceChunk = function(start,end,sub)
{
	var r = this.getChunkRange(start,end);
	return r ? this.substring(0,r[0]) + sub + this.substring(r[1]) : this;
};

// Returns a chunk of a string between start and end markers, or undefined
String.prototype.getChunk = function(start,end)
{
	var r = this.getChunkRange(start,end);
	if(r)
		return this.substring(r[0],r[1]);
};


// Static method to bracket a string with double square brackets if it contains a space
String.encodeTiddlyLink = function(title)
{
	return title.indexOf(" ") == -1 ? title : "[[" + title + "]]";
};

// Static method to encodeTiddlyLink for every item in an array and join them with spaces
String.encodeTiddlyLinkList = function(list)
{
	if(list) {
		var results = [];
		for(var t=0; t<list.length; t++)
			results.push(String.encodeTiddlyLink(list[t]));
		return results.join(" ");
	} else {
		return "";
	}
};

// Convert a string as a sequence of name:"value" pairs into a hashmap
String.prototype.decodeHashMap = function()
{
	var fields = this.parseParams("anon","",false);
	var r = {};
	for(var t=1; t<fields.length; t++)
		r[fields[t].name] = fields[t].value;
	return r;
};

// Static method to encode a hashmap into a name:"value"... string
String.encodeHashMap = function(hashmap)
{
	var r = [];
	for(var t in hashmap)
		r.push(t + ':"' + hashmap[t] + '"');
	return r.join(" ");
};

// Static method to left-pad a string with 0s to a certain width
String.zeroPad = function(n,d)
{
	var s = n.toString();
	if(s.length < d)
		s = "000000000000000000000000000".substr(0,d-s.length) + s;
	return s;
};

String.prototype.startsWith = function(prefix) 
{
	return !prefix || this.substring(0,prefix.length) == prefix;
};

// Returns the first value of the given named parameter.
function getParam(params,name,defaultValue)
{
	if(!params)
		return defaultValue;
	var p = params[0][name];
	return p ? p[0] : defaultValue;
}

// Returns the first value of the given boolean named parameter.
function getFlag(params,name,defaultValue)
{
	return !!getParam(params,name,defaultValue);
}

// Substitute date components into a string
Date.prototype.formatString = function(template)
{
	var t = template.replace(/0hh12/g,String.zeroPad(this.getHours12(),2));
	t = t.replace(/hh12/g,this.getHours12());
	t = t.replace(/0hh/g,String.zeroPad(this.getHours(),2));
	t = t.replace(/hh/g,this.getHours());
	t = t.replace(/mmm/g,config.messages.dates.shortMonths[this.getMonth()]);
	t = t.replace(/0mm/g,String.zeroPad(this.getMinutes(),2));
	t = t.replace(/mm/g,this.getMinutes());
	t = t.replace(/0ss/g,String.zeroPad(this.getSeconds(),2));
	t = t.replace(/ss/g,this.getSeconds());
	t = t.replace(/[ap]m/g,this.getAmPm().toLowerCase());
	t = t.replace(/[AP]M/g,this.getAmPm().toUpperCase());
	t = t.replace(/wYYYY/g,this.getYearForWeekNo());
	t = t.replace(/wYY/g,String.zeroPad(this.getYearForWeekNo()-2000,2));
	t = t.replace(/YYYY/g,this.getFullYear());
	t = t.replace(/YY/g,String.zeroPad(this.getFullYear()-2000,2));
	t = t.replace(/MMM/g,config.messages.dates.months[this.getMonth()]);
	t = t.replace(/0MM/g,String.zeroPad(this.getMonth()+1,2));
	t = t.replace(/MM/g,this.getMonth()+1);
	t = t.replace(/0WW/g,String.zeroPad(this.getWeek(),2));
	t = t.replace(/WW/g,this.getWeek());
	t = t.replace(/DDD/g,config.messages.dates.days[this.getDay()]);
	t = t.replace(/ddd/g,config.messages.dates.shortDays[this.getDay()]);
	t = t.replace(/0DD/g,String.zeroPad(this.getDate(),2));
	t = t.replace(/DDth/g,this.getDate()+this.daySuffix());
	t = t.replace(/DD/g,this.getDate());
	return t;
};

Date.prototype.getWeek = function()
{
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if (d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week to calculate weekNo
	var n = Math.floor((dt.getTime()-new Date(dt.getFullYear(),0,1)+3600000)/86400000); 
	return Math.floor(n/7)+1;
};

Date.prototype.getYearForWeekNo = function()
{
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if (d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week
	return dt.getFullYear();
};

Date.prototype.getHours12 = function()
{
	var h = this.getHours();
	return h > 12 ? h-12 : ( h > 0 ? h : 12 );
};

Date.prototype.getAmPm = function()
{
	return this.getHours() >= 12 ? config.messages.dates.pm : config.messages.dates.am;
};

Date.prototype.daySuffix = function()
{
	return config.messages.dates.daySuffixes[this.getDate()-1];
};

// Convert a date to local YYYYMMDDHHMM string format
Date.prototype.convertToLocalYYYYMMDDHHMM = function()
{
	return String.zeroPad(this.getFullYear(),4) + String.zeroPad(this.getMonth()+1,2) + String.zeroPad(this.getDate(),2) + String.zeroPad(this.getHours(),2) + String.zeroPad(this.getMinutes(),2);
};

// Convert a date to UTC YYYYMMDDHHMM string format
Date.prototype.convertToYYYYMMDDHHMM = function()
{
	return String.zeroPad(this.getUTCFullYear(),4) + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2);
};

// Convert a date to UTC YYYYMMDD.HHMMSSMMM string format
Date.prototype.convertToYYYYMMDDHHMMSSMMM = function()
{
	return String.zeroPad(this.getUTCFullYear(),4) + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + "." + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2) + String.zeroPad(this.getUTCSeconds(),2) + String.zeroPad(this.getUTCMilliseconds(),4);
};

// Static method to create a date from a UTC YYYYMMDDHHMM format string
Date.convertFromYYYYMMDDHHMM = function(d)
{
	return new Date(Date.UTC(parseInt(d.substr(0,4),10),
			parseInt(d.substr(4,2),10)-1,
			parseInt(d.substr(6,2),10),
			parseInt(d.substr(8,2),10),
			parseInt(d.substr(10,2),10),0,0));
};

//--
//-- Crypto functions and associated conversion routines
//--

// Crypto "namespace"
function Crypto() {}

// Convert a string to an array of big-endian 32-bit words
Crypto.strToBe32s = function(str)
{
	var be = Array();
	var len = Math.floor(str.length/4);
	var i, j;
	for(i=0, j=0; i<len; i++, j+=4) {
		be[i] = ((str.charCodeAt(j)&0xff) << 24)|((str.charCodeAt(j+1)&0xff) << 16)|((str.charCodeAt(j+2)&0xff) << 8)|(str.charCodeAt(j+3)&0xff);
	}
	while (j<str.length) {
		be[j>>2] |= (str.charCodeAt(j)&0xff)<<(24-(j*8)%32);
		j++;
	}
	return be;
};

// Convert an array of big-endian 32-bit words to a string
Crypto.be32sToStr = function(be)
{
	var str = "";
	for(var i=0;i<be.length*32;i+=8)
		str += String.fromCharCode((be[i>>5]>>>(24-i%32)) & 0xff);
	return str;
};

// Convert an array of big-endian 32-bit words to a hex string
Crypto.be32sToHex = function(be)
{
	var hex = "0123456789ABCDEF";
	var str = "";
	for(var i=0;i<be.length*4;i++)
		str += hex.charAt((be[i>>2]>>((3-i%4)*8+4))&0xF) + hex.charAt((be[i>>2]>>((3-i%4)*8))&0xF);
	return str;
};

// Return, in hex, the SHA-1 hash of a string
Crypto.hexSha1Str = function(str)
{
	return Crypto.be32sToHex(Crypto.sha1Str(str));
};

// Return the SHA-1 hash of a string
Crypto.sha1Str = function(str)
{
	return Crypto.sha1(Crypto.strToBe32s(str),str.length);
};

// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
Crypto.sha1 = function(x,blen)
{
	// Add 32-bit integers, wrapping at 32 bits
	add32 = function(a,b)
	{
		var lsw = (a&0xFFFF)+(b&0xFFFF);
		var msw = (a>>16)+(b>>16)+(lsw>>16);
		return (msw<<16)|(lsw&0xFFFF);
	};
	// Add five 32-bit integers, wrapping at 32 bits
	add32x5 = function(a,b,c,d,e)
	{
		var lsw = (a&0xFFFF)+(b&0xFFFF)+(c&0xFFFF)+(d&0xFFFF)+(e&0xFFFF);
		var msw = (a>>16)+(b>>16)+(c>>16)+(d>>16)+(e>>16)+(lsw>>16);
		return (msw<<16)|(lsw&0xFFFF);
	};
	// Bitwise rotate left a 32-bit integer by 1 bit
	rol32 = function(n)
	{
		return (n>>>31)|(n<<1);
	};

	var len = blen*8;
	// Append padding so length in bits is 448 mod 512
	x[len>>5] |= 0x80 << (24-len%32);
	// Append length
	x[((len+64>>9)<<4)+15] = len;
	var w = Array(80);

	var k1 = 0x5A827999;
	var k2 = 0x6ED9EBA1;
	var k3 = 0x8F1BBCDC;
	var k4 = 0xCA62C1D6;

	var h0 = 0x67452301;
	var h1 = 0xEFCDAB89;
	var h2 = 0x98BADCFE;
	var h3 = 0x10325476;
	var h4 = 0xC3D2E1F0;

	for(var i=0;i<x.length;i+=16) {
		var j,t;
		var a = h0;
		var b = h1;
		var c = h2;
		var d = h3;
		var e = h4;
		for(j = 0;j<16;j++) {
			w[j] = x[i+j];
			t = add32x5(e,(a>>>27)|(a<<5),d^(b&(c^d)),w[j],k1);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
		}
		for(j=16;j<20;j++) {
			w[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);
			t = add32x5(e,(a>>>27)|(a<<5),d^(b&(c^d)),w[j],k1);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
		}
		for(j=20;j<40;j++) {
			w[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);
			t = add32x5(e,(a>>>27)|(a<<5),b^c^d,w[j],k2);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
		}
		for(j=40;j<60;j++) {
			w[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);
			t = add32x5(e,(a>>>27)|(a<<5),(b&c)|(d&(b|c)),w[j],k3);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
		}
		for(j=60;j<80;j++) {
			w[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);
			t = add32x5(e,(a>>>27)|(a<<5),b^c^d,w[j],k4);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
		}

		h0 = add32(h0,a);
		h1 = add32(h1,b);
		h2 = add32(h2,c);
		h3 = add32(h3,d);
		h4 = add32(h4,e);
	}
	return Array(h0,h1,h2,h3,h4);
};

//--
//-- RGB colour object
//--

// Construct an RGB colour object from a '#rrggbb', '#rgb' or 'rgb(n,n,n)' string or from separate r,g,b values
function RGB(r,g,b)
{
	this.r = 0;
	this.g = 0;
	this.b = 0;
	if(typeof r == "string") {
		if(r.substr(0,1) == "#") {
			if(r.length == 7) {
				this.r = parseInt(r.substr(1,2),16)/255;
				this.g = parseInt(r.substr(3,2),16)/255;
				this.b = parseInt(r.substr(5,2),16)/255;
			} else {
				this.r = parseInt(r.substr(1,1),16)/15;
				this.g = parseInt(r.substr(2,1),16)/15;
				this.b = parseInt(r.substr(3,1),16)/15;
			}
		} else {
			var rgbPattern = /rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/;
			var c = r.match(rgbPattern);
			if(c) {
				this.r = parseInt(c[1],10)/255;
				this.g = parseInt(c[2],10)/255;
				this.b = parseInt(c[3],10)/255;
			}
		}
	} else {
		this.r = r;
		this.g = g;
		this.b = b;
	}
	return this;
}

// Mixes this colour with another in a specified proportion
// c = other colour to mix
// f = 0..1 where 0 is this colour and 1 is the new colour
// Returns an RGB object
RGB.prototype.mix = function(c,f)
{
	return new RGB(this.r + (c.r-this.r) * f,this.g + (c.g-this.g) * f,this.b + (c.b-this.b) * f);
};

// Return an rgb colour as a #rrggbb format hex string
RGB.prototype.toString = function()
{
	return "#" + ("0" + Math.floor(this.r.clamp(0,1) * 255).toString(16)).right(2) +
				 ("0" + Math.floor(this.g.clamp(0,1) * 255).toString(16)).right(2) +
				 ("0" + Math.floor(this.b.clamp(0,1) * 255).toString(16)).right(2);
};

//--
//-- DOM utilities - many derived from www.quirksmode.org
//--

function drawGradient(place,horiz,colours)
{
	for(var t=0; t<= 100; t+=2) {
		var bar = document.createElement("div");
		place.appendChild(bar);
		bar.style.position = "absolute";
		bar.style.left = horiz ? t + "%" : 0;
		bar.style.top = horiz ? 0 : t + "%";
		bar.style.width = horiz ? (101-t) + "%" : "100%";
		bar.style.height = horiz ? "100%" : (101-t) + "%";
		bar.style.zIndex = -1;
		var f = t/100;
		var p = f*(colours.length-1);
		bar.style.backgroundColor = colours[Math.floor(p)].mix(colours[Math.ceil(p)],p-Math.floor(p)).toString();
	}
}

function createTiddlyText(theParent,theText)
{
	return theParent.appendChild(document.createTextNode(theText));
}

function createTiddlyCheckbox(theParent,caption,checked,onChange)
{
	var cb = document.createElement("input");
	cb.setAttribute("type","checkbox");
	cb.onclick = onChange;
	theParent.appendChild(cb);
	cb.checked = checked;
	cb.className = "chkOptionInput";
	if(caption)
		wikify(caption,theParent);
	return cb;
}

function createTiddlyElement(theParent,theElement,theID,theClass,theText)
{
	var e = document.createElement(theElement);
	if(theClass != null)
		e.className = theClass;
	if(theID != null)
		e.setAttribute("id",theID);
	if(theText != null)
		e.appendChild(document.createTextNode(theText));
	if(theParent != null)
		theParent.appendChild(e);
	return e;
}

function addEvent(obj,type,fn)
{
	if(obj.attachEvent) {
		obj['e'+type+fn] = fn;
		obj[type+fn] = function(){obj['e'+type+fn](window.event);};
		obj.attachEvent('on'+type,obj[type+fn]);
	} else {
		obj.addEventListener(type,fn,false);
	}
}

function removeEvent(obj,type,fn)
{
	if(obj.detachEvent) {
		obj.detachEvent('on'+type,obj[type+fn]);
		obj[type+fn] = null;
	} else {
		obj.removeEventListener(type,fn,false);
	}
}

function addClass(e,theClass)
{
	var currClass = e.className.split(" ");
	if(currClass.indexOf(theClass) == -1)
		e.className += " " + theClass;
}

function removeClass(e,theClass)
{
	var currClass = e.className.split(" ");
	var i = currClass.indexOf(theClass);
	while(i != -1) {
		currClass.splice(i,1);
		i = currClass.indexOf(theClass);
	}
	e.className = currClass.join(" ");
}

function hasClass(e,theClass)
{
	if(e.className) {
		if(e.className.split(" ").indexOf(theClass) != -1)
			return true;
	}
	return false;
}

// Find the closest relative with a given property value (property defaults to tagName, relative defaults to parentNode)
function findRelated(e,value,name,relative)
{
	name = name ? name : "tagName";
	relative = relative ? relative : "parentNode";
	if(name == "className") {
		while(e && !hasClass(e,value)) {
			e = e[relative];
		}
	} else {
		while(e && e[name] != value) {
			e = e[relative];
		}
	}
	return e;
}

// Resolve the target object of an event
function resolveTarget(e)
{
	var obj;
	if(e.target)
		obj = e.target;
	else if(e.srcElement)
		obj = e.srcElement;
	if(obj.nodeType == 3) // defeat Safari bug
		obj = obj.parentNode;
	return obj;
}

// Return the content of an element as plain text with no formatting
function getPlainText(e)
{
	var text = "";
	if(e.innerText)
		text = e.innerText;
	else if(e.textContent)
		text = e.textContent;
	return text;
}

// Get the scroll position for window.scrollTo necessary to scroll a given element into view
function ensureVisible(e)
{
	var posTop = findPosY(e);
	var posBot = posTop + e.offsetHeight;
	var winTop = findScrollY();
	var winHeight = findWindowHeight();
	var winBot = winTop + winHeight;
	if(posTop < winTop) {
		return posTop;
	} else if(posBot > winBot) {
		if(e.offsetHeight < winHeight)
			return posTop - (winHeight - e.offsetHeight);
		else
			return posTop;
	} else {
		return winTop;
	}
}

// Get the current width of the display window
function findWindowWidth()
{
	return window.innerWidth ? window.innerWidth : document.documentElement.clientWidth;
}

// Get the current height of the display window
function findWindowHeight()
{
	return window.innerHeight ? window.innerHeight : document.documentElement.clientHeight;
}

// Get the current horizontal page scroll position
function findScrollX()
{
	return window.scrollX ? window.scrollX : document.documentElement.scrollLeft;
}

// Get the current vertical page scroll position
function findScrollY()
{
	return window.scrollY ? window.scrollY : document.documentElement.scrollTop;
}

function findPosX(obj)
{
	var curleft = 0;
	while(obj.offsetParent) {
		curleft += obj.offsetLeft;
		obj = obj.offsetParent;
	}
	return curleft;
}

function findPosY(obj)
{
	var curtop = 0;
	while(obj.offsetParent) {
		curtop += obj.offsetTop;
		obj = obj.offsetParent;
	}
	return curtop;
}

// Blur a particular element
function blurElement(e)
{
	if(e != null && e.focus && e.blur) {
		e.focus();
		e.blur();
	}
}

// Create a non-breaking space
function insertSpacer(place)
{
	var e = document.createTextNode(String.fromCharCode(160));
	if(place)
		place.appendChild(e);
	return e;
}

// Remove all children of a node
function removeChildren(e)
{
	while(e && e.hasChildNodes())
		removeNode(e.firstChild);
}

// Remove a node and all it's children
function removeNode(e)
{
	scrubNode(e);
	e.parentNode.removeChild(e);
}

// Remove any event handlers or non-primitve custom attributes
function scrubNode(e)
{
	var att = e.attributes;
	if(att) {
		for(var t=0; t<att.length; t++) {
			var n = att[t].name;
			if(n !== 'style' && (typeof e[n] === 'function' || (typeof e[n] === 'object' && e[n] != null))) {
				try {
					e[n] = null;
				} catch(ex) {
				}
			}
		}
	}
	var c = e.firstChild;
	while(c) {
		scrubNode(c);
		c = c.nextSibling;
	}
}

// Add a stylesheet, replacing any previous custom stylesheet
function setStylesheet(s,id,doc)
{
	if(!id)
		id = "customStyleSheet";
	if(!doc)
		doc = document;
	var n = doc.getElementById(id);
	if(doc.createStyleSheet) {
		// Test for IE's non-standard createStyleSheet method
		if(n)
			n.parentNode.removeChild(n);
		// This failed without the &nbsp;
		doc.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd","&nbsp;<style id='" + id + "'>" + s + "</style>");
	} else {
		if(n) {
			n.replaceChild(doc.createTextNode(s),n.firstChild);
		} else {
			n = doc.createElement("style");
			n.type = "text/css";
			n.id = id;
			n.appendChild(doc.createTextNode(s));
			doc.getElementsByTagName("head")[0].appendChild(n);
		}
	}
}

// Force the browser to do a document reflow when needed to workaround browser bugs
function forceReflow()
{
	if(config.browser.isGecko) {
		setStylesheet("body {top:-1em;margin-top:1em;}");
		setStylesheet("");
	}
}

// Replace the current selection of a textarea or text input and scroll it into view
function replaceSelection(e,text)
{
	if(e.setSelectionRange) {
		var oldpos = e.selectionStart;
		var isRange = e.selectionEnd > e.selectionStart;
		e.value = e.value.substr(0,e.selectionStart) + text + e.value.substr(e.selectionEnd);
		e.setSelectionRange(isRange ? oldpos : oldpos + text.length,oldpos + text.length);
		var linecount = e.value.split('\n').length;
		var thisline = e.value.substr(0,e.selectionStart).split('\n').length-1;
		e.scrollTop = Math.floor((thisline - e.rows / 2) * e.scrollHeight / linecount);
	} else if(document.selection) {
		var range = document.selection.createRange();
		if(range.parentElement() == e) {
			var isCollapsed = range.text == "";
			range.text = text;
			if(!isCollapsed) {
				range.moveStart('character', -text.length);
				range.select();
			}
		}
	}
}

// Returns the text of the given (text) node, possibly merging subsequent text nodes
function getNodeText(e)
{
	var t = ""; 
	while(e && e.nodeName == "#text") {
		t += e.nodeValue;
		e = e.nextSibling;
	}
	return t;
}

//--
//-- LoaderBase and SaverBase
//--

function LoaderBase() {}

LoaderBase.prototype.loadTiddler = function(store,node,tiddlers)
{
	var title = this.getTitle(store,node);
	if(title) {
		var tiddler = store.createTiddler(title);
		this.internalizeTiddler(store,tiddler,title,node);
		tiddlers.push(tiddler);
	}
};

LoaderBase.prototype.loadTiddlers = function(store,nodes)
{
	var tiddlers = [];
	for(var t = 0; t < nodes.length; t++) {
		try {
			this.loadTiddler(store,nodes[t],tiddlers);
		} catch(ex) {
			showException(ex,config.messages.tiddlerLoadError.format([this.getTitle(store,nodes[t])]));
		}
	}
	return tiddlers;
};

function SaverBase() {}

SaverBase.prototype.externalize = function(store)
{
	var results = [];
	var tiddlers = store.getTiddlers("title");
	for(var t = 0; t < tiddlers.length; t++)
		results.push(this.externalizeTiddler(store,tiddlers[t]));
	return results.join("\n");
};

//--
//-- TW21Loader (inherits from LoaderBase)
//--

function TW21Loader() {}

TW21Loader.prototype = new LoaderBase();

TW21Loader.prototype.getTitle = function(store,node)
{
	var title = null;
	if(node.getAttribute) {
		title = node.getAttribute("title");
		if(!title)
			title = node.getAttribute("tiddler");
	}
	if(!title && node.id) {
		var lenPrefix = store.idPrefix.length;
		if (node.id.substr(0,lenPrefix) == store.idPrefix)
			title = node.id.substr(lenPrefix);
	}
	return title;
};

TW21Loader.prototype.internalizeTiddler = function(store,tiddler,title,node)
{
	var e = node.firstChild;
	var text = null;
	if(node.getAttribute("tiddler")) {
		text = getNodeText(e).unescapeLineBreaks();
	} else {
		while(e.nodeName!="PRE" && e.nodeName!="pre") {
			e = e.nextSibling;
		}
		text = e.innerHTML.replace(/\r/mg,"").htmlDecode();
	}
	var modifier = node.getAttribute("modifier");
	var c = node.getAttribute("created");
	var m = node.getAttribute("modified");
	var created = c ? Date.convertFromYYYYMMDDHHMM(c) : version.date;
	var modified = m ? Date.convertFromYYYYMMDDHHMM(m) : created;
	var tags = node.getAttribute("tags");
	var fields = {};
	var attrs = node.attributes;
	for(var i = attrs.length-1; i >= 0; i--) {
		var name = attrs[i].name;
		if (attrs[i].specified && !TiddlyWiki.isStandardField(name)) {
			fields[name] = attrs[i].value.unescapeLineBreaks();
		}
	}
	tiddler.assign(title,text,modifier,modified,tags,created,fields);
	return tiddler;
};

//--
//-- TW21Saver (inherits from SaverBase)
//--

function TW21Saver() {}

TW21Saver.prototype = new SaverBase();

TW21Saver.prototype.externalizeTiddler = function(store,tiddler)
{
	try {
		var extendedAttributes = "";
		var usePre = config.options.chkUsePreForStorage;
		store.forEachField(tiddler,
			function(tiddler,fieldName,value) {
				// don't store stuff from the temp namespace
				if(typeof value != "string")
					value = "";
				if (!fieldName.match(/^temp\./))
					extendedAttributes += ' %0="%1"'.format([fieldName,value.escapeLineBreaks().htmlEncode()]);
			},true);
		var created = tiddler.created.convertToYYYYMMDDHHMM();
		var modified = tiddler.modified.convertToYYYYMMDDHHMM();
		var vdate = version.date.convertToYYYYMMDDHHMM();
		var attributes = tiddler.modifier ? ' modifier="' + tiddler.modifier.htmlEncode() + '"' : "";
		attributes += (usePre && modified == created) ? "" : ' modified="' + modified +'"';
		attributes += (usePre && created == vdate) ? "" :' created="' + created + '"';
		var tags = tiddler.getTags();
		if(!usePre || tags)
			attributes += ' tags="' + tags.htmlEncode() + '"';
		return ('<div %0="%1"%2%3>%4</'+'div>').format([
				usePre ? "title" : "tiddler",
				tiddler.title.htmlEncode(),
				attributes,
				extendedAttributes,
				usePre ? "\n<pre>" + tiddler.text.htmlEncode() + "</pre>\n" : tiddler.text.escapeLineBreaks().htmlEncode()
			]);
	} catch (ex) {
		throw exceptionText(ex,config.messages.tiddlerSaveError.format([tiddler.title]));
	}
};

//--
//-- Deprecated code
//--

// @Deprecated: Use createElementAndWikify and this.termRegExp instead
config.formatterHelpers.charFormatHelper = function(w)
{
	w.subWikify(createTiddlyElement(w.output,this.element),this.terminator);
};

// @Deprecated: Use enclosedTextHelper and this.lookaheadRegExp instead
config.formatterHelpers.monospacedByLineHelper = function(w)
{
	var lookaheadRegExp = new RegExp(this.lookahead,"mg");
	lookaheadRegExp.lastIndex = w.matchStart;
	var lookaheadMatch = lookaheadRegExp.exec(w.source);
	if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
		var text = lookaheadMatch[1];
		if(config.browser.isIE)
			text = text.replace(/\n/g,"\r");
		createTiddlyElement(w.output,"pre",null,null,text);
		w.nextMatch = lookaheadRegExp.lastIndex;
	}
};

// @Deprecated: Use <br> or <br /> instead of <<br>>
config.macros.br.handler = function(place)
{
	createTiddlyElement(place,"br");
};

// Find an entry in an array. Returns the array index or null
// @Deprecated: Use indexOf instead
Array.prototype.find = function(item)
{
	var i = this.indexOf(item);
	return i == -1 ? null : i;
};

// Load a tiddler from an HTML DIV. The caller should make sure to later call Tiddler.changed()
// @Deprecated: Use store.getLoader().internalizeTiddler instead
Tiddler.prototype.loadFromDiv = function(divRef,title)
{
	return store.getLoader().internalizeTiddler(store,this,title,divRef);
};

// Format the text for storage in an HTML DIV
// @Deprecated Use store.getSaver().externalizeTiddler instead.
Tiddler.prototype.saveToDiv = function()
{
	return store.getSaver().externalizeTiddler(store,this);
};

// @Deprecated: Use store.allTiddlersAsHtml() instead
function allTiddlersAsHtml()
{
	return store.allTiddlersAsHtml();
}

// @Deprecated: Use refreshPageTemplate instead
function applyPageTemplate(title)
{
	refreshPageTemplate(title);
}

// @Deprecated: Use story.displayTiddlers instead
function displayTiddlers(srcElement,titles,template,unused1,unused2,animate,unused3)
{
	story.displayTiddlers(srcElement,titles,template,animate);
}

// @Deprecated: Use story.displayTiddler instead
function displayTiddler(srcElement,title,template,unused1,unused2,animate,unused3)
{
	story.displayTiddler(srcElement,title,template,animate);
}

// @Deprecated: Use functions on right hand side directly instead
var createTiddlerPopup = Popup.create;
var scrollToTiddlerPopup = Popup.show;
var hideTiddlerPopup = Popup.remove;

// @Deprecated: Use right hand side directly instead
var regexpBackSlashEn = new RegExp("\\\\n","mg");
var regexpBackSlash = new RegExp("\\\\","mg");
var regexpBackSlashEss = new RegExp("\\\\s","mg");
var regexpNewLine = new RegExp("\n","mg");
var regexpCarriageReturn = new RegExp("\r","mg");
//--
//-- End of scripts
//--
//]]>
</script>
<script type="text/javascript">
//<![CDATA[
if(useJavaSaver)
	document.write("<applet style='position:absolute;left:-1px' name='TiddlySaver' code='TiddlySaver.class' archive='TiddlySaver.jar' width='1' height='1'></applet>");
//]]>
</script>
<!--POST-SCRIPT-START-->

<!--POST-SCRIPT-END-->
</body>
</html>